---
milestone: v2.3
audited: 2026-01-24T22:45:00Z
status: gaps_found
scores:
  requirements: 23/23
  phases: 8/8
  integration: 11/12
  flows: 2/3
gaps:
  requirements: []
  integration:
    - "Region detection mismatch: SpawnReplacementMixin uses canSeeSky(), MobFinalizeSpawnMixin uses heightmap comparison"
  flows:
    - "Surface spawn flow breaks at surface/cave boundary with obstructions (trees, overhangs)"
tech_debt: []
---

# Milestone v2.3 Audit Report: Extra Features Batch 7 (Monster Overhaul)

**Audited:** 2026-01-24T22:45:00Z
**Status:** GAPS FOUND
**Overall Score:** 44/46 (96%)

## Executive Summary

All 8 phases passed individual verification. All 23 requirements have implementing code. However, integration checking revealed a **critical region detection mismatch** between Phase 41 (NBT Spawn Origin Tagging) and Phase 42 (Regional Spawn System) that causes incorrect cap counting at surface/cave boundaries.

## Scores

| Category | Score | Status |
|----------|-------|--------|
| Requirements | 23/23 | ✓ All satisfied |
| Phase Verifications | 8/8 | ✓ All passed |
| Integration Points | 11/12 | ⚠ 1 broken |
| E2E Flows | 2/3 | ⚠ 1 broken |

## Phase Verification Summary

| Phase | Name | Status | Score |
|-------|------|--------|-------|
| 37 | Global Monster Modifications | PASSED | 5/5 |
| 38 | Spawn Table Replacements | PASSED | 6/6 |
| 39 | Entity-Specific Behaviors (Simple) | PASSED | 6/6 |
| 40 | Entity-Specific Behaviors (Complex) | PASSED | 6/6 |
| 41 | NBT Spawn Origin Tagging | PASSED | 5/5 |
| 42 | Regional Spawn System | PASSED | 7/7 |
| 43 | Monster Cap Partitioning | PASSED | 5/5 |
| 44 | Damage Rebalancing | PASSED | 6/6 |

## Critical Gap: Region Detection Mismatch

### The Problem

Two phases use **different algorithms** to determine which region a position belongs to:

**SpawnReplacementMixin (Phase 42) - Distribution Selection:**
```java
if (level.canSeeSky(pos)) return "OW_SURFACE";
if (pos.getY() < 0) return "OW_LOWER_CAVE";
return "OW_UPPER_CAVE";
```

**MobFinalizeSpawnMixin (Phase 41) - NBT Tagging:**
```java
if (y < 0) return "OW_LOWER_CAVE";
if (y >= level.getHeight(Heightmap.Types.MOTION_BLOCKING, x, z))
    return "OW_SURFACE";
return "OW_UPPER_CAVE";
```

### How They Diverge

| Scenario | canSeeSky | heightmap | Result |
|----------|-----------|-----------|--------|
| Open sky at Y=70 | true → SURFACE | Y >= heightmap → SURFACE | Match |
| Under tree at Y=70 | false → UPPER_CAVE | Y >= heightmap → SURFACE | **MISMATCH** |
| In cave at Y=40 | false → UPPER_CAVE | Y < heightmap → UPPER_CAVE | Match |
| Deep cave at Y=-20 | false (Y<0) → LOWER_CAVE | Y < 0 → LOWER_CAVE | Match |

### Impact

When a mob spawns under tree cover or an overhang at heightmap level:

1. **Phase 42** selects from UPPER_CAVE distribution (caves get 35% pillagers, witches, etc.)
2. **Phase 42** checks UPPER_CAVE cap (28 mobs)
3. Mob spawns successfully
4. **Phase 41** tags mob as SURFACE (because Y >= heightmap)
5. **Phase 43** counts mob against SURFACE cap (21 mobs)

**Result:** Upper cave mobs consume surface cap budget. Surface cap fills faster than expected. Cave spawns continue even when surface should be "full."

### Estimated Frequency

- 15-20% of surface-level spawns occur under obstruction (trees, overhangs)
- Affects spawn balance in forest, jungle, roofed forest, mountain biomes
- Causes silent gameplay balance drift

## E2E Flow Status

### Flow 1: Surface Spawn → Speed Modified → Region Tagged → Cap Checked
**Status:** BROKEN

Breaks at surface/cave boundary when `canSeeSky() != (Y >= heightmap)`.

### Flow 2: Cave Spawn → Distribution Roll → Custom Mob → Equipment → Region Tagged
**Status:** COMPLETE

Works correctly for underground spawns where both detection methods agree.

### Flow 3: Damage Flow → Mob Modifier → Class Multiplier
**Status:** COMPLETE

Damage rebalancing integrates correctly with class system.

## Integration Points Verified

| # | From | To | Status |
|---|------|-----|--------|
| 1 | THC.kt | MonsterModifications.register() | ✓ CONNECTED |
| 2 | THC.kt | SimpleEntityBehaviors.register() | ✓ CONNECTED |
| 3 | THC.kt | GhastModifications.register() | ✓ CONNECTED |
| 4 | THC.kt | DamageRebalancing.register() | ✓ CONNECTED |
| 5 | PatrolSpawnerMixin | StageManager.getCurrentStage() | ✓ CONNECTED |
| 6 | SpawnReplacementMixin | SpawnDistributions.selectMob() | ✓ CONNECTED |
| 7 | SpawnReplacementMixin | PillagerVariant.applyEquipment() | ✓ CONNECTED |
| 8 | SpawnReplacementMixin | RegionalCapManager.canSpawnInRegion() | ✓ CONNECTED |
| 9 | RegionalCapManager | THCAttachments.SPAWN_REGION | ✓ CONNECTED |
| 10 | RegionalCapManager | THCAttachments.SPAWN_COUNTED | ✓ CONNECTED |
| 11 | Custom Mobs | ThreatManager | ✓ CONNECTED |
| 12 | Region Detection | Phase 41 ↔ Phase 42 | ⚠ MISMATCHED |

## Cross-System Interactions

### Threat System (v1.3) ↔ Custom Spawns
**Status:** ✓ CONNECTED

Custom mobs (witches, pillagers, etc.) properly register with threat system via standard `Mob.finalizeSpawn()` lifecycle.

### Class System (v2.2) ↔ Mob Damage
**Status:** ✓ CONNECTED

Damage flow correctly stacks:
1. Mob ATTACK_DAMAGE modifier (Phase 44)
2. Player damage reduction (Phase 12)
3. Class multiplier (Phase 35)

### Base Spawn Blocking (v1.3) ↔ Regional Distribution
**Status:** ✓ CONNECTED

Base chunk blocking (HEAD injection) executes BEFORE regional distribution roll, correctly preventing all spawns in claimed chunks.

## Requirements Traceability

| Requirement | Phase | Implementation | Status |
|-------------|-------|----------------|--------|
| FR-01: 20% speed boost | 37 | MonsterModifications ENTITY_LOAD | ✓ |
| FR-02: Equipment loot removal | 37 | THC.kt removedItems set | ✓ |
| FR-03: Zombie → Husk | 38 | SpawnReplacementMixin | ✓ |
| FR-04: Baby zombie normalization | 37 | MonsterModifications counter-modifier | ✓ |
| FR-05: Iron drop removal | 37 | THC.kt removedItems set | ✓ |
| FR-06: Skeleton → Stray | 38 | SpawnReplacementMixin | ✓ |
| FR-07: Ghast fireball velocity | 40 | GhastModifications ENTITY_LOAD | ✓ |
| FR-08: Ghast fire rate | 40 | GhastShootFireballGoalMixin | ✓ |
| FR-09: Ghast fire spread | 40 | LargeFireballMixin | ✓ |
| FR-10: Enderman teleport-behind | 40 | EndermanMixin hurtServer | ✓ |
| FR-11: Enderman proximity aggro | 40 | EndermanProximityAggroGoal | ✓ |
| FR-12: Vex health reduction | 39 | SimpleEntityBehaviors | ✓ |
| FR-13: Vex sword removal | 39 | SimpleEntityBehaviors | ✓ |
| FR-14: Phantom spawn removal | 39 | PhantomSpawnerMixin | ✓ |
| FR-15: Patrol stage-gating | 39 | PatrolSpawnerMixin | ✓ |
| FR-16: Damage rebalancing | 44 | DamageRebalancing + 3 mixins | ✓ |
| FR-17: Iron golem prevention | 39 | CarvedPumpkinBlockMixin | ✓ |
| FR-18: Regional spawn system | 42 | SpawnReplacementMixin | ✓ |
| FR-19: Custom distributions | 42 | SpawnDistributions | ✓ |
| FR-20: Pillager variants | 42 | PillagerVariant + PillagerMixin | ✓ |
| FR-21: Pack sizes [1,4] | 42 | SpawnReplacementMixin | ✓ |
| FR-22: Partitioned caps | 43 | RegionalCapManager | ✓ |
| FR-23: NBT spawn tagging | 41 | MobFinalizeSpawnMixin | ✓ |

## Tech Debt

None accumulated. All phases implemented cleanly without TODOs, FIXMEs, or deferred items.

## Recommendation

**Fix the region detection mismatch before completing milestone.**

The fix is straightforward: unify region detection to use ONE algorithm in both locations. Options:

**Option A:** Use `canSeeSky()` everywhere (treats under-tree as cave)
- Pros: Simple, consistent
- Cons: More aggressive cave distribution at surface level

**Option B:** Use heightmap comparison everywhere (treats under-tree as surface)
- Pros: Y-level based, matches player intuition
- Cons: Requires `getHeight()` call in hot path

**Option C:** Use `canSeeSky()` in both, but heightmap as fallback for edge cases
- Pros: Best of both worlds
- Cons: More complex

Recommended: **Option B** - Players think of "surface" as "at ground level" regardless of tree cover. Use heightmap in both locations.

---

*Audited: 2026-01-24T22:45:00Z*
*Auditor: Claude (gsd-audit-milestone orchestrator)*
