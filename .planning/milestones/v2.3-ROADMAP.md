# Milestone v2.3: Extra Features Batch 7 (Monster Overhaul)

**Status:** ✅ SHIPPED 2026-01-25
**Phases:** 37-45
**Total Plans:** 13

## Overview

Comprehensive monster overhaul creating distinct threat profiles across Overworld regions. Global modifications increase monster speed and remove equipment drops. Spawn table replacements substitute husks for zombies and strays for skeletons. Entity-specific behaviors modify Ghast, Enderman, Vex, Phantom, Iron Golem, and Illager patrols. Regional spawn system introduces three-way Overworld split (Surface/Upper Cave/Lower Cave) with custom mob distributions and Pillager variants. Partitioned monster caps prevent surface spawns from consuming cave capacity. NBT tagging enables region tracking and cap counting. Damage rebalancing tunes 6 mobs for THC balance. Gap closure phase unified region detection algorithms.

## Phases

### Phase 37: Global Monster Modifications

**Goal**: All hostile mobs behave more aggressively through speed increase and loot economy changes
**Depends on**: Nothing (first phase)
**Plans**: 1 plan

Plans:
- [x] 37-01-PLAN.md — Speed modifications + loot filtering (FR-01, FR-02, FR-04, FR-05)

**Details:**
- FR-01: 20% speed increase via attribute modifier on ENTITY_LOAD
- Exclusions: Creepers (unchanged), Baby zombies (normalized), Bosses (Wither, Dragon)
- FR-02: Equipment drops removed via loot event interception
- FR-04: Baby zombie speed normalized by counter-modifier
- FR-05: Iron ingot drops removed from zombie/husk loot table

---

### Phase 38: Spawn Table Replacements

**Goal**: Overworld surface threats shift from basic zombies/skeletons to more dangerous variants
**Depends on**: Phase 37
**Plans**: 1 plan

Plans:
- [x] 38-01-PLAN.md — Entity replacement mixin for surface spawns (FR-03, FR-06)

**Details:**
- FR-03: Zombie -> Husk replacement in NaturalSpawner.getRandomSpawnMobAt
- FR-06: Skeleton -> Stray replacement in same mixin
- Exception: Structure spawns use vanilla pools
- Exception: Spider jockeys keep skeleton riders (passenger check)

---

### Phase 39: Entity-Specific Behaviors (Simple)

**Goal**: Individual mob modifications that are straightforward HEAD cancellation or attribute changes
**Depends on**: Phase 38, Stage System (v2.2)
**Plans**: 2 plans

Plans:
- [x] 39-01-PLAN.md — Vex modifications (health reduction, sword removal)
- [x] 39-02-PLAN.md — Spawner cancellations (phantom, patrol) + iron golem prevention

**Details:**
- FR-12: Vex health set to 8 HP on spawn via ENTITY_LOAD
- FR-13: Vex mainhand cleared on spawn
- FR-14: PhantomSpawner.tick HEAD cancellation returning 0
- FR-15: PatrolSpawner.tick HEAD cancellation when stage < 2
- FR-17: Iron golem summon prevention via CarvedPumpkinBlock.trySpawnGolem

---

### Phase 40: Entity-Specific Behaviors (Complex)

**Goal**: Ghast and Enderman behavior modifications requiring careful implementation
**Depends on**: Phase 39
**Plans**: 2 plans

Plans:
- [x] 40-01-PLAN.md — Ghast modifications (velocity, fire rate, fire spread)
- [x] 40-02-PLAN.md — Enderman modifications (proximity aggro, teleport-behind)

**Details:**
- FR-07: Fireball velocity scaled 1.5x at spawn time
- FR-08: Shoot cooldown increased from 60 to 80 ticks
- FR-09: LargeFireball.onHit TAIL injection adds extra fire blocks
- FR-10: EnderMan.hurtServer RETURN injection with 50% chance teleport behind attacker
- FR-11: EnderMan.customServerAiStep HEAD injection for proximity aggro check

---

### Phase 41: NBT Spawn Origin Tagging

**Goal**: Every spawned mob has region origin tracked for cap counting
**Depends on**: Phase 40
**Plans**: 1 plan

Plans:
- [x] 41-01-PLAN.md — Spawn attachments + MobFinalizeSpawnMixin for region tagging (FR-23)

**Details:**
- FR-23: Two entity attachments - SPAWN_REGION (String) and SPAWN_COUNTED (Boolean)
- Region calculated at spawn time from position: heightmap comparison + Y level
- Region values: OW_SURFACE, OW_UPPER_CAVE, OW_LOWER_CAVE
- Counted = true only for: NATURAL spawn reason + MONSTER category + THC-processed

---

### Phase 42: Regional Spawn System

**Goal**: Overworld spawns follow region-based distributions with custom mob types
**Depends on**: Phase 41 (requires NBT tagging for region assignment)
**Plans**: 2 plans

Plans:
- [x] 42-01-PLAN.md — Regional distribution infrastructure + spawn replacement integration
- [x] 42-02-PLAN.md — Pillager melee AI modification

**Details:**
- FR-18: Region detection - OW_SURFACE: isSkyVisible(pos), OW_UPPER_CAVE: Y >= 0 && !sky, OW_LOWER_CAVE: Y < 0 && !sky
- FR-19: Custom distributions per region (Surface 5% witch, Upper Cave pillagers/vexes/witches, Lower Cave blazes/breezes/vindicators/evokers)
- FR-20: Pillager MELEE variant gets iron sword, RANGED keeps crossbow
- FR-21: Custom spawns use pack size [1, 4], vanilla fallback uses biome pack sizes

---

### Phase 43: Monster Cap Partitioning

**Goal**: Regional caps prevent surface spawns from consuming all cave capacity
**Depends on**: Phase 42 (requires regional spawns and NBT tagging)
**Plans**: 1 plan

Plans:
- [x] 43-01-PLAN.md — Regional cap manager + spawn cycle hooks + cap check integration

**Details:**
- FR-22: Per-region caps - OW_SURFACE 30%, OW_UPPER_CAVE 40%, OW_LOWER_CAVE 50%
- Total 120% intentional overlap
- Cap counting uses SPAWN_REGION attachment (spawn origin, not current position)
- Track regional counts during spawn cycle, not via vanilla SpawnState

---

### Phase 44: Damage Rebalancing

**Goal**: Six mobs have damage values tuned for THC balance
**Depends on**: Phase 43
**Plans**: 2 plans

Plans:
- [x] 44-01-PLAN.md — Melee damage modifiers (Vex, Vindicator, Magma Cube)
- [x] 44-02-PLAN.md — Projectile/fang damage (Blaze, Piglin, Evoker fangs)

**Details:**
- FR-16: Damage modifications via ENTITY_LOAD attribute modifiers (melee) and @ModifyArg mixins (projectile/fang)
- Melee: ATTACK_DAMAGE attribute with ADD_MULTIPLIED_TOTAL operation
- Projectile: SmallFireballMixin, PiglinCrossbowMixin
- Fangs: EvokerFangsMixin

---

### Phase 45: Unify Region Detection (Gap Closure)

**Goal**: Fix region detection mismatch between spawn distribution and NBT tagging
**Depends on**: Phase 42, Phase 41
**Gap Closure**: Closes integration gap from v2.3 audit
**Plans**: 1 plan

Plans:
- [x] 45-01-PLAN.md — Extract shared RegionDetector utility, update both mixins

**Details:**
- Root cause: SpawnReplacementMixin used `canSeeSky()`, MobFinalizeSpawnMixin used heightmap
- Fix: Shared `RegionDetector.getRegion(level, pos)` utility using heightmap-based detection
- Heightmap chosen per audit recommendation (matches player intuition of "surface")

---

## Milestone Summary

**Key Decisions:**

- ServerEntityEvents.ENTITY_LOAD for entity spawn modification (monster speed, projectile velocity)
- Transient AttributeModifiers for runtime-only stat changes (no save bloat)
- @Redirect on addFreshEntityWithPassengers for spawn-time entity replacement
- canSeeSky(BlockPos) for initial surface determination (later unified to heightmap)
- HEAD cancellation on custom spawners for complete spawn removal (PhantomSpawner, PatrolSpawner)
- Stage-conditional spawning via StageManager.getCurrentStage check in mixin
- Weighted random selection for spawn distributions (cumulative weight matching)
- RegionDetector static utility for shared heightmap-based region detection

**Issues Resolved:**

- Minecraft 1.21.11 API changes (EntityType.create, snapTo, Identifier, subpackages)
- Kotlin daemon cache corruption (disabled incremental compilation)
- Region detection mismatch between spawn distribution and NBT tagging (Phase 45 gap closure)

**Technical Debt Incurred:**

- None

---

_For current project status, see .planning/ROADMAP.md (next milestone) or .planning/STATE.md_
