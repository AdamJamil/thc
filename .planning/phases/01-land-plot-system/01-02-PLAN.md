---
phase: 01-land-plot-system
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified: [src/main/kotlin/thc/bell/BellHandler.kt, src/main/kotlin/thc/bell/BellState.kt, src/main/java/thc/THCAttachments.java, src/main/kotlin/thc/THC.kt]
autonomous: true

must_haves:
  truths:
    - "Player can ring a bell by right-clicking it"
    - "First ring of any bell drops one land plot book"
    - "Subsequent rings of the same bell do not drop books"
    - "Different bells each drop their own book on first ring"
    - "Bell activation state persists across server restarts"
  artifacts:
    - path: "src/main/kotlin/thc/bell/BellHandler.kt"
      provides: "Bell USE event handler"
      min_lines: 30
    - path: "src/main/kotlin/thc/bell/BellState.kt"
      provides: "Bell activation state management"
      min_lines: 25
    - path: "src/main/java/thc/THCAttachments.java"
      provides: "Bell state attachment registration"
      contains: "BELL_ACTIVATED"
  key_links:
    - from: "THC.kt onInitialize"
      to: "BellHandler event registration"
      via: "UseBlockCallback.EVENT.register"
      pattern: "UseBlockCallback\\.EVENT\\.register"
    - from: "BellHandler"
      to: "BellState attachment"
      via: "getAttached/setAttached calls"
      pattern: "getAttached|setAttached"
    - from: "BellHandler"
      to: "THCItems.LAND_PLOT"
      via: "ItemStack creation and drop"
      pattern: "ItemStack.*THCItems\\.LAND_PLOT"
---

<objective>
Implement bell interaction that drops land plot books on first activation with persistent state.

Purpose: Complete the land plot acquisition mechanic - players explore to find bells, ring them once for a land plot book, and the bell "remembers" it was activated.
Output: Working bell interaction with state persistence across restarts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-land-plot-system/01-01-SUMMARY.md

# Existing patterns from codebase
@src/main/java/thc/THCAttachments.java
@src/main/kotlin/thc/buckler/BucklerState.kt
@src/main/kotlin/thc/THC.kt

# Plan 01 created
@src/main/kotlin/thc/item/THCItems.kt
@src/main/kotlin/thc/item/LandPlotItem.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement bell state storage with attachments</name>
  <files>src/main/java/thc/THCAttachments.java, src/main/kotlin/thc/bell/BellState.kt</files>
  <action>
1. Add bell attachment to `src/main/java/thc/THCAttachments.java`:
   - Study existing pattern for BUCKLER_POISE, BUCKLER_RAISE_TICK, etc.
   - Add new attachment: `public static final AttachmentType<Boolean> BELL_ACTIVATED = ...`
   - Use AttachmentRegistry.builder with Boolean type, defaultValue = false
   - Build with .persistent() to survive restarts
   - Attach to BlockEntity (not Entity like buckler attachments)
   - Register in init() method with ResourceLocation("thc", "bell_activated")

2. Create `src/main/kotlin/thc/bell/BellState.kt`:
   - Object with JvmStatic functions (follow BucklerState.kt pattern)
   - Function: `fun isActivated(level: Level, pos: BlockPos): Boolean`
     - Get block entity at pos
     - Return entity?.getData(THCAttachments.BELL_ACTIVATED) ?: false
   - Function: `fun setActivated(level: Level, pos: BlockPos, activated: Boolean)`
     - Get block entity at pos
     - Call entity?.setData(THCAttachments.BELL_ACTIVATED, activated)
   - Import net.minecraft.core.BlockPos, net.minecraft.world.level.Level
   - Import net.minecraft.world.level.block.entity.BellBlockEntity

Rationale: Attachment system (like buckler poise) provides automatic persistence. Store per-bell-block-entity.
  </action>
  <verify>
gradle build completes successfully
No compilation errors for BellState or THCAttachments
  </verify>
  <done>
Bell activation state can be stored and retrieved per bell block position, persists with block entity
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement bell USE event handler</name>
  <files>src/main/kotlin/thc/bell/BellHandler.kt, src/main/kotlin/thc/THC.kt</files>
  <action>
1. Create `src/main/kotlin/thc/bell/BellHandler.kt`:
   - Object with JvmStatic function `fun register()`
   - Inside register(), use Fabric's UseBlockCallback.EVENT.register:
   ```kotlin
   UseBlockCallback.EVENT.register(UseBlockCallback { player, level, hand, hitResult ->
       val pos = hitResult.blockPos
       val blockState = level.getBlockState(pos)

       // Check if block is a bell
       if (!blockState.`is`(Blocks.BELL)) {
           return@UseBlockCallback InteractionResult.PASS
       }

       // Server-side only
       if (level.isClientSide) {
           return@UseBlockCallback InteractionResult.SUCCESS
       }

       // Check if already activated
       if (BellState.isActivated(level, pos)) {
           return@UseBlockCallback InteractionResult.SUCCESS
       }

       // Mark as activated
       BellState.setActivated(level, pos, true)

       // Drop land plot book
       val landPlot = ItemStack(THCItems.LAND_PLOT)
       val itemEntity = ItemEntity(level, pos.x + 0.5, pos.y + 1.0, pos.z + 0.5, landPlot)
       level.addFreshEntity(itemEntity)

       return@UseBlockCallback InteractionResult.SUCCESS
   })
   ```
   - Imports: UseBlockCallback, InteractionResult, Blocks, ItemStack, ItemEntity
   - Let bell ring normally (return SUCCESS to allow vanilla bell behavior)
   - Drop item above bell (+1 Y) at center of block (+0.5 X/Z)

2. Register in `src/main/kotlin/thc/THC.kt` onInitialize():
   - Add `BellHandler.register()` call after THCItems.init()
   - Follow existing initialization pattern

Rationale: UseBlockCallback intercepts before bell rings, check state, drop book, let bell ring normally.
  </action>
  <verify>
gradle build completes successfully
No "unresolved reference" errors for BellHandler or BellState
  </verify>
  <done>
Bell USE event registered, drops land plot book on first activation only, state persists
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] gradle build succeeds without errors
- [ ] Manual test: Place bell, right-click it → land plot book drops
- [ ] Manual test: Right-click same bell again → no book drops
- [ ] Manual test: Place different bell, right-click → book drops
- [ ] Manual test: Save and exit world, reload → activated bells still don't drop books
- [ ] Bell still makes sound when rung (vanilla behavior preserved)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No build errors or warnings introduced
- Bell drops land plot book on first activation only
- Multiple bells each have independent activation state
- Bell activation state persists across server restarts
- Vanilla bell behavior (sound, villager gathering) still works
</success_criteria>

<output>
After completion, create `.planning/phases/01-land-plot-system/01-02-SUMMARY.md`
</output>
