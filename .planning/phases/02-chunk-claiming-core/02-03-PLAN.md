---
phase: 02-chunk-claiming-core
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - src/main/kotlin/thc/item/LandPlotItem.kt
autonomous: true

must_haves:
  truths:
    - "Player can use land plot book on a block to initiate claiming"
    - "Claiming fails with red message for uneven terrain"
    - "Claiming fails with red message for village chunks"
    - "Claiming fails with red message for already claimed chunks"
    - "Land plot book is consumed on successful claim"
    - "Success message confirms claim with chunk coordinates"
  artifacts:
    - path: "src/main/kotlin/thc/item/LandPlotItem.kt"
      provides: "Land plot use behavior with validation"
      contains: "useOn"
      min_lines: 40
  key_links:
    - from: "LandPlotItem.useOn"
      to: "ChunkValidator.validateTerrain"
      via: "validation call"
      pattern: "ChunkValidator\\.validateTerrain"
    - from: "LandPlotItem.useOn"
      to: "ChunkValidator.isVillageChunk"
      via: "village check"
      pattern: "ChunkValidator\\.isVillageChunk"
    - from: "LandPlotItem.useOn"
      to: "ClaimManager.addClaim"
      via: "claim registration"
      pattern: "ClaimManager\\.addClaim"
---

<objective>
Implement land plot book use behavior with validation, claiming, and player feedback.

Purpose: Complete the claiming flow - player uses item, validations run, chunk is claimed or error shown.
Output: LandPlotItem with useOn() method that validates terrain, checks village, claims chunk, and provides feedback.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

# Prior plan summaries for dependencies:
@.planning/phases/02-chunk-claiming-core/02-01-SUMMARY.md
@.planning/phases/02-chunk-claiming-core/02-02-SUMMARY.md

# Existing item patterns:
@src/main/kotlin/thc/item/BucklerItem.kt
@src/main/kotlin/thc/item/LandPlotItem.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement LandPlotItem.useOn with validation and claiming</name>
  <files>src/main/kotlin/thc/item/LandPlotItem.kt</files>
  <action>
Modify LandPlotItem to override useOn() for block-targeted use behavior.

Override useOn method:
```kotlin
override fun useOn(context: UseOnContext): InteractionResult {
    val level = context.level
    val pos = context.clickedPos
    val player = context.player ?: return InteractionResult.PASS

    // Server-side only
    if (level.isClientSide || level !is ServerLevel) {
        return InteractionResult.SUCCESS
    }

    val server = level.server
    val chunkPos = ChunkPos(pos)

    // Check if already claimed (CLAIM-05)
    if (ClaimManager.isClaimed(server, chunkPos)) {
        sendFailureMessage(player, "This chunk is already claimed!")
        return InteractionResult.FAIL
    }

    // Check for village (CLAIM-04)
    if (ChunkValidator.isVillageChunk(level, chunkPos)) {
        sendFailureMessage(player, "Cannot claim village chunks!")
        return InteractionResult.FAIL
    }

    // Validate terrain flatness (CLAIM-02, CLAIM-03)
    when (val result = ChunkValidator.validateTerrain(level, chunkPos)) {
        is ValidationResult.Failure -> {
            sendFailureMessage(player, result.reason)
            return InteractionResult.FAIL
        }
        is ValidationResult.Success -> {
            // Calculate base floor Y (CLAIM-07): lowest surface Y - 10
            val baseFloorY = result.lowestSurfaceY - 10

            // Register claim (CLAIM-01)
            ClaimManager.addClaim(server, chunkPos, baseFloorY)

            // Consume item (CLAIM-06)
            context.itemInHand.shrink(1)

            // Send success message
            sendSuccessMessage(player, chunkPos)

            return InteractionResult.SUCCESS
        }
    }
}
```

Helper methods for player messages:
```kotlin
private fun sendFailureMessage(player: Player, message: String) {
    player.displayClientMessage(
        Component.literal(message).withStyle(ChatFormatting.RED),
        true  // actionBar = true for less intrusive display
    )
}

private fun sendSuccessMessage(player: Player, chunkPos: ChunkPos) {
    player.displayClientMessage(
        Component.literal("Claimed chunk at (${chunkPos.x}, ${chunkPos.z})!")
            .withStyle(ChatFormatting.GREEN),
        true
    )
}
```

Key imports to add:
- net.minecraft.world.item.context.UseOnContext
- net.minecraft.server.level.ServerLevel
- net.minecraft.world.level.ChunkPos
- net.minecraft.network.chat.Component
- net.minecraft.ChatFormatting
- thc.claim.ClaimManager
- thc.claim.ChunkValidator
- thc.claim.ValidationResult
  </action>
  <verify>Build succeeds: `./gradlew build`</verify>
  <done>LandPlotItem.useOn validates terrain, village, existing claims, registers claim, consumes item</done>
</task>

<task type="auto">
  <name>Task 2: Verify claiming flow integration</name>
  <files>src/main/kotlin/thc/item/LandPlotItem.kt</files>
  <action>
Ensure complete integration and proper error handling:

1. Add null safety and defensive checks:
   - Player null check (already in useOn via context.player)
   - Server null check for ServerLevel

2. Verify message requirements match spec:
   - CLAIM-03: "The chunk's surface is not flat enough!" - exact message from ValidationResult.Failure
   - Village message: "Cannot claim village chunks!"
   - Already claimed message: "This chunk is already claimed!"

3. Verify item consumption happens ONLY on success (CLAIM-06):
   - shrink(1) called only after ClaimManager.addClaim succeeds

4. Add brief KDoc comment to useOn explaining the claiming flow

Run smoke test to verify mod still loads:
```bash
./gradlew runSmokeServer
```
  </action>
  <verify>
- Build succeeds: `./gradlew build`
- Smoke test passes: `./gradlew runSmokeServer`
  </verify>
  <done>Claiming flow complete with all validation messages and proper item consumption</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./gradlew build` succeeds without errors
- [ ] `./gradlew runSmokeServer` completes without crashes
- [ ] LandPlotItem.useOn compiles with all validation checks
- [ ] All failure messages match requirements
- [ ] Item consumption only occurs on successful claim
</verification>

<success_criteria>

- LandPlotItem.useOn validates terrain, village, existing claims (CLAIM-01 through CLAIM-05)
- Correct failure messages displayed for each validation failure
- Land plot book consumed only on success (CLAIM-06)
- Base floor Y correctly calculated as lowestSurfaceY - 10 (CLAIM-07)
- Smoke test passes
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-chunk-claiming-core/02-03-SUMMARY.md`
</output>
