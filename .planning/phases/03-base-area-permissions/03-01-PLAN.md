---
phase: 03-base-area-permissions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/main/kotlin/thc/base/BasePermissions.kt, src/main/kotlin/thc/THC.kt]
autonomous: true

must_haves:
  truths:
    - "Player cannot attack mobs or other players while in base area"
    - "Player cannot draw bow or crossbow while in base area"
    - "Player sees red 'No violence indoors!' message when attempting combat in base"
  artifacts:
    - path: "src/main/kotlin/thc/base/BasePermissions.kt"
      provides: "Combat restriction event handlers"
      min_lines: 40
      contains: "AttackEntityCallback"
    - path: "src/main/kotlin/thc/THC.kt"
      provides: "BasePermissions registration"
      contains: "BasePermissions.register"
  key_links:
    - from: "BasePermissions.kt"
      to: "ClaimManager.isInBase"
      via: "position check in event handlers"
      pattern: "ClaimManager\\.isInBase"
    - from: "THC.kt"
      to: "BasePermissions.register()"
      via: "mod initialization"
      pattern: "BasePermissions\\.register"
---

<objective>
Implement combat restrictions within base areas - players cannot attack or use ranged weapons while in their claimed chunks.

Purpose: Bases are safe zones where no violence is permitted, enforcing the "No violence indoors!" design principle.
Output: BasePermissions event handlers that block attacks and bow/crossbow use when player is in base area.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 2 provides the base area check API:
@.planning/phases/02-chunk-claiming-core/02-01-SUMMARY.md

# Source files to reference:
@src/main/kotlin/thc/claim/ClaimManager.kt
@src/main/kotlin/thc/THC.kt
@src/main/kotlin/thc/bell/BellHandler.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BasePermissions with combat blocking handlers</name>
  <files>src/main/kotlin/thc/base/BasePermissions.kt</files>
  <action>
Create BasePermissions object in new package `thc.base` with:

1. `register()` function that registers two Fabric event handlers:

2. **Attack blocking** via `AttackEntityCallback.EVENT.register`:
   - Check if player is null or world is client-side → return PASS
   - Get server from player.server
   - Call ClaimManager.isInBase(server, player.blockPosition())
   - If in base: display "No violence indoors!" message (red, action bar) and return FAIL
   - Otherwise: return PASS

3. **Bow/crossbow blocking** via `UseItemCallback.EVENT.register`:
   - Check if player is null or world is client-side → return PASS
   - Check if item is BowItem or CrossbowItem (use Kotlin `is` check)
   - If not bow/crossbow → return PASS
   - Get server from player.server (cast to ServerPlayer for server access)
   - Call ClaimManager.isInBase(server, player.blockPosition())
   - If in base: display "No violence indoors!" message (red, action bar) and return FAIL
   - Otherwise: return PASS

Message display pattern (from LandPlotItem):
```kotlin
player.displayClientMessage(
    Component.literal("No violence indoors!").withStyle(ChatFormatting.RED),
    true  // action bar
)
```

Import requirements:
- net.fabricmc.fabric.api.event.player.AttackEntityCallback
- net.fabricmc.fabric.api.event.player.UseItemCallback
- net.minecraft.world.InteractionResult
- net.minecraft.network.chat.Component
- net.minecraft.ChatFormatting
- net.minecraft.world.item.BowItem
- net.minecraft.world.item.CrossbowItem
- net.minecraft.server.level.ServerPlayer
- thc.claim.ClaimManager
  </action>
  <verify>File compiles: ./gradlew classes --quiet</verify>
  <done>BasePermissions.kt exists with attack and bow/crossbow blocking handlers</done>
</task>

<task type="auto">
  <name>Task 2: Register BasePermissions in mod initializer</name>
  <files>src/main/kotlin/thc/THC.kt</files>
  <action>
1. Add import: `import thc.base.BasePermissions`
2. In onInitialize(), add call to `BasePermissions.register()` after BellHandler.register()

The registration order should be:
- BellHandler.register()
- BasePermissions.register()
  </action>
  <verify>./gradlew classes --quiet compiles without errors</verify>
  <done>BasePermissions registered in THC.onInitialize()</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./gradlew classes` compiles without errors
- [ ] BasePermissions.kt exists with both event handlers
- [ ] THC.kt imports and registers BasePermissions
- [ ] ClaimManager.isInBase is called in both handlers
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Combat blocking logic uses ClaimManager.isInBase() for position checks
- Message matches requirement exactly: "No violence indoors!" in red
  </success_criteria>

<output>
After completion, create `.planning/phases/03-base-area-permissions/03-01-SUMMARY.md`
</output>
