---
phase: 04-world-restrictions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/kotlin/thc/world/WorldRestrictions.kt
  - src/main/kotlin/thc/THC.kt
autonomous: true

must_haves:
  truths:
    - "Player can place allowlist blocks outside base chunks"
    - "Player cannot place non-allowlist blocks outside base chunks (fails silently)"
    - "Allowlist blocks cannot be placed within 26 coordinates of another allowlist block"
    - "Torches and ladders are exempt from adjacency restriction"
  artifacts:
    - path: "src/main/kotlin/thc/world/WorldRestrictions.kt"
      provides: "Block allowlist, placement handler, adjacency checker"
      min_lines: 80
      contains: "ALLOWED_BLOCKS"
  key_links:
    - from: "WorldRestrictions.kt"
      to: "ClaimManager.isInBase"
      via: "base area check before restrictions"
      pattern: "ClaimManager\\.isInBase"
    - from: "WorldRestrictions.kt"
      to: "UseBlockCallback"
      via: "Fabric event registration"
      pattern: "UseBlockCallback\\.EVENT"
---

<objective>
Implement block placement restrictions outside base areas with allowlist and adjacency rules.

Purpose: Enforce risk-based territorial progression - players cannot build freely outside bases.
Output: WorldRestrictions handler blocking non-allowlist placement and enforcing 26-coord adjacency.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-chunk-claiming-core/02-01-SUMMARY.md
@.planning/phases/03-base-area-permissions/03-01-SUMMARY.md

@src/main/kotlin/thc/claim/ClaimManager.kt
@src/main/kotlin/thc/base/BasePermissions.kt
@src/main/kotlin/thc/THC.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WorldRestrictions with allowlist constants and placement handler</name>
  <files>src/main/kotlin/thc/world/WorldRestrictions.kt</files>
  <action>
Create WorldRestrictions singleton object with:

1. ALLOWED_BLOCKS Set containing all allowlist blocks:
   - Blocks.ANVIL, Blocks.CHIPPED_ANVIL, Blocks.DAMAGED_ANVIL
   - Blocks.BLAST_FURNACE
   - Blocks.BREWING_STAND
   - Blocks.CARTOGRAPHY_TABLE
   - Blocks.CAULDRON (include all variants: WATER_CAULDRON, LAVA_CAULDRON, POWDER_SNOW_CAULDRON)
   - Blocks.CHEST, Blocks.TRAPPED_CHEST
   - Blocks.COMPOSTER
   - Blocks.CRAFTING_TABLE
   - Blocks.ENCHANTING_TABLE
   - Blocks.FURNACE
   - Blocks.GRINDSTONE
   - Blocks.LECTERN
   - Blocks.LODESTONE
   - Blocks.LOOM
   - Blocks.SMITHING_TABLE
   - Blocks.SMOKER
   - Blocks.STONECUTTER
   - Blocks.TNT
   - Blocks.LADDER
   - Blocks.TORCH, Blocks.WALL_TORCH, Blocks.SOUL_TORCH, Blocks.SOUL_WALL_TORCH

2. ADJACENCY_EXEMPT_BLOCKS Set for blocks exempt from 26-coord rule:
   - All torch variants (TORCH, WALL_TORCH, SOUL_TORCH, SOUL_WALL_TORCH)
   - Blocks.LADDER

3. register() function that:
   - Registers UseBlockCallback.EVENT handler
   - In handler:
     a. Skip client side (world.isClientSide)
     b. Get player's held item, check if it's a BlockItem
     c. If not BlockItem, return PASS
     d. Get the block from BlockItem
     e. Cast world to ServerLevel, get server
     f. Check ClaimManager.isInBase(server, hitResult.blockPos) - if in base, return PASS (allow all)
     g. Check if block is in ALLOWED_BLOCKS - if not, return FAIL (silent rejection per PLACE-02)
     h. If block is allowed but NOT in ADJACENCY_EXEMPT_BLOCKS, call checkAdjacency
     i. If adjacency fails, return FAIL (silent)
     j. Otherwise return PASS

4. Private checkAdjacency function (to be implemented in Task 2)

Use InteractionResult.PASS to allow, InteractionResult.FAIL to block silently.
Do NOT show any message for placement failures (PLACE-02 specifies silent failure).

Follow BasePermissions.kt pattern for server access: (world as? ServerLevel)?.server
  </action>
  <verify>./gradlew build compiles without errors</verify>
  <done>WorldRestrictions.kt exists with ALLOWED_BLOCKS set and UseBlockCallback handler</done>
</task>

<task type="auto">
  <name>Task 2: Add 26-coordinate adjacency check</name>
  <files>src/main/kotlin/thc/world/WorldRestrictions.kt</files>
  <action>
Implement checkAdjacency function in WorldRestrictions:

1. checkAdjacency(level: ServerLevel, placementPos: BlockPos): Boolean
   - Returns true if placement is allowed (no nearby allowlist blocks)
   - Returns false if placement should be blocked (too close)

2. Algorithm:
   - Define search radius: iterate x,y,z from -26 to +26
   - For each offset position (placementPos + offset):
     - Skip if same position (offset 0,0,0)
     - Get the block at that position via level.getBlockState(pos).block
     - If block is in ALLOWED_BLOCKS AND NOT in ADJACENCY_EXEMPT_BLOCKS:
       - Return false (too close to another restricted allowlist block)
   - If no conflicts found, return true

3. Optimization consideration: The 26-coordinate range creates a 53x53x53 cube (148,877 checks).
   For performance, consider:
   - Only check if distance <= 26 (sphere, not cube) to reduce checks
   - Use: if (offset.x*offset.x + offset.y*offset.y + offset.z*offset.z <= 26*26)

Note: "26 coordinates" likely means Chebyshev distance (max of |dx|,|dy|,|dz| <= 26), which IS a cube.
Implement as cube (Chebyshev) since that's the natural interpretation of "within 26 coordinates".

4. Update the UseBlockCallback handler (Task 1) to call checkAdjacency when needed.
  </action>
  <verify>./gradlew build compiles without errors</verify>
  <done>checkAdjacency function implemented, adjacency restriction works for non-exempt blocks</done>
</task>

<task type="auto">
  <name>Task 3: Register WorldRestrictions in mod initializer</name>
  <files>src/main/kotlin/thc/THC.kt</files>
  <action>
Update THC.kt:
1. Add import for thc.world.WorldRestrictions
2. In onInitialize(), add WorldRestrictions.register() call after BasePermissions.register()

This follows the established pattern for event handler registration.
  </action>
  <verify>./gradlew build compiles without errors; grep -q "WorldRestrictions.register" src/main/kotlin/thc/THC.kt</verify>
  <done>WorldRestrictions registered in mod initialization chain</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./gradlew build` succeeds without errors
- [ ] WorldRestrictions.kt contains ALLOWED_BLOCKS set with all 20+ block types
- [ ] WorldRestrictions.kt contains ADJACENCY_EXEMPT_BLOCKS with torches and ladders
- [ ] UseBlockCallback handler checks isInBase, allowlist, and adjacency
- [ ] checkAdjacency scans 26-coordinate Chebyshev distance
- [ ] THC.kt calls WorldRestrictions.register()
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No compilation errors
- Placement restrictions ready for in-game testing (PLACE-01 through PLACE-05)
</success_criteria>

<output>
After completion, create `.planning/phases/04-world-restrictions/04-01-SUMMARY.md`
</output>
