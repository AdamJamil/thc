---
phase: 04-world-restrictions
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/main/kotlin/thc/world/VillageProtection.kt
  - src/main/kotlin/thc/THC.kt
autonomous: true

must_haves:
  truths:
    - "Player cannot break blocks in village chunks"
    - "Player CAN break ores in village chunks (exception)"
    - "Player CAN break allowlist blocks in village chunks (exception)"
  artifacts:
    - path: "src/main/kotlin/thc/world/VillageProtection.kt"
      provides: "Village block break protection with ore and allowlist exceptions"
      min_lines: 50
      contains: "isVillageChunk"
  key_links:
    - from: "VillageProtection.kt"
      to: "ChunkValidator.isVillageChunk"
      via: "village detection"
      pattern: "ChunkValidator\\.isVillageChunk"
    - from: "VillageProtection.kt"
      to: "WorldRestrictions.ALLOWED_BLOCKS"
      via: "allowlist check for exception"
      pattern: "WorldRestrictions\\.ALLOWED_BLOCKS"
    - from: "VillageProtection.kt"
      to: "PlayerBlockBreakEvents.BEFORE"
      via: "Fabric event registration"
      pattern: "PlayerBlockBreakEvents\\.BEFORE"
---

<objective>
Implement village block protection preventing most block breaking in village chunks.

Purpose: Protect villages as safe NPC zones - players cannot grief but can extract resources.
Output: VillageProtection handler blocking non-ore, non-allowlist breaking in village chunks.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-chunk-claiming-core/02-02-SUMMARY.md
@.planning/phases/04-world-restrictions/04-01-PLAN.md

@src/main/kotlin/thc/claim/ChunkValidator.kt
@src/main/kotlin/thc/THC.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VillageProtection handler with ore/allowlist exceptions</name>
  <files>src/main/kotlin/thc/world/VillageProtection.kt</files>
  <action>
Create VillageProtection singleton object:

1. register() function:
   - Register PlayerBlockBreakEvents.BEFORE event handler
   - This runs BEFORE MiningFatigue handler (order matters - rejection prevents fatigue)

2. Handler logic (level, player, pos, state, blockEntity) -> Boolean:
   a. Get ServerLevel from level (should already be server-side for BEFORE event)
   b. Get ChunkPos from pos
   c. Check if village chunk: ChunkValidator.isVillageChunk(level, chunkPos)
      - If NOT village: return true (allow, this handler doesn't apply)
   d. Get the block being broken: state.block
   e. Check if block is an ore using Tags:
      - state.`is`(BlockTags.COAL_ORES) ||
      - state.`is`(BlockTags.IRON_ORES) ||
      - state.`is`(BlockTags.COPPER_ORES) ||
      - state.`is`(BlockTags.GOLD_ORES) ||
      - state.`is`(BlockTags.REDSTONE_ORES) ||
      - state.`is`(BlockTags.LAPIS_ORES) ||
      - state.`is`(BlockTags.DIAMOND_ORES) ||
      - state.`is`(BlockTags.EMERALD_ORES) ||
      - state.`is`(Tags.Blocks.ORES) (NeoForge/Fabric common tag - check if available)
      If ore: return true (allow breaking - BREAK-06)
   f. Check if block is on allowlist: WorldRestrictions.ALLOWED_BLOCKS.contains(state.block)
      If on allowlist: return true (allow breaking - BREAK-07)
   g. Otherwise: return false (block the break - BREAK-05)

3. For ore detection, prefer using the vanilla BlockTags for each ore type since they're reliable.
   Alternative: check if block name contains "ore" as fallback.

Import:
- net.minecraft.tags.BlockTags
- thc.claim.ChunkValidator
- thc.world.WorldRestrictions (from Plan 04-01)
  </action>
  <verify>./gradlew build compiles without errors</verify>
  <done>VillageProtection.kt exists with ore and allowlist exception logic</done>
</task>

<task type="auto">
  <name>Task 2: Register VillageProtection in mod initializer</name>
  <files>src/main/kotlin/thc/THC.kt</files>
  <action>
Update THC.kt:
1. Add import for thc.world.VillageProtection
2. In onInitialize(), add VillageProtection.register() call

Important: VillageProtection should register BEFORE MiningFatigue so that blocked breaks
don't trigger fatigue. Order in onInitialize:
- BellHandler.register()
- BasePermissions.register()
- WorldRestrictions.register()
- VillageProtection.register() (new - before MiningFatigue)
- MiningFatigue.register()

The event system processes handlers in registration order. If VillageProtection returns false
(block the break), MiningFatigue won't even see the event (since break was cancelled).
  </action>
  <verify>./gradlew build compiles without errors; grep -q "VillageProtection.register" src/main/kotlin/thc/THC.kt</verify>
  <done>VillageProtection registered in correct order before MiningFatigue</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./gradlew build` succeeds without errors
- [ ] VillageProtection.kt contains PlayerBlockBreakEvents.BEFORE handler
- [ ] Handler uses ChunkValidator.isVillageChunk for village detection
- [ ] Ore detection uses BlockTags for all ore types
- [ ] Allowlist exception uses WorldRestrictions.ALLOWED_BLOCKS
- [ ] THC.kt calls VillageProtection.register() before MiningFatigue.register()
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No compilation errors
- Village protection ready for in-game testing (BREAK-05, BREAK-06, BREAK-07)
</success_criteria>

<output>
After completion, create `.planning/phases/04-world-restrictions/04-03-SUMMARY.md`
</output>
