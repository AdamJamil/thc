---
phase: 04.2-bugfixes-2
plan: 01
subsystem: world-protection
tags: [mixin, village-detection, bell-protection, bedrock-hardness]

# Dependency graph
requires:
  - phase: 04-world-restrictions
    provides: VillageProtection and bell handler infrastructure
provides:
  - Bedrock-like bell protection via BlockBehaviour mixin
  - Reliable village chunk detection with multi-position sampling
affects: [05-testing, gameplay-verification]

# Tech tracking
tech-stack:
  added: []
  patterns: [BlockBehaviour mixin injection, multi-position structure sampling]

key-files:
  created: [src/main/java/thc/mixin/BellBlockMixin.java]
  modified: [src/main/kotlin/thc/claim/ChunkValidator.kt, src/main/kotlin/thc/THC.kt, src/main/resources/thc.mixins.json]

key-decisions:
  - "Target BlockBehaviour instead of BellBlock for getDestroyProgress injection"
  - "3x3 grid at 7 Y levels (63 total checks) for comprehensive village detection"
  - "Remove event-based BellProtection in favor of mixin approach"

patterns-established:
  - "Block hardness modification: inject at BlockBehaviour.getDestroyProgress, check block type"
  - "Structure detection: combine allStarts check with multi-position piece sampling"

# Metrics
duration: 4min
completed: 2026-01-16
---

# Phase 04.2 Plan 01: Bugfixes-2 Summary

**Bedrock-like bell protection via BlockBehaviour mixin and reliable village detection with 63-point structure sampling**

## Performance

- **Duration:** 4 min
- **Started:** 2026-01-16T18:22:00Z
- **Completed:** 2026-01-16T18:26:00Z
- **Tasks:** 3
- **Files modified:** 4

## Accomplishments
- Bells now have bedrock-like indestructibility (no mining animation, no progress)
- Village chunks detected reliably across all chunks the village spans
- Cleaner architecture - mixin handles protection at block level, not event level

## Task Commits

Each task was committed atomically:

1. **Task 1: Add BellBlockMixin for bedrock-like hardness** - `56b661d` (fix)
2. **Task 2: Remove BellProtection event handler** - `84b7e14` (refactor)
3. **Task 3: Fix village chunk detection** - `a3e01ce` (fix)

**Deviation fix:** `df06b3b` (fix: target BlockBehaviour instead of BellBlock)

## Files Created/Modified
- `src/main/java/thc/mixin/BellBlockMixin.java` - Mixin injecting into BlockBehaviour.getDestroyProgress to return 0 for bells
- `src/main/kotlin/thc/claim/ChunkValidator.kt` - Enhanced isVillageChunk with 3x3 grid sampling at 7 Y levels
- `src/main/kotlin/thc/THC.kt` - Removed BellProtection.register() call
- `src/main/resources/thc.mixins.json` - Added BellBlockMixin to mixins array

## Decisions Made
- **Target BlockBehaviour, not BellBlock:** getDestroyProgress is inherited from BlockBehaviour, not overridden by BellBlock - must inject at parent class and check block type
- **63-point sampling (9 positions x 7 Y levels):** Y levels 55-80 cover typical village heights; 3x3 grid catches structure pieces at edges and center
- **Mixin over event handler:** Prevents mining animation from ever starting rather than canceling mid-flight

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Target BlockBehaviour instead of BellBlock**
- **Found during:** Task 1 (BellBlockMixin creation)
- **Issue:** Plan specified injecting into BellBlock.getDestroyProgress, but BellBlock doesn't override this method - it's inherited from BlockBehaviour. Fabric remapper warning: "Cannot remap getDestroyProgress because it does not exists in any of the targets"
- **Fix:** Changed mixin to target BlockBehaviour.class and added block type check `if (state.is(Blocks.BELL))`
- **Files modified:** src/main/java/thc/mixin/BellBlockMixin.java
- **Verification:** Build succeeds without remapping warning
- **Committed in:** df06b3b (separate commit after Task 2)

---

**Total deviations:** 1 auto-fixed (Rule 3 - blocking)
**Impact on plan:** Fix necessary for correct mixin operation. No scope creep.

## Issues Encountered
None - deviation was discovered via build warning and fixed immediately.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Bell protection and village detection bugs fixed
- Ready for Phase 5 automated testing
- Manual gameplay verification recommended to confirm fixes work as expected

---
*Phase: 04.2-bugfixes-2*
*Completed: 2026-01-16*
