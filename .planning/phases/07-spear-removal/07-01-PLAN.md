---
phase: 07-spear-removal
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/thc/mixin/RecipeManagerMixin.java
  - src/main/kotlin/thc/THC.kt
autonomous: true

must_haves:
  truths:
    - "Player cannot craft any spear (7 tiers)"
    - "Spears do not appear in structure loot chests"
    - "Mobs do not drop spears on death"
  artifacts:
    - path: "src/main/java/thc/mixin/RecipeManagerMixin.java"
      provides: "Spear recipe removal (8 recipes)"
      contains: "spear"
    - path: "src/main/kotlin/thc/THC.kt"
      provides: "Spear drop filtering via LootTableEvents.MODIFY_DROPS"
      contains: "SPEAR"
  key_links:
    - from: "RecipeManagerMixin"
      to: "RecipeMap filtering"
      via: "REMOVED_RECIPES set"
      pattern: "wooden_spear|stone_spear|iron_spear"
    - from: "THC.kt LootTableEvents"
      to: "All loot drop sources"
      via: "MODIFY_DROPS event"
      pattern: "removeIf.*SPEAR"
---

<objective>
Remove all spear acquisition paths: crafting, loot, and mob drops.

Purpose: Spears are overpowered ranged weapons that undermine the risk/reward combat philosophy. Players must use bows, crossbows, or melee - no safe ranged jabbing.

Output: Extended recipe mixin filtering 8 spear recipes, extended drop filtering removing all 7 spear tiers from loot/mob drops.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Research findings for spear item IDs and recipes
@.planning/research/FEATURES.md

# Existing patterns to extend
@src/main/java/thc/mixin/RecipeManagerMixin.java
@src/main/kotlin/thc/THC.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend RecipeManagerMixin to filter spear recipes</name>
  <files>src/main/java/thc/mixin/RecipeManagerMixin.java</files>
  <action>
Extend the existing RecipeManagerMixin to filter all spear crafting recipes.

**Recipes to remove (8 total):**
- `minecraft:wooden_spear`
- `minecraft:stone_spear`
- `minecraft:copper_spear`
- `minecraft:iron_spear`
- `minecraft:golden_spear`
- `minecraft:diamond_spear`
- `minecraft:netherite_spear_smithing` (smithing template recipe)

**Implementation:**
1. Create a static Set of recipe path strings to remove (including existing "shield")
2. Rename `thc$removeShieldRecipe` to `thc$removeDisabledRecipes`
3. Change filter condition to check if recipe path is in the removal set

**Pattern to follow:**
```java
private static final Set<String> REMOVED_RECIPE_PATHS = Set.of(
    "shield",
    "wooden_spear", "stone_spear", "copper_spear",
    "iron_spear", "golden_spear", "diamond_spear",
    "netherite_spear_smithing"
);

// In filter loop:
if (!REMOVED_RECIPE_PATHS.contains(holder.id().location().getPath())) {
    filtered.add(holder);
}
```

**What to avoid:**
- Don't use item tags (may not exist) - hardcode the recipe IDs
- Don't create separate mixin methods per recipe - single filter is cleaner
  </action>
  <verify>
Build passes: `./gradlew build`
Check mixin compiles without warnings
  </verify>
  <done>RecipeManagerMixin filters 8 spear recipes plus shield recipe (9 total)</done>
</task>

<task type="auto">
  <name>Task 2: Extend drop filtering to remove spears from all loot</name>
  <files>src/main/kotlin/thc/THC.kt</files>
  <action>
Extend the existing LootTableEvents.MODIFY_DROPS handler to filter spear drops.

**Items to filter (7 spear tiers):**
- Items.WOODEN_SPEAR
- Items.STONE_SPEAR
- Items.COPPER_SPEAR
- Items.IRON_SPEAR
- Items.GOLDEN_SPEAR
- Items.DIAMOND_SPEAR
- Items.NETHERITE_SPEAR

**Implementation:**
1. Create a Set of spear items for efficient lookup
2. Extend the existing MODIFY_DROPS handler to also filter spears
3. Use the same pattern as shield removal

**Pattern to follow:**
```kotlin
// Add import if needed
import net.minecraft.world.item.Items

// Create set of removed items (near top of object or inline)
private val REMOVED_ITEMS = setOf(
    Items.SHIELD,
    Items.WOODEN_SPEAR,
    Items.STONE_SPEAR,
    Items.COPPER_SPEAR,
    Items.IRON_SPEAR,
    Items.GOLDEN_SPEAR,
    Items.DIAMOND_SPEAR,
    Items.NETHERITE_SPEAR
)

// Update the MODIFY_DROPS handler:
LootTableEvents.MODIFY_DROPS.register(LootTableEvents.ModifyDrops { _, _, drops ->
    drops.removeIf { stack -> REMOVED_ITEMS.any { stack.`is`(it) } }
})
```

**What this handles:**
- Chest loot (ocean ruins, village weaponsmith, buried treasure, bastion, end city)
- Mob equipment drops (zombies, piglins, husks drop their held spears on death)
- Any other loot source that uses the loot table system

**What to avoid:**
- Don't create separate handlers for different loot sources
- Don't use string matching on item IDs - use Items constants
- If Items.WOODEN_SPEAR etc. don't exist in 1.21.11 API, use Registries lookup instead
  </action>
  <verify>
Build passes: `./gradlew build`
Check Kotlin compiles without errors
  </verify>
  <done>LootTableEvents.MODIFY_DROPS filters all 7 spear tiers plus shields</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./gradlew build` succeeds without errors or warnings
- [ ] RecipeManagerMixin contains 8 spear recipe paths in removal set
- [ ] THC.kt MODIFY_DROPS handler filters 7 spear item types
- [ ] No compile errors related to Items.WOODEN_SPEAR etc. (if not found, research alternatives)
</verification>

<success_criteria>
- All tasks completed
- Build passes
- No TypeScript/Kotlin errors
- SPEAR-01: 8 spear recipes filtered from RecipeMap
- SPEAR-02: Spears filtered from all loot drops via MODIFY_DROPS
- SPEAR-03: Mob spear drops filtered (same MODIFY_DROPS handles this)
</success_criteria>

<output>
After completion, create `.planning/phases/07-spear-removal/07-01-SUMMARY.md`
</output>
