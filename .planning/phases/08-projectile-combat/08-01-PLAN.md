---
phase: 08-projectile-combat
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/thc/mixin/ProjectileEntityMixin.java
  - src/main/resources/thc.mixins.json
autonomous: true

must_haves:
  truths:
    - "Player projectile hit applies Speed II to target mob for 6 seconds"
    - "Player projectile hit applies Glowing to target mob for 6 seconds"
    - "Player projectile hit redirects mob aggro to the shooter"
  artifacts:
    - path: "src/main/java/thc/mixin/ProjectileEntityMixin.java"
      provides: "Projectile hit effects injection"
      contains: "onEntityHit"
      exports: ["thc$applyHitEffects"]
  key_links:
    - from: "ProjectileEntityMixin"
      to: "Projectile.onEntityHit"
      via: "@Inject at HEAD"
      pattern: "@Inject.*onEntityHit"
    - from: "ProjectileEntityMixin"
      to: "LivingEntity.addEffect"
      via: "MobEffectInstance creation"
      pattern: "MobEffects\\.SPEED|MobEffects\\.GLOWING"
    - from: "ProjectileEntityMixin"
      to: "Mob.setTarget"
      via: "Aggro redirect"
      pattern: "setTarget.*player"
---

<objective>
Implement projectile hit effects that make combat more dangerous - mobs become faster, glow, and immediately aggro on the shooter.

Purpose: When a player hits a mob with a projectile, the mob becomes a visible threat (glowing) that rushes toward the player (speed + aggro), creating risk for ranged attacks.
Output: ProjectileEntityMixin.java with onEntityHit injection applying effects and redirecting aggro.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-drowning-modification/06-01-SUMMARY.md
@src/main/java/thc/mixin/LivingEntityMixin.java
@src/main/resources/thc.mixins.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProjectileEntityMixin with hit effects</name>
  <files>src/main/java/thc/mixin/ProjectileEntityMixin.java</files>
  <action>
Create a new mixin targeting `net.minecraft.world.entity.projectile.Projectile` (the base class for all projectiles).

Inject at HEAD of `onEntityHit(EntityHitResult)` method to apply effects when a player-shot projectile hits a LivingEntity:

1. Check if projectile owner is ServerPlayer using `getOwner()` method
2. Check if hit entity (from EntityHitResult.getEntity()) is a LivingEntity
3. If both conditions met:
   - Apply Speed II (amplifier 1) for 120 ticks (6 seconds) to the hit entity
   - Apply Glowing for 120 ticks (6 seconds) to the hit entity
4. If hit entity is a Mob (subclass of LivingEntity):
   - Call `mob.setTarget(player)` to redirect aggro to the shooter

Use existing patterns from LivingEntityMixin:
- `@Inject(method = "onEntityHit", at = @At("HEAD"))`
- `MobEffectInstance(MobEffects.MOVEMENT_SPEED, 120, 1)` for Speed II
- `MobEffectInstance(MobEffects.GLOWING, 120, 0)` for Glowing

The method signature in Minecraft 1.21.11 is:
`protected void onEntityHit(EntityHitResult entityHitResult)`

Cast self to access getOwner():
`Projectile self = (Projectile)(Object)this;`

Note: Use Mojang mappings class names (net.minecraft.world.entity.projectile.Projectile), not Yarn mappings.
  </action>
  <verify>./gradlew build succeeds without errors or warnings about missing mixin targets</verify>
  <done>ProjectileEntityMixin.java exists with onEntityHit injection applying Speed II, Glowing, and aggro redirect</done>
</task>

<task type="auto">
  <name>Task 2: Register mixin and verify</name>
  <files>src/main/resources/thc.mixins.json</files>
  <action>
Add "ProjectileEntityMixin" to the mixins array in thc.mixins.json.

After adding, run the build to verify:
1. No mixin target resolution warnings
2. Build completes successfully
  </action>
  <verify>./gradlew build passes cleanly; grep thc.mixins.json confirms ProjectileEntityMixin present</verify>
  <done>Mixin registered and build passes without warnings</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./gradlew build` succeeds without errors
- [ ] No mixin warnings about missing targets
- [ ] ProjectileEntityMixin.java contains @Inject on onEntityHit
- [ ] Speed II (MobEffects.MOVEMENT_SPEED, amplifier 1) applied for 120 ticks
- [ ] Glowing (MobEffects.GLOWING) applied for 120 ticks
- [ ] Mob.setTarget(player) called for aggro redirect
- [ ] Owner check uses getOwner() instanceof ServerPlayer
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Requirements PROJ-01, PROJ-02, PROJ-03 implemented
</success_criteria>

<output>
After completion, create `.planning/phases/08-projectile-combat/08-01-SUMMARY.md`
</output>
