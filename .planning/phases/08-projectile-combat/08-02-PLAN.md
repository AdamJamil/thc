---
phase: 08-projectile-combat
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/main/java/thc/mixin/ProjectileEntityMixin.java
autonomous: true

must_haves:
  truths:
    - "Player projectiles travel 20% faster initially (velocity boost on launch)"
    - "Player projectiles experience increased gravity after traveling 8 blocks"
  artifacts:
    - path: "src/main/java/thc/mixin/ProjectileEntityMixin.java"
      provides: "Projectile physics modifications"
      contains: "tick"
      exports: ["thc$applyVelocityBoost", "thc$applyEnhancedGravity"]
  key_links:
    - from: "ProjectileEntityMixin"
      to: "Projectile.shoot"
      via: "@Inject at TAIL for velocity boost"
      pattern: "@Inject.*shoot"
    - from: "ProjectileEntityMixin"
      to: "Projectile.tick"
      via: "@Inject for gravity modification"
      pattern: "@Inject.*tick"
    - from: "ProjectileEntityMixin"
      to: "spawn position tracking"
      via: "@Unique fields"
      pattern: "thc\\$spawn"
---

<objective>
Implement enhanced projectile physics - faster initial velocity and increased drop at range.

Purpose: Player projectiles fly faster initially (20% boost) creating more effective ranged attacks, but drop faster after 8 blocks (quadratic gravity) requiring skill at longer ranges.
Output: Extended ProjectileEntityMixin.java with velocity boost on shoot and enhanced gravity in tick.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-projectile-combat/08-01-SUMMARY.md
@src/main/java/thc/mixin/ProjectileEntityMixin.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add velocity boost on projectile shoot</name>
  <files>src/main/java/thc/mixin/ProjectileEntityMixin.java</files>
  <action>
Add velocity boost injection to the existing ProjectileEntityMixin.

Target the `shoot(double x, double y, double z, float speed, float divergence)` method in Projectile class. This method is called when a projectile is launched and sets initial velocity.

Implementation approach - inject at TAIL of shoot method:

```java
@Inject(method = "shoot", at = @At("TAIL"))
private void thc$applyVelocityBoost(double x, double y, double z, float speed, float divergence, CallbackInfo ci) {
    Projectile self = (Projectile)(Object)this;

    // Only boost player-shot projectiles
    if (!(self.getOwner() instanceof ServerPlayer)) {
        return;
    }

    // Apply 20% velocity boost
    Vec3 velocity = self.getDeltaMovement();
    self.setDeltaMovement(velocity.scale(1.2));
}
```

Note: In Mojang mappings, velocity is accessed via `getDeltaMovement()` and `setDeltaMovement()`.

Also add @Unique fields for tracking spawn position (needed for Task 2):
```java
@Unique private double thc$spawnX = Double.NaN;
@Unique private double thc$spawnY = Double.NaN;
@Unique private double thc$spawnZ = Double.NaN;
@Unique private boolean thc$spawnRecorded = false;
```

Initialize spawn position in the same injection:
```java
if (!thc$spawnRecorded) {
    thc$spawnX = self.getX();
    thc$spawnY = self.getY();
    thc$spawnZ = self.getZ();
    thc$spawnRecorded = true;
}
```
  </action>
  <verify>./gradlew build succeeds; grep ProjectileEntityMixin.java confirms shoot injection exists</verify>
  <done>Velocity boost injection added, spawn position tracking fields initialized on shoot</done>
</task>

<task type="auto">
  <name>Task 2: Add enhanced gravity after 8 blocks</name>
  <files>src/main/java/thc/mixin/ProjectileEntityMixin.java</files>
  <action>
Add tick injection to apply enhanced gravity after the projectile has traveled 8 blocks.

Inject at HEAD of `tick()` method to check distance and apply extra gravity:

```java
@Inject(method = "tick", at = @At("HEAD"))
private void thc$applyEnhancedGravity(CallbackInfo ci) {
    Projectile self = (Projectile)(Object)this;

    // Only affect player-shot projectiles
    if (!(self.getOwner() instanceof ServerPlayer)) {
        return;
    }

    // Skip if spawn not recorded yet
    if (!thc$spawnRecorded || Double.isNaN(thc$spawnX)) {
        return;
    }

    // Calculate distance from spawn
    double dx = self.getX() - thc$spawnX;
    double dy = self.getY() - thc$spawnY;
    double dz = self.getZ() - thc$spawnZ;
    double distance = Math.sqrt(dx*dx + dy*dy + dz*dz);

    // After 8 blocks, apply additional downward velocity
    if (distance >= 8.0) {
        // Quadratic factor: the further past 8 blocks, the stronger the gravity
        // Base gravity is ~0.05/tick for arrows. We add extra.
        double extraBlocks = distance - 8.0;
        // Quadratic scaling: 0.01 * (extraBlocks/8)^2 - gentle curve
        double gravityMultiplier = 0.01 * Math.pow(extraBlocks / 8.0, 2);
        // Cap at reasonable maximum (0.1 extra gravity)
        gravityMultiplier = Math.min(gravityMultiplier, 0.1);

        Vec3 velocity = self.getDeltaMovement();
        self.setDeltaMovement(velocity.x, velocity.y - gravityMultiplier, velocity.z);
    }
}
```

This implements "quadratic gravity" where:
- 0-8 blocks: Normal gravity
- 8-16 blocks: +0.01 extra downward velocity per tick
- 16-24 blocks: +0.04 extra (quadratic increase)
- Beyond: Capped at +0.1 extra per tick

The quadratic formula makes projectiles increasingly arc downward at range while keeping close-range behavior unchanged.
  </action>
  <verify>./gradlew build succeeds; grep ProjectileEntityMixin.java confirms tick injection and distance calculation</verify>
  <done>Enhanced gravity injection added with quadratic scaling after 8 blocks</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./gradlew build` succeeds without errors
- [ ] No mixin warnings about missing targets
- [ ] shoot method injection applies 1.2x velocity multiplier
- [ ] Owner check prevents non-player projectiles from being affected
- [ ] Spawn position tracked via @Unique fields
- [ ] tick method injection calculates distance from spawn
- [ ] Extra gravity applied only after 8 blocks distance
- [ ] Quadratic scaling formula implemented correctly
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Requirements PROJ-04 (20% velocity boost) and PROJ-05 (quadratic gravity) implemented
</success_criteria>

<output>
After completion, create `.planning/phases/08-projectile-combat/08-02-SUMMARY.md`
</output>
