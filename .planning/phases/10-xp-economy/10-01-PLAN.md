---
phase: 10-xp-economy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/thc/mixin/BlockXpMixin.java
  - src/main/java/thc/mixin/AnimalBreedingXpMixin.java
  - src/main/java/thc/mixin/FishingXpMixin.java
  - src/main/java/thc/mixin/VillagerTradeXpMixin.java
  - src/main/java/thc/mixin/FurnaceXpMixin.java
  - src/main/java/thc/mixin/ExperienceBottleXpMixin.java
  - src/main/resources/thc.mixins.json
autonomous: true

must_haves:
  truths:
    - "Killing mobs spawns XP orbs as normal"
    - "Mining XP-dropping ores (coal, lapis, redstone, emerald, diamond, nether quartz) spawns no XP"
    - "Breeding animals spawns no XP"
    - "Fishing spawns no XP"
    - "Trading with villagers spawns no XP"
    - "Taking items from furnace output spawns no XP"
    - "Throwing bottles o' enchanting spawns no XP"
  artifacts:
    - path: "src/main/java/thc/mixin/BlockXpMixin.java"
      provides: "Blocks ore mining XP"
      min_lines: 15
    - path: "src/main/java/thc/mixin/AnimalBreedingXpMixin.java"
      provides: "Blocks animal breeding XP"
      min_lines: 15
    - path: "src/main/java/thc/mixin/FishingXpMixin.java"
      provides: "Blocks fishing XP"
      min_lines: 15
    - path: "src/main/java/thc/mixin/VillagerTradeXpMixin.java"
      provides: "Blocks villager trading XP"
      min_lines: 15
    - path: "src/main/java/thc/mixin/FurnaceXpMixin.java"
      provides: "Blocks furnace smelting XP"
      min_lines: 15
    - path: "src/main/java/thc/mixin/ExperienceBottleXpMixin.java"
      provides: "Blocks experience bottle XP"
      min_lines: 15
  key_links:
    - from: "thc.mixins.json"
      to: "All XP mixin classes"
      via: "mixins array registration"
      pattern: "BlockXpMixin|AnimalBreedingXpMixin|FishingXpMixin|VillagerTradeXpMixin|FurnaceXpMixin|ExperienceBottleXpMixin"
---

<objective>
Block XP orbs from all non-combat sources while preserving XP from mob deaths.

Purpose: XP should only come from combat (killing mobs), reinforcing risk-for-reward philosophy. No passive XP grinding via mining, breeding, fishing, trading, smelting, or bottles.

Output: Six mixin classes that intercept and cancel XP spawning from non-combat sources.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Existing mixin patterns:
@src/main/java/thc/mixin/LivingEntityDrowningMixin.java — Shows HEAD injection with cancellable pattern
@src/main/java/thc/mixin/RecipeManagerMixin.java — Shows RETURN injection with filtering
@src/main/resources/thc.mixins.json — Mixin registry to update
</context>

<tasks>

<task type="auto">
  <name>Task 1: Block ore mining XP</name>
  <files>src/main/java/thc/mixin/BlockXpMixin.java</files>
  <action>
Create mixin targeting `net.minecraft.world.level.block.Block` class.

Inject at HEAD of `popExperience(ServerLevel, BlockPos, int)` method with cancellable=true.
Cancel all calls to prevent XP orb spawning from block breaking (ores).

This method is called by OreBlock subclasses when broken. Canceling it blocks XP from:
- Coal ore, deepslate coal ore
- Lapis lazuli ore, deepslate lapis ore
- Redstone ore, deepslate redstone ore
- Emerald ore, deepslate emerald ore
- Diamond ore, deepslate diamond ore
- Nether quartz ore

Use `@Mixin(Block.class)` and follow thc$ naming convention for the inject method.
  </action>
  <verify>Build compiles: ./gradlew build</verify>
  <done>BlockXpMixin.java exists and targets Block.popExperience method</done>
</task>

<task type="auto">
  <name>Task 2: Block animal breeding XP</name>
  <files>src/main/java/thc/mixin/AnimalBreedingXpMixin.java</files>
  <action>
Create mixin targeting `net.minecraft.world.entity.animal.Animal` class.

The breeding XP is spawned via ExperienceOrb.award() called from within the breed/spawnChildFromBreeding methods.

Inject at HEAD of `spawnChildFromBreeding(ServerLevel, Animal)` method. Within the inject:
- Use @Redirect or @ModifyArg to intercept the ExperienceOrb.award() call and change amount to 0
- OR use @Inject at INVOKE targeting ExperienceOrb.award and cancel/modify

Alternative approach if method signature differs: Target the finalizeSpawnChildFromBreeding method or use @Redirect on ExperienceOrb.award calls within Animal class methods.

Follow existing mixin patterns. Use `@Mixin(Animal.class)`.
  </action>
  <verify>Build compiles: ./gradlew build</verify>
  <done>AnimalBreedingXpMixin.java exists and blocks breeding XP</done>
</task>

<task type="auto">
  <name>Task 3: Block fishing XP</name>
  <files>src/main/java/thc/mixin/FishingXpMixin.java</files>
  <action>
Create mixin targeting `net.minecraft.world.entity.projectile.FishingHook` class.

Fishing XP is awarded when player reels in a catch. The retrieve() method handles this and calls ExperienceOrb.award().

Inject using @Redirect or @ModifyArg to intercept the ExperienceOrb.award() call within retrieve() and set amount to 0.

Alternative: If the XP spawn is in a different method, target that instead. Check for methods like `catchingFish` or similar.

Use `@Mixin(FishingHook.class)` and thc$ naming convention.
  </action>
  <verify>Build compiles: ./gradlew build</verify>
  <done>FishingXpMixin.java exists and blocks fishing XP</done>
</task>

<task type="auto">
  <name>Task 4: Block villager trading XP</name>
  <files>src/main/java/thc/mixin/VillagerTradeXpMixin.java</files>
  <action>
Create mixin targeting `net.minecraft.world.entity.npc.Villager` class (or AbstractVillager if the method is there).

Trading XP is spawned when a trade is completed. Look for method like `rewardTradeXp` or within `updateSpecialPrices`/trade completion handlers.

Inject to intercept ExperienceOrb.award() calls and set amount to 0, or cancel the XP-spawning method entirely.

Note: The existing AbstractVillagerMixin targets getOffers() for trade filtering. This new mixin targets XP specifically.

Use `@Mixin(Villager.class)` or `@Mixin(AbstractVillager.class)` depending on where the XP method lives.
  </action>
  <verify>Build compiles: ./gradlew build</verify>
  <done>VillagerTradeXpMixin.java exists and blocks trading XP</done>
</task>

<task type="auto">
  <name>Task 5: Block furnace smelting XP</name>
  <files>src/main/java/thc/mixin/FurnaceXpMixin.java</files>
  <action>
Create mixin targeting `net.minecraft.world.level.block.entity.AbstractFurnaceBlockEntity` class.

Furnace XP is spawned when player manually removes items from the output slot. The method `awardUsedRecipesAndPopExperience` handles this.

Inject at HEAD of `awardUsedRecipesAndPopExperience(ServerPlayer, ItemStack, ServerLevel)` with cancellable=true to prevent XP spawn.

Alternative if method signature differs: Target `createExperience` or any method that calls ExperienceOrb.award().

Use `@Mixin(AbstractFurnaceBlockEntity.class)` and thc$ naming convention.
  </action>
  <verify>Build compiles: ./gradlew build</verify>
  <done>FurnaceXpMixin.java exists and blocks smelting XP</done>
</task>

<task type="auto">
  <name>Task 6: Block experience bottle XP</name>
  <files>src/main/java/thc/mixin/ExperienceBottleXpMixin.java</files>
  <action>
Create mixin targeting `net.minecraft.world.entity.projectile.ThrownExperienceBottle` class.

Experience bottles spawn XP on collision via the onHit() method which calls ExperienceOrb.award().

Inject at HEAD of `onHit(HitResult)` with cancellable=true. Cancel to prevent bottle from breaking and spawning XP.

Alternative: If we want the bottle to break but not give XP, use @Redirect on the ExperienceOrb.award() call instead.

Recommendation: Cancel entirely - if bottles can't give XP, they serve no purpose and should just not work.

Use `@Mixin(ThrownExperienceBottle.class)` and thc$ naming convention.
  </action>
  <verify>Build compiles: ./gradlew build</verify>
  <done>ExperienceBottleXpMixin.java exists and blocks bottle XP</done>
</task>

<task type="auto">
  <name>Task 7: Register all XP mixins</name>
  <files>src/main/resources/thc.mixins.json</files>
  <action>
Add all six new mixin classes to the mixins array in thc.mixins.json:
- BlockXpMixin
- AnimalBreedingXpMixin
- FishingXpMixin
- VillagerTradeXpMixin
- FurnaceXpMixin
- ExperienceBottleXpMixin

Maintain alphabetical ordering within the array for consistency with existing entries.
  </action>
  <verify>JSON is valid and all mixins listed: cat src/main/resources/thc.mixins.json | grep -E "XpMixin"</verify>
  <done>thc.mixins.json contains all six new XP mixin entries</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ./gradlew build succeeds without errors
- [ ] All six mixin files exist in src/main/java/thc/mixin/
- [ ] thc.mixins.json contains all six new mixin registrations
- [ ] No TypeScript/compilation errors
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Build compiles successfully
- Six new mixin classes created following established patterns
- Mixin registry updated with all new entries
</success_criteria>

<output>
After completion, create `.planning/phases/10-xp-economy/10-01-SUMMARY.md`
</output>
