---
phase: 10-xp-economy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/thc/mixin/BlockXpMixin.java
  - src/main/java/thc/mixin/AnimalBreedingXpMixin.java
  - src/main/java/thc/mixin/FishingXpMixin.java
  - src/main/java/thc/mixin/VillagerTradeXpMixin.java
  - src/main/java/thc/mixin/FurnaceXpMixin.java
  - src/main/resources/thc.mixins.json
autonomous: true

must_haves:
  truths:
    - "Killing mobs spawns XP orbs as normal"
    - "Mining XP-dropping ores (coal, lapis, redstone, emerald, diamond, nether quartz) spawns no XP orbs"
    - "Breeding animals spawns no XP orbs"
    - "Fishing spawns no XP orbs"
    - "Trading with villagers spawns no XP orbs"
    - "Taking items from furnace output spawns no XP orbs"
    - "Throwing bottles o' enchanting works normally (spawns XP orbs)"
  artifacts:
    - path: "src/main/java/thc/mixin/BlockXpMixin.java"
      provides: "Blocks ore mining XP via HEAD cancellation"
      min_lines: 15
    - path: "src/main/java/thc/mixin/AnimalBreedingXpMixin.java"
      provides: "Blocks animal breeding XP via HEAD cancellation"
      min_lines: 15
    - path: "src/main/java/thc/mixin/FishingXpMixin.java"
      provides: "Blocks fishing XP via HEAD cancellation"
      min_lines: 15
    - path: "src/main/java/thc/mixin/VillagerTradeXpMixin.java"
      provides: "Blocks villager trading XP via HEAD cancellation"
      min_lines: 15
    - path: "src/main/java/thc/mixin/FurnaceXpMixin.java"
      provides: "Blocks furnace smelting XP via HEAD cancellation"
      min_lines: 15
  key_links:
    - from: "thc.mixins.json"
      to: "All XP mixin classes"
      via: "mixins array registration"
      pattern: "BlockXpMixin|AnimalBreedingXpMixin|FishingXpMixin|VillagerTradeXpMixin|FurnaceXpMixin"
---

<objective>
Block XP orbs from all non-combat sources while preserving XP from mob deaths AND experience bottles.

Purpose: XP should only come from combat (killing mobs) or rare/expensive items (bottles), reinforcing risk-for-reward philosophy. No passive XP grinding via mining, breeding, fishing, trading, or smelting.

Output: Five mixin classes that intercept and completely cancel XP spawning from passive sources.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-xp-economy/10-CONTEXT.md

Existing mixin patterns:
@src/main/java/thc/mixin/LivingEntityDrowningMixin.java — Shows HEAD injection with cancellable pattern
@src/main/java/thc/mixin/RecipeManagerMixin.java — Shows RETURN injection with filtering
@src/main/resources/thc.mixins.json — Mixin registry to update

Key design decision from CONTEXT.md:
- Use COMPLETE CANCELLATION (HEAD inject + cancel) for all blocked sources
- NO zero-value ghost orbs - nothing spawns at all
- Experience bottles STAY FUNCTIONAL - do NOT block them
</context>

<tasks>

<task type="auto">
  <name>Task 1: Block ore mining XP</name>
  <files>src/main/java/thc/mixin/BlockXpMixin.java</files>
  <action>
Create mixin targeting `net.minecraft.world.level.block.Block` class.

Inject at HEAD of `popExperience(ServerLevel, BlockPos, int)` method with cancellable=true.
Cancel ALL calls via `ci.cancel()` to completely prevent XP orb spawning from block breaking.

This method is called by OreBlock subclasses when broken. Canceling it blocks XP from:
- Coal ore, deepslate coal ore
- Lapis lazuli ore, deepslate lapis ore
- Redstone ore, deepslate redstone ore
- Emerald ore, deepslate emerald ore
- Diamond ore, deepslate diamond ore
- Nether quartz ore

Use `@Mixin(Block.class)` and follow thc$ naming convention for the inject method.
  </action>
  <verify>Build compiles: ./gradlew build</verify>
  <done>BlockXpMixin.java exists and cancels Block.popExperience at HEAD</done>
</task>

<task type="auto">
  <name>Task 2: Block animal breeding XP</name>
  <files>src/main/java/thc/mixin/AnimalBreedingXpMixin.java</files>
  <action>
Create mixin targeting `net.minecraft.world.entity.animal.Animal` class.

The breeding XP is spawned via ExperienceOrb.award() called from within the finalizeSpawnChildFromBreeding method.

Use @Inject at HEAD of `finalizeSpawnChildFromBreeding(ServerLevel, Animal, AgeableMob)` with cancellable=true.
Then immediately call the original method logic EXCEPT the ExperienceOrb.award() call, then cancel.

Alternative simpler approach: Use @Redirect on the ExperienceOrb.award() call within finalizeSpawnChildFromBreeding to make it a no-op (call nothing, do nothing).

IMPORTANT: Use complete cancellation approach - no XP orbs should spawn at all, not zero-value orbs.

Use `@Mixin(Animal.class)` and thc$ naming convention.
  </action>
  <verify>Build compiles: ./gradlew build</verify>
  <done>AnimalBreedingXpMixin.java exists and blocks breeding XP completely</done>
</task>

<task type="auto">
  <name>Task 3: Block fishing XP</name>
  <files>src/main/java/thc/mixin/FishingXpMixin.java</files>
  <action>
Create mixin targeting `net.minecraft.world.entity.projectile.FishingHook` class.

Fishing XP is awarded when player reels in a catch. The retrieve() method handles this and calls ExperienceOrb.award().

Use @Redirect to intercept the ExperienceOrb.award() call within retrieve() and make it a no-op.
The redirect method should simply do nothing (empty body or return immediately).

This ensures no XP orbs spawn at all when fishing - complete cancellation, not zero-value orbs.

Use `@Mixin(FishingHook.class)` and thc$ naming convention.
  </action>
  <verify>Build compiles: ./gradlew build</verify>
  <done>FishingXpMixin.java exists and blocks fishing XP completely</done>
</task>

<task type="auto">
  <name>Task 4: Block villager trading XP</name>
  <files>src/main/java/thc/mixin/VillagerTradeXpMixin.java</files>
  <action>
Create mixin targeting `net.minecraft.world.entity.npc.Villager` class.

Trading XP is spawned when a trade is completed. The method `rewardTradeXp` handles XP award.

Use @Inject at HEAD of `rewardTradeXp(MerchantOffer)` with cancellable=true.
Cancel immediately via `ci.cancel()` to completely prevent XP spawning.

If method signature differs in this Minecraft version, check for alternative methods that call ExperienceOrb.award().

Note: The existing AbstractVillagerMixin targets getOffers() for trade filtering. This new mixin targets XP specifically.

Use `@Mixin(Villager.class)` and thc$ naming convention.
  </action>
  <verify>Build compiles: ./gradlew build</verify>
  <done>VillagerTradeXpMixin.java exists and blocks trading XP completely</done>
</task>

<task type="auto">
  <name>Task 5: Block furnace smelting XP</name>
  <files>src/main/java/thc/mixin/FurnaceXpMixin.java</files>
  <action>
Create mixin targeting `net.minecraft.world.level.block.entity.AbstractFurnaceBlockEntity` class.

Furnace XP is spawned when player manually removes items from the output slot. The method that spawns XP needs to be intercepted.

Look for methods like:
- `awardUsedRecipesAndPopExperience`
- `createExperience`
- Any method calling ExperienceOrb.award()

Use @Inject at HEAD with cancellable=true on the XP-spawning method.
Cancel immediately via `ci.cancel()` to completely prevent XP spawning.

IMPORTANT: The method should still unlock recipes if that's part of the same method - only block the XP portion if possible. If they're inseparable, blocking both is acceptable.

Use `@Mixin(AbstractFurnaceBlockEntity.class)` and thc$ naming convention.
  </action>
  <verify>Build compiles: ./gradlew build</verify>
  <done>FurnaceXpMixin.java exists and blocks smelting XP completely</done>
</task>

<task type="auto">
  <name>Task 6: Register all XP mixins</name>
  <files>src/main/resources/thc.mixins.json</files>
  <action>
Add all five new mixin classes to the mixins array in thc.mixins.json:
- BlockXpMixin
- AnimalBreedingXpMixin
- FishingXpMixin
- VillagerTradeXpMixin
- FurnaceXpMixin

NOTE: Do NOT add ExperienceBottleXpMixin - experience bottles should remain functional.

Maintain alphabetical ordering within the array for consistency with existing entries.
  </action>
  <verify>JSON is valid and all five mixins listed: cat src/main/resources/thc.mixins.json | grep -E "XpMixin"</verify>
  <done>thc.mixins.json contains all five new XP mixin entries (no bottle mixin)</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ./gradlew build succeeds without errors
- [ ] All five mixin files exist in src/main/java/thc/mixin/
- [ ] thc.mixins.json contains all five new mixin registrations
- [ ] No ExperienceBottleXpMixin exists (bottles should work)
- [ ] No compilation errors
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Build compiles successfully
- Five new mixin classes created using complete cancellation pattern
- Experience bottles NOT blocked (verify by NOT creating bottle mixin)
- Mixin registry updated with all new entries
</success_criteria>

<output>
After completion, create `.planning/phases/10-xp-economy/10-01-SUMMARY.md`
</output>
