---
phase: 11-tiered-arrows
plan: 03
type: execute
wave: 3
depends_on: ["11-02"]
files_modified:
  - src/main/java/thc/mixin/AnvilMenuMixin.java
  - src/main/resources/thc.mixins.json
autonomous: true

must_haves:
  truths:
    - "64 Flint Arrows + 1 Iron Ingot in anvil produces 64 Iron Arrows"
    - "64 Flint Arrows + 1 Diamond in anvil produces 64 Diamond Arrows"
    - "64 Flint Arrows + 1 Netherite Ingot in anvil produces 64 Netherite Arrows"
    - "Anvil recipe consumes XP levels (standard anvil cost)"
  artifacts:
    - path: "src/main/java/thc/mixin/AnvilMenuMixin.java"
      provides: "Anvil recipe interception for arrow crafting"
      min_lines: 40
      contains: "AnvilMenu"
  key_links:
    - from: "AnvilMenuMixin"
      to: "THCArrows.IRON_ARROW"
      via: "ItemStack creation with registered items"
      pattern: "THCArrows"
---

<objective>
Implement anvil recipes for tiered arrow crafting.

Purpose: Allow players to upgrade 64 flint arrows to tiered arrows using anvil + material.
Output: Anvil mixin that handles arrow tier upgrade recipes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/main/java/thc/mixin/ProjectileEntityMixin.java
@src/main/java/thc/mixin/RecipeManagerMixin.java
@src/main/resources/thc.mixins.json
@src/main/kotlin/thc/item/THCArrows.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AnvilMenuMixin for arrow crafting</name>
  <files>src/main/java/thc/mixin/AnvilMenuMixin.java</files>
  <action>
    Create AnvilMenuMixin to intercept anvil crafting:

    ```java
    package thc.mixin;

    import net.minecraft.world.entity.player.Player;
    import net.minecraft.world.inventory.AnvilMenu;
    import net.minecraft.world.inventory.ContainerLevelAccess;
    import net.minecraft.world.inventory.DataSlot;
    import net.minecraft.world.inventory.ItemCombinerMenu;
    import net.minecraft.world.inventory.MenuType;
    import net.minecraft.world.item.ItemStack;
    import net.minecraft.world.item.Items;
    import org.spongepowered.asm.mixin.Final;
    import org.spongepowered.asm.mixin.Mixin;
    import org.spongepowered.asm.mixin.Shadow;
    import org.spongepowered.asm.mixin.injection.At;
    import org.spongepowered.asm.mixin.injection.Inject;
    import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;
    import thc.item.THCArrows;

    @Mixin(AnvilMenu.class)
    public abstract class AnvilMenuMixin extends ItemCombinerMenu {

        @Shadow @Final private DataSlot cost;

        public AnvilMenuMixin(MenuType<?> type, int containerId, Player player, ContainerLevelAccess access) {
            super(type, containerId, player, access);
        }

        @Inject(method = "createResult", at = @At("HEAD"), cancellable = true)
        private void thc$handleArrowCrafting(CallbackInfo ci) {
            ItemStack left = this.inputSlots.getItem(0);
            ItemStack right = this.inputSlots.getItem(1);

            // Check for arrow upgrade recipe: 64 arrows in left slot
            if (!left.is(Items.ARROW) || left.getCount() < 64) {
                return;
            }

            ItemStack result = null;
            int levelCost = 1;

            // Iron Ingot -> Iron Arrows
            if (right.is(Items.IRON_INGOT) && right.getCount() >= 1) {
                result = new ItemStack(THCArrows.IRON_ARROW, 64);
                levelCost = 1;
            }
            // Diamond -> Diamond Arrows
            else if (right.is(Items.DIAMOND) && right.getCount() >= 1) {
                result = new ItemStack(THCArrows.DIAMOND_ARROW, 64);
                levelCost = 2;
            }
            // Netherite Ingot -> Netherite Arrows
            else if (right.is(Items.NETHERITE_INGOT) && right.getCount() >= 1) {
                result = new ItemStack(THCArrows.NETHERITE_ARROW, 64);
                levelCost = 3;
            }

            if (result != null) {
                this.resultSlots.setItem(0, result);
                this.cost.set(levelCost);
                ci.cancel();
            }
        }
    }
    ```

    Key design decisions:
    - Uses HEAD injection on createResult to intercept before vanilla logic
    - Cancels vanilla result computation when arrow recipe matches
    - Requires exactly 64 arrows (full stack) for upgrade
    - Level costs scale: 1 for iron, 2 for diamond, 3 for netherite
    - Consumes 1 material item per craft
    - Uses vanilla anvil slot consumption mechanics (no need to override onTake)
  </action>
  <verify>./gradlew build succeeds</verify>
  <done>AnvilMenuMixin intercepts anvil for arrow recipes</done>
</task>

<task type="auto">
  <name>Task 2: Register AnvilMenuMixin</name>
  <files>src/main/resources/thc.mixins.json</files>
  <action>
    Add AnvilMenuMixin to the mixins array in thc.mixins.json:
    - Add "AnvilMenuMixin" to the "mixins" array
    - This registers the server-side mixin for anvil interception
  </action>
  <verify>./gradlew build succeeds with no mixin errors</verify>
  <done>AnvilMenuMixin registered in mixin configuration</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ./gradlew build succeeds
- [ ] AnvilMenuMixin exists with createResult injection
- [ ] Mixin registered in thc.mixins.json
- [ ] Mixin imports THCArrows and uses registered arrow items
</verification>

<success_criteria>

- All tasks completed
- Build passes
- Anvil intercepts 64 arrows + material to produce tiered arrows
- Level costs appropriate for each tier (1/2/3)
</success_criteria>

<output>
After completion, create `.planning/phases/11-tiered-arrows/11-03-SUMMARY.md`
</output>
