---
phase: 12-combat-rebalancing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/main/java/thc/mixin/ProjectileEntityMixin.java]
autonomous: true

must_haves:
  truths:
    - "Arrow hits apply Speed 4 (not Speed 2) to target mobs"
    - "Arrow hits do not knock back enemy mobs"
  artifacts:
    - path: "src/main/java/thc/mixin/ProjectileEntityMixin.java"
      provides: "Arrow hit effect and knockback modifications"
      contains: "MobEffects.SPEED"
  key_links: []
---

<objective>
Modify arrow combat to apply Speed 4 instead of Speed 2 and remove knockback from arrow hits on enemy mobs.

Purpose: Push players toward ranged combat by making arrow-hit mobs faster and more threatening, while removing the safety of knockback distancing.
Output: Modified ProjectileEntityMixin with updated hit effects and knockback prevention.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 8 established the ProjectileEntityMixin patterns:
@.planning/phases/08-projectile-combat/08-01-SUMMARY.md

# Current implementation:
@src/main/java/thc/mixin/ProjectileEntityMixin.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Increase Speed effect amplifier from 1 to 3</name>
  <files>src/main/java/thc/mixin/ProjectileEntityMixin.java</files>
  <action>
In the `thc$applyHitEffects` method, change the Speed effect amplifier from 1 (Speed II) to 3 (Speed IV).

Find this line:
```java
target.addEffect(new MobEffectInstance(MobEffects.SPEED, THC_EFFECT_DURATION_TICKS, 1), player);
```

Change to:
```java
target.addEffect(new MobEffectInstance(MobEffects.SPEED, THC_EFFECT_DURATION_TICKS, 3), player);
```

Note: Minecraft effect amplifiers are 0-indexed, so amplifier 3 = Speed IV (Speed level 4).
  </action>
  <verify>Build succeeds: `./gradlew build`</verify>
  <done>Speed effect uses amplifier 3 instead of 1</done>
</task>

<task type="auto">
  <name>Task 2: Remove knockback from arrow hits on enemy mobs</name>
  <files>src/main/java/thc/mixin/ProjectileEntityMixin.java</files>
  <action>
Add knockback prevention for arrow hits in the `thc$applyHitEffects` method. After applying effects, check if the target is an enemy mob and set its knockback resistance.

Add after the effect application and aggro redirect block, still inside the method:

```java
// Remove knockback from arrow hits on enemy mobs
if (target instanceof Mob mob) {
    // Store current delta movement and restore after hit processing
    // We need to cancel the knockback that will be applied by the arrow damage
    // Use @Inject at TAIL of onHitEntity to reset velocity after vanilla processes the hit
}
```

Actually, the knockback is applied during hurt() processing, not in onHitEntity directly. The cleaner approach is to add a TAIL injection that resets the mob's delta movement after the hit is processed.

Create a new injection method `thc$removeArrowKnockback`:

```java
@Inject(method = "onHitEntity", at = @At("TAIL"))
private void thc$removeArrowKnockback(EntityHitResult entityHitResult, CallbackInfo ci) {
    Projectile self = (Projectile) (Object) this;
    Entity owner = self.getOwner();

    if (!(owner instanceof ServerPlayer)) {
        return;
    }

    Entity hitEntity = entityHitResult.getEntity();
    if (!(hitEntity instanceof Mob mob)) {
        return;
    }

    // Only remove knockback from enemy mobs (monsters)
    if (mob.getType().getCategory() != MobCategory.MONSTER) {
        return;
    }

    // Reset velocity to cancel knockback (preserve Y for gravity)
    Vec3 velocity = mob.getDeltaMovement();
    mob.setDeltaMovement(0, velocity.y, 0);
    mob.hurtMarked = true;
}
```

Add the MobCategory import if not present:
```java
import net.minecraft.world.entity.MobCategory;
```

This approach:
1. Runs AFTER vanilla hit processing applies knockback
2. Only affects mobs hit by player projectiles
3. Only affects MONSTER category (hostile mobs)
4. Preserves vertical velocity for gravity/jumping
5. Uses hurtMarked to sync the velocity change to clients
  </action>
  <verify>Build succeeds: `./gradlew build`</verify>
  <done>Arrow hits on monster-category mobs no longer apply horizontal knockback</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./gradlew build` succeeds without errors
- [ ] ProjectileEntityMixin.java contains `MobEffects.SPEED, THC_EFFECT_DURATION_TICKS, 3`
- [ ] ProjectileEntityMixin.java contains `thc$removeArrowKnockback` method
- [ ] ProjectileEntityMixin.java imports MobCategory
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- COMBAT-01: Arrow hits apply Speed IV (amplifier 3)
- COMBAT-02: Arrow hits on monster mobs have knockback removed
</success_criteria>

<output>
After completion, create `.planning/phases/12-combat-rebalancing/12-01-SUMMARY.md`
</output>
