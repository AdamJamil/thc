---
phase: 12-combat-rebalancing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/main/java/thc/mixin/PlayerAttackMixin.java, src/main/resources/thc.mixins.json]
autonomous: true

must_haves:
  truths:
    - "Sweeping edge enchantment has no effect on weapon hits"
    - "All melee damage dealt by players is reduced by 75%"
  artifacts:
    - path: "src/main/java/thc/mixin/PlayerAttackMixin.java"
      provides: "Melee damage reduction and sweeping edge nullification"
      contains: "getSweepingDamageRatio"
  key_links: []
---

<objective>
Disable sweeping edge enchantment effectiveness and reduce all player melee damage by 75%.

Purpose: Significantly weaken melee combat to push players toward ranged combat and create meaningful risk when engaging in close quarters.
Output: New PlayerAttackMixin that modifies attack damage calculations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing damage modification pattern from LivingEntityMixin:
@src/main/java/thc/mixin/LivingEntityMixin.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PlayerAttackMixin with melee damage reduction</name>
  <files>src/main/java/thc/mixin/PlayerAttackMixin.java</files>
  <action>
Create a new mixin targeting `net.minecraft.world.entity.player.Player` to modify attack damage.

The Player class has an `attack(Entity target)` method that handles melee attacks. We need to intercept the damage calculation.

**Approach 1: @ModifyVariable on attack damage**

The Player.attack() method calculates damage in a local variable before applying it. We can use @ModifyVariable to reduce it.

```java
package thc.mixin;

import net.minecraft.world.entity.Entity;
import net.minecraft.world.entity.player.Player;
import org.spongepowered.asm.mixin.Mixin;
import org.spongepowered.asm.mixin.injection.At;
import org.spongepowered.asm.mixin.injection.ModifyVariable;

@Mixin(Player.class)
public abstract class PlayerAttackMixin {
    /**
     * Reduce all melee damage by 75%.
     * The attack() method stores damage in a local variable 'f' (damage from getAttackDamage).
     * We intercept it after the attribute calculation and scale it down.
     */
    @ModifyVariable(
        method = "attack",
        at = @At(value = "STORE"),
        ordinal = 0
    )
    private float thc$reduceMeleeDamage(float originalDamage) {
        // Reduce damage by 75% (multiply by 0.25)
        return originalDamage * 0.25f;
    }
}
```

Note: The ordinal = 0 targets the first float variable stored in the method, which is the attack damage from `this.getAttackDamage(target)`.

**Implementation notes:**
- This applies to ALL player melee attacks, including sweeping attacks
- The 75% reduction happens early in damage calculation
- Buckler damage is separate (handled in LivingEntityMixin) and won't be affected by this
  </action>
  <verify>Build succeeds: `./gradlew build`</verify>
  <done>PlayerAttackMixin.java created with melee damage reduction</done>
</task>

<task type="auto">
  <name>Task 2: Disable sweeping edge enchantment effect</name>
  <files>src/main/java/thc/mixin/PlayerAttackMixin.java</files>
  <action>
In Minecraft 1.21, the sweeping attack mechanic is handled in Player.attack(). The enchantment's damage ratio is calculated via `EnchantmentHelper.getSweepingDamageRatio(...)`.

Add a method to override the sweeping damage ratio calculation result. We can use @Redirect or @ModifyVariable.

**Approach: @Redirect on getSweepingDamageRatio call**

Add to PlayerAttackMixin:

```java
import net.minecraft.world.item.ItemStack;
import net.minecraft.world.item.enchantment.EnchantmentHelper;
import org.spongepowered.asm.mixin.injection.Redirect;

/**
 * Disable sweeping edge enchantment by returning 0 for sweep damage ratio.
 */
@Redirect(
    method = "attack",
    at = @At(
        value = "INVOKE",
        target = "Lnet/minecraft/world/item/enchantment/EnchantmentHelper;getSweepingDamageRatio(Lnet/minecraft/server/level/ServerLevel;Lnet/minecraft/world/item/ItemStack;F)F"
    )
)
private float thc$disableSweepingEdge(net.minecraft.server.level.ServerLevel level, ItemStack weapon, float baseDamage) {
    // Return 0 to completely disable sweeping edge bonus damage
    return 0.0f;
}
```

This intercepts the EnchantmentHelper.getSweepingDamageRatio call and returns 0, making the sweeping edge enchantment have no effect on damage.

Add required import:
```java
import net.minecraft.server.level.ServerLevel;
```
  </action>
  <verify>Build succeeds: `./gradlew build`</verify>
  <done>Sweeping edge enchantment returns 0 damage ratio</done>
</task>

<task type="auto">
  <name>Task 3: Register mixin in configuration</name>
  <files>src/main/resources/thc.mixins.json</files>
  <action>
Add `PlayerAttackMixin` to the mixins array in thc.mixins.json.

Find the "mixins" array and add:
```json
"PlayerAttackMixin"
```

The entry should be added alongside the other mixin class names.
  </action>
  <verify>Build succeeds: `./gradlew build`</verify>
  <done>PlayerAttackMixin registered in mixin configuration</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./gradlew build` succeeds without errors
- [ ] PlayerAttackMixin.java exists with both thc$reduceMeleeDamage and thc$disableSweepingEdge methods
- [ ] thc.mixins.json contains "PlayerAttackMixin"
- [ ] No mixin application errors in build output
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- COMBAT-03: Sweeping edge enchantment has no effect (returns 0 damage ratio)
- COMBAT-04: All melee damage reduced by 75% (multiplied by 0.25)
</success_criteria>

<output>
After completion, create `.planning/phases/12-combat-rebalancing/12-02-SUMMARY.md`
</output>
