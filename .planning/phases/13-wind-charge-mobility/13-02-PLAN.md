---
phase: 13-wind-charge-mobility
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/thc/THCAttachments.java
  - src/main/java/thc/mixin/WindChargePlayerBoostMixin.java
  - src/main/java/thc/mixin/PlayerFallDamageMixin.java
  - src/main/resources/thc.mixins.json
autonomous: true

must_haves:
  truths:
    - "Wind charge self-boost launches player 50% higher than vanilla"
    - "After wind charge self-boost, player negates fall damage on next landing"
    - "Fall damage negation is consumed after one landing"
  artifacts:
    - path: "src/main/java/thc/THCAttachments.java"
      provides: "WIND_CHARGE_BOOSTED attachment for tracking boost state"
      contains: "WIND_CHARGE_BOOSTED"
    - path: "src/main/java/thc/mixin/WindChargePlayerBoostMixin.java"
      provides: "Mixin to increase wind charge boost and set attachment"
      exports: ["thc$enhancePlayerBoost"]
    - path: "src/main/java/thc/mixin/PlayerFallDamageMixin.java"
      provides: "Mixin to negate fall damage when boosted"
      exports: ["thc$negateFallDamage"]
  key_links:
    - from: "WindChargePlayerBoostMixin"
      to: "THCAttachments.WIND_CHARGE_BOOSTED"
      via: "setAttached on successful player boost"
      pattern: "setAttached.*WIND_CHARGE_BOOSTED.*true"
    - from: "PlayerFallDamageMixin"
      to: "THCAttachments.WIND_CHARGE_BOOSTED"
      via: "getAttached check and clear on landing"
      pattern: "getAttached.*WIND_CHARGE_BOOSTED"
---

<objective>
Enhance wind charge player boost by 50% and add one-time fall damage negation.

Purpose: Make wind charges a powerful mobility tool that rewards skilled use by removing fall damage risk after self-boost.
Output: Two mixins (boost enhancement + fall negation) with shared player attachment state.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing attachment pattern:
@src/main/java/thc/THCAttachments.java
@src/main/java/thc/buckler/BucklerState.java

# Existing mixin patterns:
@src/main/java/thc/mixin/ProjectileEntityMixin.java
@src/main/java/thc/mixin/LivingEntityMixin.java
@src/main/resources/thc.mixins.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add wind charge boost attachment</name>
  <files>src/main/java/thc/THCAttachments.java</files>
  <action>
    Add a new attachment to track wind charge boost state:

    ```java
    public static final AttachmentType<Boolean> WIND_CHARGE_BOOSTED = AttachmentRegistry.create(
        Identifier.fromNamespaceAndPath("thc", "wind_charge_boosted"),
        builder -> builder.initializer(() -> Boolean.FALSE)
    );
    ```

    This tracks whether a player has been boosted by their own wind charge and should negate fall damage on next landing.

    No persistence needed (builder.persistent not called) - state resets on relog which is fine.
  </action>
  <verify>
    - THCAttachments.java contains WIND_CHARGE_BOOSTED field
    - ./gradlew build succeeds
  </verify>
  <done>WIND_CHARGE_BOOSTED attachment defined for player state tracking</done>
</task>

<task type="auto">
  <name>Task 2: Create wind charge boost enhancement mixin</name>
  <files>src/main/java/thc/mixin/WindChargePlayerBoostMixin.java, src/main/resources/thc.mixins.json</files>
  <action>
    Create a mixin targeting the wind charge's player boost logic.

    In Minecraft 1.21+, wind charges are handled by:
    - `net.minecraft.world.entity.projectile.windcharge.WindCharge` (player wind charges)
    - The explosion/boost logic is in `WindCharge.explode()` or similar

    The player boost happens when a wind charge explodes near its owner. The boost velocity is applied to the player.

    Implementation approach:
    1. Target `WindCharge` class (net.minecraft.world.entity.projectile.windcharge.WindCharge)
    2. Find the method that applies the boost to entities (likely in explosion handling)
    3. Use @Inject or @ModifyVariable to increase the Y velocity by 50% when the entity is the owner
    4. Set WIND_CHARGE_BOOSTED attachment to true on the player

    Key points:
    - Only modify boost for the wind charge's owner (self-boost)
    - Multiply Y velocity by 1.5 for 50% increase
    - Set attachment via `((AttachmentTarget) player).setAttached(THCAttachments.WIND_CHARGE_BOOSTED, true)`

    The exact method name needs verification during implementation - look for methods that apply velocity/knockback to entities in WindCharge or its parent AbstractWindCharge class.

    Register mixin in thc.mixins.json.
  </action>
  <verify>
    - WindChargePlayerBoostMixin.java exists with @Mixin annotation targeting WindCharge
    - Contains method that increases Y velocity by 1.5x for owner
    - Sets WIND_CHARGE_BOOSTED attachment to true
    - thc.mixins.json includes "WindChargePlayerBoostMixin"
    - ./gradlew build succeeds
  </verify>
  <done>Wind charge self-boost increased by 50% and sets fall damage negation flag</done>
</task>

<task type="auto">
  <name>Task 3: Create fall damage negation mixin</name>
  <files>src/main/java/thc/mixin/PlayerFallDamageMixin.java, src/main/resources/thc.mixins.json</files>
  <action>
    Create a mixin to negate fall damage when WIND_CHARGE_BOOSTED is true.

    Target: `net.minecraft.world.entity.player.Player` or `net.minecraft.server.level.ServerPlayer`

    Implementation approach:
    1. Target the `causeFallDamage` method in Player/LivingEntity
    2. At HEAD, check if player has WIND_CHARGE_BOOSTED attachment set to true
    3. If true:
       - Clear the attachment (set to false) - one-time use
       - Cancel the method (return true to indicate damage was handled)
    4. If false, let vanilla logic proceed

    ```java
    @Inject(method = "causeFallDamage", at = @At("HEAD"), cancellable = true)
    private void thc$negateFallDamage(float fallDistance, float multiplier, DamageSource source, CallbackInfoReturnable<Boolean> cir) {
        Player self = (Player) (Object) this;
        AttachmentTarget target = (AttachmentTarget) self;
        Boolean boosted = target.getAttached(THCAttachments.WIND_CHARGE_BOOSTED);
        if (boosted != null && boosted) {
            target.setAttached(THCAttachments.WIND_CHARGE_BOOSTED, false);
            cir.setReturnValue(true); // Damage "handled" (negated)
        }
    }
    ```

    Target ServerPlayer specifically to ensure server-side handling.

    Register mixin in thc.mixins.json.
  </action>
  <verify>
    - PlayerFallDamageMixin.java exists with @Mixin annotation
    - Contains thc$negateFallDamage method
    - Method checks and clears WIND_CHARGE_BOOSTED attachment
    - Method cancels fall damage when boosted
    - thc.mixins.json includes "PlayerFallDamageMixin"
    - ./gradlew build succeeds
  </verify>
  <done>Fall damage negated once after wind charge self-boost</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./gradlew build` succeeds without errors
- [ ] THCAttachments.java contains WIND_CHARGE_BOOSTED
- [ ] WindChargePlayerBoostMixin.java exists and is registered
- [ ] PlayerFallDamageMixin.java exists and is registered
- [ ] Both mixins properly reference WIND_CHARGE_BOOSTED attachment
</verification>

<success_criteria>

- WIND-02 satisfied: Wind charge self-boost launches player 50% higher
- WIND-03 satisfied: Fall damage negated on next landing after self-boost
- Build passes
- All three components (attachment + 2 mixins) properly wired
</success_criteria>

<output>
After completion, create `.planning/phases/13-wind-charge-mobility/13-02-SUMMARY.md`
</output>
