---
phase: 15-threat-system
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/main/java/thc/mixin/MobDamageThreatMixin.java
  - src/main/java/thc/mixin/ProjectileEntityMixin.java
  - src/main/resources/thc.mixins.json
autonomous: true
must_haves:
  truths:
    - "Dealing X damage to a mob adds X threat to all hostile/neutral mobs within 15 blocks"
    - "Arrow hits add +10 bonus threat to the struck mob specifically"
    - "Threat propagation only occurs for player-dealt damage"
  artifacts:
    - path: "src/main/java/thc/mixin/MobDamageThreatMixin.java"
      provides: "Damage event hook for threat propagation"
      min_lines: 40
  key_links:
    - from: "MobDamageThreatMixin.java"
      to: "ThreatManager.addThreat"
      via: "hurtServer TAIL injection"
      pattern: "ThreatManager\\.addThreat"
    - from: "ProjectileEntityMixin.java"
      to: "ThreatManager.addThreat"
      via: "onHitEntity injection"
      pattern: "ThreatManager\\.addThreat"
---

<objective>
Implement threat propagation: when a player deals damage, add threat to nearby hostile/neutral mobs.

Purpose: This is the core threat generation mechanic (THREAT-02, THREAT-04). Damage spreads threat to nearby mobs, creating tactical aggro management.
Output: Mixin that hooks damage events and propagates threat to nearby mobs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/MOB_TARGETING_AI_RESEARCH.md

# Foundation from Plan 01:
@src/main/java/thc/threat/ThreatManager.java
@src/main/java/thc/THCAttachments.java

# Existing patterns for damage hooks and MobCategory filtering:
@src/main/java/thc/mixin/LivingEntityMixin.java
@src/main/java/thc/mixin/ProjectileEntityMixin.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MobDamageThreatMixin for threat propagation</name>
  <files>src/main/java/thc/mixin/MobDamageThreatMixin.java</files>
  <action>
    Create a new mixin targeting Mob.class to hook damage events and propagate threat:

    ```java
    package thc.mixin;

    import net.minecraft.server.level.ServerLevel;
    import net.minecraft.server.level.ServerPlayer;
    import net.minecraft.world.damagesource.DamageSource;
    import net.minecraft.world.entity.Entity;
    import net.minecraft.world.entity.Mob;
    import net.minecraft.world.entity.MobCategory;
    import net.minecraft.world.phys.AABB;
    import org.spongepowered.asm.mixin.Mixin;
    import org.spongepowered.asm.mixin.Unique;
    import org.spongepowered.asm.mixin.injection.At;
    import org.spongepowered.asm.mixin.injection.Inject;
    import org.spongepowered.asm.mixin.injection.callback.CallbackInfoReturnable;
    import thc.threat.ThreatManager;

    @Mixin(Mob.class)
    public abstract class MobDamageThreatMixin {
        private static final double THC_THREAT_RADIUS = 15.0;

        @Inject(method = "hurtServer", at = @At("TAIL"))
        private void thc$propagateThreatOnDamage(
            ServerLevel level,
            DamageSource source,
            float amount,
            CallbackInfoReturnable<Boolean> cir
        ) {
            // Only propagate if damage was actually dealt
            if (!cir.getReturnValue() || amount <= 0) {
                return;
            }

            // Get the player who dealt damage
            Entity attacker = source.getEntity();
            if (!(attacker instanceof ServerPlayer player)) {
                return;
            }

            Mob self = (Mob) (Object) this;

            // Add threat to all hostile/neutral mobs within 15 blocks
            AABB area = self.getBoundingBox().inflate(THC_THREAT_RADIUS);
            for (Mob nearby : level.getEntitiesOfClass(Mob.class, area, this::thc$isHostileOrNeutral)) {
                ThreatManager.addThreat(nearby, player.getUUID(), amount);
            }
        }

        @Unique
        private boolean thc$isHostileOrNeutral(Mob mob) {
            MobCategory category = mob.getType().getCategory();
            return category == MobCategory.MONSTER || category == MobCategory.CREATURE;
            // Note: CREATURE includes wolves, iron golems which are neutral
            // MONSTER is hostile mobs
        }
    }
    ```

    Key points:
    - Use TAIL injection so damage is confirmed dealt (cir.getReturnValue())
    - Propagate `amount` as threat value (THREAT-02: X damage = X threat)
    - Check MobCategory for hostile (MONSTER) and neutral (CREATURE) mobs
    - Radius is 15 blocks per THREAT-02
  </action>
  <verify>Build compiles: `./gradlew build`</verify>
  <done>MobDamageThreatMixin created with threat propagation on damage</done>
</task>

<task type="auto">
  <name>Task 2: Add +10 bonus threat for arrow hits</name>
  <files>src/main/java/thc/mixin/ProjectileEntityMixin.java</files>
  <action>
    Modify the existing ProjectileEntityMixin to add +10 bonus threat to the struck mob specifically (THREAT-04).

    In the existing `thc$applyHitEffects` method (HEAD injection on onHitEntity), add after the existing effect application:

    ```java
    // Add +10 bonus threat to struck mob (THREAT-04)
    if (target instanceof Mob mob) {
        ThreatManager.addThreat(mob, player.getUUID(), 10.0);
    }
    ```

    Required import: `import thc.threat.ThreatManager;`

    Note: The damage-based threat will ALSO apply from Plan 02 Task 1 when the mob takes damage. This is additive - arrow hits generate both:
    1. Base threat from damage (via MobDamageThreatMixin)
    2. +10 bonus threat (via this modification)
  </action>
  <verify>Build compiles: `./gradlew build`</verify>
  <done>Arrow hits add +10 bonus threat to struck mob</done>
</task>

<task type="auto">
  <name>Task 3: Register MobDamageThreatMixin</name>
  <files>src/main/resources/thc.mixins.json</files>
  <action>
    Add "MobDamageThreatMixin" to the mixins array in thc.mixins.json.

    Add it alphabetically near other mixins.
  </action>
  <verify>Build and game launches without mixin errors: `./gradlew build`</verify>
  <done>MobDamageThreatMixin registered in mixin config</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./gradlew build` succeeds without errors
- [ ] MobDamageThreatMixin exists and is registered
- [ ] ProjectileEntityMixin modified to add +10 bonus threat
- [ ] Damage propagates threat to nearby hostile/neutral mobs within 15 blocks
</verification>

<success_criteria>

- All tasks completed
- Build succeeds
- Threat propagation working: damage spreads threat, arrows add bonus
</success_criteria>

<output>
After completion, create `.planning/phases/15-threat-system/15-02-SUMMARY.md`
</output>
