---
phase: 15-threat-system
plan: 03
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/main/java/thc/threat/ThreatManager.java
  - src/main/java/thc/THCAttachments.java
autonomous: true
must_haves:
  truths:
    - "Threat decays by 1 per second for each player on each mob"
    - "Decay only happens once per second (tick-based check)"
    - "Zero or negative threat values are removed from the map"
  artifacts:
    - path: "src/main/java/thc/threat/ThreatManager.java"
      provides: "decayThreat method"
      contains: "decayThreat"
    - path: "src/main/java/thc/THCAttachments.java"
      provides: "THREAT_LAST_DECAY timestamp attachment"
      contains: "THREAT_LAST_DECAY"
  key_links:
    - from: "ThreatManager.decayThreat"
      to: "THREAT_LAST_DECAY"
      via: "tick-based decay check"
      pattern: "getGameTime.*THREAT_LAST_DECAY"
---

<objective>
Implement threat decay: threat reduces by 1 per second per player per mob.

Purpose: Prevent permanent aggro accumulation (THREAT-03). Threat naturally decays, allowing players to disengage or transfer aggro.
Output: Decay method in ThreatManager and timestamp attachment for tick-based decay.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/MOB_TARGETING_AI_RESEARCH.md

# Foundation from Plan 01:
@src/main/java/thc/threat/ThreatManager.java
@src/main/java/thc/THCAttachments.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add THREAT_LAST_DECAY attachment</name>
  <files>src/main/java/thc/THCAttachments.java</files>
  <action>
    Add a timestamp attachment to track when threat was last decayed:

    ```java
    public static final AttachmentType<Long> THREAT_LAST_DECAY = AttachmentRegistry.create(
        Identifier.fromNamespaceAndPath("thc", "threat_last_decay"),
        builder -> builder.initializer(() -> 0L)
    );
    ```

    This stores the game tick when decay was last applied, allowing once-per-second decay.
    Not persistent - resets when mob unloads.
  </action>
  <verify>Build compiles: `./gradlew build`</verify>
  <done>THREAT_LAST_DECAY attachment registered</done>
</task>

<task type="auto">
  <name>Task 2: Add decayThreat method to ThreatManager</name>
  <files>src/main/java/thc/threat/ThreatManager.java</files>
  <action>
    Add decay method to ThreatManager:

    ```java
    /**
     * Decay threat for all players by 1 per second.
     * Should be called frequently (e.g., in goal canUse/canContinueToUse).
     * Uses tick-based check to only decay once per second (20 ticks).
     */
    public static void decayThreat(Mob mob) {
        if (mob.level().isClientSide()) return;

        long now = mob.level().getGameTime();
        long lastDecay = mob.getAttachedOrCreate(THCAttachments.THREAT_LAST_DECAY);

        // Only decay once per second (20 ticks)
        if (now - lastDecay < 20) {
            return;
        }

        Map<UUID, Double> threats = mob.getAttached(THCAttachments.MOB_THREAT);
        if (threats == null || threats.isEmpty()) {
            return;
        }

        // Decay all threat values by 1
        threats.replaceAll((uuid, threat) -> threat - 1.0);

        // Remove entries at or below zero
        threats.entrySet().removeIf(entry -> entry.getValue() <= 0.0);

        mob.setAttached(THCAttachments.THREAT_LAST_DECAY, now);
    }
    ```

    Key points:
    - Check `isClientSide()` to only run on server
    - Use game time for tick-accurate 1-second intervals
    - Clean up zero/negative entries to prevent map bloat
    - Decay is lazy (called when needed), not tick-based mixin
  </action>
  <verify>Build compiles: `./gradlew build`</verify>
  <done>decayThreat method added with 1/sec decay rate</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./gradlew build` succeeds without errors
- [ ] THREAT_LAST_DECAY attachment registered
- [ ] decayThreat method exists and implements 1/sec decay
- [ ] Zero/negative threat values are cleaned up
</verification>

<success_criteria>

- All tasks completed
- Build succeeds
- Decay system ready for threat targeting (Plan 04)
</success_criteria>

<output>
After completion, create `.planning/phases/15-threat-system/15-03-SUMMARY.md`
</output>
