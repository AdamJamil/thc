---
phase: 16-world-difficulty
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/thc/mixin/ServerLevelDifficultyMixin.java
  - src/main/resources/thc.mixins.json
autonomous: true
must_haves:
  truths:
    - "Regional difficulty is always at maximum in every chunk"
    - "Moon phase effects are always at maximum"
    - "Mobs spawn with maximum equipment/enchantments possible"
  artifacts:
    - path: "src/main/java/thc/mixin/ServerLevelDifficultyMixin.java"
      provides: "Maximum regional difficulty override"
      contains: "getCurrentDifficultyAt"
    - path: "src/main/resources/thc.mixins.json"
      provides: "Mixin registration"
      contains: "ServerLevelDifficultyMixin"
  key_links:
    - from: "ServerLevelDifficultyMixin"
      to: "ServerLevel.getCurrentDifficultyAt"
      via: "@Inject RETURN override"
      pattern: "DifficultyInstance"
---

<objective>
Force maximum regional difficulty and moon phase effects everywhere.

Purpose: All areas of the world should have maximum difficulty (mob equipment, spawns, behavior) as if the player had been in one location for the maximum time with a full moon.
Output: Mixin that overrides difficulty calculations to return maximum values.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing mixin patterns:
@src/main/java/thc/mixin/LivingEntityMixin.java
@src/main/resources/thc.mixins.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ServerLevelDifficultyMixin for max difficulty</name>
  <files>src/main/java/thc/mixin/ServerLevelDifficultyMixin.java</files>
  <action>
    Create a mixin targeting ServerLevel that overrides getCurrentDifficultyAt to return maximum difficulty.

    DifficultyInstance is constructed with:
    - Difficulty (HARD is the base)
    - chunkInhabitedTime (long) - how long players have been in the chunk
    - dayTime (long) - world day time for moon phase
    - moonPhaseFactor (float) - 0.0 to 1.0, full moon = 1.0

    Regional difficulty calculation uses:
    - Higher chunkInhabitedTime = harder (capped at 50 hours real time = 3,600,000 ticks)
    - Full moon (phase factor 1.0) = harder
    - Hard difficulty = harder base

    To maximize difficulty:
    1. @Inject at HEAD of getCurrentDifficultyAt(BlockPos pos)
    2. Return a DifficultyInstance with:
       - getDifficulty() returns HARD
       - Use Long.MAX_VALUE or very high value for chunkInhabitedTime (will be clamped internally)
       - Moon phase factor 1.0f (full moon)

    Implementation:
    ```java
    @Mixin(ServerLevel.class)
    public abstract class ServerLevelDifficultyMixin {

        @Inject(method = "getCurrentDifficultyAt", at = @At("HEAD"), cancellable = true)
        private void thc$forceMaxDifficulty(BlockPos pos, CallbackInfoReturnable<DifficultyInstance> cir) {
            ServerLevel self = (ServerLevel)(Object)this;
            // Use maximum inhabited time (3,600,000 ticks = 50 hours, the cap)
            // Use moon phase 1.0f (full moon)
            // DifficultyInstance(difficulty, levelTime, chunkInhabitedTime, moonPhaseFactor)
            DifficultyInstance maxDifficulty = new DifficultyInstance(
                Difficulty.HARD,
                self.getLevelData().getGameTime(),
                3600000L,  // Max inhabited time
                1.0f       // Full moon
            );
            cir.setReturnValue(maxDifficulty);
        }
    }
    ```

    Imports needed:
    - net.minecraft.core.BlockPos
    - net.minecraft.server.level.ServerLevel
    - net.minecraft.world.Difficulty
    - net.minecraft.world.DifficultyInstance
    - org.spongepowered.asm.mixin.Mixin
    - org.spongepowered.asm.mixin.injection.At
    - org.spongepowered.asm.mixin.injection.Inject
    - org.spongepowered.asm.mixin.injection.callback.CallbackInfoReturnable
  </action>
  <verify>Build succeeds with `./gradlew build`</verify>
  <done>Mixin created that forces maximum regional difficulty in all chunks</done>
</task>

<task type="auto">
  <name>Task 2: Register ServerLevelDifficultyMixin in mixin config</name>
  <files>src/main/resources/thc.mixins.json</files>
  <action>
    Add "ServerLevelDifficultyMixin" to the mixins array in thc.mixins.json.

    Add it in alphabetical order among the existing mixins (after ServerPlayerMixin, before SnowballItemMixin).
  </action>
  <verify>JSON is valid and `./gradlew build` succeeds</verify>
  <done>Mixin is registered and loaded</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./gradlew build` succeeds without errors
- [ ] ServerLevelDifficultyMixin.java exists with HEAD inject on getCurrentDifficultyAt
- [ ] Mixin is registered in thc.mixins.json
- [ ] DifficultyInstance is created with HARD difficulty, max inhabited time, full moon
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- WORLD-03 (max regional difficulty) implemented
- WORLD-04 (moon phase always true/full) implemented
</success_criteria>

<output>
After completion, create `.planning/phases/16-world-difficulty/16-02-SUMMARY.md`
</output>
