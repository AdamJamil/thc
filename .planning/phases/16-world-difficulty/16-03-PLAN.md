---
phase: 16-world-difficulty
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/thc/mixin/NaturalSpawnerMixin.java
  - src/main/resources/thc.mixins.json
autonomous: true
must_haves:
  truths:
    - "Mobs do not spawn naturally in base chunks"
    - "Mobs can still spawn naturally outside base chunks"
    - "Spawners and spawn eggs still work in base chunks"
  artifacts:
    - path: "src/main/java/thc/mixin/NaturalSpawnerMixin.java"
      provides: "Natural spawn blocking in base chunks"
      contains: "isValidSpawnPostitionForType"
    - path: "src/main/resources/thc.mixins.json"
      provides: "Mixin registration"
      contains: "NaturalSpawnerMixin"
  key_links:
    - from: "NaturalSpawnerMixin"
      to: "ClaimManager.isClaimed"
      via: "Check chunk claim status"
      pattern: "ClaimManager"
---

<objective>
Block natural mob spawning in base chunks.

Purpose: Claimed chunks should be safe havens where mobs cannot naturally spawn, but spawners and spawn eggs should still work for player-controlled spawning.
Output: Mixin that intercepts natural spawn validation and blocks spawns in claimed chunks.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# ClaimManager API for chunk checking:
@src/main/kotlin/thc/claim/ClaimManager.kt

# Existing mixin patterns:
@src/main/java/thc/mixin/LivingEntityMixin.java
@src/main/resources/thc.mixins.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NaturalSpawnerMixin to block spawns in base chunks</name>
  <files>src/main/java/thc/mixin/NaturalSpawnerMixin.java</files>
  <action>
    Create a mixin targeting NaturalSpawner that blocks spawns in claimed chunks.

    The key method is `isValidSpawnPostitionForType(ServerLevel, MobCategory, StructureManager, ChunkGenerator, MobSpawnSettings.SpawnerData, BlockPos.MutableBlockPos, double)` - this returns boolean whether a position is valid for spawning.

    Inject at HEAD and return false if the spawn position is in a claimed chunk:

    ```java
    @Mixin(NaturalSpawner.class)
    public abstract class NaturalSpawnerMixin {

        /**
         * Block natural mob spawning in claimed base chunks.
         *
         * <p>THC bases are safe zones where mobs should not naturally spawn.
         * This does NOT affect spawners or spawn eggs, only natural spawning.
         */
        @Inject(
            method = "isValidSpawnPostitionForType",
            at = @At("HEAD"),
            cancellable = true
        )
        private static void thc$blockSpawnInBasChunks(
                ServerLevel level,
                MobCategory category,
                StructureManager structureManager,
                ChunkGenerator generator,
                MobSpawnSettings.SpawnerData spawnerData,
                BlockPos.MutableBlockPos pos,
                double squaredDistance,
                CallbackInfoReturnable<Boolean> cir) {

            // Check if this chunk is claimed
            ChunkPos chunkPos = new ChunkPos(pos);
            if (ClaimManager.INSTANCE.isClaimed(level.getServer(), chunkPos)) {
                cir.setReturnValue(false);
            }
        }
    }
    ```

    Imports needed:
    - net.minecraft.core.BlockPos
    - net.minecraft.server.level.ServerLevel
    - net.minecraft.world.entity.MobCategory
    - net.minecraft.world.level.ChunkPos
    - net.minecraft.world.level.StructureManager
    - net.minecraft.world.level.biome.MobSpawnSettings
    - net.minecraft.world.level.chunk.ChunkGenerator
    - net.minecraft.world.level.NaturalSpawner
    - org.spongepowered.asm.mixin.Mixin
    - org.spongepowered.asm.mixin.injection.At
    - org.spongepowered.asm.mixin.injection.Inject
    - org.spongepowered.asm.mixin.injection.callback.CallbackInfoReturnable
    - thc.claim.ClaimManager

    NOTE: ClaimManager is a Kotlin object, accessed via ClaimManager.INSTANCE from Java.
  </action>
  <verify>Build succeeds with `./gradlew build`</verify>
  <done>Mixin blocks natural spawning in all claimed chunks</done>
</task>

<task type="auto">
  <name>Task 2: Register NaturalSpawnerMixin in mixin config</name>
  <files>src/main/resources/thc.mixins.json</files>
  <action>
    Add "NaturalSpawnerMixin" to the mixins array in thc.mixins.json.

    Add it in alphabetical order among the existing mixins (after MonsterThreatGoalMixin, before PlayerAttackMixin).
  </action>
  <verify>JSON is valid and `./gradlew build` succeeds</verify>
  <done>Mixin is registered and loaded</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./gradlew build` succeeds without errors
- [ ] NaturalSpawnerMixin.java exists with HEAD inject on isValidSpawnPostitionForType
- [ ] Mixin correctly calls ClaimManager.INSTANCE.isClaimed()
- [ ] Mixin returns false for claimed chunks
- [ ] Mixin is registered in thc.mixins.json
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- WORLD-05 (no mob spawns in base chunks) implemented
</success_criteria>

<output>
After completion, create `.planning/phases/16-world-difficulty/16-03-SUMMARY.md`
</output>
