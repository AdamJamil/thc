---
phase: 17-remove-night-lock
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/main/kotlin/thc/THC.kt]
autonomous: true

must_haves:
  truths:
    - "Server time advances continuously after world load"
    - "doDaylightCycle gamerule is NOT forcibly disabled"
    - "Game starts without time being frozen at night"
  artifacts:
    - path: "src/main/kotlin/thc/THC.kt"
      provides: "Mod initialization without night lock"
      contains: "onInitialize"
  key_links:
    - from: "THC.kt onInitialize"
      to: "ServerLifecycleEvents.SERVER_STARTED"
      via: "Event registration without lockWorldToNight call"
      pattern: "SERVER_STARTED.*register"
---

<objective>
Remove the existing night-lock system so server time flows normally.

Purpose: Prepare for twilight system where time advances but visuals show perpetual dusk.
Output: THC.kt without night-lock code, server time advances naturally.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Source file containing night lock:
@src/main/kotlin/thc/THC.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove night lock function and call</name>
  <files>src/main/kotlin/thc/THC.kt</files>
  <action>
Remove the following from THC.kt:

1. Delete the `NIGHT_TIME` constant (line 30: `private const val NIGHT_TIME = 18000L`)

2. Modify the SERVER_STARTED event handler (lines 59-63) to ONLY set MOB_GRIEFING. The current code is:
```kotlin
ServerLifecycleEvents.SERVER_STARTED.register(ServerLifecycleEvents.ServerStarted { server ->
    server.allLevels.forEach { world ->
        lockWorldToNight(server, world)
    }
})
```

Change it to:
```kotlin
ServerLifecycleEvents.SERVER_STARTED.register(ServerLifecycleEvents.ServerStarted { server ->
    server.allLevels.forEach { world ->
        world.gameRules.set(GameRules.MOB_GRIEFING, false, server)
    }
})
```

3. Delete the entire `lockWorldToNight` function (lines 156-160).

IMPORTANT: Keep MOB_GRIEFING disabled - that's a separate feature from Phase 16 that must be preserved.
  </action>
  <verify>./gradlew build --quiet && echo "Build successful"</verify>
  <done>Night lock code removed, MOB_GRIEFING still disabled, build passes</done>
</task>

<task type="auto">
  <name>Task 2: Verify time flows normally</name>
  <files>src/main/kotlin/thc/THC.kt</files>
  <action>
Verify the changes by checking:

1. No references to `NIGHT_TIME` constant remain
2. No references to `lockWorldToNight` function remain
3. No `ADVANCE_TIME` gamerule manipulation remains
4. No `dayTime` property manipulation remains
5. MOB_GRIEFING is still set to false in the server started handler

Use grep to confirm these patterns are absent/present as expected.
  </action>
  <verify>
grep -c "NIGHT_TIME\|lockWorldToNight\|ADVANCE_TIME\|dayTime" src/main/kotlin/thc/THC.kt || echo "No night lock references found (expected)"
grep -c "MOB_GRIEFING" src/main/kotlin/thc/THC.kt && echo "MOB_GRIEFING still present (expected)"
  </verify>
  <done>No night lock references remain, MOB_GRIEFING preserved</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./gradlew build` succeeds without errors
- [ ] No `NIGHT_TIME`, `lockWorldToNight`, `ADVANCE_TIME`, or `dayTime` references in THC.kt
- [ ] `MOB_GRIEFING` gamerule still set to false in server started handler
- [ ] Server time will advance naturally (doDaylightCycle not forced to false)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- TIME-01: Server time flows normally (doDaylightCycle not disabled)
- TIME-02: Night-lock code removed
- MOB_GRIEFING still disabled (Phase 16 feature preserved)
</success_criteria>

<output>
After completion, create `.planning/phases/17-remove-night-lock/17-01-SUMMARY.md`
</output>
