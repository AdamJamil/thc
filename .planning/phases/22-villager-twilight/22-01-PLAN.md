---
phase: 22-villager-twilight
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/main/java/thc/mixin/VillagerMixin.java, src/main/resources/thc.mixins.json]
autonomous: true

must_haves:
  truths:
    - "Villagers seek beds at any server time (not just after 12000 ticks)"
    - "Villagers follow night schedule continuously"
    - "Villagers still respond to player interaction (trading works)"
  artifacts:
    - path: "src/main/java/thc/mixin/VillagerMixin.java"
      provides: "Brain schedule time override for perpetual night behavior"
      min_lines: 25
  key_links:
    - from: "VillagerMixin.java"
      to: "Brain schedule time query"
      via: "@Redirect or @ModifyVariable on time parameter"
      pattern: "level\\.(getDayTime|getTimeOfDay)"
---

<objective>
Make villagers behave as if it's always night for schedule purposes.

Purpose: In the Twilight Hardcore system, the world is perpetually hostile with monsters spawning 24/7 and visually appearing as dusk. Villagers should match this by always behaving as if it's night - seeking shelter and beds continuously. This creates a thematically consistent world where daylight doesn't mean safety.

Output: VillagerMixin that intercepts the time check used by villager Brain scheduling to return a night-time value.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Prior work:
@.planning/phases/21-bee-always-work/21-01-SUMMARY.md — Similar pattern: modifying entity behavior via environment/time checks

Existing files:
@src/main/resources/thc.mixins.json — Current mixin registrations
@src/main/java/thc/mixin/BeeMixin.java — Reference for @Redirect pattern on environment attributes
@src/main/java/thc/mixin/AbstractVillagerMixin.java — Existing villager mixin (trade filtering only)
</context>

<research>
## Villager Schedule System (Minecraft 1.21)

Villagers use a Brain AI system with scheduled Activities:
- 00010-12000 ticks: Various work/wander activities
- 12000-23999 ticks: REST/SLEEP activity (night behavior)

The Brain system calls `level.getDayTime()` (or similar) to determine which activity to run from the schedule. By making the villager's Brain think it's always after 12000 ticks, villagers will:
- Always try to sleep/rest
- Always seek shelter
- Still trade when directly interacted with (interaction overrides schedule)

## Approach

1. Create VillagerMixin targeting the Villager class
2. Find where the Brain schedule checks world time
3. Intercept that time query and return a night-time value (e.g., 13000)

The exact injection point needs discovery during implementation:
- Could be `Brain.updateActivityFromSchedule(int, long)`
- Could be where Villager calls `level.getDayTime()`
- May need to check `Schedule.getActivityForTime(int)` call site

Use similar @Redirect pattern as BeeMixin, but targeting time rather than environment attribute.
</research>

<tasks>

<task type="auto">
  <name>Task 1: Create VillagerMixin for perpetual night schedule</name>
  <files>src/main/java/thc/mixin/VillagerMixin.java</files>
  <action>
    Create a new VillagerMixin that makes villagers behave as if it's always night.

    Discovery needed: Find the exact injection point where villager Brain checks world time.

    Possible approaches (try in order):
    1. **@ModifyVariable on updateActivityFromSchedule** - If Villager overrides or calls this method, modify the time parameter to always be 13000 (night)
    2. **@Redirect on getDayTime call** - Intercept level.getDayTime() within villager brain update methods
    3. **@Redirect on Schedule.getActivityForTime** - Modify the time parameter passed to schedule lookup

    Implementation:
    - Target net.minecraft.world.entity.npc.Villager class
    - Add Javadoc explaining the twilight hardcore context
    - Return a night-time value (13000 ticks is mid-sleep period)
    - Pattern after BeeMixin's structure and documentation style

    What to avoid:
    - Don't modify AbstractVillager (already has trade filtering, keep separate)
    - Don't use @Overwrite (too invasive)
    - Don't break villager trading (interaction should still work)

    If build fails with remap warnings, investigate the actual method names in MC 1.21 and adjust.
  </action>
  <verify>./gradlew build completes without errors or remap warnings for VillagerMixin</verify>
  <done>VillagerMixin created and compiles successfully</done>
</task>

<task type="auto">
  <name>Task 2: Register mixin and test behavior</name>
  <files>src/main/resources/thc.mixins.json</files>
  <action>
    1. Add "VillagerMixin" to thc.mixins.json in alphabetical order
    2. Run the build to verify registration works
    3. Document any deviations from plan (different method name, different approach needed)
  </action>
  <verify>./gradlew build succeeds and VillagerMixin appears in the mixins list</verify>
  <done>Mixin registered and build passes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./gradlew build` succeeds without errors
- [ ] No remap warnings for VillagerMixin methods
- [ ] VillagerMixin is registered in thc.mixins.json
- [ ] Mixin targets a valid time-check method in villager Brain/Schedule system
</verification>

<success_criteria>

- VillagerMixin created with @Redirect or @ModifyVariable on time check
- Mixin registered in thc.mixins.json
- Build passes without errors or warnings
- Villagers will now use night schedule regardless of server time
</success_criteria>

<output>
After completion, create `.planning/phases/22-villager-twilight/22-01-SUMMARY.md`
</output>
