---
phase: 23-bed-mechanics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/thc/mixin/PlayerSleepMixin.java
  - src/main/java/thc/mixin/ServerLevelSleepMixin.java
  - src/main/resources/thc.mixins.json
autonomous: true

must_haves:
  truths:
    - "Player can sleep in bed at any server time (no 'You can only sleep at night')"
    - "Sleeping does not advance the day/night cycle"
    - "Using bed sets player's spawn point"
  artifacts:
    - path: "src/main/java/thc/mixin/PlayerSleepMixin.java"
      provides: "Override time-of-day sleep restriction"
      min_lines: 25
    - path: "src/main/java/thc/mixin/ServerLevelSleepMixin.java"
      provides: "Prevent time skip when all players sleep"
      min_lines: 20
  key_links:
    - from: "PlayerSleepMixin"
      to: "Player.startSleepInBed"
      via: "@Inject HEAD cancellation on BedSleepingProblem.NOT_POSSIBLE_NOW"
      pattern: "startSleepInBed"
    - from: "ServerLevelSleepMixin"
      to: "ServerLevel tick sleep handling"
      via: "Prevent setDayTime call during sleep cycle"
      pattern: "setDayTime|tickTime"
---

<objective>
Allow beds to be used at any time of day without skipping the day/night cycle.

Purpose: Complete the twilight hardcore experience — players can use beds to set spawn points in a world where danger never stops, but sleeping doesn't skip past the perpetual threat.

Output: Two mixins that (1) bypass the "You can only sleep at night" restriction and (2) prevent time advancement when players sleep.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Phase 23 is the final phase of v2.0 Twilight Hardcore. Prior phases established:
- Phase 17: Time flows normally (doDaylightCycle enabled)
- Phase 18: Client sees perpetual dusk (visual override)
- Phase 22: Villagers behave as if always night

Requirements for this phase:
- BED-01: Player can always use beds (no time-of-day restriction)
- BED-02: Sleeping does not skip time or advance day/night cycle
- BED-03: Beds still set spawn point when used

@src/main/java/thc/mixin/MobSunBurnMixin.java — Example of HEAD cancellable pattern
@src/main/java/thc/mixin/VillagerMixin.java — Example of redirect pattern in this project
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PlayerSleepMixin to allow 24/7 bed usage</name>
  <files>src/main/java/thc/mixin/PlayerSleepMixin.java</files>
  <action>
Create a mixin targeting `net.minecraft.world.entity.player.Player` that intercepts the `startSleepInBed` method.

The vanilla method returns `Either<BedSleepingProblem, Unit>` where:
- `Either.left(BedSleepingProblem.NOT_POSSIBLE_NOW)` = "You can only sleep at night"
- `Either.right(Unit.INSTANCE)` = success

**Implementation approach:**
1. Use `@Inject` at HEAD with cancellable=true
2. Check if the return would be `NOT_POSSIBLE_NOW` due to time
3. If so, manually trigger the successful sleep flow instead

**Key insight:** The method signature is:
```java
public Either<BedSleepingProblem, Unit> startSleepInBed(BlockPos pos)
```

The check for "NOT_POSSIBLE_NOW" happens early in the method based on `level.isDay()`. We need to:
1. Intercept before the time check
2. Perform our own validation (exclude the time check)
3. If all OTHER checks pass, call `startSleeping(pos)` and return success
4. If other checks fail, let vanilla handle it

**Alternative simpler approach:** Use `@Redirect` on the `level.isDay()` call within startSleepInBed to always return false (making it always "night" for bed purposes). This is cleaner if the method structure allows it.

**Pattern from project:** Follow MobSunBurnMixin HEAD inject pattern but return custom Either value.

Include detailed Javadoc explaining:
- Part of twilight hardcore system
- Why beds need to work 24/7 (spawn points in dangerous world)
- What checks are preserved (monsters nearby, obstruction, dimension)
  </action>
  <verify>
Compile succeeds: `./gradlew build`
  </verify>
  <done>PlayerSleepMixin exists with startSleepInBed injection that bypasses time-of-day check</done>
</task>

<task type="auto">
  <name>Task 2: Create ServerLevelSleepMixin to prevent time skip</name>
  <files>src/main/java/thc/mixin/ServerLevelSleepMixin.java</files>
  <action>
Create a mixin targeting `net.minecraft.server.level.ServerLevel` to prevent time advancement when players sleep.

In vanilla, when all players are sleeping:
1. ServerLevel checks if enough players slept long enough
2. If so, it calls `setDayTime()` to advance to morning

**Implementation approach:**
The sleep time advancement happens in the `tick()` method of ServerLevel. Look for the pattern where it:
1. Checks `allPlayersSleeping()` or similar
2. Calls `setDayTime(0L)` to reset to morning

**Option A - Redirect setDayTime:**
```java
@Redirect(
  method = "tick",
  at = @At(value = "INVOKE", target = "setDayTime(J)V")
)
private void thc$preventTimeSkipOnSleep(ServerLevel level, long time) {
  // Don't call setDayTime - time doesn't skip
  // Players still wake up naturally when sleep duration completes
}
```

**Option B - Intercept sleep check:**
If there's a boolean method like `areAllPlayersSleeping()` or `shouldSkipNight()`, redirect it to return false.

**Key consideration:** Players should still:
- Wake up after sleeping (sleep animation completes)
- Clear phantoms/insomnia timer (if vanilla does this)
- Set spawn point (handled by bed use, not time skip)

The mixin should ONLY prevent time advancement, not break other sleep mechanics.

Include Javadoc explaining the twilight hardcore rationale.
  </action>
  <verify>
Compile succeeds: `./gradlew build`
  </verify>
  <done>ServerLevelSleepMixin prevents time advancement during sleep cycle</done>
</task>

<task type="auto">
  <name>Task 3: Register mixins and verify</name>
  <files>src/main/resources/thc.mixins.json</files>
  <action>
Add both new mixins to the mixins configuration:
- "mixin.PlayerSleepMixin"
- "mixin.ServerLevelSleepMixin"

Then run full build to verify compilation and mixin application.
  </action>
  <verify>
`./gradlew build` succeeds with no mixin errors
  </verify>
  <done>Mixins registered and build succeeds</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./gradlew build` succeeds
- [ ] PlayerSleepMixin.java exists with startSleepInBed injection
- [ ] ServerLevelSleepMixin.java exists with time skip prevention
- [ ] Both mixins registered in thc.mixins.json
- [ ] No compilation errors or warnings
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Bed usage works at any time of day (BED-01)
- Time does not advance when sleeping (BED-02)
- Spawn point still gets set (BED-03 - inherent from successful bed use)
</success_criteria>

<output>
After completion, create `.planning/phases/23-bed-mechanics/23-01-SUMMARY.md`
</output>
