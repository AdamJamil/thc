---
phase: 26-structure-protection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/kotlin/thc/world/VillageProtection.kt
autonomous: true

must_haves:
  truths:
    - "Player cannot break non-ore blocks inside village structure bounding boxes"
    - "Player can break blocks underground below villages"
    - "Player can still break ores inside village structures"
    - "Player can still break allowlist blocks inside village structures"
  artifacts:
    - path: "src/main/kotlin/thc/world/VillageProtection.kt"
      provides: "Position-based village structure protection"
      contains: "getStructureWithPieceAt"
  key_links:
    - from: "VillageProtection.kt"
      to: "StructureManager.getStructureWithPieceAt"
      via: "Direct API call per block break"
      pattern: "getStructureWithPieceAt.*StructureTags\\.VILLAGE"
---

<objective>
Replace chunk-based village protection with structure bounding box protection.

Purpose: Allow underground traversal below villages while protecting village structures from griefing. Currently, entire chunks containing any village piece are protected, blocking underground mining.

Output: Updated VillageProtection.kt that checks individual block positions against village structure piece bounding boxes instead of checking entire chunks.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/v2.1/STRUCTURE-BOUNDARIES.md

@src/main/kotlin/thc/world/VillageProtection.kt
@src/main/kotlin/thc/claim/ChunkValidator.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace chunk check with position-based structure check</name>
  <files>src/main/kotlin/thc/world/VillageProtection.kt</files>
  <action>
    Modify VillageProtection.kt to use position-based structure detection:

    1. Add a new private helper function `isInsideVillageStructure(level: ServerLevel, pos: BlockPos): Boolean`:
       - Get structureManager from level
       - Call `structureManager.getStructureWithPieceAt(pos, StructureTags.VILLAGE)`
       - Return `structureAt.isValid`

    2. In the PlayerBlockBreakEvents.BEFORE handler:
       - Remove the existing `ChunkValidator.isVillageChunk(serverLevel, chunkPos)` call
       - Replace with `isInsideVillageStructure(serverLevel, pos)` call
       - Keep all existing logic for ore and allowlist exceptions
       - Keep all existing logging (update messages to reflect position-based check)

    3. Remove the `import net.minecraft.world.level.ChunkPos` if no longer used

    Key change: Instead of protecting all breaks in village CHUNKS, protect only breaks at positions INSIDE village structure piece bounding boxes.

    The `getStructureWithPieceAt()` method internally checks if the position is within any StructurePiece's BoundingBox for villages in the chunk - this is the same API already used in ChunkValidator.kt line 134.
  </action>
  <verify>./gradlew build succeeds without errors</verify>
  <done>VillageProtection uses getStructureWithPieceAt(pos) instead of isVillageChunk(chunkPos)</done>
</task>

<task type="auto">
  <name>Task 2: Clean up logging for position-based checks</name>
  <files>src/main/kotlin/thc/world/VillageProtection.kt</files>
  <action>
    Update logging messages to reflect the new position-based approach:

    1. Change "VillageProtection checking block break at $pos (chunk ${chunkPos.x}, ${chunkPos.z})" to "VillageProtection checking block break at $pos"

    2. Change "isVillageChunk result" log to "isInsideVillageStructure result"

    3. Update "ALLOWING (not a village)" to "ALLOWING (not inside village structure)"

    4. Update "BLOCKING break in village!" to "BLOCKING break inside village structure!"

    5. Remove unused chunkPos variable if no longer needed

    Keep logger at info level for now (can be demoted to debug in future cleanup).
  </action>
  <verify>./gradlew build succeeds without errors</verify>
  <done>Log messages accurately describe position-based structure detection</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ./gradlew build succeeds without errors
- [ ] VillageProtection.kt uses getStructureWithPieceAt for position checking
- [ ] No reference to ChunkValidator.isVillageChunk in VillageProtection.kt
- [ ] Ore and allowlist exceptions still present
- [ ] StructureTags.VILLAGE import present
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- VillageProtection checks position against structure piece bounding boxes, not chunk membership
  </success_criteria>

<output>
After completion, create `.planning/phases/26-structure-protection/26-01-SUMMARY.md`
</output>
