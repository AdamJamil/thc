---
phase: 27-eating-mechanics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/thc/mixin/ItemEatingMixin.java
  - src/main/resources/thc.mixins.json
autonomous: true

must_haves:
  truths:
    - "Eating any food item takes 64 ticks (3.2 seconds)"
    - "Eating food sets saturation to max(food_saturation, current_saturation)"
    - "Eating while at high saturation does not waste the food's saturation"
  artifacts:
    - path: "src/main/java/thc/mixin/ItemEatingMixin.java"
      provides: "Eating duration and saturation cap modifications"
      min_lines: 40
  key_links:
    - from: "ItemEatingMixin.java"
      to: "Item.getUseDuration"
      via: "@Inject HEAD return 64 when consumable present"
      pattern: "getUseDuration.*Consumable"
    - from: "ItemEatingMixin.java"
      to: "Item.finishUsingItem"
      via: "@Inject HEAD/RETURN to capture/restore saturation"
      pattern: "finishUsingItem.*saturation"
---

<objective>
Implement eating mechanics modifications: longer eating duration and saturation cap behavior.

Purpose: Create combat commitment for eating - the 3.2 second duration makes eating mid-fight a real decision. Saturation cap prevents wasting high-saturation foods when already well-fed.

Output: ItemEatingMixin with eating duration and saturation cap modifications
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Relevant source files:
@net/minecraft/world/item/Item.java (lines 303-310 for getUseDuration, lines 209-212 for finishUsingItem)
@src/main/java/thc/mixin/FoodDataMixin.java (existing food-related mixin)
@src/main/resources/thc.mixins.json (mixin registration)

Key vanilla behavior:
- Item.getUseDuration() returns consumable.consumeTicks() for food (typically 32 ticks = 1.6s)
- Item.finishUsingItem() calls consumable.onConsume() which applies food effects including saturation
- Player.getFoodData() gives access to current saturation value
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ItemEatingMixin with eating duration modification</name>
  <files>src/main/java/thc/mixin/ItemEatingMixin.java</files>
  <action>
Create ItemEatingMixin targeting net.minecraft.world.item.Item class.

Implement eating duration modification:
- @Inject at HEAD of getUseDuration(ItemStack, LivingEntity) with cancellable=true
- Check if itemStack.get(DataComponents.CONSUMABLE) != null (food item)
- If food item, cir.setReturnValue(64) to set 64 tick eating duration
- If not food, let vanilla handle it (don't modify non-food items)

Pattern follows project conventions:
- Use thc$ prefix for mixin method names
- Include descriptive javadoc explaining the modification
- Import net.minecraft.core.component.DataComponents for CONSUMABLE check

Note: Do NOT use FOOD component check - use CONSUMABLE since that's what determines eating behavior. All foods have CONSUMABLE component.
  </action>
  <verify>./gradlew build passes without mixin warnings</verify>
  <done>ItemEatingMixin created with getUseDuration returning 64 ticks for consumables</done>
</task>

<task type="auto">
  <name>Task 2: Add saturation cap behavior to finishUsingItem</name>
  <files>src/main/java/thc/mixin/ItemEatingMixin.java</files>
  <action>
Add saturation cap logic to the same ItemEatingMixin:

Implement saturation cap via paired injections:
1. @Inject at HEAD of finishUsingItem(ItemStack, Level, LivingEntity)
   - Check if livingEntity instanceof Player and itemStack has CONSUMABLE
   - Store current saturation in @Unique thread-local or instance field: thc$priorSaturation
   - Use ((Player)livingEntity).getFoodData().getSaturationLevel()

2. @Inject at RETURN of finishUsingItem
   - After vanilla processing (which added food's saturation)
   - Get new saturation from getFoodData().getSaturationLevel()
   - Calculate maxSaturation = Math.max(thc$priorSaturation, newSaturation)
   - Set saturation to maxSaturation via FoodData.setSaturationLevel() or accessor

For setSaturationLevel access:
- FoodData.saturationLevel is private
- Create accessor mixin: src/main/java/thc/mixin/access/FoodDataAccessor.java
  @Mixin(FoodData.class)
  public interface FoodDataAccessor {
    @Accessor("saturationLevel")
    void setSaturationLevel(float level);
  }

Thread safety: Use @Unique field with ThreadLocal<Float> to handle potential concurrent eating (unlikely but safe pattern).

Pattern: Store state before vanilla call, compare after, apply max.
  </action>
  <verify>./gradlew build passes</verify>
  <done>Saturation cap implemented - eating preserves max(current, food_value)</done>
</task>

<task type="auto">
  <name>Task 3: Register mixins and verify</name>
  <files>src/main/resources/thc.mixins.json, src/main/java/thc/mixin/access/FoodDataAccessor.java</files>
  <action>
Register the new mixins in thc.mixins.json:
- Add "ItemEatingMixin" to the mixins array
- Add "access.FoodDataAccessor" to the mixins array (after existing accessors)

Run full verification:
1. ./gradlew build - must pass without errors or mixin warnings
2. Check that no "Mixin apply failed" errors appear in build output
  </action>
  <verify>./gradlew build completes successfully with no mixin errors</verify>
  <done>All mixins registered, build passes, ready for in-game testing</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./gradlew build` succeeds without errors
- [ ] No mixin apply warnings in build output
- [ ] ItemEatingMixin.java exists with both getUseDuration and finishUsingItem modifications
- [ ] FoodDataAccessor.java exists for saturation level access
- [ ] Both mixins registered in thc.mixins.json
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Eating duration modification returns 64 for consumables
- Saturation cap logic captures pre/post saturation and applies max
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/27-eating-mechanics/27-01-SUMMARY.md`
</output>
