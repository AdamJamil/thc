---
phase: 28-exhaustion-healing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/thc/mixin/FoodDataMixin.java
  - src/main/java/thc/mixin/access/FoodDataAccessor.java
autonomous: true

must_haves:
  truths:
    - "Saturation drains 21% faster than vanilla (1.21 vs 1.0 per exhaustion cycle)"
    - "Player does not heal when hunger is below 18"
    - "Player heals at 3/16 hearts per second (1 HP every 53 ticks) when hunger >= 18"
    - "Vanilla natural regeneration gamerule has no effect on healing"
    - "Saturation boost (rapid healing at hunger 20) is disabled"
  artifacts:
    - path: "src/main/java/thc/mixin/FoodDataMixin.java"
      provides: "Custom exhaustion and healing mechanics"
      contains: "thc$overrideTick"
    - path: "src/main/java/thc/mixin/access/FoodDataAccessor.java"
      provides: "Field accessors for FoodData private fields"
      exports: ["setExhaustionLevel", "getTickTimer", "setTickTimer"]
  key_links:
    - from: "FoodDataMixin"
      to: "FoodData.tick()"
      via: "HEAD cancellation with full reimplementation"
      pattern: "@Inject.*HEAD.*cancellable.*true"
---

<objective>
Implement custom exhaustion and healing mechanics that replace vanilla FoodData behavior.

Purpose: Create a healing system where:
1. Saturation drains faster (4.0 exhaustion removes 1.21 saturation instead of 1.0)
2. Healing requires 9 full hunger bars (>= 18)
3. Base healing rate is 3/16 hearts per second
4. Vanilla natural regeneration gamerule is bypassed
5. Saturation boost (rapid healing at full hunger) is disabled

Output: Modified FoodDataMixin with complete tick() override and expanded FoodDataAccessor
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-exhaustion-healing/28-RESEARCH.md

# Prior work (Phase 27 established patterns)
@.planning/phases/27-eating-mechanics/27-01-SUMMARY.md

# Existing implementation to modify
@src/main/java/thc/mixin/FoodDataMixin.java
@src/main/java/thc/mixin/access/FoodDataAccessor.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand FoodDataAccessor for tick() override</name>
  <files>src/main/java/thc/mixin/access/FoodDataAccessor.java</files>
  <action>
Add accessors for all FoodData private fields needed for tick() override:
- @Accessor("exhaustionLevel") float getExhaustionLevel()
- @Accessor("exhaustionLevel") void setExhaustionLevel(float level)
- @Accessor("tickTimer") int getTickTimer()
- @Accessor("tickTimer") void setTickTimer(int timer)
- @Accessor("lastFoodLevel") int getLastFoodLevel()
- @Accessor("lastFoodLevel") void setLastFoodLevel(int level)

Keep existing setSaturationLevel accessor. The interface already exists, just add new methods.
  </action>
  <verify>Build succeeds with `./gradlew build`</verify>
  <done>FoodDataAccessor has all field accessors for exhaustion, saturation, tickTimer, and lastFoodLevel</done>
</task>

<task type="auto">
  <name>Task 2: Replace FoodDataMixin with full tick() override</name>
  <files>src/main/java/thc/mixin/FoodDataMixin.java</files>
  <action>
Replace existing FoodDataMixin (which only halves regen) with complete tick() override:

1. Add @Shadow fields for foodLevel (has public getter but need for direct access)
2. Use @Inject at HEAD with cancellable=true to fully override tick()
3. Implement custom tick logic:

```java
@Inject(method = "tick", at = @At("HEAD"), cancellable = true)
private void thc$overrideTick(Player player, CallbackInfo ci) {
    FoodDataAccessor accessor = (FoodDataAccessor) (Object) this;
    Difficulty difficulty = player.level().getDifficulty();

    // Update last food level
    accessor.setLastFoodLevel(this.foodLevel);

    // EXHAUSTION PROCESSING (modified: 1.21 saturation drain instead of 1.0)
    float exhaustion = accessor.getExhaustionLevel();
    if (exhaustion > 4.0F) {
        accessor.setExhaustionLevel(exhaustion - 4.0F);
        float saturation = this.getSaturationLevel();
        if (saturation > 0.0F) {
            // THC: Drain 1.21 saturation instead of vanilla 1.0
            accessor.setSaturationLevel(Math.max(saturation - 1.21F, 0.0F));
        } else if (difficulty != Difficulty.PEACEFUL) {
            this.foodLevel = Math.max(this.foodLevel - 1, 0);
        }
    }

    // CUSTOM HEALING (ignores naturalRegeneration gamerule)
    // Heal at 3/16 hearts/second = 1 HP every ~53 ticks when hunger >= 18
    if (this.foodLevel >= 18 && player.isHurt()) {
        int timer = accessor.getTickTimer();
        accessor.setTickTimer(timer + 1);
        if (timer >= 53) {
            player.heal(1.0F);
            this.addExhaustion(6.0F);  // Keep vanilla exhaustion cost
            accessor.setTickTimer(0);
        }
    }
    // STARVATION (keep vanilla behavior)
    else if (this.foodLevel <= 0) {
        int timer = accessor.getTickTimer();
        accessor.setTickTimer(timer + 1);
        if (timer >= 80) {
            if (player.getHealth() > 10.0F || difficulty == Difficulty.HARD
                || player.getHealth() > 1.0F && difficulty == Difficulty.NORMAL) {
                player.hurt(player.damageSources().starve(), 1.0F);
            }
            accessor.setTickTimer(0);
        }
    }
    // RESET TIMER (no healing or starvation)
    else {
        accessor.setTickTimer(0);
    }

    ci.cancel();  // Skip vanilla tick entirely
}
```

Remove the old thc$halveNaturalRegen @ModifyArg - it's superseded by the full override.

IMPORTANT:
- Saturation boost (rapid healing at hunger 20) is disabled by NOT implementing it
- naturalRegeneration gamerule is bypassed by NOT checking it
- foodLevel field needs @Shadow since we write to it
  </action>
  <verify>Build succeeds with `./gradlew build`</verify>
  <done>FoodDataMixin fully overrides tick() with custom exhaustion (1.21 drain), healing (53 tick rate, >= 18 gate), and bypassed gamerule</done>
</task>

<task type="auto">
  <name>Task 3: Test and verify mechanics</name>
  <files>None - verification only</files>
  <action>
Run build and verify no mixin errors:
1. Run `./gradlew build` - must complete without errors
2. Check for mixin application warnings in build output
3. Verify FoodDataMixin and FoodDataAccessor are registered in thc.mixins.json

Manual verification points (document for user):
- Saturation drains faster than vanilla (observable with debug screen F3)
- Healing only occurs at hunger >= 18
- Healing rate is noticeably slower than vanilla (1 HP every ~2.65 seconds vs vanilla 4 seconds at low hunger, but vanilla has faster saturation boost)
- Saturation boost at full hunger is disabled
  </action>
  <verify>./gradlew build completes without errors</verify>
  <done>Build passes, mixin registration verified, mechanics documented</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./gradlew build` succeeds without errors
- [ ] No mixin warnings about failed injections
- [ ] FoodDataAccessor has all required field accessors
- [ ] FoodDataMixin has complete tick() override
- [ ] Old @ModifyArg method removed (superseded by override)
</verification>

<success_criteria>

- All tasks completed
- Build passes without mixin errors
- FoodData.tick() fully overridden with:
  - 1.21 saturation drain per exhaustion cycle (HEAL-03)
  - Healing gate at hunger >= 18 (HEAL-04)
  - 3/16 hearts/second healing rate (HEAL-05)
  - naturalRegeneration gamerule bypassed (HEAL-11)
  - Saturation boost disabled
</success_criteria>

<output>
After completion, create `.planning/phases/28-exhaustion-healing/28-01-SUMMARY.md`
</output>
