---
phase: 31-apple-bonemeal
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/resources/data/minecraft/loot_table/blocks/oak_leaves.json
  - src/main/resources/data/minecraft/loot_table/blocks/dark_oak_leaves.json
  - src/main/resources/data/minecraft/loot_table/blocks/birch_leaves.json
  - src/main/resources/data/minecraft/loot_table/blocks/spruce_leaves.json
  - src/main/resources/data/minecraft/loot_table/blocks/jungle_leaves.json
  - src/main/resources/data/minecraft/loot_table/blocks/acacia_leaves.json
  - src/main/resources/data/minecraft/loot_table/blocks/cherry_leaves.json
  - src/main/resources/data/minecraft/loot_table/blocks/azalea_leaves.json
  - src/main/resources/data/minecraft/loot_table/blocks/mangrove_leaves.json
  - src/main/java/thc/mixin/CropBlockMixin.java
  - src/main/resources/thc.mixins.json
  - src/main/resources/data/minecraft/recipe/bone_meal.json
  - src/main/java/thc/mixin/RecipeManagerMixin.java
autonomous: true

must_haves:
  truths:
    - "Apples drop from any leaf type when broken"
    - "Apple drop rate is approximately 5x vanilla (2.5% base vs 0.5%)"
    - "Bonemeal fully matures any crop in one use"
    - "Bone crafts into 6 bonemeal"
  artifacts:
    - path: "src/main/resources/data/minecraft/loot_table/blocks/oak_leaves.json"
      provides: "Apple drops from oak leaves at 5x rate"
      contains: "0.025"
    - path: "src/main/resources/data/minecraft/loot_table/blocks/birch_leaves.json"
      provides: "Apple drops from birch leaves"
      contains: "minecraft:apple"
    - path: "src/main/java/thc/mixin/CropBlockMixin.java"
      provides: "Instant crop maturation on bonemeal"
      contains: "getMaxAge"
    - path: "src/main/resources/data/minecraft/recipe/bone_meal.json"
      provides: "6 bonemeal from 1 bone"
      contains: "\"count\": 6"
  key_links:
    - from: "CropBlockMixin.java"
      to: "CropBlock.grow"
      via: "HEAD injection with ci.cancel()"
      pattern: "@Inject.*method.*grow"
    - from: "bone_meal.json"
      to: "RecipeManagerMixin"
      via: "vanilla recipe filtered"
      pattern: "bone_meal"
---

<objective>
Improve early-game food availability and farming efficiency.

Purpose: Make apples accessible from all leaf types (not just oak/dark oak), increase apple drop rate to 5x vanilla for reliable early food, make bonemeal fully mature crops in one use for efficient farming, and double bonemeal yield from bones.
Output: 9 leaf loot table overrides, CropBlockMixin for instant growth, bone_meal recipe override.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/main/java/thc/mixin/RecipeManagerMixin.java
@src/main/resources/thc.mixins.json
@src/main/resources/data/minecraft/loot_table/blocks/smooth_stone.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create leaf loot tables with 5x apple drops</name>
  <files>
    src/main/resources/data/minecraft/loot_table/blocks/oak_leaves.json,
    src/main/resources/data/minecraft/loot_table/blocks/dark_oak_leaves.json,
    src/main/resources/data/minecraft/loot_table/blocks/birch_leaves.json,
    src/main/resources/data/minecraft/loot_table/blocks/spruce_leaves.json,
    src/main/resources/data/minecraft/loot_table/blocks/jungle_leaves.json,
    src/main/resources/data/minecraft/loot_table/blocks/acacia_leaves.json,
    src/main/resources/data/minecraft/loot_table/blocks/cherry_leaves.json,
    src/main/resources/data/minecraft/loot_table/blocks/azalea_leaves.json,
    src/main/resources/data/minecraft/loot_table/blocks/mangrove_leaves.json
  </files>
  <action>
    Create 9 loot table JSON files that override vanilla leaf block drops.

    Each loot table should have:
    1. Pool for silk touch/shears: Drop the leaf block itself
    2. Pool for saplings: Use vanilla sapling drop rates (5% base with fortune bonus)
    3. Pool for sticks: Use vanilla stick drop rates (2% base, 1-2 sticks)
    4. Pool for apples: 5x vanilla rate (2.5% base instead of 0.5%)

    Apple pool structure (5x vanilla chances):
    ```json
    {
      "bonus_rolls": 0.0,
      "conditions": [
        {
          "condition": "minecraft:inverted",
          "term": {
            "condition": "minecraft:match_tool",
            "predicate": {
              "predicates": {
                "minecraft:enchantments": [
                  { "enchantments": "minecraft:silk_touch", "levels": { "min": 1 } }
                ]
              }
            }
          }
        }
      ],
      "entries": [
        {
          "type": "minecraft:item",
          "conditions": [
            { "condition": "minecraft:survives_explosion" },
            {
              "condition": "minecraft:table_bonus",
              "enchantment": "minecraft:fortune",
              "chances": [0.025, 0.027777778, 0.03125, 0.041666668, 0.125]
            }
          ],
          "name": "minecraft:apple"
        }
      ],
      "rolls": 1.0
    }
    ```

    Note: These chances are 5x vanilla (0.005 → 0.025, etc.)

    For each leaf type, use the correct sapling:
    - oak_leaves → oak_sapling
    - dark_oak_leaves → dark_oak_sapling
    - birch_leaves → birch_sapling
    - spruce_leaves → spruce_sapling
    - jungle_leaves → jungle_sapling
    - acacia_leaves → acacia_sapling
    - cherry_leaves → cherry_sapling
    - azalea_leaves → azalea (not azalea_sapling - it's just "azalea")
    - mangrove_leaves → mangrove_propagule

    IMPORTANT: flowering_azalea_leaves needs separate handling if different, but azalea_leaves covers base case.
  </action>
  <verify>All 9 JSON files exist and parse as valid JSON</verify>
  <done>9 leaf loot tables created with apple drops at 5x rate, matching correct sapling types</done>
</task>

<task type="auto">
  <name>Task 2: Create CropBlockMixin for instant bonemeal growth</name>
  <files>
    src/main/java/thc/mixin/CropBlockMixin.java,
    src/main/resources/thc.mixins.json
  </files>
  <action>
    Create a mixin targeting CropBlock to make bonemeal fully mature crops instantly.

    Target method: grow(ServerWorld world, Random random, BlockPos pos, BlockState state)
    This is called from the Fertilizable interface when bonemeal is used.

    Implementation approach:
    1. HEAD inject with cancellable=true on grow method
    2. Get max age via getMaxAge()
    3. Set block state to withAge(getMaxAge())
    4. Cancel original method (ci.cancel())

    Pattern (use MoJang mappings - this project uses them):
    ```java
    @Mixin(CropBlock.class)
    public abstract class CropBlockMixin {
        @Shadow public abstract int getMaxAge();
        @Shadow public abstract BlockState getStateForAge(int age);

        @Inject(
            method = "performBonemeal",
            at = @At("HEAD"),
            cancellable = true
        )
        private void thc$instantGrowth(ServerLevel level, RandomSource random, BlockPos pos, BlockState state, CallbackInfo ci) {
            level.setBlock(pos, this.getStateForAge(this.getMaxAge()), 2);
            ci.cancel();
        }
    }
    ```

    Note: In MoJang mappings, the method may be `performBonemeal` not `grow`. Check the actual method name in 1.21.4.
    The method signature is: performBonemeal(ServerLevel, RandomSource, BlockPos, BlockState)

    Register the mixin in thc.mixins.json.
  </action>
  <verify>
    Build succeeds: ./gradlew build
    Mixin registered in thc.mixins.json
  </verify>
  <done>CropBlockMixin created and registered, bonemeal fully matures crops in one use</done>
</task>

<task type="auto">
  <name>Task 3: Override bone_meal recipe for 6 output</name>
  <files>
    src/main/resources/data/minecraft/recipe/bone_meal.json,
    src/main/java/thc/mixin/RecipeManagerMixin.java
  </files>
  <action>
    1. Add "bone_meal" to REMOVED_RECIPE_PATHS in RecipeManagerMixin.java

    2. Create custom recipe at src/main/resources/data/minecraft/recipe/bone_meal.json:
    ```json
    {
      "type": "minecraft:crafting_shapeless",
      "category": "misc",
      "ingredients": [
        "minecraft:bone"
      ],
      "result": {
        "count": 6,
        "id": "minecraft:bone_meal"
      }
    }
    ```

    This overrides vanilla's 3 bonemeal output with 6.
  </action>
  <verify>
    Recipe JSON parses as valid JSON
    RecipeManagerMixin includes "bone_meal" in REMOVED_RECIPE_PATHS
  </verify>
  <done>Bone crafts into 6 bonemeal instead of 3</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 9 leaf loot table JSON files exist and are valid
- [ ] CropBlockMixin compiles without errors
- [ ] bone_meal.json recipe file exists
- [ ] RecipeManagerMixin updated with "bone_meal" filter
- [ ] `./gradlew build` succeeds
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No build errors
- Apples can drop from all 9 leaf types
- Apple drop rate is 5x vanilla (2.5% base)
- Bonemeal fully matures crops
- Bone yields 6 bonemeal
</success_criteria>

<output>
After completion, create `.planning/phases/31-apple-bonemeal/31-01-SUMMARY.md`
</output>
