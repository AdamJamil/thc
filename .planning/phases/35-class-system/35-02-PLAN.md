---
phase: 35-class-system
plan: 02
type: execute
wave: 2
depends_on: ["35-01"]
files_modified:
  - src/main/java/thc/mixin/PlayerAttackMixin.java
  - src/main/java/thc/mixin/AbstractArrowMixin.java
autonomous: true

must_haves:
  truths:
    - "Melee damage is multiplied by class melee multiplier"
    - "Ranged damage is multiplied by class ranged multiplier"
    - "Players without a class deal default damage (1.0x multipliers)"
    - "Tank deals x2.5 melee, x1 ranged"
    - "Melee class deals x4 melee, x1 ranged"
    - "Ranged class deals x1 melee, x5 ranged"
    - "Support class deals x1 melee, x3 ranged"
  artifacts:
    - path: "src/main/java/thc/mixin/PlayerAttackMixin.java"
      provides: "Class-based melee damage multiplication"
      contains: "ClassManager.getClass"
    - path: "src/main/java/thc/mixin/AbstractArrowMixin.java"
      provides: "Class-based ranged damage multiplication"
      contains: "ClassManager.getClass"
  key_links:
    - from: "PlayerAttackMixin.java"
      to: "ClassManager.getClass"
      via: "melee multiplier lookup"
      pattern: "ClassManager\\.getClass.*getMeleeMultiplier"
    - from: "AbstractArrowMixin.java"
      to: "ClassManager.getClass"
      via: "ranged multiplier lookup"
      pattern: "ClassManager\\.getClass.*getRangedMultiplier"
---

<objective>
Integrate class-based damage multipliers into existing melee and ranged damage mixins.

Purpose: Complete the class system by making damage output scale with selected class role.
Output: Modified PlayerAttackMixin with melee multipliers, modified AbstractArrowMixin with ranged multipliers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/35-class-system/35-CONTEXT.md
@.planning/phases/35-class-system/35-RESEARCH.md
@.planning/phases/35-class-system/35-01-SUMMARY.md

# Files to modify
@src/main/java/thc/mixin/PlayerAttackMixin.java
@src/main/java/thc/mixin/AbstractArrowMixin.java

# Class system from Plan 01
@src/main/java/thc/playerclass/PlayerClass.java
@src/main/java/thc/playerclass/ClassManager.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add class-based melee damage multiplier</name>
  <files>src/main/java/thc/mixin/PlayerAttackMixin.java</files>
  <action>
Modify the existing thc$reduceMeleeDamage method in PlayerAttackMixin.java to apply class-based multipliers AFTER the existing 18.75% reduction.

Current code:
```java
@ModifyVariable(method = "attack", at = @At(value = "STORE"), ordinal = 0)
private float thc$reduceMeleeDamage(float originalDamage) {
    return originalDamage * 0.1875f;
}
```

Updated code:
```java
@ModifyVariable(method = "attack", at = @At(value = "STORE"), ordinal = 0)
private float thc$reduceMeleeDamage(float originalDamage) {
    float baseDamage = originalDamage * 0.1875f;  // Existing 81.25% reduction

    // Apply class-based melee multiplier
    Player self = (Player) (Object) this;
    if (self instanceof ServerPlayer serverPlayer) {
        PlayerClass playerClass = ClassManager.getClass(serverPlayer);
        if (playerClass != null) {
            baseDamage *= (float) playerClass.getMeleeMultiplier();
        }
    }

    return baseDamage;
}
```

Add required imports:
- import net.minecraft.server.level.ServerPlayer;
- import thc.playerclass.ClassManager;
- import thc.playerclass.PlayerClass;

NOTE: This preserves the critical balance value (0.1875f multiplier) from CLAUDE.md. The class multiplier is applied AFTER the base reduction, not replacing it.
  </action>
  <verify>
    - Compile: `cd /mnt/c/home/code/thc && ./gradlew compileJava`
    - Verify 0.1875f constant is unchanged
    - Verify class multiplier is applied after base reduction
  </verify>
  <done>
    - PlayerAttackMixin applies class melee multiplier
    - Base 18.75% reduction preserved (CLAUDE.md critical value)
    - Players without class get 1.0x multiplier (no change)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add class-based ranged damage multiplier</name>
  <files>src/main/java/thc/mixin/AbstractArrowMixin.java</files>
  <action>
Modify the existing thc$applyArrowHitEffects method in AbstractArrowMixin.java to apply class-based ranged multiplier.

Current code applies a fixed 13% reduction:
```java
thc$originalBaseDamage = baseDamage;
baseDamage = baseDamage * 0.13;
```

Updated code - apply class multiplier after base reduction:
```java
thc$originalBaseDamage = baseDamage;

// Apply base reduction then class multiplier
double reducedDamage = baseDamage * 0.13;

// Apply class-based ranged multiplier
PlayerClass playerClass = ClassManager.getClass(player);
if (playerClass != null) {
    reducedDamage *= playerClass.getRangedMultiplier();
}

baseDamage = reducedDamage;
```

The full method should look like:
```java
@Inject(method = "onHitEntity", at = @At("HEAD"))
private void thc$applyArrowHitEffects(EntityHitResult entityHitResult, CallbackInfo ci) {
    AbstractArrow self = (AbstractArrow) (Object) this;
    Entity owner = self.getOwner();

    if (!(owner instanceof ServerPlayer player)) {
        return;
    }

    // Store original damage and apply reductions
    thc$originalBaseDamage = baseDamage;

    // Apply base reduction (87% reduction to 13% of original)
    double reducedDamage = baseDamage * 0.13;

    // Apply class-based ranged multiplier
    PlayerClass playerClass = ClassManager.getClass(player);
    if (playerClass != null) {
        reducedDamage *= playerClass.getRangedMultiplier();
    }

    baseDamage = reducedDamage;

    // Rest of existing code (effects, threat)...
}
```

Add required imports:
- import thc.playerclass.ClassManager;
- import thc.playerclass.PlayerClass;
  </action>
  <verify>
    - Compile: `cd /mnt/c/home/code/thc && ./gradlew compileJava`
    - Verify 0.13 constant is unchanged
    - Verify class multiplier is applied after base reduction
  </verify>
  <done>
    - AbstractArrowMixin applies class ranged multiplier
    - Base 13% reduction preserved
    - Players without class get 1.0x multiplier (no change)
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Compile check:** `./gradlew build` completes without errors
2. **Smoke test:** `./gradlew runServer -Dthc.smokeTest=true` passes (100 ticks)

Code verification:
- `grep -r "ClassManager.getClass" src/main/java/thc/mixin/` shows both mixins use class lookup
- `grep -r "getMeleeMultiplier" src/main/java/thc/mixin/` shows melee multiplier applied
- `grep -r "getRangedMultiplier" src/main/java/thc/mixin/` shows ranged multiplier applied
- Verify 0.1875f and 0.13 base reduction values are preserved

Damage calculation verification (conceptual):
- No class: base * 0.1875 (melee) or base * 0.13 (ranged)
- Tank melee: base * 0.1875 * 2.5 = base * 0.46875
- Melee class melee: base * 0.1875 * 4 = base * 0.75
- Ranged class ranged: base * 0.13 * 5 = base * 0.65
- Support ranged: base * 0.13 * 3 = base * 0.39
</verification>

<success_criteria>
- Melee damage multiplied by class melee multiplier after base reduction
- Ranged damage multiplied by class ranged multiplier after base reduction
- Base reduction values (0.1875f melee, 0.13 ranged) preserved
- Players without class experience no change (1.0x multiplier)
- All 4 class multipliers correctly applied:
  - Tank: x2.5 melee, x1 ranged
  - Melee: x4 melee, x1 ranged
  - Ranged: x1 melee, x5 ranged
  - Support: x1 melee, x3 ranged
</success_criteria>

<output>
After completion, create `.planning/phases/35-class-system/35-02-SUMMARY.md`
</output>
