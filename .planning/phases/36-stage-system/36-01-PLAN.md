---
phase: 36-stage-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/kotlin/thc/stage/StageData.kt
  - src/main/java/thc/THCAttachments.java
  - src/main/java/thc/stage/StageManager.java
autonomous: true

must_haves:
  truths:
    - "Server-wide stage is stored in SavedData and persists across restarts"
    - "Stage starts at 1 and can advance up to 5"
    - "Per-player boon level is stored as persistent integer attachment"
    - "Boon level persists across death (copyOnDeath)"
    - "StageManager provides CRUD operations for stage and boon level"
  artifacts:
    - path: "src/main/kotlin/thc/stage/StageData.kt"
      provides: "Server-wide stage SavedData"
      contains: "thc_stage"
    - path: "src/main/java/thc/THCAttachments.java"
      provides: "BOON_LEVEL attachment"
      contains: "BOON_LEVEL"
    - path: "src/main/java/thc/stage/StageManager.java"
      provides: "Static utility for stage/boon CRUD"
      exports: ["getCurrentStage", "advanceStage", "getBoonLevel"]
  key_links:
    - from: "StageManager.java"
      to: "StageData.kt"
      via: "server state access"
      pattern: "StageData\\.getServerState"
    - from: "StageManager.java"
      to: "THCAttachments.BOON_LEVEL"
      via: "attachment access"
      pattern: "THCAttachments\\.BOON_LEVEL"
---

<objective>
Create the stage system data foundation: SavedData for server-wide stage persistence, integer attachment for per-player boon level, and StageManager utility for CRUD operations.

Purpose: Establish the persistent state infrastructure needed for /advanceStage command and boon level tracking.
Output: Working StageData (SavedData), BOON_LEVEL attachment, StageManager utility.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-stage-system/36-CONTEXT.md
@.planning/phases/36-stage-system/36-RESEARCH.md

# Existing patterns to follow
@src/main/kotlin/thc/claim/ClaimData.kt
@src/main/java/thc/THCAttachments.java
@src/main/java/thc/playerclass/ClassManager.java
@src/main/java/thc/threat/ThreatManager.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StageData SavedData and BOON_LEVEL attachment</name>
  <files>
    src/main/kotlin/thc/stage/StageData.kt
    src/main/java/thc/THCAttachments.java
  </files>
  <action>
1. Create src/main/kotlin/thc/stage/StageData.kt following ClaimData.kt pattern:
   ```kotlin
   package thc.stage

   import com.mojang.serialization.Codec
   import com.mojang.serialization.codecs.RecordCodecBuilder
   import net.minecraft.server.MinecraftServer
   import net.minecraft.util.datafix.DataFixTypes
   import net.minecraft.world.level.Level
   import net.minecraft.world.level.saveddata.SavedData
   import net.minecraft.world.level.saveddata.SavedDataType

   class StageData(currentStage: Int = 1) : SavedData() {

       var currentStage: Int = currentStage
           private set

       fun advanceStage(): Boolean {
           if (currentStage >= 5) return false
           currentStage++
           setDirty()
           return true
       }

       companion object {
           private const val DATA_NAME = "thc_stage"

           private val CODEC: Codec<StageData> = RecordCodecBuilder.create { instance ->
               instance.group(
                   Codec.INT.fieldOf("current_stage").forGetter { it.currentStage }
               ).apply(instance, ::StageData)
           }

           val TYPE: SavedDataType<StageData> = SavedDataType(
               DATA_NAME,
               ::StageData,
               CODEC,
               DataFixTypes.LEVEL
           )

           @JvmStatic
           fun getServerState(server: MinecraftServer): StageData {
               val overworld = server.getLevel(Level.OVERWORLD)
                   ?: throw IllegalStateException("Overworld not loaded")
               return overworld.dataStorage.computeIfAbsent(TYPE)
           }
       }
   }
   ```

2. Add BOON_LEVEL attachment to THCAttachments.java:
   - Add after PLAYER_CLASS attachment:
   ```java
   public static final AttachmentType<Integer> BOON_LEVEL = AttachmentRegistry.create(
       Identifier.fromNamespaceAndPath("thc", "boon_level"),
       builder -> {
           builder.initializer(() -> 0);
           builder.persistent(Codec.INT);
           builder.copyOnDeath();
       }
   );
   ```
  </action>
  <verify>
    - Compile: `cd /mnt/c/home/code/thc && ./gradlew compileJava compileKotlin`
    - Verify StageData.kt compiles without errors
    - Verify BOON_LEVEL attachment is properly typed as Integer
  </verify>
  <done>
    - StageData.kt exists with Codec serialization, advanceStage() method, getServerState() accessor
    - StageData enforces stage range 1-5 (advanceStage returns false at 5)
    - BOON_LEVEL attachment registered with persistent(Codec.INT) and copyOnDeath()
  </done>
</task>

<task type="auto">
  <name>Task 2: Create StageManager static utility</name>
  <files>
    src/main/java/thc/stage/StageManager.java
  </files>
  <action>
Create src/main/java/thc/stage/StageManager.java following ThreatManager/ClassManager pattern:

```java
package thc.stage;

import net.minecraft.ChatFormatting;
import net.minecraft.network.chat.Component;
import net.minecraft.server.MinecraftServer;
import net.minecraft.server.level.ServerPlayer;
import thc.THCAttachments;

/**
 * Static utility for stage and boon level CRUD operations.
 * Stage is server-wide (stored in StageData SavedData).
 * Boon level is per-player (stored in BOON_LEVEL attachment).
 */
public final class StageManager {
    private StageManager() {}

    /**
     * Get the current server-wide stage (1-5).
     */
    public static int getCurrentStage(MinecraftServer server) {
        return StageData.getServerState(server).getCurrentStage();
    }

    /**
     * Advance the server to the next stage.
     * Increments all online players' boon levels and broadcasts announcement.
     * @return true if stage advanced, false if already at max (5)
     */
    public static boolean advanceStage(MinecraftServer server) {
        StageData state = StageData.getServerState(server);
        if (!state.advanceStage()) return false;

        // Increment all online players' boon levels
        int newStage = state.getCurrentStage();
        for (ServerPlayer player : server.getPlayerList().getPlayers()) {
            incrementBoonLevel(player);
        }

        // Broadcast to all players via actionbar
        Component message = Component.literal("Trial complete. The world has advanced to Stage " + newStage + ".")
            .withStyle(ChatFormatting.RED);
        for (ServerPlayer player : server.getPlayerList().getPlayers()) {
            player.displayClientMessage(message, true); // true = actionbar
        }

        return true;
    }

    /**
     * Get a player's current boon level.
     */
    public static int getBoonLevel(ServerPlayer player) {
        Integer level = player.getAttached(THCAttachments.BOON_LEVEL);
        return level != null ? level : 0;
    }

    /**
     * Increment a player's boon level by 1.
     */
    public static void incrementBoonLevel(ServerPlayer player) {
        int current = getBoonLevel(player);
        player.setAttached(THCAttachments.BOON_LEVEL, current + 1);
    }

    /**
     * Set a player's boon level to a specific value.
     * Used for late-joiner initialization.
     */
    public static void setBoonLevel(ServerPlayer player, int level) {
        player.setAttached(THCAttachments.BOON_LEVEL, level);
    }
}
```
  </action>
  <verify>
    - Compile: `cd /mnt/c/home/code/thc && ./gradlew compileJava compileKotlin`
    - Verify StageManager references StageData correctly
    - Verify StageManager references THCAttachments.BOON_LEVEL correctly
  </verify>
  <done>
    - StageManager.java exists with getCurrentStage, advanceStage, getBoonLevel, incrementBoonLevel, setBoonLevel
    - advanceStage() increments all online players' boon levels
    - advanceStage() broadcasts red actionbar message to all players
    - getBoonLevel() handles null attachment gracefully (returns 0)
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Compile check:** `./gradlew build` completes without errors
2. **Smoke test:** `./gradlew runServer -Dthc.smokeTest=true` passes (100 ticks)

Code verification (grep):
- `grep -r "thc_stage" src/main/kotlin/thc/` shows StageData data name
- `grep -r "BOON_LEVEL" src/main/java/thc/` shows attachment in THCAttachments
- `grep -r "StageData.getServerState" src/main/java/thc/` shows StageManager using StageData
</verification>

<success_criteria>
- StageData SavedData exists with Codec serialization and persists to world save
- Stage starts at 1, can advance up to 5, advanceStage() returns false at max
- setDirty() is called after stage modification for persistence
- BOON_LEVEL attachment exists with persistent(Codec.INT) and copyOnDeath()
- StageManager provides clean API: getCurrentStage, advanceStage, getBoonLevel, setBoonLevel
- advanceStage() increments all online players' boon levels and broadcasts red actionbar message
</success_criteria>

<output>
After completion, create `.planning/phases/36-stage-system/36-01-SUMMARY.md`
</output>
