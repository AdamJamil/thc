---
phase: 36-stage-system
plan: 02
type: execute
wave: 2
depends_on: ["36-01"]
files_modified:
  - src/main/java/thc/stage/AdvanceStageCommand.java
  - src/main/kotlin/thc/THC.kt
autonomous: true

must_haves:
  truths:
    - "/advanceStage command exists and requires operator permission level 2"
    - "Command advances server stage and broadcasts to all players"
    - "Command returns error when already at stage 5"
    - "Late-joining players get boon level matching current stage"
    - "Command works from console when no players online"
  artifacts:
    - path: "src/main/java/thc/stage/AdvanceStageCommand.java"
      provides: "Op-only /advanceStage command"
      exports: ["register"]
    - path: "src/main/kotlin/thc/THC.kt"
      provides: "Command and event registration"
      contains: "AdvanceStageCommand.register"
  key_links:
    - from: "AdvanceStageCommand.java"
      to: "StageManager"
      via: "stage advancement"
      pattern: "StageManager\\.(getCurrentStage|advanceStage)"
    - from: "THC.kt"
      to: "StageManager"
      via: "late-joiner boon init"
      pattern: "StageManager\\.setBoonLevel"
---

<objective>
Create the /advanceStage command with operator permissions and implement late-joiner boon level initialization.

Purpose: Enable operators to advance server stage and ensure new players joining a progressed server receive appropriate boon levels.
Output: Working /advanceStage command, late-joiner event handler, full stage system integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-stage-system/36-CONTEXT.md
@.planning/phases/36-stage-system/36-RESEARCH.md
@.planning/phases/36-stage-system/36-01-SUMMARY.md

# Existing patterns to follow
@src/main/java/thc/playerclass/SelectClassCommand.java
@src/main/kotlin/thc/THC.kt
@src/main/java/thc/stage/StageManager.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /advanceStage command</name>
  <files>
    src/main/java/thc/stage/AdvanceStageCommand.java
  </files>
  <action>
Create src/main/java/thc/stage/AdvanceStageCommand.java following SelectClassCommand pattern:

```java
package thc.stage;

import com.mojang.brigadier.context.CommandContext;
import net.fabricmc.fabric.api.command.v2.CommandRegistrationCallback;
import net.minecraft.ChatFormatting;
import net.minecraft.commands.CommandSourceStack;
import net.minecraft.commands.Commands;
import net.minecraft.network.chat.Component;
import net.minecraft.server.MinecraftServer;

/**
 * Operator-only command to advance the server to the next stage.
 * Requires permission level 2 (operator).
 */
public final class AdvanceStageCommand {
    private AdvanceStageCommand() {}

    public static void register() {
        CommandRegistrationCallback.EVENT.register((dispatcher, registryAccess, environment) -> {
            dispatcher.register(Commands.literal("advanceStage")
                .requires(source -> source.hasPermissionLevel(2)) // Op level 2+
                .executes(AdvanceStageCommand::execute));
        });
    }

    private static int execute(CommandContext<CommandSourceStack> context) {
        MinecraftServer server = context.getSource().getServer();

        int currentStage = StageManager.getCurrentStage(server);
        if (currentStage >= 5) {
            context.getSource().sendFailure(
                Component.literal("Already at maximum stage (5)!").withStyle(ChatFormatting.RED)
            );
            return 0;
        }

        if (StageManager.advanceStage(server)) {
            context.getSource().sendSuccess(
                () -> Component.literal("Advanced to Stage " + StageManager.getCurrentStage(server))
                    .withStyle(ChatFormatting.GREEN),
                true // broadcast to ops
            );
            return 1;
        }

        // Should not reach here, but handle gracefully
        context.getSource().sendFailure(
            Component.literal("Failed to advance stage").withStyle(ChatFormatting.RED)
        );
        return 0;
    }
}
```

Key points:
- `.requires(source -> source.hasPermissionLevel(2))` restricts to operators
- Check current stage before advancing to provide meaningful error at max
- Use sendSuccess with broadcast=true so other ops see the advancement
- advanceStage() handles all the work (boon increments, player broadcast)
  </action>
  <verify>
    - Compile: `cd /mnt/c/home/code/thc && ./gradlew compileJava`
    - Verify command uses permission level 2 check
    - Verify command calls StageManager.advanceStage()
  </verify>
  <done>
    - AdvanceStageCommand.java exists with register() method
    - Command requires permission level 2 (operator)
    - Command shows error when already at stage 5
    - Command provides green success message to operator
    - Command broadcasts advancement to all ops via sendSuccess
  </done>
</task>

<task type="auto">
  <name>Task 2: Register command and late-joiner event</name>
  <files>
    src/main/kotlin/thc/THC.kt
  </files>
  <action>
Update src/main/kotlin/thc/THC.kt:

1. Add imports at top:
   ```kotlin
   import thc.stage.AdvanceStageCommand
   import thc.stage.StageManager
   import thc.playerclass.ClassManager
   ```

2. Register command in onInitialize() after SelectClassCommand.register():
   ```kotlin
   AdvanceStageCommand.register()
   ```

3. Add late-joiner boon initialization event. Add after existing ServerPlayConnectionEvents.DISCONNECT handler:
   ```kotlin
   ServerPlayConnectionEvents.JOIN.register(ServerPlayConnectionEvents.Join { handler, sender, server ->
       val player = handler.player

       // New players (no class yet) get boon level matching current stage
       // Returning players (have class) keep their accumulated boon level
       if (!ClassManager.hasClass(player)) {
           val currentStage = StageManager.getCurrentStage(server)
           StageManager.setBoonLevel(player, currentStage)
       }
   })
   ```

Key points:
- Only set boon for new players (!hasClass) - returning players keep their accumulated boon
- New player at stage 3 server gets boon level 3
- Stage 1 server: new players get boon level 1 (not 0)
  </action>
  <verify>
    - Compile: `cd /mnt/c/home/code/thc && ./gradlew compileJava compileKotlin`
    - Smoke test: `cd /mnt/c/home/code/thc && ./gradlew runServer -Dthc.smokeTest=true`
    - Verify AdvanceStageCommand.register() is called
    - Verify JOIN event handler uses ClassManager.hasClass check
  </verify>
  <done>
    - AdvanceStageCommand.register() called in THC.onInitialize()
    - ServerPlayConnectionEvents.JOIN handler registered for late-joiner boon init
    - New players get boon level = current stage
    - Returning players (have class) keep existing boon level
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Compile check:** `./gradlew build` completes without errors
2. **Smoke test:** `./gradlew runServer -Dthc.smokeTest=true` passes (100 ticks)

Code verification (grep):
- `grep -r "advanceStage" src/main/java/thc/stage/` shows command and manager
- `grep -r "hasPermissionLevel" src/main/java/thc/stage/` shows permission check
- `grep -r "ServerPlayConnectionEvents.JOIN" src/main/kotlin/thc/` shows late-joiner handler
- `grep -r "ClassManager.hasClass" src/main/kotlin/thc/THC.kt` shows new player check
</verification>

<success_criteria>
- /advanceStage command exists and is registered
- Command requires permission level 2 (operators only)
- Command returns error message when already at stage 5
- Command provides success feedback to operator in chat
- advanceStage increments all online players' boon levels
- advanceStage broadcasts red actionbar message to all players
- Late-joining new players get boon level = current stage
- Late-joining returning players keep their accumulated boon level
- Command works from server console when no players online
</success_criteria>

<output>
After completion, create `.planning/phases/36-stage-system/36-02-SUMMARY.md`
</output>
