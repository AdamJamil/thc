---
phase: 37-global-monster-modifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/kotlin/thc/monster/MonsterModifications.kt
  - src/main/kotlin/thc/THC.kt
autonomous: true

must_haves:
  truths:
    - "Zombies visibly outpace creepers when pursuing player"
    - "Baby zombies move at same speed as adult zombies"
    - "Creepers move at unchanged vanilla speed"
    - "Killing equipped zombies/skeletons yields zero armor or weapon drops"
    - "Killing husks/zombies yields zero iron ingot drops"
  artifacts:
    - path: "src/main/kotlin/thc/monster/MonsterModifications.kt"
      provides: "Speed modification via ServerEntityEvents.ENTITY_LOAD"
      exports: ["MonsterModifications.register()"]
    - path: "src/main/kotlin/thc/THC.kt"
      provides: "Extended removedItems set and MonsterModifications registration"
      contains: "MonsterModifications.register()"
  key_links:
    - from: "src/main/kotlin/thc/THC.kt"
      to: "src/main/kotlin/thc/monster/MonsterModifications.kt"
      via: "MonsterModifications.register() call in onInitialize()"
      pattern: "MonsterModifications\\.register\\(\\)"
    - from: "src/main/kotlin/thc/monster/MonsterModifications.kt"
      to: "ServerEntityEvents.ENTITY_LOAD"
      via: "Fabric event registration"
      pattern: "ServerEntityEvents\\.ENTITY_LOAD\\.register"
---

<objective>
Implement global monster modifications: 20% speed increase for hostile mobs (with exclusions), baby zombie speed normalization, and complete loot filtering for equipment and iron ingots.

Purpose: First phase of v2.3 Monster Overhaul - makes combat more dangerous through faster enemies while removing economy-breaking loot drops.

Output: MonsterModifications.kt with attribute modifiers, extended removedItems set in THC.kt
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-global-monster-modifications/37-RESEARCH.md

# Existing THC.kt structure (lines 86-105 show removedItems pattern)
@src/main/kotlin/thc/THC.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MonsterModifications.kt with speed modifications</name>
  <files>src/main/kotlin/thc/monster/MonsterModifications.kt</files>
  <action>
Create new file `src/main/kotlin/thc/monster/MonsterModifications.kt` implementing:

1. **Speed boost logic (FR-01):**
   - Apply 20% speed increase to hostile mobs via `ServerEntityEvents.ENTITY_LOAD`
   - Use `Attributes.MOVEMENT_SPEED` with `AttributeModifier.Operation.ADD_MULTIPLIED_BASE`
   - Use transient modifiers (not persistent) to prevent save bloat
   - ResourceLocation ID: `thc:monster_speed_boost`
   - Check `hasModifier()` before applying to prevent duplicates

2. **Exclusions from speed boost:**
   - Creepers (`entity is Creeper`) - unchanged speed
   - Baby zombies (`entity is Zombie && entity.isBaby`) - handled separately
   - Bosses (`entity is EnderDragon || entity is WitherBoss`) - hardcoded behaviors break
   - Only apply to `MobCategory.MONSTER` entities

3. **Baby zombie normalization (FR-04):**
   - Apply counter-modifier (-0.5) to baby zombies only
   - This negates vanilla's +0.5 BABY_SPEED_BONUS modifier
   - ResourceLocation ID: `thc:baby_zombie_normalize`
   - Result: baby zombies move at same speed as adult zombies

Implementation pattern from research:
```kotlin
object MonsterModifications {
    private val SPEED_BOOST_ID = ResourceLocation.fromNamespaceAndPath("thc", "monster_speed_boost")
    private val BABY_NORMALIZE_ID = ResourceLocation.fromNamespaceAndPath("thc", "baby_zombie_normalize")

    fun register() {
        ServerEntityEvents.ENTITY_LOAD.register { entity, world ->
            if (entity !is Mob) return@register
            if (entity.type.category != MobCategory.MONSTER) return@register

            applySpeedBoost(entity)
            normalizeBabyZombieSpeed(entity)
        }
    }

    private fun applySpeedBoost(mob: Mob) {
        // Exclusions
        if (mob is Creeper) return
        if (mob is Zombie && mob.isBaby) return
        if (mob is EnderDragon || mob is WitherBoss) return

        val speedAttr = mob.getAttribute(Attributes.MOVEMENT_SPEED) ?: return
        if (!speedAttr.hasModifier(SPEED_BOOST_ID)) {
            speedAttr.addTransientModifier(
                AttributeModifier(SPEED_BOOST_ID, 0.2, AttributeModifier.Operation.ADD_MULTIPLIED_BASE)
            )
        }
    }

    private fun normalizeBabyZombieSpeed(mob: Mob) {
        if (mob !is Zombie || !mob.isBaby) return

        val speedAttr = mob.getAttribute(Attributes.MOVEMENT_SPEED) ?: return
        if (!speedAttr.hasModifier(BABY_NORMALIZE_ID)) {
            speedAttr.addTransientModifier(
                AttributeModifier(BABY_NORMALIZE_ID, -0.5, AttributeModifier.Operation.ADD_MULTIPLIED_BASE)
            )
        }
    }
}
```

Required imports:
- `net.fabricmc.fabric.api.event.lifecycle.v1.ServerEntityEvents`
- `net.minecraft.resources.ResourceLocation`
- `net.minecraft.world.entity.Mob`
- `net.minecraft.world.entity.MobCategory`
- `net.minecraft.world.entity.ai.attributes.AttributeModifier`
- `net.minecraft.world.entity.ai.attributes.Attributes`
- `net.minecraft.world.entity.boss.enderdragon.EnderDragon`
- `net.minecraft.world.entity.boss.wither.WitherBoss`
- `net.minecraft.world.entity.monster.Creeper`
- `net.minecraft.world.entity.monster.Zombie`
  </action>
  <verify>
File exists at `src/main/kotlin/thc/monster/MonsterModifications.kt`.
Contains `object MonsterModifications` with `register()` function.
Contains both `SPEED_BOOST_ID` and `BABY_NORMALIZE_ID` ResourceLocations.
Contains exclusion checks for Creeper, baby Zombie, EnderDragon, WitherBoss.
  </verify>
  <done>
MonsterModifications.kt exists with speed boost (0.2 modifier) and baby normalization (-0.5 counter-modifier) logic.
All exclusions implemented: Creepers, baby zombies (from boost), bosses.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend THC.kt with loot filtering and registration</name>
  <files>src/main/kotlin/thc/THC.kt</files>
  <action>
Modify `src/main/kotlin/thc/THC.kt`:

1. **Add import:**
   ```kotlin
   import thc.monster.MonsterModifications
   ```

2. **Add MonsterModifications.register() call in onInitialize():**
   Add after existing registrations (around line 55, after `AdvanceStageCommand.register()`):
   ```kotlin
   MonsterModifications.register()
   ```

3. **Extend removedItems set (lines 86-98):**
   Add armor, weapons, and iron ingots to the existing set. The current set includes:
   - Shield, spears, bow, crossbow, totem

   Add these items for FR-02 (equipment drops) and FR-05 (iron ingots):
   ```kotlin
   // FR-02: Equipment drops (armor)
   Items.LEATHER_HELMET,
   Items.LEATHER_CHESTPLATE,
   Items.LEATHER_LEGGINGS,
   Items.LEATHER_BOOTS,
   Items.CHAINMAIL_HELMET,
   Items.CHAINMAIL_CHESTPLATE,
   Items.CHAINMAIL_LEGGINGS,
   Items.CHAINMAIL_BOOTS,
   Items.IRON_HELMET,
   Items.IRON_CHESTPLATE,
   Items.IRON_LEGGINGS,
   Items.IRON_BOOTS,
   Items.GOLDEN_HELMET,
   Items.GOLDEN_CHESTPLATE,
   Items.GOLDEN_LEGGINGS,
   Items.GOLDEN_BOOTS,
   Items.DIAMOND_HELMET,
   Items.DIAMOND_CHESTPLATE,
   Items.DIAMOND_LEGGINGS,
   Items.DIAMOND_BOOTS,
   // FR-02: Equipment drops (weapons) - swords, bow already in set
   Items.WOODEN_SWORD,
   Items.STONE_SWORD,
   Items.IRON_SWORD,
   Items.GOLDEN_SWORD,
   Items.DIAMOND_SWORD,
   // FR-05: Iron ingot from zombies/husks
   Items.IRON_INGOT
   ```

   Note: Items.BOW and Items.CROSSBOW are already in the set (from ranged gating).

The existing MODIFY_DROPS handler already processes removedItems correctly - no changes needed to the handler logic.
  </action>
  <verify>
`gradle build` succeeds.
THC.kt contains `MonsterModifications.register()` call.
THC.kt removedItems set contains all armor pieces (leather through diamond), swords, and IRON_INGOT.
  </verify>
  <done>
THC.kt registers MonsterModifications and filters all equipment drops (armor, swords) plus iron ingots from loot tables.
  </done>
</task>

</tasks>

<verification>
1. `gradle build` passes
2. File structure correct:
   - `src/main/kotlin/thc/monster/MonsterModifications.kt` exists
   - THC.kt has import and registration
3. Code review:
   - Speed boost uses 0.2 ADD_MULTIPLIED_BASE (20% increase)
   - Baby normalization uses -0.5 counter-modifier
   - All exclusions present (Creeper, baby Zombie, EnderDragon, WitherBoss)
   - removedItems includes all 20 armor pieces + 5 swords + iron ingot
</verification>

<success_criteria>
- gradle build succeeds
- MonsterModifications.kt implements FR-01 (speed boost) and FR-04 (baby normalization)
- THC.kt implements FR-02 (equipment removal) and FR-05 (iron removal)
- All exclusions implemented as specified in research
- Transient modifiers used (no save bloat)
</success_criteria>

<output>
After completion, create `.planning/phases/37-global-monster-modifications/37-01-SUMMARY.md`
</output>
