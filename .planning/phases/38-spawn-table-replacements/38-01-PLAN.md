---
phase: 38-spawn-table-replacements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/thc/mixin/SpawnReplacementMixin.java
  - src/main/resources/thc.mixins.json
autonomous: true

must_haves:
  truths:
    - "Surface zombies spawn as husks (sky-visible NATURAL spawns)"
    - "Surface skeletons spawn as strays (sky-visible NATURAL spawns)"
    - "Underground zombies remain zombies (no sky visibility)"
    - "Underground skeletons remain skeletons (no sky visibility)"
    - "Spider jockey skeletons are preserved (JOCKEY spawn reason bypass)"
    - "Dungeon spawner mobs are preserved (SPAWNER spawn reason bypass)"
  artifacts:
    - path: "src/main/java/thc/mixin/SpawnReplacementMixin.java"
      provides: "Entity replacement logic at spawn time"
      min_lines: 60
    - path: "src/main/resources/thc.mixins.json"
      provides: "Mixin registration"
      contains: "SpawnReplacementMixin"
  key_links:
    - from: "SpawnReplacementMixin"
      to: "NaturalSpawner.spawnCategoryForPosition"
      via: "@Redirect on addFreshEntityWithPassengers"
      pattern: "@Redirect.*addFreshEntityWithPassengers"
---

<objective>
Replace natural Overworld surface zombie spawns with husks and skeleton spawns with strays.

Purpose: Shift surface threats from basic zombies/skeletons to their more dangerous variants (husks apply hunger, strays apply slowness). Husks and strays require more player skill to handle, aligning with THC's risk-based progression.

Output: SpawnReplacementMixin that intercepts natural spawns and conditionally replaces entity types based on sky visibility.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-spawn-table-replacements/38-CONTEXT.md
@.planning/phases/38-spawn-table-replacements/38-RESEARCH.md
@.planning/phases/37-global-monster-modifications/37-01-SUMMARY.md
@src/main/java/thc/mixin/NaturalSpawnerMixin.java
@src/main/resources/thc.mixins.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SpawnReplacementMixin with entity replacement logic</name>
  <files>
    src/main/java/thc/mixin/SpawnReplacementMixin.java
    src/main/resources/thc.mixins.json
  </files>
  <action>
Create SpawnReplacementMixin.java in src/main/java/thc/mixin/:

1. **Mixin target**: NaturalSpawner class

2. **@Redirect injection**:
   - Method: `spawnCategoryForPosition`
   - Target: `ServerLevel.addFreshEntityWithPassengers(Entity)`
   - Purpose: Intercept entity before spawn, conditionally replace

3. **Replacement logic flow**:
   ```
   IF entity is Zombie or Skeleton:
     IF spawn reason is NATURAL (not JOCKEY, SPAWNER, etc.):
       IF level.canSeeSky(entity.blockPosition()):
         Create replacement entity (Husk or Stray)
         Copy entity data from original to replacement
         Call addFreshEntityWithPassengers with replacement
         RETURN result

   ELSE: Call addFreshEntityWithPassengers with original entity
   ```

4. **Entity type checks** (MC 1.21.11 pattern from Phase 37):
   - Use `entity.getType() == EntityType.ZOMBIE` (not instanceof)
   - Use `entity.getType() == EntityType.SKELETON` (not instanceof)
   - Do NOT replace HUSK, DROWNED, STRAY, WITHER_SKELETON, BOGGED

5. **Spawn reason access**:
   - The @Redirect captures parameters from spawnCategoryForPosition
   - Research indicates spawn reason may be accessible via entity data or method context
   - If spawn reason not directly accessible, check for `getPassengers()` to identify jockeys
   - Structure spawners and spawner blocks use different code paths than NaturalSpawner

6. **Sky visibility check**:
   - Use `level.canSeeSky(entity.blockPosition())`
   - This is the authoritative "surface" definition per CONTEXT.md

7. **Entity data copy for replacement**:
   - Copy position: `replacement.moveTo(original.getX(), original.getY(), original.getZ(), original.getYRot(), original.getXRot())`
   - Copy baby status: If original is ZombieEntity with isBaby() true, call setBaby(true) on Husk
   - Copy equipment: Use getItemBySlot/setItemBySlot for armor and hand items

8. **Entity creation** (use proper factory):
   - `EntityType.HUSK.create(level)` for husk creation
   - `EntityType.STRAY.create(level)` for stray creation
   - Do NOT use constructors directly

9. **Register in thc.mixins.json**:
   - Add "SpawnReplacementMixin" to the mixins array

**Important considerations**:
- NaturalSpawnerMixin already exists for base chunk blocking - this is a SEPARATE mixin class
- The @Redirect signature must match the target method exactly
- Return the boolean result from addFreshEntityWithPassengers (true = entity added)

**Research gap handling**:
- If spawnReason is not accessible in the redirect signature, fall back to passenger check:
  - If entity has passengers or is a passenger, it's a jockey - skip replacement
- Log spawn reasons during development to verify structure spawners bypass
  </action>
  <verify>
    - `./gradlew build` succeeds
    - SpawnReplacementMixin.java exists with @Redirect annotation
    - thc.mixins.json includes SpawnReplacementMixin
    - No mixin errors in gradle output
  </verify>
  <done>
    - Build succeeds with new mixin
    - Mixin properly targets NaturalSpawner.spawnCategoryForPosition
    - Both zombie->husk and skeleton->stray replacements implemented
    - Sky visibility check determines replacement eligibility
    - Entity data (position, baby status, equipment) copied to replacements
  </done>
</task>

</tasks>

<verification>
After Task 1 completes:
1. Build succeeds: `./gradlew build`
2. Mixin registered: grep SpawnReplacementMixin thc.mixins.json
3. Manual test (if smoke test works):
   - AFK on plains surface at night
   - Observe spawned mob types (expect husks/strays, no zombies/skeletons)
   - Find dungeon spawner (expect vanilla zombies/skeletons)
   - Wait for spider jockey (expect skeleton rider, not stray)
</verification>

<success_criteria>
Phase 38 is complete when:
- [ ] SpawnReplacementMixin.java compiles and builds successfully
- [ ] Mixin is registered in thc.mixins.json
- [ ] Entity type replacement logic handles both Zombie->Husk and Skeleton->Stray
- [ ] Sky visibility check (canSeeSky) determines surface vs underground
- [ ] NATURAL spawn reason filter preserves spider jockeys
- [ ] Entity data (position, baby status) preserved during replacement
</success_criteria>

<output>
After completion, create `.planning/phases/38-spawn-table-replacements/38-01-SUMMARY.md`
</output>
