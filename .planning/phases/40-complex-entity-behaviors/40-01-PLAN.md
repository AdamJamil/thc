---
phase: 40-complex-entity-behaviors
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/kotlin/thc/monster/GhastModifications.kt
  - src/main/java/thc/mixin/GhastRegisterGoalsMixin.java
  - src/main/java/thc/mixin/LargeFireballMixin.java
  - src/main/java/thc/mixin/accessor/GoalSelectorAccessor.java
  - src/main/resources/thc.mixins.json
autonomous: true

must_haves:
  truths:
    - "Ghast fireballs travel visibly faster (50% velocity boost)"
    - "Ghast fires every 4 seconds on average (not 3)"
    - "Ghast fireball ground impacts spread fire noticeably further (6 block radius vs vanilla 3)"
  artifacts:
    - path: "src/main/kotlin/thc/monster/GhastModifications.kt"
      provides: "Fireball velocity boost via ENTITY_LOAD"
      exports: ["register"]
    - path: "src/main/java/thc/mixin/GhastRegisterGoalsMixin.java"
      provides: "Fire rate modification (60->80 ticks)"
      contains: "RangedAttackGoal"
    - path: "src/main/java/thc/mixin/LargeFireballMixin.java"
      provides: "Expanded fire spread on explosion"
      contains: "onHit"
  key_links:
    - from: "src/main/kotlin/thc/monster/GhastModifications.kt"
      to: "ServerEntityEvents.ENTITY_LOAD"
      via: "register callback"
      pattern: "ENTITY_LOAD\\.register"
    - from: "src/main/java/thc/mixin/GhastRegisterGoalsMixin.java"
      to: "GoalSelector"
      via: "goal replacement"
      pattern: "addGoal.*RangedAttackGoal"
---

<objective>
Implement all three Ghast behavior modifications for the Monster Overhaul.

Purpose: Create more challenging Ghast encounters through faster projectiles, slower but more deliberate fire rate, and dramatically expanded fire spread on impact.

Output:
- GhastModifications.kt with fireball velocity boost
- GhastRegisterGoalsMixin with 80-tick fire interval
- LargeFireballMixin with doubled fire spread radius
- GoalSelectorAccessor for goal removal
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-complex-entity-behaviors/40-RESEARCH.md
@.planning/phases/40-complex-entity-behaviors/40-CONTEXT.md

# Existing patterns
@src/main/kotlin/thc/monster/MonsterModifications.kt
@src/main/java/thc/mixin/MonsterThreatGoalMixin.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Ghast fireball velocity boost (FR-07)</name>
  <files>src/main/kotlin/thc/monster/GhastModifications.kt, src/main/kotlin/thc/THC.kt</files>
  <action>
Create GhastModifications.kt following MonsterModifications.kt pattern:
- Register ENTITY_LOAD handler
- Check entity is LargeFireball
- Check owner is Ghast (not player-deflected fireballs - these should ALSO get boost per CONTEXT.md)
- Actually: Per CONTEXT.md "Deflected fireballs: Yes, player-deflected fireballs also create expanded fire area" - apply boost to ALL ghast-origin fireballs
- Wait, deflected fireballs have owner changed to player. So check if owner is Ghast OR use a tag system
- Simpler approach: Boost ALL LargeFireballs at spawn time. Vanilla only spawns LargeFireball from Ghasts.
- Scale deltaMovement by 1.5 (50% faster)
- Use setDeltaMovement(velocity.scale(1.5))

Register in THC.kt onInitialize alongside MonsterModifications.register()
  </action>
  <verify>Build succeeds with `./gradlew build`</verify>
  <done>LargeFireball entities spawn with 50% boosted velocity</done>
</task>

<task type="auto">
  <name>Task 2: Ghast fire rate reduction (FR-08)</name>
  <files>src/main/java/thc/mixin/GhastRegisterGoalsMixin.java, src/main/java/thc/mixin/accessor/GoalSelectorAccessor.java, src/main/resources/thc.mixins.json</files>
  <action>
Create GoalSelectorAccessor.java (accessor mixin for GoalSelector):
- Interface with @Mixin(GoalSelector.class)
- Expose getAvailableGoals() returning Set of WrappedGoal

Create GhastRegisterGoalsMixin.java:
- @Mixin(Ghast.class)
- @Shadow @Final protected GoalSelector goalSelector
- @Inject on registerGoals at TAIL
- Use GoalSelectorAccessor to iterate availableGoals
- Remove goals with priority 1 that are RangedAttackGoal instances
- Add new RangedAttackGoal with:
  - self (Ghast)
  - 1.0 (speed modifier - unchanged)
  - 80 (attack interval - was 60, now 4 seconds)
  - 64.0f (attack radius - unchanged)

Register both mixins in thc.mixins.json alphabetically.

Note: RangedAttackGoal constructor is (RangedAttackMob mob, double speedModifier, int attackInterval, float attackRadius)
  </action>
  <verify>Build succeeds with `./gradlew build`</verify>
  <done>Ghast RangedAttackGoal uses 80-tick interval instead of 60</done>
</task>

<task type="auto">
  <name>Task 3: Ghast fireball fire spread doubling (FR-09)</name>
  <files>src/main/java/thc/mixin/LargeFireballMixin.java, src/main/resources/thc.mixins.json</files>
  <action>
Create LargeFireballMixin.java:
- @Mixin(LargeFireball.class)
- @Inject on onHit at TAIL (after vanilla explosion completes)
- Get impact position from hitResult.getLocation()
- Only proceed if level is ServerLevel

Fire placement logic for expanded radius:
- Vanilla fire spread is ~3 blocks from center
- THC adds fire in ring from 3-6 blocks from center
- Iterate blocks in 6-block cube around impact
- Skip if distance from center < 3 or > 6
- Check if block is air AND block below is solid (isSolid())
- 33% chance to place fire (matches vanilla probability)
- Use level.setBlock(firePos, Blocks.FIRE.defaultBlockState(), 3)

Note: This fires for ALL LargeFireball impacts, which is correct per CONTEXT.md (deflected fireballs also spread extra fire).

Register in thc.mixins.json alphabetically.
  </action>
  <verify>Build succeeds with `./gradlew build`</verify>
  <done>Ghast fireball explosions place fire in 6-block radius (doubled from vanilla 3)</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `./gradlew build` succeeds
2. All three mixins registered in thc.mixins.json
3. GhastModifications.register() called from THC.kt
4. Check for no compilation warnings related to mixin targets
</verification>

<success_criteria>
- GhastModifications.kt exists and registered
- GhastRegisterGoalsMixin.java modifies fire rate to 80 ticks
- LargeFireballMixin.java doubles fire spread radius
- All builds pass
- Ready for in-game testing (FR-07, FR-08, FR-09)
</success_criteria>

<output>
After completion, create `.planning/phases/40-complex-entity-behaviors/40-01-SUMMARY.md`
</output>
