---
phase: 40-complex-entity-behaviors
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/thc/entity/EndermanProximityAggroGoal.java
  - src/main/java/thc/mixin/EndermanMixin.java
  - src/main/resources/thc.mixins.json
autonomous: true

must_haves:
  truths:
    - "Walking within 3 blocks of neutral enderman triggers aggro"
    - "Fighting enderman results in ~50% teleport-behind occurrences"
    - "Enderman teleport-behind positions player between enderman and original position"
  artifacts:
    - path: "src/main/java/thc/entity/EndermanProximityAggroGoal.java"
      provides: "Custom AI goal for 3-block proximity aggro"
      min_lines: 30
    - path: "src/main/java/thc/mixin/EndermanMixin.java"
      provides: "Proximity goal injection and teleport-behind logic"
      contains: ["registerGoals", "hurtServer"]
  key_links:
    - from: "src/main/java/thc/mixin/EndermanMixin.java"
      to: "EndermanProximityAggroGoal"
      via: "targetSelector.addGoal"
      pattern: "addGoal.*EndermanProximityAggroGoal"
    - from: "src/main/java/thc/mixin/EndermanMixin.java"
      to: "EnderMan.teleportTo"
      via: "hurtServer injection"
      pattern: "teleportTo"
---

<objective>
Implement Enderman behavior modifications for the Monster Overhaul.

Purpose: Create more threatening Enderman encounters through proximity-based aggro (no eye contact needed) and tactical teleport-behind behavior after damage exchanges.

Output:
- EndermanProximityAggroGoal.java custom AI goal
- EndermanMixin.java with goal injection and teleport-behind logic
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-complex-entity-behaviors/40-RESEARCH.md
@.planning/phases/40-complex-entity-behaviors/40-CONTEXT.md

# Existing patterns
@src/main/java/thc/mixin/MonsterThreatGoalMixin.java
@src/main/java/thc/threat/ThreatTargetGoal.java
@src/main/java/thc/mixin/MobDamageThreatMixin.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enderman proximity aggro goal (FR-11)</name>
  <files>src/main/java/thc/entity/EndermanProximityAggroGoal.java, src/main/java/thc/mixin/EndermanMixin.java, src/main/resources/thc.mixins.json</files>
  <action>
Create EndermanProximityAggroGoal.java in thc.entity package:
- Extend TargetGoal (like ThreatTargetGoal pattern)
- Constructor takes EnderMan
- AGGRO_RANGE = 3.0
- setFlags(EnumSet.of(Goal.Flag.TARGET))

canUse():
- Return false if enderman already has target
- Find nearest player within AGGRO_RANGE using level().getNearestPlayer(enderman, AGGRO_RANGE)
- Skip if player is spectator or creative
- If valid player found, call enderman.setTarget(player) and return true
- Return false if no valid player

canContinueToUse():
- Return true if enderman still has target (let vanilla AI handle de-aggro)

Create EndermanMixin.java:
- @Mixin(EnderMan.class)
- @Shadow @Final protected GoalSelector targetSelector
- @Inject on registerGoals at TAIL
- Add EndermanProximityAggroGoal with priority 1 (after vanilla priority 2+ targeting)

Register EndermanMixin in thc.mixins.json alphabetically.
  </action>
  <verify>Build succeeds with `./gradlew build`</verify>
  <done>Enderman aggros on players within 3 blocks regardless of eye contact</done>
</task>

<task type="auto">
  <name>Task 2: Enderman teleport-behind on damage (FR-10)</name>
  <files>src/main/java/thc/mixin/EndermanMixin.java</files>
  <action>
Add teleport-behind logic to EndermanMixin.java:

@Shadow protected abstract boolean teleportTo(double x, double y, double z)

@Inject on hurtServer at TAIL:
- Check cir.getReturnValue() is true (damage was dealt)
- Check amount > 0
- Get attacker from source.getEntity()
- If attacker is not ServerPlayer, return
- 50% chance check: if (!level.random.nextBoolean()) return

Calculate behind-player position:
- Get player position: player.position()
- Get player look direction: player.getLookAngle()
- Calculate behind: playerPos.subtract(playerLook.scale(3.0))
- This puts enderman 3 blocks behind player based on look direction

Attempt teleport:
- Call teleportTo(behind.x, behind.y, behind.z)
- If returns false (invalid position), that's fine - vanilla handles random teleport
- No fallback needed - enderman either appears behind or teleports randomly

Note: hurtServer signature in MC 1.21.11 is:
boolean hurtServer(ServerLevel level, DamageSource source, float amount)
  </action>
  <verify>Build succeeds with `./gradlew build`</verify>
  <done>Enderman has 50% chance to teleport 3 blocks behind player after taking damage</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `./gradlew build` succeeds
2. EndermanMixin registered in thc.mixins.json
3. EndermanProximityAggroGoal class exists and compiles
4. Both registerGoals and hurtServer injections present in EndermanMixin
</verification>

<success_criteria>
- EndermanProximityAggroGoal.java exists with 3-block range
- EndermanMixin.java injects proximity goal and teleport-behind logic
- All builds pass
- Ready for in-game testing (FR-10, FR-11)
</success_criteria>

<output>
After completion, create `.planning/phases/40-complex-entity-behaviors/40-02-SUMMARY.md`
</output>
