---
phase: 42-regional-spawn-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/thc/spawn/SpawnDistributions.java
  - src/main/java/thc/spawn/PillagerVariant.java
  - src/main/java/thc/mixin/SpawnReplacementMixin.java
autonomous: true
user_setup: []

must_haves:
  truths:
    - "When exploring the surface, player encounters witches 5% of the time instead of other mobs"
    - "In upper caves (Y >= 0, underground), player sees witches, vex, and pillagers mixed with normal mobs"
    - "In lower caves (Y < 0), player sees blazes, breezes, vindicators, and pillagers mixed with normal mobs"
    - "Custom mobs spawn in groups of 1-4 nearby each other"
    - "Melee pillagers visibly carry iron swords, ranged pillagers carry crossbows"
    - "Normal mobs continue spawning alongside custom mobs"
  artifacts:
    - path: "src/main/java/thc/spawn/SpawnDistributions.java"
      provides: "Weighted random selection for regional spawn distributions"
      exports: ["selectMob", "MobSelection"]
    - path: "src/main/java/thc/spawn/PillagerVariant.java"
      provides: "Equipment application for MELEE/RANGED pillager variants"
      exports: ["MELEE", "RANGED", "applyEquipment"]
    - path: "src/main/java/thc/mixin/SpawnReplacementMixin.java"
      provides: "Regional distribution integration with spawn replacement"
      contains: "SpawnDistributions.selectMob"
  key_links:
    - from: "src/main/java/thc/mixin/SpawnReplacementMixin.java"
      to: "SpawnDistributions.selectMob"
      via: "method call in redirect"
      pattern: "SpawnDistributions\\.selectMob"
    - from: "src/main/java/thc/mixin/SpawnReplacementMixin.java"
      to: "PillagerVariant.applyEquipment"
      via: "method call for pillager equipment"
      pattern: "PillagerVariant.*applyEquipment"
---

<objective>
Implement regional spawn distribution system with weighted random selection

Purpose: Replace vanilla mob spawns with custom mobs based on region (surface/upper cave/lower cave) using probability tables. Custom spawns bypass vanilla spawn conditions (witches spawn anywhere, blazes/breezes don't need fortress).

Output: Working regional spawn selection integrated with existing spawn replacement mixin
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-regional-spawn-system/42-CONTEXT.md
@.planning/phases/42-regional-spawn-system/42-RESEARCH.md

# Key existing infrastructure
@src/main/java/thc/mixin/SpawnReplacementMixin.java
@src/main/java/thc/mixin/MobFinalizeSpawnMixin.java
@src/main/java/thc/THCAttachments.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create spawn distribution infrastructure</name>
  <files>
    src/main/java/thc/spawn/SpawnDistributions.java
    src/main/java/thc/spawn/PillagerVariant.java
  </files>
  <action>
Create SpawnDistributions.java in thc.spawn package:

1. Define WeightedEntry record: (EntityType<?> type, String variant, int weight)
   - type = null means vanilla fallback
   - variant = "MELEE" or "RANGED" for pillagers, null otherwise

2. Define MobSelection record: (EntityType<?> type, String variant, boolean isVanilla)
   - Static factory: MobSelection.vanillaFallback() returns (null, null, true)

3. Create static Map<String, List<WeightedEntry>> TABLES with distributions:
   - OW_SURFACE: 5 witch, 95 vanilla fallback
   - OW_UPPER_CAVE: 5 witch, 2 vex, 10 pillager RANGED, 25 pillager MELEE, 58 vanilla fallback
   - OW_LOWER_CAVE: 8 blaze, 8 breeze, 12 vindicator, 25 pillager MELEE, 2 evoker, 45 vanilla fallback
   - Validate each table sums to 100 in static initializer

4. Implement selectMob(String region, RandomSource random):
   - Get table for region, return vanilla fallback if missing
   - Roll random.nextInt(100)
   - Iterate entries, accumulate weights, return when roll < cumulative
   - Return vanilla fallback as final fallback (should never reach)

Create PillagerVariant.java enum in thc.spawn package:
- MELEE: setItemSlot(MAINHAND, iron sword), setItemSlot(OFFHAND, empty), setDropChance(MAINHAND, 0.0f)
- RANGED: no-op (vanilla crossbow already set)
- Abstract method applyEquipment(Pillager pillager)
  </action>
  <verify>
Build passes: `./gradlew build`
SpawnDistributions class compiles with selectMob method
PillagerVariant enum compiles with applyEquipment method
  </verify>
  <done>
SpawnDistributions.selectMob returns correct MobSelection based on region and random roll.
PillagerVariant.MELEE.applyEquipment sets iron sword, PillagerVariant.RANGED does nothing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate regional distribution into spawn replacement</name>
  <files>src/main/java/thc/mixin/SpawnReplacementMixin.java</files>
  <action>
Modify SpawnReplacementMixin to integrate regional distribution BEFORE surface variant replacement:

1. Add region detection method using FR-18 spec (isSkyVisible semantics):
   - detectRegion(ServerLevel level, BlockPos pos) -> String
   - FIRST check: if level.canSeeSky(pos) -> return "OW_SURFACE"
   - ELSE if Y < 0 -> return "OW_LOWER_CAVE"
   - ELSE -> return "OW_UPPER_CAVE"
   - Check dimension: only Overworld has custom distributions (return null for non-Overworld)

2. In thc$replaceWithSurfaceVariant redirect, add regional distribution check FIRST:
   - Get region from entity position (null if non-Overworld)
   - If region is not null: Call SpawnDistributions.selectMob(region, level.random)
   - If vanilla fallback OR null region: proceed with existing husk/stray replacement logic
   - If custom mob selected: create that mob instead, skip surface variant logic

3. For custom mob creation:
   - Create entity with EntityType.create(level, EntitySpawnReason.NATURAL)
   - Copy position/rotation from original entity using snapTo()
   - If pillager with variant, call PillagerVariant.valueOf(variant).applyEquipment(pillager)
   - Call mob.finalizeSpawn() to trigger equipment and NBT tagging
   - Return the new mob

4. For pack spawning with custom mobs (proper vanilla-style implementation):
   a. When custom mob selected, roll pack size: 1 + random.nextInt(4) for [1,4] uniform
   b. Initialize SpawnGroupData groupData = null for first mob
   c. For each pack member:
      - First mob uses original position
      - Additional pack members offset by random (-5 to +5) on X/Z from PREVIOUS position
      - Check NaturalSpawner.isSpawnPositionOk(type, level, MobSpawnType.NATURAL, pos, ...) for each position
      - If position not OK, skip this pack member (partial spawns allowed)
      - Create mob, apply variant equipment if pillager
      - Call groupData = mob.finalizeSpawn(..., groupData) - thread groupData through pack
      - Add to level via addFreshEntityWithPassengers
   d. Do NOT adjust Y - use spawn position directly (pack members get X/Z offset only)

5. CRITICAL: Preserve passenger checks (spider jockey protection) and base chunk blocking integration
  </action>
  <verify>
Build passes: `./gradlew build`
Mixin applies without conflicts
grep confirms SpawnDistributions.selectMob call in redirect method
grep confirms canSeeSky for surface detection
grep confirms isSpawnPositionOk for collision checks
  </verify>
  <done>
SpawnReplacementMixin intercepts spawns, rolls regional distribution using canSeeSky for region detection, creates custom mobs with pack spawning [1,4] using SpawnGroupData threading and collision checks, applies pillager equipment, falls back to existing husk/stray logic for vanilla fallback.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify integration and add documentation</name>
  <files>src/main/java/thc/mixin/SpawnReplacementMixin.java</files>
  <action>
1. Verify dimension handling:
   - Overworld: use regional distribution (OW_SURFACE, OW_UPPER_CAVE, OW_LOWER_CAVE)
   - Nether/End: skip distribution, vanilla only (return null from detectRegion)
   - NOTE: End support deferred to Phase 44b (Phase 41 NBT tagging is Overworld-only)

2. Ensure NBT tagging still works:
   - Custom mobs go through finalizeSpawn which triggers MobFinalizeSpawnMixin
   - SPAWN_REGION and SPAWN_COUNTED attachments will be set automatically

3. Verify integration points:
   - Base chunk blocking (NaturalSpawnerMixin) still runs first (different mixin, HEAD inject)
   - Surface variant replacement (husk/stray) only runs on vanilla fallback
   - Regional distribution runs on all Overworld spawns, rolls custom vs vanilla

4. Add documentation comments explaining the priority order:
   - Step 1: Base chunk blocking (via NaturalSpawnerMixin HEAD on isValidSpawnPostitionForType)
   - Step 2: Regional distribution roll (in this redirect)
   - Step 3: Surface variant replacement (only if vanilla fallback selected)
   - Step 4: Region detection uses canSeeSky(pos) per FR-18 spec
  </action>
  <verify>
Build passes: `./gradlew build`
grep for dimension check in detectRegion (OVERWORLD comparison)
Documentation comments present explaining spawn priority order
  </verify>
  <done>
Nether/End spawns vanilla (no custom distribution). Overworld uses regional distributions with canSeeSky-based region detection. NBT tagging via MobFinalizeSpawnMixin works for all custom spawns. Priority order documented.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew build` succeeds
2. SpawnDistributions class exists with selectMob method
3. PillagerVariant enum exists with MELEE and RANGED variants
4. SpawnReplacementMixin integrates regional distribution
5. Region detection uses level.canSeeSky(pos) per FR-18
6. Pack spawning logic present with SpawnGroupData threading
7. Pack spawning uses isSpawnPositionOk for collision checks
8. Dimension check excludes Nether and End
</verification>

<success_criteria>
1. Build passes with no errors
2. SpawnDistributions.selectMob correctly selects from weighted tables
3. PillagerVariant.MELEE sets iron sword, RANGED is no-op
4. SpawnReplacementMixin rolls regional distribution before surface replacement
5. Region detection: canSeeSky -> SURFACE, else Y<0 -> LOWER_CAVE, else UPPER_CAVE
6. Custom mobs spawn in packs of 1-4 with position collision checks
7. SpawnGroupData threaded through pack members
8. Vanilla fallback proceeds to existing husk/stray logic
9. Only Overworld has custom distributions (Nether/End skip)
</success_criteria>

<output>
After completion, create `.planning/phases/42-regional-spawn-system/42-01-SUMMARY.md`
</output>
