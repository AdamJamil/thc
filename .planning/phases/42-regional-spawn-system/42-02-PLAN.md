---
phase: 42-regional-spawn-system
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/thc/mixin/PillagerMixin.java
  - src/main/resources/thc.mixins.json
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Melee pillagers attack players with iron sword (no crossbow usage)"
    - "Ranged pillagers retain vanilla crossbow behavior"
    - "Melee pillagers actively pursue and attack targets"
  artifacts:
    - path: "src/main/java/thc/mixin/PillagerMixin.java"
      provides: "AI goal modification for melee pillager variant"
      contains: "MeleeAttackGoal"
    - path: "src/main/resources/thc.mixins.json"
      provides: "Mixin registration"
      contains: "PillagerMixin"
  key_links:
    - from: "src/main/java/thc/mixin/PillagerMixin.java"
      to: "goalSelector"
      via: "@Shadow field access"
      pattern: "goalSelector\\.getAvailableGoals"
    - from: "src/main/java/thc/mixin/PillagerMixin.java"
      to: "Items.IRON_SWORD"
      via: "equipment check for variant detection"
      pattern: "Items\\.IRON_SWORD"
---

<objective>
Implement Pillager melee AI modification for sword-wielding variants

Purpose: Melee pillagers (spawned via regional distribution with iron sword) need MeleeAttackGoal instead of RangedAttackGoal. Without this, pillagers with non-bow/crossbow weapons are passive and don't attack.

Output: PillagerMixin that removes RangedAttackGoal and adds MeleeAttackGoal for iron sword pillagers
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-regional-spawn-system/42-CONTEXT.md
@.planning/phases/42-regional-spawn-system/42-RESEARCH.md

# AI goal modification pattern
@src/main/java/thc/mixin/EndermanMixin.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PillagerMixin for melee AI</name>
  <files>
    src/main/java/thc/mixin/PillagerMixin.java
    src/main/resources/thc.mixins.json
  </files>
  <action>
Create PillagerMixin.java in thc.mixin package:

1. @Mixin(Pillager.class) targeting net.minecraft.world.entity.monster.Pillager

2. @Shadow @Final protected GoalSelector goalSelector for goal manipulation

3. @Inject into finalizeSpawn at TAIL:
   - This runs AFTER equipment is set by both vanilla and PillagerVariant
   - Check if mainhand item is Items.IRON_SWORD (melee variant detection)
   - If not iron sword, return early (ranged variant, leave vanilla AI)

4. For melee variant (iron sword detected):
   - Remove RangedAttackGoal from goalSelector:
     goalSelector.getAvailableGoals().removeIf(goal -> goal.getGoal() instanceof RangedAttackGoal)
   - Add MeleeAttackGoal with priority 4 (same as vanilla ranged priority):
     goalSelector.addGoal(4, new MeleeAttackGoal((Pillager)(Object)this, 1.0, false))
   - Parameters: speed multiplier 1.0, pauseWhenMobIdle false (aggressive pursuit)

5. Required imports:
   - net.minecraft.world.entity.monster.Pillager
   - net.minecraft.world.entity.ai.goal.GoalSelector
   - net.minecraft.world.entity.ai.goal.MeleeAttackGoal
   - net.minecraft.world.entity.ai.goal.RangedAttackGoal
   - net.minecraft.world.item.Items
   - org.spongepowered.asm.mixin annotations

Register in thc.mixins.json:
- Add "PillagerMixin" to the mixins array
  </action>
  <verify>
Build passes: `./gradlew build`
grep -r "PillagerMixin" src/main/resources confirms registration
grep "MeleeAttackGoal" src/main/java/thc/mixin/PillagerMixin.java confirms AI modification
  </verify>
  <done>
PillagerMixin exists, detects iron sword in finalizeSpawn TAIL, removes RangedAttackGoal, adds MeleeAttackGoal for melee variant pillagers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify integration and add documentation</name>
  <files>src/main/java/thc/mixin/PillagerMixin.java</files>
  <action>
1. Add comprehensive javadoc explaining:
   - Why melee AI is needed (vanilla pillagers with non-bow weapons are passive)
   - Equipment-based detection (iron sword = melee variant)
   - Priority 4 matches vanilla RangedAttackGoal priority
   - Speed 1.0 and pauseWhenMobIdle false for aggressive pursuit

2. Verify timing is correct:
   - finalizeSpawn TAIL runs after:
     - Mob.populateDefaultEquipmentSlots (vanilla equipment)
     - PillagerVariant.applyEquipment (THC equipment override from Plan 01)
     - MobFinalizeSpawnMixin (NBT tagging)
   - This ensures iron sword is present when we check

3. Add logging for debugging (optional, can be removed later):
   - THC.LOGGER.debug("Configured melee pillager at {}", blockPosition()) when AI modified
  </action>
  <verify>
Build passes: `./gradlew build`
Javadoc comments present in PillagerMixin
  </verify>
  <done>
PillagerMixin is fully documented with timing explanation and integration notes. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew build` succeeds
2. PillagerMixin.java exists in mixin package
3. Registered in thc.mixins.json
4. Uses finalizeSpawn TAIL injection
5. Checks for IRON_SWORD in mainhand
6. Removes RangedAttackGoal, adds MeleeAttackGoal
</verification>

<success_criteria>
1. Build passes with no errors
2. PillagerMixin registered and compiles
3. Iron sword detection in finalizeSpawn works
4. RangedAttackGoal removed for melee variant
5. MeleeAttackGoal added with correct parameters (speed 1.0, false)
6. Ranged variant pillagers unaffected (no iron sword = no modification)
</success_criteria>

<output>
After completion, create `.planning/phases/42-regional-spawn-system/42-02-SUMMARY.md`
</output>
