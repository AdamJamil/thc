---
phase: 44-damage-rebalancing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/kotlin/thc/monster/DamageRebalancing.kt
  - src/main/kotlin/thc/THCMod.kt
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Vex deals ~4 damage per hit (down from 13.5 on Hard)"
    - "Vindicator deals ~11.7 damage per hit (down from 19.5 on Hard)"
    - "Large magma cube deals ~4.7 damage per hit (down from 9 on Hard)"
  artifacts:
    - path: "src/main/kotlin/thc/monster/DamageRebalancing.kt"
      provides: "ATTACK_DAMAGE modifiers for melee mobs"
      exports: ["DamageRebalancing.register"]
  key_links:
    - from: "src/main/kotlin/thc/THCMod.kt"
      to: "DamageRebalancing.register()"
      via: "onInitialize call"
      pattern: "DamageRebalancing\\.register"
---

<objective>
Apply ATTACK_DAMAGE attribute modifiers to Vex, Vindicator, and Magma Cube to reduce melee damage to THC balance values.

Purpose: These mobs currently deal excessive damage. Vex (13.5), Vindicator (19.5), and Large Magma Cube (9) need reduction to create balanced encounters where player skill matters more than raw mob damage.

Output: DamageRebalancing.kt with ENTITY_LOAD registration applying transient ATTACK_DAMAGE modifiers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-damage-rebalancing/44-CONTEXT.md
@.planning/phases/44-damage-rebalancing/44-RESEARCH.md

# Existing patterns
@src/main/kotlin/thc/monster/MonsterModifications.kt
@src/main/kotlin/thc/monster/SimpleEntityBehaviors.kt
@src/main/kotlin/thc/THCMod.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DamageRebalancing.kt with melee damage modifiers</name>
  <files>src/main/kotlin/thc/monster/DamageRebalancing.kt</files>
  <action>
Create DamageRebalancing.kt following the established MonsterModifications.kt pattern.

**Structure:**
```kotlin
object DamageRebalancing {
    // Identifiers for each mob type
    private val VEX_DAMAGE_ID = Identifier.fromNamespaceAndPath("thc", "vex_damage_reduction")
    private val VINDICATOR_DAMAGE_ID = Identifier.fromNamespaceAndPath("thc", "vindicator_damage_reduction")
    private val MAGMA_CUBE_DAMAGE_ID = Identifier.fromNamespaceAndPath("thc", "magma_cube_damage_reduction")

    fun register() {
        ServerEntityEvents.ENTITY_LOAD.register { entity, world ->
            if (entity !is Mob) return@register
            applyVexDamage(entity)
            applyVindicatorDamage(entity)
            applyMagmaCubeDamage(entity)
        }
    }
}
```

**Damage calculations (using ADD_MULTIPLIED_TOTAL for difficulty scaling):**

1. **Vex**: 13.5 (Hard armed) -> ~4
   - Multiplier: 4 / 13.5 = 0.296
   - Modifier value: 0.296 - 1 = -0.704
   - Use: `AttributeModifier(VEX_DAMAGE_ID, -0.704, Operation.ADD_MULTIPLIED_TOTAL)`

2. **Vindicator**: 19.5 (Hard armed) -> ~11.7
   - Multiplier: 11.7 / 19.5 = 0.600
   - Modifier value: 0.600 - 1 = -0.400
   - Use: `AttributeModifier(VINDICATOR_DAMAGE_ID, -0.400, Operation.ADD_MULTIPLIED_TOTAL)`

3. **Magma Cube**: 9 (Hard large) -> ~4.7
   - Multiplier: 4.7 / 9 = 0.522
   - Modifier value: 0.522 - 1 = -0.478
   - Use: `AttributeModifier(MAGMA_CUBE_DAMAGE_ID, -0.478, Operation.ADD_MULTIPLIED_TOTAL)`
   - Apply to ALL sizes (preserves ratio between large/medium/small)

**Implementation notes:**
- Use EntityType comparison (not instanceof) per MC 1.21.11 pattern
- Vex: `entity.type == EntityType.VEX`
- Vindicator: `entity.type == EntityType.VINDICATOR`
- MagmaCube: `entity.type == EntityType.MAGMA_CUBE`
- Use addTransientModifier (no NBT persistence)
- Check hasModifier before adding to ensure idempotence
  </action>
  <verify>Run `./gradlew build` - compiles without errors</verify>
  <done>DamageRebalancing.kt exists with register() function and three modifier application functions</done>
</task>

<task type="auto">
  <name>Task 2: Register DamageRebalancing in THCMod</name>
  <files>src/main/kotlin/thc/THCMod.kt</files>
  <action>
Add DamageRebalancing.register() call in THCMod.onInitialize(), following the pattern of existing MonsterModifications and SimpleEntityBehaviors registrations.

Add import: `import thc.monster.DamageRebalancing`
Add call in onInitialize: `DamageRebalancing.register()`

Place after other monster-related registrations for logical grouping.
  </action>
  <verify>Run `./gradlew build` - compiles without errors</verify>
  <done>THCMod.kt calls DamageRebalancing.register() in onInitialize</done>
</task>

<task type="auto">
  <name>Task 3: Verify damage modifications in-game</name>
  <files></files>
  <action>
Run smoke test to verify mod loads correctly:

1. `./gradlew runClient`
2. Create world, spawn each mob type
3. Take damage and observe values in F3 debug or death screen

Expected damage values (on Hard difficulty):
- Vex: ~4 damage (was 13.5)
- Vindicator: ~11.7 damage (was 19.5)
- Large magma cube: ~4.7 damage (was 9)

Note: Exact values may vary slightly due to rounding. Accept +/-0.5 variance.
  </action>
  <verify>Mod loads without errors, mobs deal reduced damage</verify>
  <done>Vex, Vindicator, and Magma Cube deal THC-balanced damage values</done>
</task>

</tasks>

<verification>
1. Build succeeds: `./gradlew build`
2. Mod loads without errors in runClient
3. F3 debug or damage observation confirms:
   - Vex damage reduced from 13.5 to ~4
   - Vindicator damage reduced from 19.5 to ~11.7
   - Large magma cube damage reduced from 9 to ~4.7
</verification>

<success_criteria>
- DamageRebalancing.kt exists with ATTACK_DAMAGE modifiers for Vex, Vindicator, Magma Cube
- THCMod.kt registers DamageRebalancing
- Build compiles successfully
- All three mob types deal THC-balanced melee damage
</success_criteria>

<output>
After completion, create `.planning/phases/44-damage-rebalancing/44-01-SUMMARY.md`
</output>
