---
phase: 44-damage-rebalancing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/thc/mixin/SmallFireballMixin.java
  - src/main/java/thc/mixin/EvokerFangsMixin.java
  - src/main/java/thc/mixin/PiglinCrossbowMixin.java
  - src/main/resources/thc.mixins.json
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Blaze fireball deals ~3.8 damage (down from 7.5 on Hard)"
    - "Evoker fangs deal ~2.5 damage (down from 6 on Normal)"
    - "Piglin arrow deals ~8 damage (up from ~4 base)"
  artifacts:
    - path: "src/main/java/thc/mixin/SmallFireballMixin.java"
      provides: "Blaze fireball damage reduction"
      contains: "@ModifyArg"
    - path: "src/main/java/thc/mixin/EvokerFangsMixin.java"
      provides: "Evoker fang damage reduction"
      contains: "@ModifyArg"
    - path: "src/main/java/thc/mixin/PiglinCrossbowMixin.java"
      provides: "Piglin arrow damage boost"
      contains: "baseDamage"
  key_links:
    - from: "src/main/resources/thc.mixins.json"
      to: "SmallFireballMixin, EvokerFangsMixin, PiglinCrossbowMixin"
      via: "mixin registration"
      pattern: "SmallFireballMixin|EvokerFangsMixin|PiglinCrossbowMixin"
---

<objective>
Create mixins for Blaze fireball, Evoker fang, and Piglin arrow damage modifications.

Purpose: Projectile and special attack damage cannot use attribute modifiers - they require method interception. Blaze fireballs and Evoker fangs need reduction; Piglin arrows need a boost.

Output: Three new mixins registered in thc.mixins.json.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-damage-rebalancing/44-CONTEXT.md
@.planning/phases/44-damage-rebalancing/44-RESEARCH.md

# Existing patterns
@src/main/java/thc/mixin/AbstractArrowMixin.java
@src/main/java/thc/mixin/LargeFireballMixin.java
@src/main/resources/thc.mixins.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SmallFireballMixin for Blaze damage</name>
  <files>src/main/java/thc/mixin/SmallFireballMixin.java</files>
  <action>
Create SmallFireballMixin.java to reduce Blaze fireball damage.

**Target:** Blaze uses SmallFireball (not LargeFireball - that's Ghast)
**Method:** SmallFireball.onHitEntity calls hurt() with hardcoded damage
**Approach:** @ModifyArg to intercept the damage value passed to hurt()

**Damage calculation:**
- Vanilla: 5 (Normal) / 7.5 (Hard)
- Target: ~3.8
- Multiplier: 3.8 / 5.0 = 0.76

```java
@Mixin(SmallFireball.class)
public abstract class SmallFireballMixin {
    @ModifyArg(
        method = "onHitEntity",
        at = @At(value = "INVOKE",
            target = "Lnet/minecraft/world/entity/LivingEntity;hurt(Lnet/minecraft/world/damagesource/DamageSource;F)Z"),
        index = 1
    )
    private float thc$reduceFireballDamage(float original) {
        return original * 0.76f;
    }
}
```

**Notes:**
- Only affects SmallFireball (Blaze), not LargeFireball (Ghast)
- Apply to ALL SmallFireball instances (Blaze-shot, dispenser-shot, command-spawned)
- index = 1 targets the float damage parameter (index 0 is DamageSource)
  </action>
  <verify>Run `./gradlew build` - compiles without errors</verify>
  <done>SmallFireballMixin.java exists with @ModifyArg reducing damage by 24%</done>
</task>

<task type="auto">
  <name>Task 2: Create EvokerFangsMixin for fang damage</name>
  <files>src/main/java/thc/mixin/EvokerFangsMixin.java</files>
  <action>
Create EvokerFangsMixin.java to reduce Evoker fang damage.

**Target:** EvokerFangs.dealDamageTo method calls hurt() with damage
**Approach:** @ModifyArg to intercept the damage value

**Damage calculation:**
- Vanilla: 6 (Normal) / 9 (Hard)
- Target: ~2.5
- Multiplier: 2.5 / 6.0 = 0.417

```java
@Mixin(EvokerFangs.class)
public abstract class EvokerFangsMixin {
    @ModifyArg(
        method = "dealDamageTo",
        at = @At(value = "INVOKE",
            target = "Lnet/minecraft/world/entity/LivingEntity;hurt(Lnet/minecraft/world/damagesource/DamageSource;F)Z"),
        index = 1
    )
    private float thc$reduceFangDamage(float original) {
        return original * 0.417f;
    }
}
```

**Notes:**
- Apply to ALL fangs regardless of summoner (Evoker, commands, mods) per CONTEXT.md
- Do NOT check owner - universal reduction
  </action>
  <verify>Run `./gradlew build` - compiles without errors</verify>
  <done>EvokerFangsMixin.java exists with @ModifyArg reducing damage to ~2.5</done>
</task>

<task type="auto">
  <name>Task 3: Create PiglinCrossbowMixin for arrow damage boost</name>
  <files>src/main/java/thc/mixin/PiglinCrossbowMixin.java</files>
  <action>
Create PiglinCrossbowMixin.java to boost Piglin arrow damage.

**Target:** Arrow baseDamage when shot by Piglin
**Approach:** Inject at Piglin's performRangedAttack or use CrossbowAttackMob pattern

**Damage calculation:**
- Vanilla: ~4 base damage
- Target: ~8
- Multiplier: 2.0x

**Option A - CrossbowAttackMob.performCrossbowAttack:**
The crossbow attack creates the arrow. Inject TAIL and modify arrow.baseDamage.

```java
@Mixin(Piglin.class)
public abstract class PiglinCrossbowMixin {
    @Inject(
        method = "performRangedAttack",
        at = @At("TAIL")
    )
    private void thc$boostPiglinArrowDamage(LivingEntity target, float velocity, CallbackInfo ci) {
        // Arrow already spawned - need different approach
    }
}
```

**Option B - ENTITY_LOAD on Arrow with owner check:**
In a new mixin or extending AbstractArrowMixin, check if arrow owner is Piglin (not PiglinBrute).

**Recommended approach:** Extend AbstractArrowMixin with ENTITY_LOAD check:
- In ENTITY_LOAD, if arrow owner is EntityType.PIGLIN, set baseDamage *= 2.0

Actually, arrows don't have owner set at ENTITY_LOAD time. Better approach:

**Option C - Inject at CrossbowItem.shootProjectile:**
This is where the arrow is created and shot. Inject TAIL, check if shooter is Piglin, modify arrow damage.

```java
@Mixin(CrossbowItem.class)
public abstract class CrossbowItemMixin {
    @Inject(
        method = "shootProjectile",
        at = @At("TAIL")
    )
    private void thc$boostPiglinArrow(LivingEntity shooter, ...) {
        if (shooter.getType() == EntityType.PIGLIN) {
            // Find the arrow and boost damage
        }
    }
}
```

**Simplest approach - Redirect in Piglin attack:**
Since we only care about Piglins, target Piglin class directly.

Use @Inject on Piglin's ranged attack method with access to the spawned projectile.

If method signature issues arise, use the AbstractArrowAccessor pattern to set baseDamage on arrows shot by Piglins.

For MC 1.21.11, check the exact method: `Piglin.shootCrossbowProjectile` or similar.

Target EntityType.PIGLIN only (not PIGLIN_BRUTE) - Brutes are melee-only anyway.
  </action>
  <verify>Run `./gradlew build` - compiles without errors</verify>
  <done>PiglinCrossbowMixin.java exists boosting Piglin arrow damage to ~8</done>
</task>

<task type="auto">
  <name>Task 4: Register mixins in thc.mixins.json</name>
  <files>src/main/resources/thc.mixins.json</files>
  <action>
Add the three new mixins to the "mixins" array in thc.mixins.json:

Add to mixins array (alphabetical order):
- "EvokerFangsMixin"
- "PiglinCrossbowMixin" (or CrossbowItemMixin if using that approach)
- "SmallFireballMixin"

Place near other entity mixins for logical grouping.
  </action>
  <verify>Run `./gradlew build` - compiles and mixins are registered</verify>
  <done>thc.mixins.json includes all three new mixins</done>
</task>

</tasks>

<verification>
1. Build succeeds: `./gradlew build`
2. Mod loads without errors in runClient
3. Damage observation confirms:
   - Blaze fireball damage reduced from 5/7.5 to ~3.8
   - Evoker fang damage reduced from 6/9 to ~2.5
   - Piglin arrow damage increased from ~4 to ~8
</verification>

<success_criteria>
- SmallFireballMixin.java exists with @ModifyArg for Blaze damage
- EvokerFangsMixin.java exists with @ModifyArg for fang damage
- PiglinCrossbowMixin.java exists boosting Piglin arrow damage
- All three mixins registered in thc.mixins.json
- Build compiles successfully
- Blaze, Evoker fangs, and Piglin arrows deal THC-balanced damage
</success_criteria>

<output>
After completion, create `.planning/phases/44-damage-rebalancing/44-02-SUMMARY.md`
</output>
