---
phase: 45-unify-region-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/thc/spawn/RegionDetector.java
  - src/main/java/thc/mixin/SpawnReplacementMixin.java
  - src/main/java/thc/mixin/MobFinalizeSpawnMixin.java
autonomous: true

must_haves:
  truths:
    - "Mobs under tree canopy get OW_SURFACE region (not UPPER_CAVE)"
    - "Spawn distribution and NBT tagging use identical region detection"
    - "Surface cap counting matches spawn distribution decisions"
  artifacts:
    - path: "src/main/java/thc/spawn/RegionDetector.java"
      provides: "Shared heightmap-based region detection"
      exports: ["getRegion"]
      min_lines: 30
    - path: "src/main/java/thc/mixin/SpawnReplacementMixin.java"
      provides: "Spawn distribution with unified region detection"
      contains: "RegionDetector.getRegion"
    - path: "src/main/java/thc/mixin/MobFinalizeSpawnMixin.java"
      provides: "NBT tagging with unified region detection"
      contains: "RegionDetector.getRegion"
  key_links:
    - from: "SpawnReplacementMixin.java"
      to: "RegionDetector.java"
      via: "static method call"
      pattern: "RegionDetector\\.getRegion"
    - from: "MobFinalizeSpawnMixin.java"
      to: "RegionDetector.java"
      via: "static method call"
      pattern: "RegionDetector\\.getRegion"
---

<objective>
Extract region detection into shared RegionDetector utility and update both mixins to use it.

Purpose: Fix integration gap where SpawnReplacementMixin uses canSeeSky() while MobFinalizeSpawnMixin uses heightmap, causing region detection mismatches under tree canopy.
Output: Single source of truth for region detection; both mixins delegate to RegionDetector.getRegion().
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/45-unify-region-detection/45-RESEARCH.md
@src/main/java/thc/mixin/SpawnReplacementMixin.java
@src/main/java/thc/mixin/MobFinalizeSpawnMixin.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RegionDetector utility</name>
  <files>src/main/java/thc/spawn/RegionDetector.java</files>
  <action>
Create `thc/spawn/RegionDetector.java` - static utility class with heightmap-based region detection.

Implementation (extract from MobFinalizeSpawnMixin.java lines 49-65):
```java
package thc.spawn;

import net.minecraft.core.BlockPos;
import net.minecraft.server.level.ServerLevel;
import net.minecraft.world.level.Level;
import net.minecraft.world.level.levelgen.Heightmap;

/**
 * Shared region detection logic for spawn system.
 *
 * Used by SpawnReplacementMixin (distribution + cap check) and
 * MobFinalizeSpawnMixin (NBT tagging).
 *
 * Uses heightmap-based detection per v2.3 audit recommendation:
 * - Matches player intuition ("surface" = ground level, not sky visibility)
 * - MOTION_BLOCKING excludes leaves (under-tree = surface, not cave)
 */
public final class RegionDetector {

    private RegionDetector() {
        // Utility class
    }

    /**
     * Detect spawn region for a given position.
     *
     * Algorithm:
     * - Non-Overworld: null (no regional system)
     * - Y < 0: OW_LOWER_CAVE
     * - Y >= MOTION_BLOCKING heightmap: OW_SURFACE
     * - Otherwise: OW_UPPER_CAVE
     *
     * @param level The server level
     * @param pos   The spawn position
     * @return Region string or null if non-Overworld
     */
    public static String getRegion(ServerLevel level, BlockPos pos) {
        // Only Overworld has regional spawn system
        if (level.dimension() != Level.OVERWORLD) {
            return null;
        }

        int y = pos.getY();

        // Lower cave: below Y=0 (sea level)
        if (y < 0) {
            return "OW_LOWER_CAVE";
        }

        // Surface: Y >= heightmap at X/Z
        int surfaceY = level.getHeight(Heightmap.Types.MOTION_BLOCKING, pos.getX(), pos.getZ());
        if (y >= surfaceY) {
            return "OW_SURFACE";
        }

        // Upper cave: Y >= 0 but below heightmap
        return "OW_UPPER_CAVE";
    }
}
```

This is the EXACT logic from MobFinalizeSpawnMixin.detectRegion() - no new invention, just extraction.
  </action>
  <verify>File exists at src/main/java/thc/spawn/RegionDetector.java with getRegion method</verify>
  <done>RegionDetector.java exists with heightmap-based getRegion() method</done>
</task>

<task type="auto">
  <name>Task 2: Update SpawnReplacementMixin to use RegionDetector</name>
  <files>src/main/java/thc/mixin/SpawnReplacementMixin.java</files>
  <action>
Refactor SpawnReplacementMixin to use shared RegionDetector:

1. Add import: `import thc.spawn.RegionDetector;`

2. Delete the @Unique thc$detectRegion method (lines 119-139) - no longer needed

3. Update thc$replaceWithSurfaceVariant (line 85):
   BEFORE: `String region = thc$detectRegion(level, pos);`
   AFTER:  `String region = RegionDetector.getRegion(level, pos);`

4. Update thc$getReplacementEntity (lines 227-228):
   BEFORE: `if (!level.canSeeSky(pos)) { return entity; }`
   AFTER:  Use region-based check since we already know the region from earlier in the flow.

   Actually, thc$getReplacementEntity is ONLY called for vanilla fallback (after region is determined).
   The canSeeSky check here is redundant - surface variants only apply when region == OW_SURFACE.
   Since we already checked region in thc$replaceWithSurfaceVariant, pass region as parameter:

   Change signature: `thc$getReplacementEntity(ServerLevel level, Entity entity, String region)`
   Change line 107: `Entity entityToSpawn = thc$getReplacementEntity(level, entity, region);`
   Change line 228: `if (!"OW_SURFACE".equals(region)) { return entity; }`

5. Update Javadoc (lines 41-47) to document heightmap-based detection instead of canSeeSky

This ensures both distribution selection AND surface variant replacement use the same region detection logic.
  </action>
  <verify>
    grep "RegionDetector.getRegion" src/main/java/thc/mixin/SpawnReplacementMixin.java (should find 1 match)
    grep "canSeeSky" src/main/java/thc/mixin/SpawnReplacementMixin.java (should find 0 matches)
    grep "thc\$detectRegion" src/main/java/thc/mixin/SpawnReplacementMixin.java (should find 0 matches)
  </verify>
  <done>SpawnReplacementMixin uses RegionDetector.getRegion() with no duplicate logic</done>
</task>

<task type="auto">
  <name>Task 3: Update MobFinalizeSpawnMixin to use RegionDetector</name>
  <files>src/main/java/thc/mixin/MobFinalizeSpawnMixin.java</files>
  <action>
Refactor MobFinalizeSpawnMixin to use shared RegionDetector:

1. Add import: `import thc.spawn.RegionDetector;`

2. Remove import: `import net.minecraft.world.level.levelgen.Heightmap;` (no longer needed)

3. Delete the @Unique detectRegion method (lines 48-65) - logic now in RegionDetector

4. Update thc$tagSpawnOrigin (line 40):
   BEFORE: `String region = detectRegion(serverLevel, self.blockPosition());`
   AFTER:  `String region = RegionDetector.getRegion(serverLevel, self.blockPosition());`

The import removal is optional but keeps the file clean.
  </action>
  <verify>
    grep "RegionDetector.getRegion" src/main/java/thc/mixin/MobFinalizeSpawnMixin.java (should find 1 match)
    grep "getHeight.*MOTION_BLOCKING" src/main/java/thc/mixin/MobFinalizeSpawnMixin.java (should find 0 matches)
    grep "detectRegion" src/main/java/thc/mixin/MobFinalizeSpawnMixin.java (should find 0 matches)
  </verify>
  <done>MobFinalizeSpawnMixin uses RegionDetector.getRegion() with no duplicate logic</done>
</task>

</tasks>

<verification>
1. Build verification: `./gradlew build` compiles without errors
2. No duplicate detection: Both mixins use RegionDetector, neither has its own region detection
3. Pattern consistency: Both mixins import and call RegionDetector.getRegion()
</verification>

<success_criteria>
1. RegionDetector.java exists with heightmap-based getRegion()
2. SpawnReplacementMixin calls RegionDetector.getRegion() (no canSeeSky, no thc$detectRegion)
3. MobFinalizeSpawnMixin calls RegionDetector.getRegion() (no detectRegion method)
4. Build succeeds with no compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/45-unify-region-detection/45-01-SUMMARY.md`
</output>
