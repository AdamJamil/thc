---
phase: 46-iron-boat
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/kotlin/thc/entity/IronBoat.kt
  - src/main/kotlin/thc/entity/THCEntities.kt
  - src/main/kotlin/thc/item/IronBoatItem.kt
  - src/main/kotlin/thc/item/THCItems.kt
  - src/main/kotlin/thc/THC.kt
autonomous: true

must_haves:
  truths:
    - "Iron boat entity can be spawned in the world"
    - "Iron boat floats on lava like normal boats float on water"
    - "Iron boat floats on water like normal boats"
    - "Iron boat only takes damage from player attacks"
    - "Broken iron boat drops item with initial velocity toward attacker"
  artifacts:
    - path: "src/main/kotlin/thc/entity/IronBoat.kt"
      provides: "Custom boat entity with lava support"
      contains: "class IronBoat"
    - path: "src/main/kotlin/thc/entity/THCEntities.kt"
      provides: "Entity type registration"
      contains: "IRON_BOAT"
    - path: "src/main/kotlin/thc/item/IronBoatItem.kt"
      provides: "Item that spawns iron boat entity"
      contains: "class IronBoatItem"
  key_links:
    - from: "src/main/kotlin/thc/item/IronBoatItem.kt"
      to: "THCEntities.IRON_BOAT"
      via: "Entity spawn on use"
      pattern: "IronBoat\\(THCEntities\\.IRON_BOAT"
    - from: "src/main/kotlin/thc/THC.kt"
      to: "THCEntities.init"
      via: "Entity registration initialization"
      pattern: "THCEntities\\.init\\(\\)"
---

<objective>
Create the iron boat entity and item with full lava compatibility and damage immunity.

Purpose: Enable players to craft and place iron boats that work on lava for safe Nether traversal.
Output: Working IronBoat entity with lava physics, damage filtering, and IronBoatItem that spawns it.
</objective>

<execution_context>
@/home/tack/.claude/get-shit-done/workflows/execute-plan.md
@/home/tack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/46-iron-boat/46-CONTEXT.md
@.planning/phases/46-iron-boat/46-RESEARCH.md

# Reference files for registration patterns
@src/main/kotlin/thc/item/THCItems.kt
@src/main/kotlin/thc/THC.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Entity Type Registration</name>
  <files>src/main/kotlin/thc/entity/THCEntities.kt</files>
  <action>
Create new file `src/main/kotlin/thc/entity/THCEntities.kt` with entity type registration:

```kotlin
package thc.entity

import net.minecraft.core.Registry
import net.minecraft.core.registries.BuiltInRegistries
import net.minecraft.resources.Identifier
import net.minecraft.world.entity.EntityType
import net.minecraft.world.entity.MobCategory

object THCEntities {
    val IRON_BOAT: EntityType<IronBoat> = Registry.register(
        BuiltInRegistries.ENTITY_TYPE,
        Identifier.fromNamespaceAndPath("thc", "iron_boat"),
        EntityType.Builder.create(::IronBoat, MobCategory.MISC)
            .sized(1.375f, 0.5625f)  // Same as vanilla boat
            .build("iron_boat")
    )

    fun init() {
        // Registration happens at object init, this just forces class loading
    }
}
```

Use Identifier.fromNamespaceAndPath (MC 1.21.11 Fabric pattern). Size matches vanilla boat dimensions.
  </action>
  <verify>File exists with correct structure. Build compiles (may have errors until IronBoat class exists).</verify>
  <done>THCEntities.kt exists with IRON_BOAT entity type registration using correct MC 1.21.11 APIs.</done>
</task>

<task type="auto">
  <name>Task 2: Create IronBoat Entity</name>
  <files>src/main/kotlin/thc/entity/IronBoat.kt</files>
  <action>
Create new file `src/main/kotlin/thc/entity/IronBoat.kt` extending vanilla Boat with lava support.

Key implementation points:

1. **Fire immunity:**
   - Override `fireImmune()` to return true
   - Override `isOnFire()` to return false

2. **Lava float physics** - Override these methods to treat lava same as water:
   - `checkInWater()`: Check both FluidTags.WATER and FluidTags.LAVA
   - `getWaterLevelAbove()`: Include lava in fluid height detection
   - `isUnderwater()`: Check for both water and lava submersion
   - The floatBoat() method should work automatically once fluid detection includes lava

3. **Damage immunity** - Override `hurt(DamageSource, Float)`:
   - If source.entity is Player, call super.hurt() to allow damage
   - Otherwise return false (blocks lava, fire, mob attacks, cacti, collisions)

4. **Drop behavior with velocity toward attacker** - Override `destroy(DamageSource)` or equivalent:
   - Create ItemEntity with ItemStack of THCItems.IRON_BOAT
   - If source.entity exists, calculate direction vector from boat to attacker
   - Apply initial velocity: direction.normalize() * 0.5 speed, plus small upward Y component (0.3)
   - Set item.hurtMarked = true for client sync
   - Add item to level

Reference TheObsidianBoat mod pattern from research, but adapt to MC 1.21.11 APIs.
Verify actual Boat class method signatures via decompilation if needed.
  </action>
  <verify>`./gradlew build` compiles without errors.</verify>
  <done>IronBoat.kt exists with fire immunity, lava physics, player-only damage, and velocity-based drop.</done>
</task>

<task type="auto">
  <name>Task 3: Create IronBoatItem and Wire Registration</name>
  <files>
    src/main/kotlin/thc/item/IronBoatItem.kt
    src/main/kotlin/thc/item/THCItems.kt
    src/main/kotlin/thc/THC.kt
  </files>
  <action>
**IronBoatItem.kt** - Create item that spawns iron boat entity on use:
- Extend Item class
- Override use() method similar to vanilla BoatItem:
  - Get hit result with ClipContext.Fluid.ANY to hit lava/water surface
  - If hit, create IronBoat entity at hit location
  - Call level.addFreshEntity(boat) on server side only (!level.isClientSide)
  - Shrink stack by 1
  - Return sidedSuccess

**THCItems.kt** - Add IRON_BOAT registration:
```kotlin
@JvmField
val IRON_BOAT: Item = register("iron_boat") { key ->
    IronBoatItem(
        Item.Properties()
            .setId(key)
            .stacksTo(1)
            .component(DataComponents.DAMAGE_RESISTANT, DamageResistant(DamageTypeTags.IS_FIRE))
    )
}
```
- Use DataComponents.DAMAGE_RESISTANT with DamageTypeTags.IS_FIRE for lava/fire immunity when dropped
- Add to transportation tab in init(): `entries.accept(IRON_BOAT)`

**THC.kt** - Add entity initialization:
- Import thc.entity.THCEntities
- Add `THCEntities.init()` call in onInitialize() (after THCItems.init())

Note: For transportation creative tab, use:
```kotlin
private val transportTabKey: ResourceKey<CreativeModeTab> = ResourceKey.create(
    Registries.CREATIVE_MODE_TAB,
    Identifier.withDefaultNamespace("tools")  // boats are in tools tab
)
```
  </action>
  <verify>`./gradlew build` succeeds. No runtime errors expected until client renderer added.</verify>
  <done>IronBoatItem spawns entity, item registered with fire resistance component, entities initialized in THC.kt.</done>
</task>

</tasks>

<verification>
1. `./gradlew build` completes successfully
2. Grep confirms key patterns:
   - `grep -r "IRON_BOAT" src/main/kotlin/` shows registration in THCEntities, THCItems
   - `grep -r "THCEntities.init" src/main/kotlin/` shows initialization in THC.kt
   - `grep -r "FluidTags.LAVA" src/main/kotlin/` shows lava detection in IronBoat
</verification>

<success_criteria>
- IronBoat entity class exists with lava physics (checkInWater includes lava)
- IronBoat entity is fire immune and only damaged by player attacks
- IronBoat drops item with initial velocity toward attacker when destroyed
- IronBoatItem spawns entity on fluid surface
- IRON_BOAT item has DAMAGE_RESISTANT component for fire immunity
- THCEntities.init() called in THC.onInitialize()
- Build compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/46-iron-boat/46-01-SUMMARY.md`
</output>
