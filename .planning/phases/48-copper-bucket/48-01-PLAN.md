---
phase: 48-copper-bucket
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/kotlin/thc/item/CopperBucketItem.kt
  - src/main/kotlin/thc/item/CopperWaterBucketItem.kt
  - src/main/kotlin/thc/item/CopperMilkBucketItem.kt
  - src/main/kotlin/thc/item/THCItems.kt
  - src/main/kotlin/thc/THC.kt
  - src/main/resources/data/thc/recipe/copper_bucket.json
  - src/main/resources/assets/thc/models/item/copper_bucket.json
  - src/main/resources/assets/thc/models/item/copper_bucket_of_water.json
  - src/main/resources/assets/thc/models/item/copper_bucket_of_milk.json
  - src/main/resources/assets/thc/lang/en_us.json
autonomous: true

must_haves:
  truths:
    - "Player can craft copper bucket using 3 copper ingots in bucket pattern"
    - "Copper bucket can pick up water source blocks"
    - "Copper bucket can place water"
    - "Copper bucket can milk cows (produces copper milk bucket)"
    - "Copper milk bucket is drinkable and clears status effects"
    - "Copper bucket cannot pick up lava (silent fail)"
    - "All three bucket variants display correct textures in inventory"
  artifacts:
    - path: "src/main/kotlin/thc/item/CopperBucketItem.kt"
      provides: "Empty copper bucket with water-only pickup"
      contains: "FluidTags.WATER"
    - path: "src/main/kotlin/thc/item/CopperWaterBucketItem.kt"
      provides: "Water-filled bucket with placement"
      contains: "Blocks.WATER"
    - path: "src/main/kotlin/thc/item/CopperMilkBucketItem.kt"
      provides: "Milk bucket with drinking mechanics"
      contains: "removeAllEffects"
    - path: "src/main/kotlin/thc/item/THCItems.kt"
      provides: "Item registrations"
      contains: "COPPER_BUCKET"
    - path: "src/main/resources/data/thc/recipe/copper_bucket.json"
      provides: "Crafting recipe"
      contains: "copper_ingot"
  key_links:
    - from: "THC.kt"
      to: "THCItems.COPPER_BUCKET"
      via: "UseEntityCallback for cow milking"
      pattern: "Cow.*COPPER_BUCKET"
    - from: "CopperBucketItem.kt"
      to: "THCItems.COPPER_BUCKET_OF_WATER"
      via: "Water pickup creates water bucket"
      pattern: "COPPER_BUCKET_OF_WATER"
    - from: "CopperMilkBucketItem.kt"
      to: "THCItems.COPPER_BUCKET"
      via: "Drinking returns empty bucket"
      pattern: "COPPER_BUCKET"
---

<objective>
Implement copper bucket as an early-game bucket alternative that can only hold water or milk, not lava or other fluids.

Purpose: Provides progression gate - players can have water transport before iron, but cannot bypass lava challenges with copper.
Output: Three working bucket items (empty, water, milk) with crafting recipe and cow milking support.
</objective>

<execution_context>
@/home/tack/.claude/get-shit-done/workflows/execute-plan.md
@/home/tack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/48-copper-bucket/48-CONTEXT.md
@.planning/phases/48-copper-bucket/48-RESEARCH.md

# Existing patterns to follow:
@src/main/kotlin/thc/item/THCItems.kt
@src/main/kotlin/thc/item/IronBoatItem.kt
@src/main/kotlin/thc/THC.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create copper bucket items and registration</name>
  <files>
    src/main/kotlin/thc/item/CopperBucketItem.kt
    src/main/kotlin/thc/item/CopperWaterBucketItem.kt
    src/main/kotlin/thc/item/CopperMilkBucketItem.kt
    src/main/kotlin/thc/item/THCItems.kt
  </files>
  <action>
Create three custom bucket item classes following patterns from 48-RESEARCH.md:

1. **CopperBucketItem.kt** (empty copper bucket):
   - Extend Item, NOT BucketItem (BucketItem hardcoded for specific fluids)
   - Override `use()` to check FluidState at target position
   - Use `getPlayerPOVHitResult(level, player, ClipContext.Fluid.SOURCE_ONLY)` for ray trace
   - If `fluidState.is(FluidTags.WATER) && fluidState.isSource`:
     - Server-side only: Remove water block, shrink stack, give COPPER_BUCKET_OF_WATER
     - Play SoundEvents.BUCKET_FILL
     - Return `InteractionResult.sidedSuccess(level.isClientSide)`
   - If lava or other fluid: Return `InteractionResult.FAIL` (silent, no animation)
   - Otherwise: Return `InteractionResult.PASS`

2. **CopperWaterBucketItem.kt** (water-filled bucket):
   - Extend Item with overridden `use()`
   - Use `ClipContext.Fluid.NONE` for ray trace (targeting blocks, not fluid)
   - Place `Blocks.WATER.defaultBlockState()` at target position
   - Server-side: Shrink stack, give COPPER_BUCKET back
   - Play SoundEvents.BUCKET_EMPTY
   - Return `sidedSuccess(level.isClientSide)`

3. **CopperMilkBucketItem.kt** (milk bucket):
   - Override `use()` to start drinking: `player.startUsingItem(hand)`, return `InteractionResult.CONSUME`
   - Override `finishUsingItem()` to:
     - If ServerPlayer: call `entity.removeAllEffects()`
     - Return empty COPPER_BUCKET (handle creative mode with `abilities.instabuild`)
   - Override `getUseAnimation()` to return `ItemUseAnimation.DRINK`
   - Override `getUseDuration()` to return `32` (same as vanilla milk)

4. **Update THCItems.kt**:
   - Add COPPER_BUCKET registration: stacksTo(16) like vanilla empty buckets
   - Add COPPER_BUCKET_OF_WATER: stacksTo(1), craftRemainder(COPPER_BUCKET)
   - Add COPPER_BUCKET_OF_MILK: stacksTo(1), craftRemainder(COPPER_BUCKET)
   - Add all three to toolsTabKey creative tab group

Follow existing IronBoatItem.kt for use() pattern and THCItems.kt for registration pattern.
  </action>
  <verify>
Project compiles: `./gradlew build`
Items exist in THCItems.kt with correct stack sizes and remainders.
  </verify>
  <done>
Three copper bucket item classes created with fluid restriction logic.
Items registered with correct properties (stack sizes, craft remainders).
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire cow milking callback and create assets</name>
  <files>
    src/main/kotlin/thc/THC.kt
    src/main/resources/data/thc/recipe/copper_bucket.json
    src/main/resources/assets/thc/models/item/copper_bucket.json
    src/main/resources/assets/thc/models/item/copper_bucket_of_water.json
    src/main/resources/assets/thc/models/item/copper_bucket_of_milk.json
    src/main/resources/assets/thc/lang/en_us.json
  </files>
  <action>
1. **THC.kt - Add UseEntityCallback for cow milking**:
   - In onInitialize(), add UseEntityCallback.EVENT.register
   - Check: `stack.item == THCItems.COPPER_BUCKET && entity is Cow && !entity.isBaby`
   - Server-side only (!level.isClientSide):
     - Play SoundEvents.COW_MILK
     - Shrink stack
     - Add ItemStack(THCItems.COPPER_BUCKET_OF_MILK) to inventory, drop if full
   - Return `InteractionResult.sidedSuccess(level.isClientSide)` on match
   - Return `InteractionResult.PASS` when not handling
   - Import: `net.minecraft.world.entity.animal.Cow`, `net.fabricmc.fabric.api.event.player.UseEntityCallback`

2. **Recipe: copper_bucket.json**:
```json
{
  "type": "minecraft:crafting_shaped",
  "category": "misc",
  "key": {
    "C": "minecraft:copper_ingot"
  },
  "pattern": [
    "C C",
    " C "
  ],
  "result": {
    "count": 1,
    "id": "thc:copper_bucket"
  }
}
```

3. **Item models** (3 files, same structure as iron_boat.json):
```json
{
  "parent": "minecraft:item/generated",
  "textures": {
    "layer0": "thc:item/copper_bucket"
  }
}
```
(Repeat for copper_bucket_of_water and copper_bucket_of_milk with matching texture paths)

4. **Update en_us.json** - Add translations:
   - "item.thc.copper_bucket": "Copper Bucket"
   - "item.thc.copper_bucket_of_water": "Copper Bucket of Water"
   - "item.thc.copper_bucket_of_milk": "Copper Bucket of Milk"

Note: Textures already exist at textures/item/copper_bucket*.png
  </action>
  <verify>
Project compiles: `./gradlew build`
Recipe file parses correctly (no JSON errors).
Model files reference existing textures.
  </verify>
  <done>
Cow milking produces copper milk bucket.
Crafting recipe available for copper bucket.
All three items show correct names and textures.
  </done>
</task>

</tasks>

<verification>
1. Run `./gradlew build` - should compile without errors
2. Run `./gradlew runClient` and verify in-game:
   - Copper bucket appears in Tools & Utilities creative tab
   - Crafting 3 copper ingots in bucket pattern yields copper bucket
   - Right-click water source with copper bucket -> picks up water, returns copper bucket of water
   - Right-click lava with copper bucket -> nothing happens (silent fail, no animation)
   - Right-click cow with copper bucket -> plays milk sound, returns copper bucket of milk
   - Right-click block with copper bucket of water -> places water, returns empty copper bucket
   - Drink copper bucket of milk -> clears effects, returns empty copper bucket
   - All items display correct textures
</verification>

<success_criteria>
- BUCK-01: Copper bucket craftable with 3 copper ingots in bucket pattern
- BUCK-02: Copper bucket only holds water or milk (lava/powder snow fail silently)
- BUCK-03: All three copper bucket variants use correct custom textures
- Build passes without errors
- All three items functional in-game
</success_criteria>

<output>
After completion, create `.planning/phases/48-copper-bucket/48-01-SUMMARY.md`
</output>
