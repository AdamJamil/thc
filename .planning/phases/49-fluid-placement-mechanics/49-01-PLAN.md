---
phase: 49-fluid-placement-mechanics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/thc/mixin/BucketItemLavaMixin.java
  - src/main/kotlin/thc/item/CopperWaterBucketItem.kt
  - src/main/resources/thc.mixins.json
autonomous: true

must_haves:
  truths:
    - "Right-clicking with lava bucket does nothing (silent fail)"
    - "Water placed from copper bucket creates flowing water that spreads and drains"
    - "Natural water sources (oceans, rivers) remain unaffected"
  artifacts:
    - path: "src/main/java/thc/mixin/BucketItemLavaMixin.java"
      provides: "Lava bucket placement cancellation"
      contains: "Items.LAVA_BUCKET"
    - path: "src/main/kotlin/thc/item/CopperWaterBucketItem.kt"
      provides: "Flowing water placement logic"
      contains: "FLOWING_WATER"
  key_links:
    - from: "BucketItemLavaMixin.java"
      to: "BucketItem.use()"
      via: "@Inject HEAD cancellation"
      pattern: "cir.setReturnValue.*FAIL"
    - from: "CopperWaterBucketItem.kt"
      to: "FlowingFluid.LEVEL"
      via: "setValue for level 8"
      pattern: "setValue.*LEVEL.*8"
---

<objective>
Block lava bucket placement and modify copper water bucket to place flowing water instead of source blocks.

Purpose: Restrict fluid economy - no infinite water from buckets, no lava placement at all
Output: BucketItemLavaMixin.java mixin, modified CopperWaterBucketItem.kt
</objective>

<execution_context>
@/home/tack/.claude/get-shit-done/workflows/execute-plan.md
@/home/tack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/49-fluid-placement-mechanics/49-RESEARCH.md

# Current copper bucket implementation (from Phase 48)
@src/main/kotlin/thc/item/CopperWaterBucketItem.kt

# Mixin registration
@src/main/resources/thc.mixins.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Block vanilla lava bucket placement</name>
  <files>
    src/main/java/thc/mixin/BucketItemLavaMixin.java
    src/main/resources/thc.mixins.json
  </files>
  <action>
Create BucketItemLavaMixin.java that injects at HEAD of BucketItem.use() method:

```java
@Mixin(BucketItem.class)
public class BucketItemLavaMixin {

    @Inject(
        method = "use",
        at = @At("HEAD"),
        cancellable = true
    )
    private void thc$blockLavaPlacement(
            Level level,
            Player player,
            InteractionHand hand,
            CallbackInfoReturnable<InteractionResult> cir) {

        ItemStack stack = player.getItemInHand(hand);

        if (stack.getItem() == Items.LAVA_BUCKET) {
            cir.setReturnValue(InteractionResult.FAIL);
        }
    }
}
```

Required imports:
- net.minecraft.world.InteractionHand
- net.minecraft.world.InteractionResult
- net.minecraft.world.entity.player.Player
- net.minecraft.world.item.BucketItem
- net.minecraft.world.item.ItemStack
- net.minecraft.world.item.Items
- net.minecraft.world.level.Level
- org.spongepowered.asm.mixin.Mixin
- org.spongepowered.asm.mixin.injection.At
- org.spongepowered.asm.mixin.injection.Inject
- org.spongepowered.asm.mixin.injection.callback.CallbackInfoReturnable

Add "BucketItemLavaMixin" to the mixins array in thc.mixins.json (alphabetically after "BellBlockMixin").
  </action>
  <verify>
./gradlew build --quiet
Build succeeds without errors.
  </verify>
  <done>
BucketItemLavaMixin.java exists, registered in thc.mixins.json, build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Modify copper water bucket to place flowing water</name>
  <files>
    src/main/kotlin/thc/item/CopperWaterBucketItem.kt
  </files>
  <action>
Modify CopperWaterBucketItem.kt to place flowing water at level 8 instead of a source block.

Replace the water placement line:
```kotlin
// OLD: level.setBlock(targetPos, Blocks.WATER.defaultBlockState(), 11)

// NEW: Place flowing water at level 8 (max height, spreads and drains)
val flowingWater = Fluids.FLOWING_WATER
    .defaultFluidState()
    .setValue(FlowingFluid.LEVEL, 8)
    .createLegacyBlock()

level.setBlock(targetPos, flowingWater, 11)

// Schedule tick for water to start flowing
level.scheduleTick(targetPos, Fluids.FLOWING_WATER, Fluids.FLOWING_WATER.getTickDelay(level))
```

Required new imports:
- net.minecraft.world.level.material.Fluids
- net.minecraft.world.level.material.FlowingFluid

Remove the now-unused import:
- net.minecraft.world.level.block.Blocks

The level 8 value means "falling water" which will flow outward and downward, then drain naturally when not sustained by a source block.
  </action>
  <verify>
./gradlew build --quiet
Build succeeds without errors.
  </verify>
  <done>
CopperWaterBucketItem.kt places flowing water (FLOWING_WATER with LEVEL=8), schedules tick, build passes.
  </done>
</task>

</tasks>

<verification>
1. Build verification: `./gradlew build --quiet` passes
2. Mixin registration: BucketItemLavaMixin appears in thc.mixins.json
3. Code verification:
   - BucketItemLavaMixin.java contains `Items.LAVA_BUCKET` check and `InteractionResult.FAIL` return
   - CopperWaterBucketItem.kt contains `Fluids.FLOWING_WATER`, `setValue(FlowingFluid.LEVEL, 8)`, and `scheduleTick`
</verification>

<success_criteria>
1. BUCK-04: Lava bucket placement blocked via BucketItem.use() HEAD injection returning FAIL for Items.LAVA_BUCKET
2. WATR-01: Copper water bucket places flowing water at level 8 (not source block)
3. WATR-02: Placed water uses vanilla flowing physics via scheduleTick (flows and drains naturally)
4. Build passes with all changes
</success_criteria>

<output>
After completion, create `.planning/phases/49-fluid-placement-mechanics/49-01-SUMMARY.md`
</output>
