---
phase: 50-elytra-flight-changes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/thc/mixin/FireworkRocketEntityMixin.java
  - src/main/java/thc/mixin/PlayerElytraMixin.java
  - src/main/resources/thc.mixins.json
autonomous: true

must_haves:
  truths:
    - "Firework rockets do not boost player speed during elytra flight"
    - "Player gains 2x speed multiplier when diving"
    - "Player loses 1.8x speed when ascending"
  artifacts:
    - path: "src/main/java/thc/mixin/FireworkRocketEntityMixin.java"
      provides: "Firework boost cancellation"
      contains: "@Redirect"
    - path: "src/main/java/thc/mixin/PlayerElytraMixin.java"
      provides: "Pitch-based velocity multipliers"
      contains: "isFallFlying"
  key_links:
    - from: "FireworkRocketEntityMixin"
      to: "FireworkRocketEntity.tick"
      via: "@Redirect on addDeltaMovement call"
      pattern: "addDeltaMovement"
    - from: "PlayerElytraMixin"
      to: "LivingEntity.travel"
      via: "HEAD+TAIL velocity capture and modification"
      pattern: "setDeltaMovement.*hurtMarked"
---

<objective>
Implement skill-based elytra flight mechanics that reward diving over firework spam.

Purpose: Remove trivial elytra propulsion (firework spam) and replace with skill-based diving mechanics that amplify natural glide physics.
Output: Two mixin classes blocking firework boost and applying pitch-based velocity multipliers.
</objective>

<execution_context>
@/home/tack/.claude/get-shit-done/workflows/execute-plan.md
@/home/tack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/50-elytra-flight-changes/50-CONTEXT.md
@.planning/phases/50-elytra-flight-changes/50-RESEARCH.md
@src/main/java/thc/mixin/WindChargePlayerBoostMixin.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Block firework rocket boost during elytra flight</name>
  <files>
    src/main/java/thc/mixin/FireworkRocketEntityMixin.java
    src/main/resources/thc.mixins.json
  </files>
  <action>
Create FireworkRocketEntityMixin.java that intercepts the velocity addition to attached gliding players.

Implementation:
1. Create mixin targeting FireworkRocketEntity
2. Use @Redirect on tick() method to intercept the addDeltaMovement call that targets the attached LivingEntity
3. In the redirect, check if the target is a Player - if so, do nothing (cancel boost); otherwise call original method
4. Target signature: Lnet/minecraft/world/entity/LivingEntity;addDeltaMovement(Lnet/minecraft/world/phys/Vec3;)V

Register the mixin in thc.mixins.json.

Per CONTEXT.md: Fireworks may still fire visually, just no velocity change. The visual explosion is unaffected - only the velocity addition is cancelled.

Reference WindChargePlayerBoostMixin for velocity modification patterns and ServerPlayer type checking.
  </action>
  <verify>
Run `./gradlew build` - build succeeds with no mixin errors.
  </verify>
  <done>
FireworkRocketEntityMixin.java exists and is registered. Mixin cancels velocity addition to players during elytra flight while preserving firework entity behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply pitch-based velocity multipliers during elytra flight</name>
  <files>
    src/main/java/thc/mixin/PlayerElytraMixin.java
    src/main/resources/thc.mixins.json
  </files>
  <action>
Create PlayerElytraMixin.java that modifies velocity deltas based on pitch during elytra gliding.

Implementation:
1. Create mixin targeting LivingEntity
2. Use @Unique fields to store velocity before travel() runs:
   - thc$velocityXBefore, thc$velocityYBefore, thc$velocityZBefore
3. Use @Inject at HEAD of travel(Vec3) to capture velocity if entity is ServerPlayer and isFallFlying()
4. Use @Inject at TAIL of travel(Vec3) to:
   - Check if ServerPlayer and isFallFlying() (skip otherwise)
   - Calculate delta: velAfter - velBefore for each component
   - Get pitch via player.getXRot() (positive = looking down = diving, negative = looking up = ascending)
   - Apply multiplier: pitch >= 0 ? 2.0 : 1.8 to all three delta components
   - Set new velocity: velBefore + (delta * multiplier)
   - Set player.hurtMarked = true for client sync

Per CONTEXT.md decisions:
- Multipliers apply to the delta (speed change per tick), not absolute velocity
- No discrete pitch thresholds - sign of pitch determines multiplier
- Pitch >= 0 (diving or neutral): 2x multiplier on delta
- Pitch < 0 (ascending): 1.8x multiplier on delta

Critical: Always set hurtMarked = true after setDeltaMovement() for client sync.
  </action>
  <verify>
Run `./gradlew build` - build succeeds with no mixin errors.
  </verify>
  <done>
PlayerElytraMixin.java exists and is registered. Mixin captures velocity before travel(), calculates delta after, and applies pitch-based multiplier to amplify natural glide physics.
  </done>
</task>

</tasks>

<verification>
1. Run `./gradlew build` - project compiles without errors
2. Verify both mixins registered in thc.mixins.json
3. Verify FireworkRocketEntityMixin has @Redirect targeting addDeltaMovement
4. Verify PlayerElytraMixin has HEAD+TAIL injections on travel with hurtMarked sync
</verification>

<success_criteria>
1. Build succeeds with both mixins registered
2. FireworkRocketEntityMixin cancels velocity addition for Player entities
3. PlayerElytraMixin applies 2x/1.8x multiplier to velocity delta based on pitch sign
4. hurtMarked flag set after velocity modification for client sync
</success_criteria>

<output>
After completion, create `.planning/phases/50-elytra-flight-changes/50-01-SUMMARY.md`
</output>
