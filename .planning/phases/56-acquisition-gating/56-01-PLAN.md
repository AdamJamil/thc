---
phase: 56-acquisition-gating
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/kotlin/thc/enchant/EnchantmentEnforcement.kt
  - src/main/kotlin/thc/THC.kt
autonomous: true

must_haves:
  truths:
    - "Stage 3+ enchanted books are removed from chest and fishing loot"
    - "Items with stage 3+ enchantments are removed from chest and fishing loot"
    - "Stage 1-2 enchanted books (including lure, luck_of_the_sea) remain in loot"
    - "Mob drops are unaffected by filtering (only chest/fishing targeted)"
  artifacts:
    - path: "src/main/kotlin/thc/enchant/EnchantmentEnforcement.kt"
      provides: "isStage3Plus() helper and updated STAGE_1_2_ENCHANTMENTS"
      contains: "fun isStage3Plus"
    - path: "src/main/kotlin/thc/THC.kt"
      provides: "Extended MODIFY_DROPS handler with stage 3+ filtering"
      contains: "isStage3Plus"
  key_links:
    - from: "src/main/kotlin/thc/THC.kt"
      to: "EnchantmentEnforcement.isStage3Plus"
      via: "function call in MODIFY_DROPS"
      pattern: "EnchantmentEnforcement\\.isStage3Plus"
---

<objective>
Add runtime filtering to remove stage 3+ enchantment books and enchanted items from all loot tables (chests, fishing, etc.) while preserving stage 1-2 items.

Purpose: Gate powerful enchantments to specific mob drops, making them exclusive rewards for combat rather than random chest finds.
Output: Updated EnchantmentEnforcement.kt with stage classification helpers, extended MODIFY_DROPS handler in THC.kt
</objective>

<execution_context>
@/home/tack/.claude/get-shit-done/workflows/execute-plan.md
@/home/tack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/56-acquisition-gating/56-RESEARCH.md
@src/main/kotlin/thc/enchant/EnchantmentEnforcement.kt
@src/main/kotlin/thc/THC.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update EnchantmentEnforcement with stage 3+ classification</name>
  <files>src/main/kotlin/thc/enchant/EnchantmentEnforcement.kt</files>
  <action>
Add lure and luck_of_the_sea to STAGE_1_2_ENCHANTMENTS set (these are fishing rod enchantments that should remain accessible via lectern):
```kotlin
val STAGE_1_2_ENCHANTMENTS = setOf(
    // Stage 1
    "minecraft:mending",
    "minecraft:unbreaking",
    // Stage 2
    "minecraft:efficiency",
    "minecraft:fortune",
    "minecraft:silk_touch",
    // Fishing (stage 1-2 for lectern access)
    "minecraft:lure",
    "minecraft:luck_of_the_sea"
)
```

Add isStage3Plus() helper function:
```kotlin
/**
 * Check if an enchantment is stage 3 or higher.
 * Stage 3+ enchantments are NOT in STAGE_1_2_ENCHANTMENTS and NOT in REMOVED_ENCHANTMENTS.
 * Used for filtering loot tables to gate powerful enchantments to mob drops.
 */
fun isStage3Plus(enchantId: String?): Boolean {
    if (enchantId == null) return false
    return !STAGE_1_2_ENCHANTMENTS.contains(enchantId) &&
           !REMOVED_ENCHANTMENTS.contains(enchantId)
}

/**
 * Check if ItemEnchantments contains any stage 3+ enchantments.
 */
fun hasStage3PlusEnchantment(enchantments: ItemEnchantments?): Boolean {
    if (enchantments == null || enchantments.isEmpty) return false
    return enchantments.entrySet().any { entry ->
        val enchantId = entry.key.unwrapKey().orElse(null)?.identifier()?.toString()
        isStage3Plus(enchantId)
    }
}
```
  </action>
  <verify>Build compiles: `./gradlew build` completes without errors. Verify STAGE_1_2_ENCHANTMENTS has 7 entries (mending, unbreaking, efficiency, fortune, silk_touch, lure, luck_of_the_sea).</verify>
  <done>EnchantmentEnforcement has isStage3Plus() and hasStage3PlusEnchantment() functions, STAGE_1_2_ENCHANTMENTS includes fishing enchantments.</done>
</task>

<task type="auto">
  <name>Task 2: Extend MODIFY_DROPS to filter stage 3+ enchantments</name>
  <files>src/main/kotlin/thc/THC.kt</files>
  <action>
Extend the existing LootTableEvents.MODIFY_DROPS handler to filter stage 3+ items AFTER the existing removedItems filter but BEFORE correctStack() is called.

Add filtering logic after the existing `drops.removeIf { stack -> removedItems.any { stack.is(it) } }` line:
```kotlin
// Filter stage 3+ enchanted books (chests, fishing treasure)
drops.removeIf { stack ->
    if (stack.`is`(Items.ENCHANTED_BOOK)) {
        val stored = stack.get(DataComponents.STORED_ENCHANTMENTS)
        EnchantmentEnforcement.hasStage3PlusEnchantment(stored)
    } else {
        // Filter items (armor, weapons) with stage 3+ enchantments
        val enchants = stack.get(DataComponents.ENCHANTMENTS)
        EnchantmentEnforcement.hasStage3PlusEnchantment(enchants)
    }
}
```

Important: This goes AFTER the removedItems filter and Blast Totem replacement, but BEFORE the correctStack() loop.

Add necessary import if not present: `import net.minecraft.world.item.Items`
  </action>
  <verify>Build compiles: `./gradlew build` completes without errors.</verify>
  <done>MODIFY_DROPS handler filters out enchanted books with stage 3+ enchantments and items with stage 3+ enchantments from all loot drops.</done>
</task>

</tasks>

<verification>
1. Build succeeds: `./gradlew build`
2. Code review: EnchantmentEnforcement.STAGE_1_2_ENCHANTMENTS contains 7 entries
3. Code review: isStage3Plus returns true for "minecraft:sharpness", false for "minecraft:mending"
4. Code review: MODIFY_DROPS handler has stage 3+ filtering before correctStack loop
</verification>

<success_criteria>
- EnchantmentEnforcement.kt has isStage3Plus() and hasStage3PlusEnchantment() functions
- STAGE_1_2_ENCHANTMENTS includes lure and luck_of_the_sea (7 total)
- THC.kt MODIFY_DROPS filters stage 3+ books and enchanted items
- Build compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/56-acquisition-gating/56-01-SUMMARY.md`
</output>
