---
phase: 57-soul-economy-combat-tuning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - data/minecraft/loot_table/entities/pillager.json
  - data/minecraft/loot_table/entities/vindicator.json
  - data/minecraft/loot_table/entities/evoker.json
  - data/minecraft/loot_table/entities/illusioner.json
  - data/minecraft/loot_table/entities/ravager.json
  - data/minecraft/loot_table/entities/witch.json
  - src/main/resources/data/thc/recipe/soul_soil.json
  - src/main/java/thc/mixin/AbstractArrowMixin.java
  - src/main/kotlin/thc/monster/DamageRebalancing.kt
autonomous: true

must_haves:
  truths:
    - "Pillagers drop soul dust at 20% rate on death"
    - "Vindicators drop soul dust at 20% rate on death"
    - "Evokers drop soul dust at 20% rate on death"
    - "Illusioners drop soul dust at 20% rate on death"
    - "Ravagers drop soul dust at 20% rate on death"
    - "Witches drop soul dust at 20% rate on death"
    - "4 soul dust in 2x2 pattern crafts 1 soul soil"
    - "Arrow hits apply Speed III (not Speed IV) to targets"
    - "Melee pillagers deal 6.5 damage (not 4.5)"
  artifacts:
    - path: "data/minecraft/loot_table/entities/pillager.json"
      provides: "Soul dust pool added to pillager drops"
      contains: "thc:soul_dust"
    - path: "data/minecraft/loot_table/entities/vindicator.json"
      provides: "Soul dust pool added to vindicator drops"
      contains: "thc:soul_dust"
    - path: "data/minecraft/loot_table/entities/evoker.json"
      provides: "Soul dust pool added to evoker drops"
      contains: "thc:soul_dust"
    - path: "data/minecraft/loot_table/entities/illusioner.json"
      provides: "Soul dust pool added to illusioner drops"
      contains: "thc:soul_dust"
    - path: "data/minecraft/loot_table/entities/ravager.json"
      provides: "Soul dust pool added to ravager drops"
      contains: "thc:soul_dust"
    - path: "data/minecraft/loot_table/entities/witch.json"
      provides: "Soul dust pool added to witch drops"
      contains: "thc:soul_dust"
    - path: "src/main/resources/data/thc/recipe/soul_soil.json"
      provides: "2x2 crafting recipe for soul soil"
      contains: "minecraft:soul_soil"
    - path: "src/main/java/thc/mixin/AbstractArrowMixin.java"
      provides: "Arrow hit speed effect at amplifier 2"
      contains: "SPEED.*2"
    - path: "src/main/kotlin/thc/monster/DamageRebalancing.kt"
      provides: "Melee pillager damage modifier"
      contains: "pillager_melee_damage"
  key_links:
    - from: "data/minecraft/loot_table/entities/*.json"
      to: "thc:soul_dust"
      via: "loot table entry"
      pattern: "thc:soul_dust"
    - from: "src/main/resources/data/thc/recipe/soul_soil.json"
      to: "thc:soul_dust"
      via: "recipe ingredient"
      pattern: "thc:soul_dust"
    - from: "DamageRebalancing.kt"
      to: "EntityType.PILLAGER"
      via: "type check with iron sword equipment"
      pattern: "PILLAGER.*IRON_SWORD"
---

<objective>
Implement soul economy (illager drops + crafting) and combat tuning (arrow speed + pillager damage).

Purpose: Enable soul dust farming from illagers and soul soil crafting for enchanting table progression; fine-tune combat balance for arrow kiting and melee pillager threat.
Output: 6 modified loot tables, 1 new recipe, modified arrow mixin, modified damage rebalancing.
</objective>

<execution_context>
@/home/tack/.claude/get-shit-done/workflows/execute-plan.md
@/home/tack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v2.6-ROADMAP.md
@.planning/phases/57-soul-economy-combat-tuning/57-RESEARCH.md

# Existing files to modify
@data/minecraft/loot_table/entities/pillager.json
@data/minecraft/loot_table/entities/vindicator.json
@data/minecraft/loot_table/entities/evoker.json
@data/minecraft/loot_table/entities/illusioner.json
@data/minecraft/loot_table/entities/ravager.json
@data/minecraft/loot_table/entities/witch.json
@src/main/java/thc/mixin/AbstractArrowMixin.java
@src/main/kotlin/thc/monster/DamageRebalancing.kt

# Reference patterns
@data/minecraft/loot_table/entities/blaze.json (random_chance_with_enchanted_bonus pattern)
@src/main/resources/data/thc/recipe/enchanting_table.json (shaped recipe pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add soul dust drops to illagers and create soul soil recipe</name>
  <files>
    data/minecraft/loot_table/entities/pillager.json
    data/minecraft/loot_table/entities/vindicator.json
    data/minecraft/loot_table/entities/evoker.json
    data/minecraft/loot_table/entities/illusioner.json
    data/minecraft/loot_table/entities/ravager.json
    data/minecraft/loot_table/entities/witch.json
    src/main/resources/data/thc/recipe/soul_soil.json
  </files>
  <action>
Add a soul dust drop pool to each of the 6 illager loot tables. The pool structure (from blaze.json pattern):

```json
{
  "bonus_rolls": 0.0,
  "conditions": [
    {
      "condition": "minecraft:random_chance_with_enchanted_bonus",
      "enchantment": "minecraft:looting",
      "enchanted_chance": {
        "type": "minecraft:linear",
        "base": 0.21,
        "per_level_above_first": 0.0
      },
      "unenchanted_chance": 0.2
    }
  ],
  "entries": [
    {
      "type": "minecraft:item",
      "name": "thc:soul_dust"
    }
  ],
  "rolls": 1.0
}
```

For each loot table:
- pillager.json: Add this pool to existing pools array (preserve ominous_bottle pool)
- vindicator.json: Add this pool to existing pools array (preserve emerald pool)
- evoker.json: Add this pool to existing pools array (preserve totem and emerald pools)
- illusioner.json: Add pools array with just this pool (currently empty table)
- ravager.json: Replace saddle pool with soul dust pool (saddles removed in v2.4)
- witch.json: Add this pool to existing pools array (preserve all ingredient pools)

Create soul_soil.json recipe:
```json
{
  "type": "minecraft:crafting_shaped",
  "category": "building",
  "key": {
    "D": "thc:soul_dust"
  },
  "pattern": [
    "DD",
    "DD"
  ],
  "result": {
    "count": 1,
    "id": "minecraft:soul_soil"
  }
}
```
  </action>
  <verify>
- `./gradlew build` compiles without errors
- Verify all 6 loot tables contain `thc:soul_dust` entry
- Verify soul_soil.json exists and has valid JSON structure
  </verify>
  <done>
- All 6 illager types have 20% soul dust drop rate with +1% per Looting level
- 4 soul dust crafts 1 soul soil in 2x2 pattern
  </done>
</task>

<task type="auto">
  <name>Task 2: Reduce arrow speed effect from Speed IV to Speed III</name>
  <files>src/main/java/thc/mixin/AbstractArrowMixin.java</files>
  <action>
In AbstractArrowMixin.java line 67, change the Speed effect amplifier from 4 to 2.

Current (Speed V, displayed as Speed IV):
```java
target.addEffect(new MobEffectInstance(MobEffects.SPEED, THC_EFFECT_DURATION_TICKS, 4), player);
```

Change to (Speed III, displayed as Speed III):
```java
target.addEffect(new MobEffectInstance(MobEffects.SPEED, THC_EFFECT_DURATION_TICKS, 2), player);
```

Note: Minecraft effect amplifiers are 0-indexed (amplifier 0 = level I, amplifier 2 = level III).

Also update the comment on line 66 from "Apply Speed 5" to "Apply Speed 3".
  </action>
  <verify>
- `./gradlew build` compiles without errors
- Grep for `MobEffects.SPEED.*2` in AbstractArrowMixin.java returns a match
  </verify>
  <done>Arrow hits apply Speed III (amplifier 2) to target mobs instead of Speed V (amplifier 4)</done>
</task>

<task type="auto">
  <name>Task 3: Increase melee pillager damage to 6.5</name>
  <files>src/main/kotlin/thc/monster/DamageRebalancing.kt</files>
  <action>
Add melee pillager damage modifier to DamageRebalancing.kt following the existing pattern.

1. Add new ID constant:
```kotlin
private val PILLAGER_MELEE_DAMAGE_ID = Identifier.fromNamespaceAndPath("thc", "pillager_melee_damage")
```

2. Add new method:
```kotlin
/**
 * Increase melee pillager damage from ~4.5 to 6.5.
 * Melee pillagers have iron swords - check mainhand to distinguish from ranged.
 * Multiplier: 6.5 / 4.5 = 1.444, modifier = +0.444
 */
private fun applyPillagerMeleeDamage(mob: Mob) {
    if (mob.type != EntityType.PILLAGER) return
    // Only melee variants have iron sword in mainhand
    if (!mob.mainHandItem.`is`(Items.IRON_SWORD)) return

    val damageAttr = mob.getAttribute(Attributes.ATTACK_DAMAGE) ?: return
    if (!damageAttr.hasModifier(PILLAGER_MELEE_DAMAGE_ID)) {
        damageAttr.addTransientModifier(
            AttributeModifier(PILLAGER_MELEE_DAMAGE_ID, 0.444, AttributeModifier.Operation.ADD_MULTIPLIED_TOTAL)
        )
    }
}
```

3. Add required import:
```kotlin
import net.minecraft.world.item.Items
```

4. Call new method in register() ENTITY_LOAD handler:
```kotlin
applyPillagerMeleeDamage(entity)
```
  </action>
  <verify>
- `./gradlew build` compiles without errors
- Grep for `pillager_melee_damage` in DamageRebalancing.kt returns a match
- Grep for `0.444` in DamageRebalancing.kt returns a match
  </verify>
  <done>Melee pillagers (with iron sword) deal ~6.5 damage instead of ~4.5 via +44.4% damage modifier</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build verification:
   ```bash
   ./gradlew build
   ```
   Must compile without errors.

2. Loot table verification:
   ```bash
   grep -l "thc:soul_dust" data/minecraft/loot_table/entities/*.json | wc -l
   ```
   Must return 6 (all illager types).

3. Recipe verification:
   ```bash
   cat src/main/resources/data/thc/recipe/soul_soil.json | grep "minecraft:soul_soil"
   ```
   Must return the result line.

4. Arrow effect verification:
   ```bash
   grep "SPEED.*2" src/main/java/thc/mixin/AbstractArrowMixin.java
   ```
   Must match the new amplifier.

5. Pillager damage verification:
   ```bash
   grep "PILLAGER_MELEE_DAMAGE_ID" src/main/kotlin/thc/monster/DamageRebalancing.kt
   ```
   Must return the ID constant.
</verification>

<success_criteria>
Phase 57 is complete when:
- [ ] All 6 illager loot tables contain soul dust pool with 20% drop rate
- [ ] Soul soil recipe (4 soul dust -> 1 soul soil) exists and is valid
- [ ] Arrow hit speed effect uses amplifier 2 (Speed III)
- [ ] Melee pillager damage modifier (+0.444) applies to iron sword pillagers
- [ ] `./gradlew build` succeeds
- [ ] All 4 requirements (SOUL-01, SOUL-02, CMBT-01, CMBT-02) satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/57-soul-economy-combat-tuning/57-01-SUMMARY.md`
</output>
