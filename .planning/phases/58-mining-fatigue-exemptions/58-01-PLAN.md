---
phase: 58-mining-fatigue-exemptions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/resources/data/minecraft/loot_table/blocks/gravel.json
  - src/main/kotlin/thc/world/MiningFatigue.kt
autonomous: true

must_haves:
  truths:
    - "Breaking gravel with any shovel always drops flint (100% rate)"
    - "Gravel blocks can be broken without mining fatigue"
    - "Grass, podzol, mycelium, and moss blocks can be broken without mining fatigue"
    - "All flower variants can be broken without mining fatigue"
    - "All ore blocks can be broken without mining fatigue (existing)"
    - "All glass variants can be broken without mining fatigue"
    - "All bed colors can be broken without mining fatigue"
    - "All placeable-anywhere blocks (torches, chests, crafting tables, etc.) can be broken without mining fatigue"
    - "Mining fatigue still applies to stone, wood, and other non-exempt blocks outside bases"
  artifacts:
    - path: "src/main/resources/data/minecraft/loot_table/blocks/gravel.json"
      provides: "Gravel loot table override with shovel flint guarantee"
      contains: "minecraft:flint"
    - path: "src/main/kotlin/thc/world/MiningFatigue.kt"
      provides: "Expanded block exemption checking"
      contains: "isExemptBlock"
  key_links:
    - from: "MiningFatigue.kt"
      to: "WorldRestrictions.ALLOWED_BLOCKS"
      via: "set membership check"
      pattern: "ALLOWED_BLOCKS\\.contains"
    - from: "MiningFatigue.kt"
      to: "BlockTags.FLOWERS, BlockTags.DIRT, BlockTags.IMPERMEABLE, BlockTags.BEDS"
      via: "BlockState.is() tag checks"
      pattern: "state\\.`is`\\(BlockTags\\."
---

<objective>
Expand mining fatigue exemptions to cover common world blocks and implement guaranteed flint drops from gravel with shovels.

Purpose: Players can interact with traversal blocks (flowers, grass), utility blocks (placeable-anywhere allowlist), and resource blocks (ores, gravel, glass) without mining fatigue penalty. Gravel becomes a reliable flint source when using the appropriate tool.

Output: Updated MiningFatigue.kt with expanded exemption logic, new gravel loot table override.
</objective>

<execution_context>
@/home/tack/.claude/get-shit-done/workflows/execute-plan.md
@/home/tack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/58-mining-fatigue-exemptions/58-RESEARCH.md
@src/main/kotlin/thc/world/MiningFatigue.kt
@src/main/kotlin/thc/world/WorldRestrictions.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gravel loot table for guaranteed shovel flint</name>
  <files>src/main/resources/data/minecraft/loot_table/blocks/gravel.json</files>
  <action>
Create a new loot table override for gravel that guarantees flint drops when broken with any shovel.

Structure using `minecraft:alternatives`:
1. First child: Check for silk touch - drop gravel if silk touch present
2. Second child: Nested alternatives with `minecraft:survives_explosion` condition:
   a. Check for shovel (`#minecraft:shovels` item tag) - drop flint
   b. Fallback - drop gravel

Use the exact JSON structure from 58-RESEARCH.md "Gravel Loot Table with Shovel Check" section. Key details:
- `"items": "#minecraft:shovels"` uses hash prefix for item tag reference (covers all 7 shovel tiers)
- Silk touch check uses nested predicates structure with `minecraft:enchantments`
- Include `"random_sequence": "minecraft:blocks/gravel"` at root level
- Pool has `"rolls": 1.0` and `"bonus_rolls": 0.0`

Do NOT add fortune interaction - this is a guaranteed drop, not RNG.
  </action>
  <verify>
File exists at correct path and contains valid JSON with:
- `match_tool` predicate checking `#minecraft:shovels`
- `minecraft:flint` item entry
- Silk touch priority over shovel check
  </verify>
  <done>
Gravel loot table override exists that:
1. Drops gravel if broken with silk touch
2. Drops flint if broken with any shovel (without silk touch)
3. Drops gravel otherwise (hand, other tools)
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend MiningFatigue.kt with expanded exemptions</name>
  <files>src/main/kotlin/thc/world/MiningFatigue.kt</files>
  <action>
Extend the mining fatigue exemption logic in MiningFatigue.kt to cover additional block categories.

1. Add new helper function `isExemptBlock(state: BlockState): Boolean` that returns true if:
   - `state.is(BlockTags.FLOWERS)` - all flower variants (17+)
   - `state.is(BlockTags.DIRT)` - grass_block, podzol, mycelium, moss_block, mud, etc.
   - `state.is(BlockTags.IMPERMEABLE)` - all glass variants (plain, 16 stained, tinted, barrier)
   - `state.is(BlockTags.BEDS)` - all 16 bed colors
   - `state.is(Blocks.GRAVEL)` - gravel blocks specifically

2. Add ALLOWED_BLOCKS check function that references `WorldRestrictions.ALLOWED_BLOCKS`:
   - `WorldRestrictions.ALLOWED_BLOCKS.contains(state.block)` - torches, chests, crafting tables, etc.

3. In the block break handler (around line 96, after the `isOre(state)` check), add two additional exemption checks:
   ```kotlin
   // No fatigue for exempt block categories (flowers, grass, glass, beds, gravel)
   if (isExemptBlock(state)) {
       return@register true
   }

   // No fatigue for placeable-anywhere blocks
   if (WorldRestrictions.ALLOWED_BLOCKS.contains(state.block)) {
       return@register true
   }
   ```

4. Add import for WorldRestrictions at top of file:
   ```kotlin
   import thc.world.WorldRestrictions
   ```

IMPORTANT: Keep existing `isOre()` function unchanged - it already handles WRLD-05.
  </action>
  <verify>
Run `./gradlew build` to verify compilation passes. Check that:
- `isExemptBlock` function exists with BlockTags checks
- ALLOWED_BLOCKS reference exists in handler
- Existing `isOre()` function unchanged
  </verify>
  <done>
MiningFatigue.kt extended with:
1. `isExemptBlock()` helper checking flowers, dirt, impermeable, beds, gravel
2. ALLOWED_BLOCKS check for placeable-anywhere blocks
3. Both checks integrated into block break handler
4. Ores still exempt (existing functionality preserved)
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `./gradlew build` passes without errors
2. gravel.json exists at `src/main/resources/data/minecraft/loot_table/blocks/gravel.json`
3. MiningFatigue.kt contains `isExemptBlock` function
4. MiningFatigue.kt references `WorldRestrictions.ALLOWED_BLOCKS`

Functional verification (in-game):
- Break gravel with wooden shovel -> drops flint
- Break gravel with netherite shovel -> drops flint
- Break gravel with silk touch shovel -> drops gravel
- Break gravel with pickaxe -> drops gravel
- Break grass block outside base -> no mining fatigue
- Break poppy outside base -> no mining fatigue
- Break glass outside base -> no mining fatigue
- Break white bed outside base -> no mining fatigue
- Break torch outside base -> no mining fatigue
- Break stone outside base -> mining fatigue applied
</verification>

<success_criteria>
- WRLD-01: Breaking gravel with shovel always drops flint (100% rate)
- WRLD-02: Mining fatigue exempts gravel
- WRLD-03: Mining fatigue exempts grass blocks (all types via BlockTags.DIRT)
- WRLD-04: Mining fatigue exempts flower blocks (all types via BlockTags.FLOWERS)
- WRLD-05: Mining fatigue exempts ore blocks (existing, unchanged)
- WRLD-06: Mining fatigue exempts glass blocks (via BlockTags.IMPERMEABLE)
- WRLD-07: Mining fatigue exempts beds (via BlockTags.BEDS)
- WRLD-08: Mining fatigue exempts all placeable-anywhere blocks (via WorldRestrictions.ALLOWED_BLOCKS)
</success_criteria>

<output>
After completion, create `.planning/phases/58-mining-fatigue-exemptions/58-01-SUMMARY.md`
</output>
