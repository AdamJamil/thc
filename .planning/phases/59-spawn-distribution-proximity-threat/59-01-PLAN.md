---
phase: 59-spawn-distribution-proximity-threat
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/thc/spawn/SpawnDistributions.java
  - src/main/java/thc/mixin/MobDamageThreatMixin.java
autonomous: true

must_haves:
  truths:
    - "Wither skeletons spawn in deepslate caves at 15% rate"
    - "Pillagers spawn in deepslate caves at 20% rate (reduced from 25%)"
    - "Vanilla mobs spawn in deepslate caves at 35% rate (reduced from 45%)"
    - "Dealing damage adds ceil(damage/4) threat to mobs within 5 blocks of player"
    - "Direct damage target does not receive proximity threat bonus"
  artifacts:
    - path: "src/main/java/thc/spawn/SpawnDistributions.java"
      provides: "OW_LOWER_CAVE distribution with wither skeleton"
      contains: "EntityType.WITHER_SKELETON, 15"
    - path: "src/main/java/thc/mixin/MobDamageThreatMixin.java"
      provides: "Proximity threat propagation"
      contains: "Math.ceil"
  key_links:
    - from: "SpawnDistributions.java"
      to: "SpawnReplacementMixin"
      via: "selectMob() weighted random"
      pattern: "selectMob.*OW_LOWER_CAVE"
    - from: "MobDamageThreatMixin.java"
      to: "ThreatManager"
      via: "addThreat() for proximity mobs"
      pattern: "ThreatManager\\.addThreat.*proximityThreat"
---

<objective>
Add wither skeletons to deepslate region spawn pool and implement proximity-based threat propagation when dealing damage.

Purpose: Increases danger in deep caves with wither skeletons while making combat more tactical - nearby mobs become aware when player attacks.
Output: Modified spawn distribution and threat propagation logic.
</objective>

<execution_context>
@/home/tack/.claude/get-shit-done/workflows/execute-plan.md
@/home/tack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/59-spawn-distribution-proximity-threat/59-RESEARCH.md
@src/main/java/thc/spawn/SpawnDistributions.java
@src/main/java/thc/mixin/MobDamageThreatMixin.java
@src/main/java/thc/threat/ThreatManager.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add wither skeleton to deepslate spawn distribution</name>
  <files>src/main/java/thc/spawn/SpawnDistributions.java</files>
  <action>
Modify the OW_LOWER_CAVE spawn distribution table:

1. Add wither skeleton entry at 15% weight:
   ```java
   lowerCave.add(new WeightedEntry(EntityType.WITHER_SKELETON, 15));
   ```

2. Reduce pillager melee weight from 25% to 20%:
   ```java
   lowerCave.add(new WeightedEntry(EntityType.PILLAGER, "MELEE", 20)); // was 25
   ```

3. Reduce vanilla fallback from 45% to 35%:
   ```java
   lowerCave.add(new WeightedEntry(null, null, 35)); // was 45
   ```

Final OW_LOWER_CAVE distribution (must sum to 100):
- 15% wither skeleton (NEW)
- 8% blaze
- 8% breeze
- 12% vindicator
- 20% pillager melee (was 25%)
- 2% evoker
- 35% vanilla fallback (was 45%)

Total: 15 + 8 + 8 + 12 + 20 + 2 + 35 = 100

Note: Wither skeletons spawn like blazes/breezes - no fortress requirement. THC custom spawns bypass vanilla conditions.
  </action>
  <verify>
1. `./gradlew build` compiles without errors
2. Server starts without "Distribution sums to X, expected 100" error
  </verify>
  <done>
OW_LOWER_CAVE has wither skeleton at 15%, pillager at 20%, vanilla at 35%, totaling 100%.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement player-centered proximity threat</name>
  <files>src/main/java/thc/mixin/MobDamageThreatMixin.java</files>
  <action>
Rewrite the threat propagation logic in MobDamageThreatMixin.java:

1. Remove the old 15-block target-centered threat propagation entirely.

2. Implement new proximity threat:
   - Calculate proximity threat: `Math.ceil(amount / 4.0)`
   - Find mobs within 5 blocks of PLAYER (not target): `player.getBoundingBox().inflate(5.0)`
   - Skip the direct damage target (THRT-02 requirement)
   - Add proximity threat to all other nearby hostile/neutral mobs

Updated thc$propagateThreatOnDamage method:

```java
@Inject(method = "hurtServer", at = @At("TAIL"))
private void thc$propagateThreatOnDamage(
    ServerLevel level,
    DamageSource source,
    float amount,
    CallbackInfoReturnable<Boolean> cir
) {
    // Only run for Mob instances
    LivingEntity self = (LivingEntity) (Object) this;
    if (!(self instanceof Mob damagedMob)) {
        return;
    }

    // Only propagate if damage was actually dealt
    if (!cir.getReturnValue() || amount <= 0) {
        return;
    }

    // Get the player who dealt damage
    Entity attacker = source.getEntity();
    if (!(attacker instanceof ServerPlayer player)) {
        return;
    }

    // Calculate proximity threat: ceil(damage / 4)
    double proximityThreat = Math.ceil(amount / 4.0);

    // Find mobs within 5 blocks of PLAYER (not target)
    AABB area = player.getBoundingBox().inflate(5.0);
    for (Mob nearby : level.getEntitiesOfClass(Mob.class, area, MobDamageThreatMixin::thc$isHostileOrNeutral)) {
        // THRT-02: Skip the direct damage target
        if (nearby == damagedMob) {
            continue;
        }
        ThreatManager.addThreat(nearby, player.getUUID(), proximityThreat);
    }
}
```

Key changes:
- Radius: 15 blocks (target-centered) -> 5 blocks (player-centered)
- Threat amount: full damage -> ceil(damage/4)
- Direct target: included -> excluded
- Center point: damaged mob -> attacking player

Remove or update the THC_THREAT_RADIUS constant (no longer needed for proximity).
  </action>
  <verify>
1. `./gradlew build` compiles without errors
2. Code inspection confirms:
   - AABB uses player.getBoundingBox() not mob.getBoundingBox()
   - Math.ceil(amount / 4.0) calculates proximity threat
   - damagedMob is excluded from proximity threat
  </verify>
  <done>
Dealing X damage adds ceil(X/4) threat to mobs within 5 blocks of player, excluding the direct damage target.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew build` succeeds
2. `./gradlew runServer` starts without distribution sum errors
3. Code review confirms:
   - SpawnDistributions OW_LOWER_CAVE sums to 100
   - Wither skeleton entry exists at weight 15
   - Proximity threat uses player position, not target position
   - Direct damage target excluded from proximity calculation
</verification>

<success_criteria>
- [ ] SPAWN-01: Wither skeleton in OW_LOWER_CAVE at 15% weight
- [ ] SPAWN-02: Pillager weight reduced to 20%
- [ ] SPAWN-03: Vanilla fallback reduced to 35%
- [ ] THRT-01: ceil(X/4) threat added to mobs within 5 blocks of player on damage
- [ ] THRT-02: Direct damage target excluded from proximity threat
- [ ] Build succeeds with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/59-spawn-distribution-proximity-threat/59-01-SUMMARY.md`
</output>
