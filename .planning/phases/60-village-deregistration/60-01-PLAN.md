---
phase: 60-village-deregistration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/thc/mixin/PoiManagerMixin.java
  - src/main/java/thc/mixin/VillagerPoiClaimMixin.java
  - src/main/resources/thc.mixins.json
autonomous: true

must_haves:
  truths:
    - "Beds placed in claimed chunks do not register as village POI"
    - "Villagers cannot claim beds located in claimed chunks"
    - "Villages in unclaimed territory function normally"
    - "Existing village mechanics outside claimed chunks are unaffected"
  artifacts:
    - path: "src/main/java/thc/mixin/PoiManagerMixin.java"
      provides: "POI registration blocking in claimed chunks"
      contains: "thc$blockPoiInClaimedChunks"
    - path: "src/main/java/thc/mixin/VillagerPoiClaimMixin.java"
      provides: "Villager POI claiming prevention in claimed chunks"
      contains: "thc$blockPoiClaimInClaimedChunks"
  key_links:
    - from: "PoiManagerMixin.java"
      to: "ClaimManager.isClaimed"
      via: "HEAD injection on add method"
      pattern: "ClaimManager\\.INSTANCE\\.isClaimed"
    - from: "VillagerPoiClaimMixin.java"
      to: "ClaimManager.isClaimed"
      via: "injection on acquirePoi task"
      pattern: "ClaimManager\\.INSTANCE\\.isClaimed"
---

<objective>
Prevent beds and villagers in claimed chunks from registering to village mechanics.

Purpose: Players claiming a chunk should decouple it from village mechanics - beds won't count towards village population and villagers in that chunk won't be counted. This gives players control over their territory without inadvertently affecting nearby villages.

Output: Two mixins implementing a two-layer defense: (1) POI registration blocking when beds are placed in claimed chunks, (2) villager POI claiming blocking when villagers attempt to claim POI in claimed chunks.
</objective>

<execution_context>
@/home/tack/.claude/get-shit-done/workflows/execute-plan.md
@/home/tack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/60-village-deregistration/60-RESEARCH.md

# Existing patterns for chunk claim checks
@src/main/java/thc/mixin/NaturalSpawnerMixin.java
@src/main/kotlin/thc/claim/ClaimManager.kt

# Existing villager mixin (may need extension or separate mixin)
@src/main/java/thc/mixin/VillagerMixin.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PoiManagerMixin for POI Registration Blocking</name>
  <files>
    src/main/java/thc/mixin/PoiManagerMixin.java
    src/main/resources/thc.mixins.json
  </files>
  <action>
Create PoiManagerMixin.java to block POI registration in claimed chunks.

**Implementation approach:**
1. Target the `PoiManager.add` method with HEAD injection and cancellable callback
2. Convert the BlockPos parameter to ChunkPos
3. Obtain MinecraftServer instance from PoiManager's context (research needed: PoiManager may have a level/server field accessible via @Shadow, or it may need to be obtained from the method's context)
4. Call `ClaimManager.INSTANCE.isClaimed(server, chunkPos)`
5. If claimed, cancel the callback to prevent POI registration

**Critical research during implementation:**
- Decompile/inspect PoiManager class to find how to access MinecraftServer
- PoiManager is created per ServerLevel, so there should be a way to get the level reference
- Check if PoiManager has multiple `add` method overloads - may need specific method descriptor

**Follow existing pattern from NaturalSpawnerMixin:**
```java
ChunkPos chunkPos = new ChunkPos(pos);
if (ClaimManager.INSTANCE.isClaimed(server, chunkPos)) {
    ci.cancel();
}
```

**Register mixin:** Add "PoiManagerMixin" to thc.mixins.json mixins array.

**Avoid:**
- Don't use NBT tags on blocks (chunk-based check is cleaner)
- Don't try to remove existing POI (that's handled by task 2's claiming prevention)
  </action>
  <verify>
`./gradlew build` compiles successfully.
Mixin class exists at expected path.
Mixin is registered in thc.mixins.json.
  </verify>
  <done>
PoiManagerMixin blocks POI registration for beds, job sites, and bells placed in claimed chunks using HEAD injection cancellation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create VillagerPoiClaimMixin for Villager Claiming Prevention</name>
  <files>
    src/main/java/thc/mixin/VillagerPoiClaimMixin.java
    src/main/resources/thc.mixins.json
  </files>
  <action>
Create VillagerPoiClaimMixin.java to prevent villagers from claiming POI in claimed chunks.

This is the second layer of defense - even if POI exists (from before a chunk was claimed), villagers shouldn't be able to claim beds or job sites located in claimed chunks.

**Implementation approach:**
1. Research the exact method where villagers acquire/claim POI:
   - Check Villager brain memory system for HOME, JOB_SITE, MEETING_POINT
   - Likely candidates: `AcquirePoi` task, `Brain.setMemory` calls
   - May need to target villager-specific task classes
2. Inject at HEAD of the claiming method
3. Extract the BlockPos from the GlobalPos memory value
4. Check if the POI's chunk is claimed
5. Cancel if claimed

**Critical research during implementation:**
- Decompile Villager and related brain task classes in MC 1.21.11
- Find where `MemoryModuleType.HOME` and `MemoryModuleType.JOB_SITE` are set
- The memory value is typically `Optional<GlobalPos>` - extract BlockPos from GlobalPos.pos()
- Get server from villager: `((Villager)(Object)this).level().getServer()`

**Pattern for memory check:**
```java
if (value.isPresent() && value.get() instanceof GlobalPos globalPos) {
    BlockPos pos = globalPos.pos();
    ChunkPos chunkPos = new ChunkPos(pos);
    MinecraftServer server = villager.level().getServer();
    if (server != null && ClaimManager.INSTANCE.isClaimed(server, chunkPos)) {
        ci.cancel();
    }
}
```

**Note:** This is a SEPARATE mixin from the existing VillagerMixin (which handles twilight schedule). Keep concerns separated.

**Register mixin:** Add "VillagerPoiClaimMixin" to thc.mixins.json mixins array.

**Alternative approach if Brain.setMemory is too broad:**
Target the specific AcquirePoi or ValidateNearbyPoi tasks that villagers use. These are more specific but require finding the exact class names in Yarn mappings.
  </action>
  <verify>
`./gradlew build` compiles successfully.
Mixin class exists at expected path.
Mixin is registered in thc.mixins.json.
  </verify>
  <done>
VillagerPoiClaimMixin prevents villagers from claiming beds, job sites, or meeting points located in claimed chunks, providing the second layer of defense.
  </done>
</task>

</tasks>

<verification>
1. Build succeeds: `./gradlew build` completes without errors
2. Both mixins are registered in thc.mixins.json
3. PoiManagerMixin contains HEAD injection with ClaimManager check
4. VillagerPoiClaimMixin contains HEAD injection with ClaimManager check
5. Smoke test passes: `./gradlew runGameTest` (if applicable, note PlayerSleepMixin issue may still block)
</verification>

<success_criteria>
1. Beds placed in claimed chunks do not appear in POI system (blocked at registration)
2. Villagers cannot claim beds/job sites in claimed chunks (blocked at claiming)
3. Villages in unclaimed chunks function normally (claim check returns false, normal flow proceeds)
4. Build compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/60-village-deregistration/60-01-SUMMARY.md`
</output>
