---
phase: 61-smithing-table-tier-upgrades
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/thc/mixin/SmithingMenuMixin.java
  - src/main/kotlin/thc/smithing/TierUpgradeConfig.kt
  - src/main/resources/thc.mixins.json
  - src/main/resources/data/thc/recipe/leather_to_copper_helmet.json
  - src/main/resources/data/thc/recipe/leather_to_copper_chestplate.json
  - src/main/resources/data/thc/recipe/leather_to_copper_leggings.json
  - src/main/resources/data/thc/recipe/leather_to_copper_boots.json
  - src/main/resources/data/thc/recipe/copper_to_iron_helmet.json
  - src/main/resources/data/thc/recipe/copper_to_iron_chestplate.json
  - src/main/resources/data/thc/recipe/copper_to_iron_leggings.json
  - src/main/resources/data/thc/recipe/copper_to_iron_boots.json
  - src/main/resources/data/thc/recipe/iron_to_diamond_helmet.json
  - src/main/resources/data/thc/recipe/iron_to_diamond_chestplate.json
  - src/main/resources/data/thc/recipe/iron_to_diamond_leggings.json
  - src/main/resources/data/thc/recipe/iron_to_diamond_boots.json
autonomous: true

must_haves:
  truths:
    - "Leather armor upgrades to copper at smithing table"
    - "Copper armor upgrades to iron at smithing table"
    - "Iron armor upgrades to diamond at smithing table"
    - "Upgrades require crafting-equivalent material counts"
    - "Enchantments preserved during armor tier upgrade"
    - "Durability restored to maximum after upgrade"
  artifacts:
    - path: "src/main/java/thc/mixin/SmithingMenuMixin.java"
      provides: "SmithingMenu interception for count validation and consumption"
      contains: "getRequiredMaterialCount"
    - path: "src/main/kotlin/thc/smithing/TierUpgradeConfig.kt"
      provides: "Material count mappings for armor and tools"
      contains: "ARMOR_MATERIAL_COUNTS"
    - path: "src/main/resources/data/thc/recipe/leather_to_copper_helmet.json"
      provides: "Leather to copper helmet smithing recipe"
      contains: "smithing_transform"
  key_links:
    - from: "SmithingMenuMixin.java"
      to: "TierUpgradeConfig.kt"
      via: "getRequiredMaterialCount call"
      pattern: "TierUpgradeConfig\\.getRequiredMaterialCount"
    - from: "SmithingMenuMixin.java"
      to: "DataComponents.DAMAGE"
      via: "durability restoration"
      pattern: "remove.*DAMAGE"
---

<objective>
Implement SmithingMenu mixin infrastructure and armor tier upgrade recipes for leather->copper->iron->diamond progression.

Purpose: Enable players to upgrade armor tiers at smithing tables with proper material costs, enchantment preservation, and durability restoration.
Output: Working armor tier upgrades with mixin infrastructure reusable for tool upgrades.
</objective>

<execution_context>
@/home/tack/.claude/get-shit-done/workflows/execute-plan.md
@/home/tack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/61-smithing-table-tier-upgrades/61-RESEARCH.md
@src/main/java/thc/mixin/AnvilMenuMixin.java (pattern reference)
@src/main/kotlin/thc/armor/ArmorRebalancing.kt (confirms copper armor exists)
@data/minecraft/recipe/netherite_helmet_smithing.json (vanilla smithing format)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TierUpgradeConfig and SmithingMenuMixin</name>
  <files>
    src/main/kotlin/thc/smithing/TierUpgradeConfig.kt
    src/main/java/thc/mixin/SmithingMenuMixin.java
    src/main/resources/thc.mixins.json
  </files>
  <action>
Create TierUpgradeConfig.kt in src/main/kotlin/thc/smithing/:
- Object with ARMOR_MATERIAL_COUNTS map: base item -> required material count
  - Helmet: 5 (leather, copper, iron)
  - Chestplate: 8 (leather, copper, iron)
  - Leggings: 7 (leather, copper, iron)
  - Boots: 4 (leather, copper, iron)
- VALID_TIER_UPGRADES map: Pair(base, addition) -> result item
  - Leather armor + copper ingot -> copper armor
  - Copper armor + iron ingot -> iron armor
  - Iron armor + diamond -> diamond armor
- getRequiredMaterialCount(baseItem: Item): Int function
- getUpgradeResult(baseItem: Item, additionItem: Item): Item? function
- isValidTierUpgrade(baseItem: Item, additionItem: Item): Boolean function

Create SmithingMenuMixin.java extending ItemCombinerMenu (like AnvilMenuMixin):
- @Mixin(SmithingMenu.class)
- @Inject on createResult at HEAD:
  - Get base item from inputSlots.getItem(1)
  - Get addition item from inputSlots.getItem(2)
  - Check if valid tier upgrade via TierUpgradeConfig.isValidTierUpgrade()
  - If tier upgrade but count insufficient: set result to EMPTY, cancel
  - If tier upgrade with sufficient count: create result with:
    - Copy enchantments from base item (vanilla does this automatically)
    - Remove DataComponents.DAMAGE (restores durability)
    - Set to resultSlots.setItem(0, result)
    - Cancel to skip vanilla logic
- @Inject on onTake at RETURN:
  - If was tier upgrade (check via stored flag or recheck):
    - Consume extra materials: addition.shrink(requiredCount - 1)

Register mixin in thc.mixins.json.

Note: The template slot is required by vanilla UI. Use BARRIER as dummy template in recipes - the mixin will bypass template requirement for tier upgrades by checking only base+addition validity.
  </action>
  <verify>
Run `./gradlew build` - compilation succeeds with new mixin.
  </verify>
  <done>
SmithingMenuMixin intercepts tier upgrades, validates material count, consumes correct amount, restores durability.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Armor Tier Upgrade Recipes</name>
  <files>
    src/main/resources/data/thc/recipe/leather_to_copper_helmet.json
    src/main/resources/data/thc/recipe/leather_to_copper_chestplate.json
    src/main/resources/data/thc/recipe/leather_to_copper_leggings.json
    src/main/resources/data/thc/recipe/leather_to_copper_boots.json
    src/main/resources/data/thc/recipe/copper_to_iron_helmet.json
    src/main/resources/data/thc/recipe/copper_to_iron_chestplate.json
    src/main/resources/data/thc/recipe/copper_to_iron_leggings.json
    src/main/resources/data/thc/recipe/copper_to_iron_boots.json
    src/main/resources/data/thc/recipe/iron_to_diamond_helmet.json
    src/main/resources/data/thc/recipe/iron_to_diamond_chestplate.json
    src/main/resources/data/thc/recipe/iron_to_diamond_leggings.json
    src/main/resources/data/thc/recipe/iron_to_diamond_boots.json
  </files>
  <action>
Create 12 smithing_transform recipes in src/main/resources/data/thc/recipe/:

For each armor piece, create recipe JSON:
```json
{
  "type": "minecraft:smithing_transform",
  "template": "minecraft:barrier",
  "base": "minecraft:{tier}_{piece}",
  "addition": "minecraft:{material}",
  "result": {
    "id": "minecraft:{next_tier}_{piece}"
  }
}
```

Leather -> Copper (using copper_ingot):
- leather_to_copper_helmet.json: leather_helmet + copper_ingot -> copper_helmet
- leather_to_copper_chestplate.json: leather_chestplate + copper_ingot -> copper_chestplate
- leather_to_copper_leggings.json: leather_leggings + copper_ingot -> copper_leggings
- leather_to_copper_boots.json: leather_boots + copper_ingot -> copper_boots

Copper -> Iron (using iron_ingot):
- copper_to_iron_helmet.json: copper_helmet + iron_ingot -> iron_helmet
- copper_to_iron_chestplate.json: copper_chestplate + iron_ingot -> iron_chestplate
- copper_to_iron_leggings.json: copper_leggings + iron_ingot -> iron_leggings
- copper_to_iron_boots.json: copper_boots + iron_ingot -> iron_boots

Iron -> Diamond (using diamond):
- iron_to_diamond_helmet.json: iron_helmet + diamond -> diamond_helmet
- iron_to_diamond_chestplate.json: iron_chestplate + diamond -> diamond_chestplate
- iron_to_diamond_leggings.json: iron_leggings + diamond -> diamond_leggings
- iron_to_diamond_boots.json: iron_boots + diamond -> diamond_boots

Note: The mixin handles material count validation (e.g., helmet needs 5 ingots even though recipe shows 1). Enchantment preservation is automatic with smithing_transform type.
  </action>
  <verify>
Run `./gradlew build` - JSON files are valid and included in JAR.
  </verify>
  <done>
12 armor tier upgrade recipes exist covering leather->copper->iron->diamond for all 4 armor pieces.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew build` succeeds
2. SmithingMenuMixin.java compiles and is registered
3. TierUpgradeConfig.kt contains all armor material counts
4. 12 recipe JSON files exist in data/thc/recipe/
5. Recipe files use correct minecraft:smithing_transform type
</verification>

<success_criteria>
- SMTH-01: Leather armor upgrades to copper (recipes + mixin validation)
- SMTH-02: Copper armor upgrades to iron (recipes + mixin validation)
- SMTH-03: Iron armor upgrades to diamond (recipes + mixin validation)
- SMTH-08: Tier upgrades preserve enchantments (automatic via smithing_transform)
- SMTH-09: Tier upgrades restore durability (mixin removes DAMAGE component)
</success_criteria>

<output>
After completion, create `.planning/phases/61-smithing-table-tier-upgrades/61-01-SUMMARY.md`
</output>
