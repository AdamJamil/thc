---
phase: 67-job-restriction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/thc/villager/AllowedProfessions.java
  - src/main/java/thc/mixin/VillagerProfessionMixin.java
  - src/main/resources/thc.mixins.json
autonomous: true

must_haves:
  truths:
    - "Villagers cannot acquire disallowed professions (armorer, cleric, farmer, etc.)"
    - "Attempts to set disallowed profession result in NONE profession instead"
    - "Zombie villager cures with disallowed professions become jobless"
    - "Naturally spawned villagers with disallowed professions become jobless"
  artifacts:
    - path: "src/main/java/thc/villager/AllowedProfessions.java"
      provides: "Profession validation and job block constants"
      contains: "ALLOWED"
    - path: "src/main/java/thc/mixin/VillagerProfessionMixin.java"
      provides: "setVillagerData interception"
      contains: "setVillagerData"
  key_links:
    - from: "VillagerProfessionMixin.java"
      to: "AllowedProfessions.java"
      via: "isAllowed() check"
      pattern: "AllowedProfessions\\.isAllowed"
---

<objective>
Implement profession restriction at the data layer by intercepting all profession assignments.

Purpose: Prevent villagers from acquiring or keeping disallowed professions (armorer, cleric, farmer, fisherman, fletcher, leatherworker, shepherd, toolsmith, weaponsmith). This covers natural spawns, job block acquisition, zombie villager cures, and NBT loading.
Output: AllowedProfessions helper class and VillagerProfessionMixin that forces disallowed professions to NONE.
</objective>

<execution_context>
@/home/tack/.claude/get-shit-done/workflows/execute-plan.md
@/home/tack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/67-job-restriction/67-RESEARCH.md

# Existing mixin patterns
@src/main/java/thc/mixin/VillagerMixin.java
@src/main/resources/thc.mixins.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AllowedProfessions helper class</name>
  <files>src/main/java/thc/villager/AllowedProfessions.java</files>
  <action>
Create the AllowedProfessions helper class with:

1. ALLOWED set containing ResourceKeys for:
   - VillagerProfession.MASON
   - VillagerProfession.LIBRARIAN
   - VillagerProfession.BUTCHER
   - VillagerProfession.CARTOGRAPHER
   - VillagerProfession.NONE
   - VillagerProfession.NITWIT

2. DISALLOWED_JOB_BLOCKS set containing Blocks for:
   - Blocks.COMPOSTER (farmer)
   - Blocks.BREWING_STAND (cleric)
   - Blocks.SMITHING_TABLE (toolsmith)
   - Blocks.BLAST_FURNACE (armorer)
   - Blocks.FLETCHING_TABLE (fletcher)
   - Blocks.CAULDRON (leatherworker)
   - Blocks.WATER_CAULDRON (leatherworker variant)
   - Blocks.LAVA_CAULDRON (leatherworker variant)
   - Blocks.POWDER_SNOW_CAULDRON (leatherworker variant)
   - Blocks.BARREL (fisherman)
   - Blocks.GRINDSTONE (weaponsmith)
   - Blocks.LOOM (shepherd)

3. Static methods:
   - isAllowed(ResourceKey<VillagerProfession> profKey) - returns true if allowed (null = allowed)
   - isDisallowedJobBlock(Block block) - returns true if block grants disallowed profession
   - getNoneHolder() - returns Holder<VillagerProfession> for NONE via BuiltInRegistries

Use Set.of() for immutable sets. Follow existing THC utility class patterns.
  </action>
  <verify>File compiles with no errors: `./gradlew compileJava`</verify>
  <done>AllowedProfessions.java exists with all constants and methods</done>
</task>

<task type="auto">
  <name>Task 2: Create VillagerProfessionMixin</name>
  <files>src/main/java/thc/mixin/VillagerProfessionMixin.java, src/main/resources/thc.mixins.json</files>
  <action>
Create VillagerProfessionMixin.java:

1. @Mixin(Villager.class)
2. @Shadow getVillagerData() method
3. @Inject at HEAD of setVillagerData method, cancellable=true
4. In injected method:
   - Extract profession from newData via newData.profession()
   - Get ResourceKey via holder.unwrapKey().orElse(null)
   - If !AllowedProfessions.isAllowed(profKey):
     - Get current data via this.getVillagerData()
     - Create fixed data with NONE profession: current.withProfession(AllowedProfessions.getNoneHolder())
     - Call ((Villager)(Object)this).setVillagerData(fixed)
     - ci.cancel() to prevent original call

Add javadoc explaining this intercepts all profession changes including AI job acquisition, NBT loading, commands, and zombie cure.

Register in thc.mixins.json - add "VillagerProfessionMixin" to the mixins array.

IMPORTANT: The existing VillagerMixin handles schedule behavior - this is a separate mixin for profession restriction.
  </action>
  <verify>
Build succeeds: `./gradlew build`
Mixin registered: grep for VillagerProfessionMixin in thc.mixins.json
  </verify>
  <done>VillagerProfessionMixin.java created and registered, build passes</done>
</task>

</tasks>

<verification>
1. `./gradlew build` completes without errors
2. VillagerProfessionMixin registered in thc.mixins.json
3. AllowedProfessions helper has ALLOWED set with 6 professions (4 allowed + NONE + NITWIT)
4. AllowedProfessions helper has DISALLOWED_JOB_BLOCKS set with 12 blocks
</verification>

<success_criteria>
- Build passes with both new files
- Mixin properly intercepts setVillagerData at HEAD
- AllowedProfessions provides validation for both professions and blocks
- Requirements VJOB-01, VJOB-02, VJOB-04 addressed (profession restriction at data layer)
</success_criteria>

<output>
After completion, create `.planning/phases/67-job-restriction/67-01-SUMMARY.md`
</output>
