---
phase: 67-job-restriction
plan: 02
type: execute
wave: 2
depends_on: ["67-01"]
files_modified:
  - src/main/java/thc/mixin/ServerLevelPoiMixin.java
autonomous: true

must_haves:
  truths:
    - "Disallowed job blocks do not register as POI"
    - "Villagers cannot see brewing stands, smithing tables, etc. as workstations"
    - "Only lecterns, smokers, stonecutters, and cartography tables grant professions"
  artifacts:
    - path: "src/main/java/thc/mixin/ServerLevelPoiMixin.java"
      provides: "POI blocking for disallowed job blocks"
      contains: "isDisallowedJobBlock"
  key_links:
    - from: "ServerLevelPoiMixin.java"
      to: "AllowedProfessions.java"
      via: "isDisallowedJobBlock() check"
      pattern: "AllowedProfessions\\.isDisallowedJobBlock"
---

<objective>
Extend ServerLevelPoiMixin to block POI registration for disallowed job blocks.

Purpose: Prevent villagers from seeing disallowed job blocks (brewing stand, smithing table, composter, etc.) as valid workstations. This is defense-in-depth alongside the VillagerProfessionMixin - even if a villager somehow tried to acquire a disallowed profession via job block, the POI wouldn't exist.
Output: Extended ServerLevelPoiMixin that blocks both claimed chunk POI and disallowed job block POI.
</objective>

<execution_context>
@/home/tack/.claude/get-shit-done/workflows/execute-plan.md
@/home/tack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/67-job-restriction/67-RESEARCH.md
@.planning/phases/67-job-restriction/67-01-SUMMARY.md

# Existing mixin to extend
@src/main/java/thc/mixin/ServerLevelPoiMixin.java
# Helper class from 67-01
@src/main/java/thc/villager/AllowedProfessions.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ServerLevelPoiMixin with job block filtering</name>
  <files>src/main/java/thc/mixin/ServerLevelPoiMixin.java</files>
  <action>
Extend the existing ServerLevelPoiMixin to also block disallowed job blocks:

1. Add import for:
   - net.minecraft.world.level.block.Block
   - thc.villager.AllowedProfessions

2. In the existing thc$blockPoiInClaimedChunks method, AFTER the claimed chunk check:
   - Get the new block: Block newBlock = newState.getBlock()
   - If AllowedProfessions.isDisallowedJobBlock(newBlock): ci.cancel()

3. Update the javadoc to mention it now blocks both:
   - POI in claimed chunks (existing)
   - POI for disallowed job blocks everywhere (new)

The logic flow should be:
```java
// Existing: block all POI in claimed chunks
if (ClaimManager.INSTANCE.isClaimed(self.getServer(), chunkPos)) {
    ci.cancel();
    return;
}

// NEW: block disallowed job site POI everywhere
Block newBlock = newState.getBlock();
if (AllowedProfessions.isDisallowedJobBlock(newBlock)) {
    ci.cancel();
}
```

IMPORTANT: Add `return;` after the claimed chunk cancel to prevent the job block check from running unnecessarily.
  </action>
  <verify>
Build succeeds: `./gradlew build`
ServerLevelPoiMixin contains isDisallowedJobBlock call
  </verify>
  <done>ServerLevelPoiMixin blocks both claimed chunk POI and disallowed job block POI</done>
</task>

</tasks>

<verification>
1. `./gradlew build` completes without errors
2. ServerLevelPoiMixin imports AllowedProfessions
3. ServerLevelPoiMixin calls isDisallowedJobBlock() on new blocks
4. Both claimed chunk blocking and job block blocking work in sequence
</verification>

<success_criteria>
- Build passes
- ServerLevelPoiMixin handles both POI blocking concerns
- Disallowed job blocks (composter, brewing stand, etc.) don't register POI
- Allowed job blocks (lectern, smoker, stonecutter, cartography table) still work
- Requirement VJOB-03 addressed (job blocks for disallowed professions don't grant jobs)
</success_criteria>

<output>
After completion, create `.planning/phases/67-job-restriction/67-02-SUMMARY.md`
</output>
