---
phase: 68-custom-trade-tables
plan: 02
type: execute
wave: 2
depends_on: ["68-01"]
files_modified:
  - src/main/java/thc/villager/CustomTradeTables.java
autonomous: true

must_haves:
  truths:
    - "Librarian level 1 has 2 trades with 50/50 variants"
    - "Librarian level 2 has 2 trades with 50/50 variants (enchanted books)"
    - "Librarian level 3 has 2 trades with 50/50 variants"
    - "Librarian level 4 has 2 trades with 50/50 variants"
    - "Librarian level 5 has 1 trade with 50/50 variant"
    - "Enchanted books have correct enchantments at THC internal levels"
  artifacts:
    - path: "src/main/java/thc/villager/CustomTradeTables.java"
      provides: "Complete librarian trade implementation"
      contains: "getLibrarianTrades"
  key_links:
    - from: "getLibrarianTrades"
      to: "createEnchantedBookTrade"
      via: "enchanted book factory calls"
      pattern: "createEnchantedBookTrade"
    - from: "createEnchantedBookTrade"
      to: "EnchantmentEnforcement.INTERNAL_LEVELS"
      via: "enchantment level lookup"
      pattern: "INTERNAL_LEVELS"
---

<objective>
Implement all 9 librarian trades (TLIB-01 through TLIB-09) with enchanted book creation using THC's internal enchantment levels.

Purpose: Librarian is the most complex profession due to enchanted book creation requiring registry access and level normalization.
Output: Complete librarian trade table with 50/50 variants for all slots.
</objective>

<execution_context>
@/home/tack/.claude/get-shit-done/workflows/execute-plan.md
@/home/tack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/68-custom-trade-tables/68-CONTEXT.md
@.planning/phases/68-custom-trade-tables/68-RESEARCH.md
@.planning/phases/68-custom-trade-tables/68-01-SUMMARY.md
@.planning/REQUIREMENTS.md (TLIB-01 through TLIB-09)
@src/main/kotlin/thc/enchant/EnchantmentEnforcement.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add enchanted book creation method</name>
  <files>src/main/java/thc/villager/CustomTradeTables.java</files>
  <action>
Add to CustomTradeTables.java:

1. Add required imports:
   - `net.minecraft.core.Holder`
   - `net.minecraft.core.Registry`
   - `net.minecraft.core.component.DataComponents`
   - `net.minecraft.core.registries.Registries`
   - `net.minecraft.resources.Identifier`
   - `net.minecraft.world.item.enchantment.Enchantment`
   - `net.minecraft.world.item.enchantment.ItemEnchantments`
   - `thc.enchant.EnchantmentEnforcement`

2. Add factory method for enchanted book trades:

```java
/**
 * Creates an enchanted book trade for librarian.
 * Uses THC's internal enchantment levels from EnchantmentEnforcement.
 *
 * @param emeraldCost Emerald cost for the trade
 * @param enchantmentId Enchantment ID without namespace (e.g., "mending")
 * @param serverLevel Server level for registry access
 * @return MerchantOffer for the enchanted book trade
 */
public static MerchantOffer createEnchantedBookTrade(
        int emeraldCost,
        String enchantmentId,
        ServerLevel serverLevel) {

    // Create enchanted book with specific enchantment
    ItemStack book = new ItemStack(Items.ENCHANTED_BOOK);

    // Get enchantment holder from registry
    Registry<Enchantment> registry = serverLevel.registryAccess()
        .lookupOrThrow(Registries.ENCHANTMENT);
    var enchantKey = ResourceKey.create(Registries.ENCHANTMENT,
        Identifier.withDefaultNamespace(enchantmentId));
    var enchantHolder = registry.get(enchantKey);

    if (enchantHolder.isPresent()) {
        // Get internal level from EnchantmentEnforcement
        String fullId = "minecraft:" + enchantmentId;
        int enchantLevel = EnchantmentEnforcement.INSTANCE.getINTERNAL_LEVELS()
            .getOrDefault(fullId, 1);

        // Build enchantments
        ItemEnchantments.Mutable builder = new ItemEnchantments.Mutable(ItemEnchantments.EMPTY);
        builder.set(enchantHolder.get(), enchantLevel);
        book.set(DataComponents.STORED_ENCHANTMENTS, builder.toImmutable());
    }

    return new MerchantOffer(
        new ItemCost(Items.EMERALD, emeraldCost),
        Optional.of(new ItemCost(Items.BOOK, 1)),
        book,
        0, Integer.MAX_VALUE, 0, 0.05f
    );
}
```

Note: EnchantmentEnforcement is a Kotlin object, access via `.INSTANCE` and use getter for the map.
  </action>
  <verify>File compiles: `cd /mnt/c/home/code/thc && ./gradlew compileJava 2>&1 | tail -20`</verify>
  <done>createEnchantedBookTrade() method exists and uses EnchantmentEnforcement.INTERNAL_LEVELS</done>
</task>

<task type="auto">
  <name>Task 2: Implement all librarian trades</name>
  <files>src/main/java/thc/villager/CustomTradeTables.java</files>
  <action>
Add to CustomTradeTables.java:

1. Add private method for librarian trades by level:

```java
/**
 * Get librarian trades for a specific level.
 * All slots have 50/50 variants per REQUIREMENTS.md TLIB-01 through TLIB-09.
 */
private static List<MerchantOffer> getLibrarianTrades(int level, ServerLevel serverLevel, RandomSource random) {
    return switch (level) {
        case 1 -> List.of(
            // TLIB-01: 24 paper -> 1e OR 1e -> 8 lanterns (50/50)
            getVariantTrade(random,
                () -> createSimpleTrade(Items.PAPER, 24, Items.EMERALD, 1),
                () -> createSimpleTrade(Items.EMERALD, 1, Items.LANTERN, 8)
            ),
            // TLIB-02: 5e + book -> mending OR 5e + book -> unbreaking (50/50)
            getVariantTrade(random,
                () -> createEnchantedBookTrade(5, "mending", serverLevel),
                () -> createEnchantedBookTrade(5, "unbreaking", serverLevel)
            )
        );
        case 2 -> List.of(
            // TLIB-03: 10e + book -> efficiency OR 10e + book -> fortune (50/50)
            getVariantTrade(random,
                () -> createEnchantedBookTrade(10, "efficiency", serverLevel),
                () -> createEnchantedBookTrade(10, "fortune", serverLevel)
            ),
            // TLIB-04: 10e + book -> silk touch OR 4 books -> 1e (50/50)
            getVariantTrade(random,
                () -> createEnchantedBookTrade(10, "silk_touch", serverLevel),
                () -> createSimpleTrade(Items.BOOK, 4, Items.EMERALD, 1)
            )
        );
        case 3 -> List.of(
            // TLIB-05: 15e + book -> protection OR 15e + book -> projectile_protection (50/50)
            getVariantTrade(random,
                () -> createEnchantedBookTrade(15, "protection", serverLevel),
                () -> createEnchantedBookTrade(15, "projectile_protection", serverLevel)
            ),
            // TLIB-06: 15e + book -> looting OR 9e -> 3 bookshelves (50/50)
            getVariantTrade(random,
                () -> createEnchantedBookTrade(15, "looting", serverLevel),
                () -> createSimpleTrade(Items.EMERALD, 9, Items.BOOKSHELF, 3)
            )
        );
        case 4 -> List.of(
            // TLIB-07: 20e + book -> sharpness OR 20e + book -> power (50/50)
            getVariantTrade(random,
                () -> createEnchantedBookTrade(20, "sharpness", serverLevel),
                () -> createEnchantedBookTrade(20, "power", serverLevel)
            ),
            // TLIB-08: 20e + book -> blast_protection OR 20e + book -> feather_falling (50/50)
            getVariantTrade(random,
                () -> createEnchantedBookTrade(20, "blast_protection", serverLevel),
                () -> createEnchantedBookTrade(20, "feather_falling", serverLevel)
            )
        );
        case 5 -> List.of(
            // TLIB-09: 30e + book -> breach OR 30e + book -> piercing (50/50)
            getVariantTrade(random,
                () -> createEnchantedBookTrade(30, "breach", serverLevel),
                () -> createEnchantedBookTrade(30, "piercing", serverLevel)
            )
        );
        default -> List.of();
    };
}
```

2. Update getTradesFor() dispatcher to call getLibrarianTrades():

In getTradesFor(), add the librarian case:
```java
if (profession.location().equals(VillagerProfession.LIBRARIAN.location())) {
    return getLibrarianTrades(level, serverLevel, random);
}
```
  </action>
  <verify>Build succeeds: `cd /mnt/c/home/code/thc && ./gradlew build 2>&1 | tail -30`</verify>
  <done>All 9 librarian trades implemented (TLIB-01 through TLIB-09) with 50/50 variants</done>
</task>

</tasks>

<verification>
1. Build succeeds: `./gradlew build`
2. getLibrarianTrades() returns correct number of trades per level:
   - Level 1: 2 trades
   - Level 2: 2 trades
   - Level 3: 2 trades
   - Level 4: 2 trades
   - Level 5: 1 trade
3. createEnchantedBookTrade() uses EnchantmentEnforcement.INTERNAL_LEVELS for levels
</verification>

<success_criteria>
- All 9 librarian trade requirements (TLIB-01 through TLIB-09) implemented
- Enchanted books use THC internal enchantment levels
- 50/50 variant selection works via getVariantTrade()
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/68-custom-trade-tables/68-02-SUMMARY.md`
</output>
