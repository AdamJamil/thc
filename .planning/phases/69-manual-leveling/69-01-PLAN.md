---
phase: 69-manual-leveling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/thc/mixin/VillagerLevelingMixin.java
  - src/main/java/thc/villager/VillagerXpConfig.java
  - src/main/resources/thc.mixins.json
autonomous: true

must_haves:
  truths:
    - "Villagers do not level up automatically when reaching XP threshold"
    - "Villager XP caps at max for current level (no overflow beyond threshold)"
    - "Each level requires specific number of trades: 2/3/4/5"
  artifacts:
    - path: "src/main/java/thc/mixin/VillagerLevelingMixin.java"
      provides: "Auto-leveling block and XP cap"
      exports: ["thc$blockAutoLeveling", "thc$capXpAtLevelMax"]
    - path: "src/main/java/thc/villager/VillagerXpConfig.java"
      provides: "XP threshold constants per level"
      exports: ["getMaxXpForLevel", "isAtMaxXp", "XP_PER_TRADE"]
  key_links:
    - from: "VillagerLevelingMixin"
      to: "VillagerXpConfig"
      via: "getMaxXpForLevel() call in rewardTradeXp injection"
      pattern: "VillagerXpConfig\\.getMaxXpForLevel"
---

<objective>
Block automatic villager leveling and implement custom XP thresholds.

Purpose: VLEV-01 requires villagers cannot auto-level; VLEV-05 requires 2/3/4/5 trades per level with XP capping
Output: VillagerLevelingMixin.java (blocks auto-level, caps XP), VillagerXpConfig.java (XP constants)
</objective>

<execution_context>
@/home/tack/.claude/get-shit-done/workflows/execute-plan.md
@/home/tack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/69-manual-leveling/69-CONTEXT.md
@.planning/phases/69-manual-leveling/69-RESEARCH.md
@src/main/java/thc/villager/AllowedProfessions.java
@src/main/java/thc/mixin/VillagerMixin.java
@src/main/resources/thc.mixins.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VillagerXpConfig with XP thresholds</name>
  <files>src/main/java/thc/villager/VillagerXpConfig.java</files>
  <action>
Create VillagerXpConfig.java in the existing thc.villager package with:
- XP_PER_TRADE = 5 (uniform XP gain per trade)
- MAX_XP_PER_LEVEL array: [0, 10, 15, 20, 25, 0] for levels 0-5
  - Level 1 (Novice): 10 XP = 2 trades
  - Level 2 (Apprentice): 15 XP = 3 trades
  - Level 3 (Journeyman): 20 XP = 4 trades
  - Level 4 (Expert): 25 XP = 5 trades
  - Level 5 (Master): 0 (no more leveling)
- getMaxXpForLevel(int level): Returns max XP for given level
- isAtMaxXp(int level, int currentXp): Returns true if XP >= max for level

Follow AllowedProfessions.java style (final class, private constructor, static methods).
  </action>
  <verify>File compiles: `./gradlew compileJava --quiet 2>&1 | head -20`</verify>
  <done>VillagerXpConfig.java exists with XP constants matching 2/3/4/5 trades per level requirement</done>
</task>

<task type="auto">
  <name>Task 2: Create VillagerLevelingMixin to block auto-level and cap XP</name>
  <files>src/main/java/thc/mixin/VillagerLevelingMixin.java, src/main/resources/thc.mixins.json</files>
  <action>
Create VillagerLevelingMixin.java with two injections:

1. Block auto-leveling (VLEV-01):
   @Inject(method = "shouldIncreaseLevel", at = @At("HEAD"), cancellable = true)
   Return false always - prevents vanilla increaseMerchantCareer() call

2. Cap XP at level max (VLEV-05):
   @Inject(method = "rewardTradeXp", at = @At("TAIL"))
   After trade XP is awarded, cap tradingXp at VillagerXpConfig.getMaxXpForLevel(currentLevel)
   Use @Shadow for getVillagerData() and tradingXp field

Required imports:
- net.minecraft.world.entity.npc.villager.Villager
- net.minecraft.world.entity.npc.villager.VillagerData
- net.minecraft.world.item.trading.MerchantOffer
- thc.villager.VillagerXpConfig
- Mixin annotations (Mixin, Shadow, Inject, At, CallbackInfo, CallbackInfoReturnable)

Add "VillagerLevelingMixin" to thc.mixins.json mixins array (alphabetical order after "VillagerMixin").
  </action>
  <verify>Build succeeds: `./gradlew build --quiet 2>&1 | tail -5`</verify>
  <done>VillagerLevelingMixin registered and compiles; shouldIncreaseLevel returns false; rewardTradeXp caps XP</done>
</task>

</tasks>

<verification>
1. Build passes: `./gradlew build`
2. Mixin registered: grep "VillagerLevelingMixin" src/main/resources/thc.mixins.json
3. XP config has correct values: grep -E "10|15|20|25" src/main/java/thc/villager/VillagerXpConfig.java
</verification>

<success_criteria>
- VillagerLevelingMixin.java exists with shouldIncreaseLevel and rewardTradeXp injections
- VillagerXpConfig.java exists with XP thresholds (10/15/20/25)
- Build succeeds with mixin registered
- Villagers will no longer auto-level (to be verified in 69-02 with manual testing)
</success_criteria>

<output>
After completion, create `.planning/phases/69-manual-leveling/69-01-SUMMARY.md`
</output>
