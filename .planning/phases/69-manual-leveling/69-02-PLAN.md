---
phase: 69-manual-leveling
plan: 02
type: execute
wave: 2
depends_on: ["69-01"]
files_modified:
  - src/main/kotlin/thc/villager/VillagerInteraction.kt
  - src/main/kotlin/thc/THC.kt
autonomous: true

must_haves:
  truths:
    - "Right-click villager with emerald at max XP triggers level up"
    - "Level up requires matching stage (Stage 2 for Apprentice, etc.)"
    - "Emerald is consumed on successful level up"
    - "Emerald NOT consumed when stage requirement not met"
    - "At 0 XP, emerald interaction passes through (reserved for Phase 70)"
    - "Vanilla particles and sound play on successful level up"
  artifacts:
    - path: "src/main/kotlin/thc/villager/VillagerInteraction.kt"
      provides: "UseEntityCallback handler for villager emerald interactions"
      exports: ["register"]
    - path: "src/main/kotlin/thc/THC.kt"
      provides: "VillagerInteraction.register() call"
      contains: "VillagerInteraction.register()"
  key_links:
    - from: "VillagerInteraction.kt"
      to: "VillagerXpConfig"
      via: "import and getMaxXpForLevel/isAtMaxXp calls"
      pattern: "VillagerXpConfig\\."
    - from: "VillagerInteraction.kt"
      to: "StageManager"
      via: "getCurrentStage() for stage gate validation"
      pattern: "StageManager\\.getCurrentStage"
    - from: "THC.kt"
      to: "VillagerInteraction"
      via: "register() call in onInitialize"
      pattern: "VillagerInteraction\\.register"
---

<objective>
Implement manual villager level-up via emerald right-click with stage gates.

Purpose: VLEV-02/03/04 require emerald-based manual leveling with stage gates and consumption
Output: VillagerInteraction.kt (UseEntityCallback handler), THC.kt registration
</objective>

<execution_context>
@/home/tack/.claude/get-shit-done/workflows/execute-plan.md
@/home/tack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/69-manual-leveling/69-CONTEXT.md
@.planning/phases/69-manual-leveling/69-RESEARCH.md
@.planning/phases/69-manual-leveling/69-01-SUMMARY.md
@src/main/kotlin/thc/THC.kt
@src/main/java/thc/stage/StageManager.java
@src/main/java/thc/villager/VillagerXpConfig.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VillagerInteraction.kt with UseEntityCallback handler</name>
  <files>src/main/kotlin/thc/villager/VillagerInteraction.kt</files>
  <action>
Create VillagerInteraction.kt as Kotlin object with register() function.

UseEntityCallback.EVENT.register handler logic:
1. Only handle Villager entities
2. Only process server-side (level.isClientSide check)
3. Only trigger on emerald in hand (Items.EMERALD, not EMERALD_BLOCK)
4. Return PASS for non-emerald to open trade GUI normally

handleLevelUp() function for emerald interaction:
1. Get villager data: level (1-5), tradingXp
2. If already master (level >= 5): Show "Already at master!" via action bar, return FAIL
3. If currentXp < maxXp AND currentXp > 0: Show "Not enough experience to level up!", return FAIL
4. If currentXp == 0: Return PASS (reserved for Phase 70 cycling, no message)
5. Check stage gate: targetLevel = currentLevel + 1, requiredStage = targetLevel
   - If StageManager.getCurrentStage(server) < requiredStage: Show "Complete the next trial!", return FAIL (no emerald consumed)
6. On success:
   - Consume emerald: stack.shrink(1)
   - Increment level: villager.villagerData = data.withLevel(targetLevel)
   - Reset XP: villager.tradingXp = 0
   - Play effects: HAPPY_VILLAGER particles (10 count, spread 0.5), VILLAGER_YES sound
   - Return SUCCESS

Messages use Component.literal() with actionbar (true parameter in displayClientMessage).

Required imports:
- net.fabricmc.fabric.api.event.player.UseEntityCallback
- net.minecraft.world.InteractionResult
- net.minecraft.world.entity.npc.villager.Villager
- net.minecraft.world.item.Items
- net.minecraft.server.level.ServerPlayer
- net.minecraft.server.level.ServerLevel
- net.minecraft.network.chat.Component
- net.minecraft.core.particles.ParticleTypes
- net.minecraft.sounds.SoundEvents
- net.minecraft.sounds.SoundSource
- thc.stage.StageManager
- thc.villager.VillagerXpConfig
  </action>
  <verify>File compiles: `./gradlew compileKotlin --quiet 2>&1 | head -20`</verify>
  <done>VillagerInteraction.kt exists with register() function and complete level-up logic</done>
</task>

<task type="auto">
  <name>Task 2: Register VillagerInteraction in THC.kt</name>
  <files>src/main/kotlin/thc/THC.kt</files>
  <action>
Add VillagerInteraction.register() call to THC.onInitialize().

1. Add import: import thc.villager.VillagerInteraction
2. Add registration call after existing registrations (near other register() calls like LecternEnchanting.register())

Place the registration BEFORE the cow milking UseEntityCallback block so that villager interactions are processed first (order matters for UseEntityCallback - first handler returning SUCCESS/FAIL wins).
  </action>
  <verify>Build succeeds: `./gradlew build --quiet 2>&1 | tail -5`</verify>
  <done>VillagerInteraction.register() called in THC.onInitialize()</done>
</task>

<task type="auto">
  <name>Task 3: Verify complete integration</name>
  <files></files>
  <action>
Run full build and verify all components are wired:
1. Build succeeds with no errors
2. VillagerInteraction imported in THC.kt
3. VillagerXpConfig imported in VillagerInteraction.kt
4. StageManager imported in VillagerInteraction.kt
  </action>
  <verify>
`./gradlew build --quiet` succeeds AND
`grep -l "VillagerInteraction" src/main/kotlin/thc/THC.kt` returns file AND
`grep -l "VillagerXpConfig" src/main/kotlin/thc/villager/VillagerInteraction.kt` returns file
  </verify>
  <done>Full build passes with all imports and registrations in place</done>
</task>

</tasks>

<verification>
1. Build passes: `./gradlew build`
2. Registration exists: grep "VillagerInteraction.register" src/main/kotlin/thc/THC.kt
3. Stage check exists: grep "StageManager.getCurrentStage" src/main/kotlin/thc/villager/VillagerInteraction.kt
4. XP config used: grep "VillagerXpConfig" src/main/kotlin/thc/villager/VillagerInteraction.kt
</verification>

<success_criteria>
- VillagerInteraction.kt exists with complete level-up logic
- THC.kt calls VillagerInteraction.register()
- Build succeeds
- Stage gates use targetLevel == requiredStage mapping
- 0 XP case returns PASS (reserved for Phase 70)
- Emerald only consumed on successful level up
</success_criteria>

<output>
After completion, create `.planning/phases/69-manual-leveling/69-02-SUMMARY.md`
</output>
