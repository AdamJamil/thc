---
phase: 73-revival-mechanics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/thc/THCAttachments.java
  - src/main/java/thc/downed/RevivalState.java
  - src/main/kotlin/thc/THC.kt
autonomous: true

must_haves:
  truths:
    - "Alive player sneaking within 2 blocks of downed location accumulates revival progress"
    - "Multiple revivers each add progress per tick (stacking)"
    - "Support class adds progress at 1.0/tick (5 seconds total)"
    - "Non-Support classes add progress at 0.5/tick (10 seconds total)"
    - "Revival progress is preserved when reviver leaves (does not reset)"
  artifacts:
    - path: "src/main/java/thc/THCAttachments.java"
      provides: "REVIVAL_PROGRESS attachment"
      contains: "REVIVAL_PROGRESS"
    - path: "src/main/java/thc/downed/RevivalState.java"
      provides: "State accessor for revival progress"
      exports: ["getProgress", "setProgress", "addProgress", "clearProgress"]
    - path: "src/main/kotlin/thc/THC.kt"
      provides: "Server tick processor for revival progress"
      contains: "processRevival"
  key_links:
    - from: "src/main/kotlin/thc/THC.kt"
      to: "src/main/java/thc/downed/DownedState.java"
      via: "Check if player is downed and get downed location"
      pattern: "DownedState\\.isDowned|DownedState\\.getDownedLocation"
    - from: "src/main/kotlin/thc/THC.kt"
      to: "src/main/java/thc/downed/RevivalState.java"
      via: "Add revival progress to downed player"
      pattern: "RevivalState\\.addProgress"
    - from: "src/main/kotlin/thc/THC.kt"
      to: "src/main/java/thc/playerclass/ClassManager.java"
      via: "Check if reviver is Support class for 2x progress"
      pattern: "ClassManager\\.getClass"
---

<objective>
Add revival progress tracking: when alive players sneak within 2 blocks of a downed location, progress accumulates on the downed player.

Purpose: Foundation for revival mechanic - progress must be tracked before completion can be implemented.
Output: Working progress accumulation with class bonus (Support 2x speed) and multi-reviver stacking.
</objective>

<execution_context>
@/home/tack/.claude/get-shit-done/workflows/execute-plan.md
@/home/tack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/73-revival-mechanics/73-CONTEXT.md
@.planning/phases/73-revival-mechanics/73-RESEARCH.md

# Phase 72 artifacts (downed state foundation):
@src/main/java/thc/THCAttachments.java
@src/main/java/thc/downed/DownedState.java
@src/main/java/thc/playerclass/ClassManager.java
@src/main/java/thc/playerclass/PlayerClass.java
@src/main/kotlin/thc/THC.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add REVIVAL_PROGRESS attachment and RevivalState accessor</name>
  <files>
    src/main/java/thc/THCAttachments.java
    src/main/java/thc/downed/RevivalState.java
  </files>
  <action>
1. In THCAttachments.java, add new non-persistent Double attachment for revival progress:
   ```java
   /**
    * Tracks revival progress for a downed player (0.0 to 1.0).
    * Non-persistent - revival state should not survive server restart.
    * 0.0 when no progress, 1.0 when fully revived.
    */
   public static final AttachmentType<Double> REVIVAL_PROGRESS = AttachmentRegistry.create(
       Identifier.fromNamespaceAndPath("thc", "revival_progress"),
       builder -> builder.initializer(() -> 0.0D)
   );
   ```

2. Create RevivalState.java in thc/downed/ package following BucklerState pattern:
   ```java
   package thc.downed;

   import net.fabricmc.fabric.api.attachment.v1.AttachmentTarget;
   import net.minecraft.server.level.ServerPlayer;
   import thc.THCAttachments;

   /**
    * State accessor for revival progress.
    * Progress stored on the DOWNED player, not the reviver.
    */
   public final class RevivalState {
       private RevivalState() {}

       private static AttachmentTarget target(ServerPlayer player) {
           return (AttachmentTarget) player;
       }

       public static double getProgress(ServerPlayer player) {
           Double value = target(player).getAttachedOrCreate(THCAttachments.REVIVAL_PROGRESS);
           return value == null ? 0.0D : value;
       }

       public static void setProgress(ServerPlayer player, double value) {
           target(player).setAttached(THCAttachments.REVIVAL_PROGRESS, value);
       }

       public static void addProgress(ServerPlayer player, double amount) {
           setProgress(player, Math.min(1.0, getProgress(player) + amount));
       }

       public static void clearProgress(ServerPlayer player) {
           setProgress(player, 0.0D);
       }
   }
   ```
  </action>
  <verify>
    Run `./gradlew compileJava` - should compile without errors
  </verify>
  <done>
    REVIVAL_PROGRESS attachment exists in THCAttachments, RevivalState accessor class created with get/set/add/clear methods
  </done>
</task>

<task type="auto">
  <name>Task 2: Add server tick processor for revival progress</name>
  <files>
    src/main/kotlin/thc/THC.kt
  </files>
  <action>
1. Add imports at top of THC.kt:
   ```kotlin
   import thc.downed.DownedState
   import thc.downed.RevivalState
   ```

2. Add a new private function for revival processing:
   ```kotlin
   private fun processRevival(server: MinecraftServer) {
       val players = server.playerList.players

       // Find all downed players first
       val downedPlayers = players.filter { DownedState.isDowned(it) }
       if (downedPlayers.isEmpty()) return

       // For each alive player who is sneaking, check proximity to downed players
       for (reviver in players) {
           // Must be alive (not downed) and sneaking
           if (DownedState.isDowned(reviver)) continue
           if (!reviver.isShiftKeyDown) continue

           // Determine progress rate based on class
           val playerClass = ClassManager.getClass(reviver)
           val progressRate = if (playerClass == PlayerClass.SUPPORT) {
               1.0 / 100.0  // 100 ticks = 5 seconds to reach 1.0
           } else {
               0.5 / 100.0  // 200 ticks = 10 seconds (0.5 per tick scaled to 0-1 range)
           }

           // Check each downed player
           for (downed in downedPlayers) {
               val downedLoc = DownedState.getDownedLocation(downed) ?: continue

               // 2 block radius = 4.0 squared distance
               val distSq = reviver.position().distanceToSqr(downedLoc)
               if (distSq > 4.0) continue

               // Accumulate progress on the downed player
               RevivalState.addProgress(downed, progressRate)
           }
       }
   }
   ```

3. Register the tick processor in the existing END_SERVER_TICK registration (around line 105):
   Find:
   ```kotlin
   ServerTickEvents.END_SERVER_TICK.register(ServerTickEvents.EndTick { server ->
       updateBucklerState(server)
   })
   ```
   Change to:
   ```kotlin
   ServerTickEvents.END_SERVER_TICK.register(ServerTickEvents.EndTick { server ->
       updateBucklerState(server)
       processRevival(server)
   })
   ```

Note: Progress accumulation is naturally atomic (server tick is single-threaded). Multiple revivers calling addProgress in the same tick = stacking.
  </action>
  <verify>
    Run `./gradlew build` - should compile and build successfully
  </verify>
  <done>
    Server tick processor iterates players, finds sneaking revivers near downed locations, accumulates progress with class bonus
  </done>
</task>

</tasks>

<verification>
1. `./gradlew build` passes
2. Code inspection confirms:
   - REVIVAL_PROGRESS attachment in THCAttachments (non-persistent Double)
   - RevivalState accessor with get/set/add/clear methods
   - processRevival function in THC.kt
   - Tick processor called in END_SERVER_TICK
   - Progress rate: 0.005/tick for non-Support, 0.01/tick for Support
   - Proximity check uses distanceToSqr with 4.0 threshold (2 blocks)
</verification>

<success_criteria>
- REVIVAL_PROGRESS attachment registered (non-persistent)
- RevivalState accessor follows BucklerState pattern
- Tick processor finds downed players via DownedState.isDowned
- Revivers must be sneaking (isShiftKeyDown) within 2 blocks
- Support class gets 2x progress rate (5 seconds vs 10 seconds)
- Progress stored on downed player, naturally stacks with multiple revivers
- All code compiles and builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/73-revival-mechanics/73-01-SUMMARY.md`
</output>
