---
phase: 76-boon-buckler-gate
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/kotlin/thc/item/BucklerItem.kt
autonomous: true

must_haves:
  truths:
    - "Non-Bastion players cannot raise buckler"
    - "Bastion at Stage 1 cannot raise buckler"
    - "Bastion at Stage 2+ can raise buckler normally"
    - "Rejected raise attempts show action bar message"
  artifacts:
    - path: "src/main/kotlin/thc/item/BucklerItem.kt"
      provides: "Class + stage gate on buckler raise"
      contains: "getBoonLevel"
  key_links:
    - from: "BucklerItem.use()"
      to: "ClassManager.getClass()"
      via: "class check before raise"
      pattern: "ClassManager\\.getClass"
    - from: "BucklerItem.use()"
      to: "StageManager.getBoonLevel()"
      via: "boon level check before raise"
      pattern: "StageManager\\.getBoonLevel"
---

<objective>
Add class and stage gate to buckler raising, restricting buckler usage to Bastion class at Stage 2+.

Purpose: Buckler becomes a Bastion class boon that unlocks at Stage 2, giving Bastion unique defensive identity.
Output: Modified BucklerItem.kt with gate checks in use() method.
</objective>

<execution_context>
@/home/tack/.claude/get-shit-done/workflows/execute-plan.md
@/home/tack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/76-boon-buckler-gate/76-CONTEXT.md
@.planning/phases/76-boon-buckler-gate/76-RESEARCH.md

# Relevant source files
@src/main/kotlin/thc/item/BucklerItem.kt
@src/main/java/thc/playerclass/ClassManager.java
@src/main/java/thc/playerclass/PlayerClass.java
@src/main/java/thc/stage/StageManager.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add class and stage gate to BucklerItem.use()</name>
  <files>src/main/kotlin/thc/item/BucklerItem.kt</files>
  <action>
Modify the `use()` method in BucklerItem.kt to add class + stage gate checks immediately after the hand check (before poise/broken checks).

Add required imports at top of file:
```kotlin
import thc.playerclass.ClassManager
import thc.playerclass.PlayerClass
import thc.stage.StageManager
import net.minecraft.ChatFormatting
import net.minecraft.network.chat.Component
```

After the hand != OFF_HAND check and inside the `if (player is ServerPlayer)` block, add gate logic BEFORE the existing broken/poise checks:

```kotlin
// Buckler gate: Bastion class at Stage 2+ only
val playerClass = ClassManager.getClass(player)
val boonLevel = StageManager.getBoonLevel(player)
if (playerClass != PlayerClass.BASTION || boonLevel < 2) {
    player.displayClientMessage(
        Component.literal("Your wimpy arms cannot lift the buckler.")
            .withStyle(ChatFormatting.RED),
        true
    )
    return InteractionResult.FAIL
}
```

Note: After Phase 75 completes, the enum will be `PlayerClass.BASTION`. If Phase 75 has not yet run, use `PlayerClass.TANK` instead (check the PlayerClass.java file to see current enum name).

The check must happen BEFORE the broken/poise checks so that non-Bastion players get the class rejection message rather than a confusing "buckler broken" state.
  </action>
  <verify>
Run `./gradlew build` to verify compilation succeeds.

Grep for the gate pattern:
```bash
grep -n "getBoonLevel" src/main/kotlin/thc/item/BucklerItem.kt
grep -n "ClassManager" src/main/kotlin/thc/item/BucklerItem.kt
```
Both should return matches in the use() method.
  </verify>
  <done>
- BucklerItem.use() checks class via ClassManager.getClass()
- BucklerItem.use() checks boon level via StageManager.getBoonLevel()
- Gate requires Bastion class AND boon level >= 2
- Rejection shows "Your wimpy arms cannot lift the buckler." in red on action bar
- Gate check happens before broken/poise checks
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Build verification:**
   ```bash
   ./gradlew build
   ```
   Must complete without errors.

2. **Code verification:**
   - BucklerItem.kt imports ClassManager, PlayerClass, StageManager
   - BucklerItem.kt imports ChatFormatting, Component
   - use() method contains gate check before broken/poise checks
   - Gate check returns InteractionResult.FAIL with action bar message

3. **Manual testing (after build):**
   If user wants to verify in-game:
   - Non-Bastion class: Cannot raise buckler, sees rejection message
   - Bastion at Stage 1: Cannot raise buckler, sees rejection message
   - Bastion at Stage 2+: Can raise buckler normally
</verification>

<success_criteria>
- [x] BucklerItem.kt compiles with gate logic
- [x] Gate checks class (must be Bastion)
- [x] Gate checks boon level (must be >= 2)
- [x] Rejection displays action bar message in red
- [x] Existing buckler functionality preserved for authorized players
</success_criteria>

<output>
After completion, create `.planning/phases/76-boon-buckler-gate/76-01-SUMMARY.md`
</output>
