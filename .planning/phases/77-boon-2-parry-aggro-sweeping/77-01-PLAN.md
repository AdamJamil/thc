---
phase: 77-boon-2-parry-aggro-sweeping
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/thc/boon/BoonGate.java
  - src/main/java/thc/mixin/LivingEntityMixin.java
  - src/main/java/thc/mixin/PlayerAttackMixin.java
autonomous: true

must_haves:
  truths:
    - "Bastion at Stage 3+ parry propagates threat to nearby mobs"
    - "Bastion at Stage 3+ melee attacks apply sweeping damage"
    - "Non-Bastion classes still have sweeping disabled"
    - "Bastion at Stage 1-2 does not get parry aggro or sweeping"
  artifacts:
    - path: "src/main/java/thc/boon/BoonGate.java"
      provides: "Shared Stage 3+ gate check utility"
      exports: ["hasStage3Boon"]
    - path: "src/main/java/thc/mixin/LivingEntityMixin.java"
      provides: "Parry threat propagation"
      contains: "thc$propagateParryThreat"
    - path: "src/main/java/thc/mixin/PlayerAttackMixin.java"
      provides: "Conditional sweeping edge"
      contains: "BoonGate.hasStage3Boon"
  key_links:
    - from: "LivingEntityMixin.java"
      to: "BoonGate.hasStage3Boon"
      via: "call after parry"
      pattern: "BoonGate\\.hasStage3Boon"
    - from: "PlayerAttackMixin.java"
      to: "BoonGate.hasStage3Boon"
      via: "conditional in redirect"
      pattern: "BoonGate\\.hasStage3Boon"
    - from: "LivingEntityMixin.java"
      to: "ThreatManager.addThreat"
      via: "threat propagation call"
      pattern: "ThreatManager\\.addThreat"
---

<objective>
Implement Stage 3+ boons for Bastion class: parry threat propagation and sweeping edge enablement.

Purpose: Give Bastion a tanking identity at Stage 3+ - successful parries draw mob aggro and melee attacks cleave nearby enemies.

Output: Working parry aggro and sweeping edge gated behind Bastion class + Stage 3+ check.
</objective>

<execution_context>
@/home/tack/.claude/get-shit-done/workflows/execute-plan.md
@/home/tack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v3.1-ROADMAP.md
@.planning/phases/77-boon-2-parry-aggro-sweeping/77-CONTEXT.md
@.planning/phases/77-boon-2-parry-aggro-sweeping/77-RESEARCH.md

# Key source files
@src/main/java/thc/mixin/LivingEntityMixin.java
@src/main/java/thc/mixin/PlayerAttackMixin.java
@src/main/java/thc/threat/ThreatManager.java
@src/main/java/thc/playerclass/ClassManager.java
@src/main/java/thc/stage/StageManager.java
@src/main/java/thc/playerclass/PlayerClass.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BoonGate utility class</name>
  <files>src/main/java/thc/boon/BoonGate.java</files>
  <action>
Create new utility class `thc.boon.BoonGate` with a static method `hasStage3Boon(ServerPlayer)`.

The method should:
1. Get the player's class via `ClassManager.getClass(player)`
2. Return false if class is not `PlayerClass.BASTION`
3. Get boon level via `StageManager.getBoonLevel(player)`
4. Return true only if boon level >= 3

Pattern to follow:
```java
package thc.boon;

import net.minecraft.server.level.ServerPlayer;
import thc.playerclass.ClassManager;
import thc.playerclass.PlayerClass;
import thc.stage.StageManager;

public final class BoonGate {
    private BoonGate() {}

    public static boolean hasStage3Boon(ServerPlayer player) {
        PlayerClass playerClass = ClassManager.getClass(player);
        if (playerClass != PlayerClass.BASTION) {
            return false;
        }
        return StageManager.getBoonLevel(player) >= 3;
    }
}
```
  </action>
  <verify>File compiles: `./gradlew compileJava` succeeds without errors</verify>
  <done>BoonGate.hasStage3Boon() exists and returns true only for Bastion class with boon level 3+</done>
</task>

<task type="auto">
  <name>Task 2: Add parry threat propagation to LivingEntityMixin</name>
  <files>src/main/java/thc/mixin/LivingEntityMixin.java</files>
  <action>
Modify LivingEntityMixin to propagate threat after successful parry for Bastion Stage 3+.

1. Add import for BoonGate: `import thc.boon.BoonGate;`
2. Add import for ThreatManager: `import thc.threat.ThreatManager;`

3. In the parry success block (after line 85 `thc$stunNearby(level, player, stats);`), add the threat propagation call:
```java
// After thc$stunNearby call, before level.playSound:
if (player instanceof ServerPlayer serverPlayer && BoonGate.hasStage3Boon(serverPlayer)) {
    thc$propagateParryThreat(level, serverPlayer);
}
```

4. Add new @Unique method `thc$propagateParryThreat`:
```java
@Unique
private static void thc$propagateParryThreat(ServerLevel level, ServerPlayer player) {
    // Use same 3-block radius as stunNearby
    for (Mob mob : level.getEntitiesOfClass(Mob.class, player.getBoundingBox().inflate(3.0D),
        entity -> entity.getType().getCategory() == MobCategory.MONSTER)) {
        ThreatManager.addThreat(mob, player.getUUID(), 10.0);
    }
}
```

The 10.0 threat value matches arrow hit threat and is above the 5.0 minimum threshold for aggro.
  </action>
  <verify>File compiles: `./gradlew compileJava` succeeds without errors</verify>
  <done>Successful parry by Bastion Stage 3+ adds 10.0 threat to all monster mobs within 3 blocks</done>
</task>

<task type="auto">
  <name>Task 3: Enable conditional sweeping edge in PlayerAttackMixin</name>
  <files>src/main/java/thc/mixin/PlayerAttackMixin.java</files>
  <action>
Modify PlayerAttackMixin to conditionally enable sweeping edge for Bastion Stage 3+.

1. Add import for BoonGate: `import thc.boon.BoonGate;`

2. Modify the `thc$disableSweepAttack` redirect method to call the original method for Bastion Stage 3+:

Before:
```java
private boolean thc$disableSweepAttack(Player instance, boolean bl, boolean bl2, boolean bl3) {
    return false;
}
```

After:
```java
private boolean thc$disableSweepAttack(Player instance, boolean bl, boolean bl2, boolean bl3) {
    // Allow sweeping for Bastion Stage 3+
    if (instance instanceof ServerPlayer serverPlayer && BoonGate.hasStage3Boon(serverPlayer)) {
        return instance.isSweepAttack(bl, bl2, bl3);
    }
    return false;  // Default: sweeping disabled
}
```

The redirect intercepts the isSweepAttack call. For Bastion Stage 3+, we call through to the original method. For everyone else, we return false to disable sweeping.

NOTE: The isSweepAttack method is private but callable from within the same class via the redirect.
  </action>
  <verify>Build succeeds: `./gradlew build` completes without errors</verify>
  <done>Bastion Stage 3+ gets vanilla sweeping edge; all other players have sweeping disabled</done>
</task>

</tasks>

<verification>
1. Build: `./gradlew build` succeeds
2. Game launches: `./gradlew runClient` starts without crashes
3. Manual test parry aggro:
   - `/selectClass bastion`, `/boonlevel 3`
   - Spawn multiple zombies nearby
   - Raise buckler and parry an attack
   - Verify: All nearby mobs should switch target to player
4. Manual test sweeping:
   - `/selectClass bastion`, `/boonlevel 3`
   - Full charge sword attack near multiple mobs
   - Verify: Sweep particles appear, AoE damage applied
5. Negative test non-Bastion:
   - `/selectClass melee`, `/boonlevel 3`
   - Parry attack - no aggro redirect (stun still works)
   - Sword attack - no sweep particles
6. Negative test Bastion Stage 2:
   - `/selectClass bastion`, `/boonlevel 2`
   - Parry attack - no aggro redirect
   - Sword attack - no sweep particles
</verification>

<success_criteria>
- PRRY-01: Parry threat propagation requires Bastion class + Stage 3+ (verified by test 3 vs 5 vs 6)
- PRRY-02: Sweeping edge enabled for Bastion class + Stage 3+ (verified by test 4)
- PRRY-03: Non-Bastion players cannot use sweeping edge (verified by test 5)
</success_criteria>

<output>
After completion, create `.planning/phases/77-boon-2-parry-aggro-sweeping/77-01-SUMMARY.md`
</output>
