---
phase: 78-snowball-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/thc/mixin/SnowballHitMixin.java
  - src/main/resources/thc.mixins.json
autonomous: true

must_haves:
  truths:
    - "Bastion at Stage 4+ snowball hit applies Slowness III (2s) to target mob"
    - "Bastion at Stage 4+ snowball hit applies Slowness III (2s) to hostile mobs within 1.5 blocks"
    - "Bastion at Stage 4+ snowball hit knocks target back ~1 block away from thrower"
    - "Non-Bastion snowballs behave vanilla (no slowness, no knockback)"
    - "Bastion Stage 1-3 snowballs behave vanilla"
    - "Snowball hits on players have no effect (PvP unchanged)"
  artifacts:
    - path: "src/main/java/thc/mixin/SnowballHitMixin.java"
      provides: "Snowball hit enhancement for Bastion class"
      contains: "Snowball.class"
    - path: "src/main/resources/thc.mixins.json"
      provides: "Mixin registration"
      contains: "SnowballHitMixin"
  key_links:
    - from: "SnowballHitMixin"
      to: "ClassManager.getClass()"
      via: "Boon gate check"
      pattern: "ClassManager\\.getClass"
    - from: "SnowballHitMixin"
      to: "StageManager.getBoonLevel()"
      via: "Stage gate check"
      pattern: "StageManager\\.getBoonLevel"
    - from: "SnowballHitMixin"
      to: "MobEffects.SLOWNESS"
      via: "Effect application"
      pattern: "MobEffects\\.SLOWNESS"
---

<objective>
Implement enhanced snowball combat for Bastion class at Stage 4+. On snowball hit, apply Slowness III (2s) to the target mob and hostile mobs within 1.5 blocks, plus knock the target back ~1 block away from the thrower.

Purpose: Give Bastion class a unique crowd-control tool that rewards stage progression with tactical snowball utility.
Output: SnowballHitMixin that gates enhanced effects behind Bastion class + Stage 4+, with AoE slowness and directional knockback.
</objective>

<execution_context>
@/home/tack/.claude/get-shit-done/workflows/execute-plan.md
@/home/tack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/78-snowball-enhancement/78-CONTEXT.md
@.planning/phases/78-snowball-enhancement/78-RESEARCH.md

# Pattern references
@src/main/java/thc/mixin/AbstractArrowMixin.java (projectile hit pattern)
@src/main/java/thc/mixin/LivingEntityMixin.java (AoE effect + knockback pattern, lines 191-206)
@src/main/java/thc/playerclass/ClassManager.java
@src/main/java/thc/stage/StageManager.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SnowballHitMixin with enhanced effects</name>
  <files>src/main/java/thc/mixin/SnowballHitMixin.java</files>
  <action>
Create a new mixin targeting `Snowball.class` to intercept `onHitEntity()`:

1. **Inject at HEAD of onHitEntity(EntityHitResult, CallbackInfo)**
   - Why HEAD: Need to apply effects before vanilla processing, and Snowball doesn't call super.onHitEntity()

2. **Gate checks (in order):**
   - `self.level() instanceof ServerLevel` - server-side only
   - `owner instanceof ServerPlayer` - only player-thrown snowballs
   - `ClassManager.getClass(player) == PlayerClass.BASTION` - Bastion class only
   - `StageManager.getBoonLevel(player) >= 4` - Stage 4+ only
   - `hitEntity instanceof Mob` - only affect mobs (SNOW-05: players unaffected)

3. **Hostile mob filter (per CONTEXT.md decisions):**
   - Must be `MobCategory.MONSTER`
   - Must have `mob.getTarget() instanceof Player`
   - This excludes neutral mobs and passive mobs

4. **Apply to target:**
   - Slowness III (amplifier=2) for 40 ticks (2 seconds)
   - Knockback: direction from thrower to target, strength 0.4 horizontal, 0.2 vertical
   - Set `hurtMarked = true` for client sync

5. **Apply AoE (1.5 block radius from target):**
   - Use `level.getEntitiesOfClass(Mob.class, target.getBoundingBox().inflate(1.5), filter)`
   - Skip the direct hit target (already has slowness)
   - Apply slowness only (no knockback to AoE targets per spec)

**Constants:**
```java
private static final int THC_SLOWNESS_DURATION = 40;    // 2 seconds
private static final int THC_SLOWNESS_AMPLIFIER = 2;    // Level III (0-indexed)
private static final double THC_AOE_RADIUS = 1.5;
private static final double THC_KNOCKBACK_STRENGTH = 0.4;
```

**Structure (follow AbstractArrowMixin pattern):**
```java
@Mixin(Snowball.class)
public abstract class SnowballHitMixin {
    @Inject(method = "onHitEntity", at = @At("HEAD"))
    private void thc$applyEnhancedSnowballEffects(EntityHitResult result, CallbackInfo ci) { ... }

    @Unique
    private static boolean thc$isHostileMobTargetingPlayer(Mob mob) { ... }

    @Unique
    private static void thc$applySlowness(Mob mob, ServerPlayer source) { ... }

    @Unique
    private static void thc$applyKnockback(Mob target, ServerPlayer thrower) { ... }

    @Unique
    private static void thc$applyAoESlowness(ServerLevel level, Mob target, ServerPlayer source) { ... }
}
```

**Imports needed:**
- net.minecraft.world.entity.projectile.Snowball
- net.minecraft.server.level.ServerLevel
- net.minecraft.server.level.ServerPlayer
- net.minecraft.world.entity.Entity
- net.minecraft.world.entity.Mob
- net.minecraft.world.entity.MobCategory
- net.minecraft.world.entity.player.Player
- net.minecraft.world.effect.MobEffects
- net.minecraft.world.effect.MobEffectInstance
- net.minecraft.world.phys.AABB
- net.minecraft.world.phys.Vec3
- net.minecraft.world.phys.EntityHitResult
- thc.playerclass.ClassManager
- thc.playerclass.PlayerClass
- thc.stage.StageManager
  </action>
  <verify>File exists and compiles: `./gradlew classes` succeeds with no errors</verify>
  <done>SnowballHitMixin.java exists with boon-gated slowness and knockback logic</done>
</task>

<task type="auto">
  <name>Task 2: Register mixin and verify build</name>
  <files>src/main/resources/thc.mixins.json</files>
  <action>
1. Add "SnowballHitMixin" to the mixins array in thc.mixins.json
   - Add alphabetically between "SnowballItemMixin" and "SpawnReplacementMixin"

2. Run full build to verify mixin registration and compilation:
   ```
   ./gradlew build
   ```

3. Check for any mixin application warnings or errors in build output
  </action>
  <verify>`./gradlew build` completes successfully with no mixin errors</verify>
  <done>SnowballHitMixin registered and full project builds without errors</done>
</task>

</tasks>

<verification>
1. **Build verification:** `./gradlew build` passes
2. **Mixin registration:** SnowballHitMixin appears in thc.mixins.json
3. **Code inspection:**
   - Boon gate checks: Bastion class + Stage 4+
   - Target slowness: Slowness III (40 ticks)
   - AoE slowness: 1.5 block radius, hostile mobs only
   - Knockback: ~0.4 strength away from thrower
   - Player exclusion: `instanceof Mob` check before effects
</verification>

<success_criteria>
- [x] SnowballHitMixin.java created with proper structure
- [x] Mixin registered in thc.mixins.json
- [x] Build passes without errors
- [x] Gate checks: Bastion + Stage 4+ required
- [x] Slowness III (2s) applied to target
- [x] Slowness III (2s) applied to hostile mobs in 1.5 block radius
- [x] Knockback ~1 block away from thrower
- [x] Players not affected (PvP unchanged)
</success_criteria>

<output>
After completion, create `.planning/phases/78-snowball-enhancement/78-01-SUMMARY.md`
</output>
