---
phase: 79-boat-mastery
plan: 02
type: execute
wave: 2
depends_on: [79-01]
files_modified:
  - src/main/java/thc/mixin/BoatPlacementMixin.java
  - src/main/resources/thc.mixins.json
autonomous: true

must_haves:
  truths:
    - "Bastion at Stage 5+ can place boats on solid ground"
    - "Non-Bastion cannot place boats on land, sees action bar message"
    - "Bastion below Stage 5 cannot place boats on land, sees action bar message"
    - "All players can still place boats on water (vanilla behavior)"
  artifacts:
    - path: "src/main/java/thc/mixin/BoatPlacementMixin.java"
      provides: "Land placement gate and custom spawn logic"
      contains: "getBoonLevel"
  key_links:
    - from: "BoatPlacementMixin"
      to: "ClassManager.getClass"
      via: "Bastion check"
      pattern: "PlayerClass\\.BASTION"
    - from: "BoatPlacementMixin"
      to: "StageManager.getBoonLevel"
      via: "Stage 5+ check"
      pattern: "getBoonLevel.*>=.*5"
---

<objective>
Gate boat land placement to Bastion class at Stage 5+ with custom spawn logic.

Purpose: Core boon mechanic - qualified players can place boats on solid ground for crowd control
Output: BoatPlacementMixin that intercepts vanilla BoatItem.use() and implements land placement
</objective>

<execution_context>
@/home/tack/.claude/get-shit-done/workflows/execute-plan.md
@/home/tack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v3.1-ROADMAP.md
@.planning/phases/79-boat-mastery/79-RESEARCH.md

# Pattern references
@src/main/java/thc/playerclass/ClassManager.java
@src/main/java/thc/stage/StageManager.java
@src/main/kotlin/thc/item/IronBoatItem.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Boat land placement mixin</name>
  <files>
    src/main/java/thc/mixin/BoatPlacementMixin.java
    src/main/resources/thc.mixins.json
  </files>
  <action>
Create BoatPlacementMixin.java that intercepts vanilla BoatItem.use() to:
1. Allow water placement for everyone (vanilla behavior unchanged)
2. Gate land placement to Bastion + Stage 5+
3. Show action bar message for unqualified players attempting land placement
4. Implement custom boat spawning on solid ground for qualified players

Key implementation details:
- Mixin to `net.minecraft.world.item.BoatItem`
- Inject at HEAD of `use()` method with cancellation
- Use `Item.getPlayerPOVHitResult(level, player, ClipContext.Fluid.ANY)` to detect what player is looking at
- If hit is water: return immediately, let vanilla handle it
- If hit is solid block:
  - Check if player is ServerPlayer with Bastion class and boonLevel >= 5
  - If not qualified: show action bar message, return FAIL
  - If qualified: spawn boat on top of the solid block (similar to IronBoatItem pattern)

```java
package thc.mixin;

import net.minecraft.core.BlockPos;
import net.minecraft.network.chat.Component;
import net.minecraft.server.level.ServerPlayer;
import net.minecraft.stats.Stats;
import net.minecraft.tags.FluidTags;
import net.minecraft.world.InteractionHand;
import net.minecraft.world.InteractionResult;
import net.minecraft.world.entity.player.Player;
import net.minecraft.world.entity.vehicle.Boat;
import net.minecraft.world.item.BoatItem;
import net.minecraft.world.item.Item;
import net.minecraft.world.item.ItemStack;
import net.minecraft.world.level.ClipContext;
import net.minecraft.world.level.Level;
import net.minecraft.world.level.gameevent.GameEvent;
import net.minecraft.world.phys.BlockHitResult;
import net.minecraft.world.phys.HitResult;
import org.spongepowered.asm.mixin.Final;
import org.spongepowered.asm.mixin.Mixin;
import org.spongepowered.asm.mixin.Shadow;
import org.spongepowered.asm.mixin.injection.At;
import org.spongepowered.asm.mixin.injection.Inject;
import org.spongepowered.asm.mixin.injection.callback.CallbackInfoReturnable;
import thc.playerclass.ClassManager;
import thc.playerclass.PlayerClass;
import thc.stage.StageManager;

@Mixin(BoatItem.class)
public abstract class BoatPlacementMixin {

    @Shadow @Final private Boat.Type type;

    @Inject(method = "use", at = @At("HEAD"), cancellable = true)
    private void thc$gateLandPlacement(Level level, Player player, InteractionHand hand,
                                        CallbackInfoReturnable<InteractionResult> cir) {
        ItemStack stack = player.getItemInHand(hand);

        // Ray trace - include both fluids and blocks
        HitResult hitResult = Item.getPlayerPOVHitResult(level, player, ClipContext.Fluid.ANY);

        if (hitResult.getType() != HitResult.Type.BLOCK) {
            return; // Miss - let vanilla handle
        }

        BlockHitResult blockHit = (BlockHitResult) hitResult;
        BlockPos hitPos = blockHit.getBlockPos();

        // Check if hitting water - let vanilla handle water placement for everyone
        if (level.getFluidState(hitPos).is(FluidTags.WATER) ||
            level.getFluidState(hitPos.above()).is(FluidTags.WATER)) {
            return; // Water placement - vanilla handles this
        }

        // Solid ground hit - gate on Bastion + Stage 5+
        if (!level.getBlockState(hitPos).isSolid()) {
            return; // Not solid - let vanilla handle (will likely fail)
        }

        // This is a land placement attempt
        if (player instanceof ServerPlayer sp) {
            PlayerClass playerClass = ClassManager.getClass(sp);
            int boonLevel = StageManager.getBoonLevel(sp);

            if (playerClass != PlayerClass.BASTION || boonLevel < 5) {
                // Not qualified - show message and block
                sp.displayClientMessage(
                    Component.literal("Boat Mastery requires Bastion at Stage 5+"),
                    true
                );
                cir.setReturnValue(InteractionResult.FAIL);
                return;
            }

            // Qualified - spawn boat on top of solid block
            BlockPos spawnPos = hitPos.above();
            double x = spawnPos.getX() + 0.5;
            double y = spawnPos.getY();
            double z = spawnPos.getZ() + 0.5;

            Boat boat = new Boat(level, x, y, z);
            boat.setVariant(this.type);
            boat.setYRot(player.getYRot());

            // Check collision
            if (!level.noCollision(boat, boat.getBoundingBox())) {
                cir.setReturnValue(InteractionResult.FAIL);
                return;
            }

            // Spawn server-side only
            if (!level.isClientSide()) {
                level.addFreshEntity(boat);
                level.gameEvent(player, GameEvent.ENTITY_PLACE, spawnPos);
                stack.consume(1, player);
            }

            player.awardStat(Stats.ITEM_USED.get((Item)(Object)this));
            cir.setReturnValue(InteractionResult.SUCCESS);
        }
    }
}
```

Add "BoatPlacementMixin" to the mixins array in thc.mixins.json.
  </action>
  <verify>`./gradlew compileJava` succeeds without errors</verify>
  <done>BoatPlacementMixin created with land placement gate and custom spawn logic</done>
</task>

<task type="auto">
  <name>Task 2: Verify gate logic</name>
  <files>None (testing)</files>
  <action>
Run full build to verify mixin compiles and registers correctly:
1. `./gradlew build`
2. Verify no mixin application errors

The gate should behave as:
- Water placement: All players, vanilla behavior
- Land placement + Bastion + Stage 5+: Success, boat spawns on block
- Land placement + wrong class/stage: Fail with action bar message
  </action>
  <verify>`./gradlew build` completes successfully</verify>
  <done>Build passes, mixin registered correctly</done>
</task>

</tasks>

<verification>
1. `./gradlew build` passes
2. In-game: Non-Bastion player cannot place boat on solid ground (sees message)
3. In-game: Bastion at Stage 5+ can place boat on solid ground
4. In-game: Water placement works for all players
</verification>

<success_criteria>
- BOAT-01 satisfied: Bastion + Stage 5+ can place wooden boats on land
- BOAT-02 satisfied: Non-Bastion or lower stage cannot place boats on land
- BOAT-03 satisfied: Water boat placement unchanged for all players
- Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/79-boat-mastery/79-02-SUMMARY.md`
</output>
