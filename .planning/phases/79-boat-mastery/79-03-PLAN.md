---
phase: 79-boat-mastery
plan: 03
type: execute
wave: 3
depends_on: [79-02]
files_modified:
  - src/main/java/thc/mixin/BoatTrappingMixin.java
  - src/main/resources/thc.mixins.json
autonomous: true

must_haves:
  truths:
    - "Hostile mobs entering boats become trapped passengers"
    - "Trapped hostile mobs break out after 4 seconds (80 ticks)"
    - "Boat drops as item when mob breaks out (not destroyed)"
    - "Mobs can be attacked while trapped in boat"
  artifacts:
    - path: "src/main/java/thc/mixin/BoatTrappingMixin.java"
      provides: "Trap timing and breakout logic"
      contains: "MobCategory.MONSTER"
  key_links:
    - from: "BoatTrappingMixin"
      to: "AbstractBoat.tick()"
      via: "Mixin injection"
      pattern: "@Inject.*tick"
    - from: "BoatTrappingMixin"
      to: "mob.stopRiding()"
      via: "Breakout eject"
      pattern: "stopRiding"
---

<objective>
Implement hostile mob trapping in boats with 4-second timed breakout.

Purpose: Crowd control mechanic for Boat Mastery boon - trap mobs temporarily, boat is reusable
Output: BoatTrappingMixin that tracks hostile passengers and ejects them after 80 ticks
</objective>

<execution_context>
@/home/tack/.claude/get-shit-done/workflows/execute-plan.md
@/home/tack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v3.1-ROADMAP.md
@.planning/phases/79-boat-mastery/79-RESEARCH.md

# Pattern references
@src/main/kotlin/thc/entity/IronBoat.kt
@src/main/java/thc/mixin/ProjectileEntityMixin.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Boat trapping mixin</name>
  <files>
    src/main/java/thc/mixin/BoatTrappingMixin.java
    src/main/resources/thc.mixins.json
  </files>
  <action>
Create BoatTrappingMixin.java that injects into AbstractBoat.tick() to:
1. Track when hostile mobs board the boat (store tick timestamp)
2. Check each tick if any hostile passenger has been trapped for 80 ticks
3. On breakout: eject mob, drop boat as item, discard boat entity

Key implementation details:
- Mixin to `net.minecraft.world.entity.vehicle.AbstractBoat`
- Use `@Unique` Map to track passenger UUID -> board tick
- Only track hostile mobs (MobCategory.MONSTER)
- Server-side only (check `!level.isClientSide()`)
- Use `getDropItem()` to get correct boat item type for drops
- Only apply to vanilla Boat class, NOT IronBoat (use `instanceof Boat` check)

```java
package thc.mixin;

import net.minecraft.world.entity.Entity;
import net.minecraft.world.entity.EntityType;
import net.minecraft.world.entity.MobCategory;
import net.minecraft.world.entity.Mob;
import net.minecraft.world.entity.item.ItemEntity;
import net.minecraft.world.entity.vehicle.AbstractBoat;
import net.minecraft.world.entity.vehicle.Boat;
import net.minecraft.world.item.ItemStack;
import org.spongepowered.asm.mixin.Mixin;
import org.spongepowered.asm.mixin.Unique;
import org.spongepowered.asm.mixin.injection.At;
import org.spongepowered.asm.mixin.injection.Inject;
import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

/**
 * Mixin to implement hostile mob trapping in boats.
 * Hostile mobs that enter boats are tracked and auto-eject after 80 ticks (4 seconds).
 * When breakout occurs, the boat drops as an item (reusable, not destroyed).
 *
 * Only applies to vanilla wooden boats, not IronBoat.
 */
@Mixin(AbstractBoat.class)
public class BoatTrappingMixin {

    /**
     * Map of trapped hostile mob UUID to the game tick when they boarded.
     */
    @Unique
    private final Map<UUID, Long> thc$trappedSince = new HashMap<>();

    @Inject(method = "tick", at = @At("TAIL"))
    private void thc$handleMobTrapping(CallbackInfo ci) {
        AbstractBoat self = (AbstractBoat) (Object) this;

        // Only process on server side
        if (self.level().isClientSide()) return;

        // Only apply to vanilla Boat, not IronBoat or other custom boats
        if (!(self instanceof Boat)) return;

        long currentTick = self.level().getGameTime();

        // Track new hostile passengers
        for (Entity passenger : self.getPassengers()) {
            if (passenger instanceof Mob mob &&
                mob.getType().getCategory() == MobCategory.MONSTER) {
                // Only add if not already tracked
                thc$trappedSince.putIfAbsent(mob.getUUID(), currentTick);
            }
        }

        // Check for breakout (any hostile mob trapped 80+ ticks)
        for (Entity passenger : new ArrayList<>(self.getPassengers())) {
            if (passenger instanceof Mob mob) {
                Long boardTick = thc$trappedSince.get(mob.getUUID());
                if (boardTick != null && currentTick - boardTick >= 80) {
                    // Time's up - mob breaks out
                    // Eject all passengers
                    for (Entity p : new ArrayList<>(self.getPassengers())) {
                        p.stopRiding();
                    }

                    // Drop boat as item
                    thc$dropBoatItem(self);

                    // Remove boat entity
                    self.discard();
                    return; // Exit - boat is gone
                }
            }
        }

        // Clean up tracking for passengers that left (not via breakout)
        thc$trappedSince.keySet().removeIf(uuid ->
            self.getPassengers().stream().noneMatch(p -> p.getUUID().equals(uuid))
        );
    }

    @Unique
    private void thc$dropBoatItem(AbstractBoat boat) {
        // Get the correct item for this boat variant
        ItemStack stack = new ItemStack(boat.getDropItem());
        ItemEntity itemEntity = new ItemEntity(
            boat.level(),
            boat.getX(),
            boat.getY(),
            boat.getZ(),
            stack
        );
        boat.level().addFreshEntity(itemEntity);
    }
}
```

Add "BoatTrappingMixin" to the mixins array in thc.mixins.json.
  </action>
  <verify>`./gradlew compileJava` succeeds without errors</verify>
  <done>BoatTrappingMixin created with trap timing and breakout logic</done>
</task>

<task type="auto">
  <name>Task 2: Build and verify</name>
  <files>None (testing)</files>
  <action>
Run full build to verify all Phase 79 mixins work together:
1. `./gradlew build`
2. Verify no mixin application errors
3. Verify all 3 boat-related mixins are registered in thc.mixins.json

Expected behavior summary:
- Boats stack to 16 (from 79-01)
- Boats require copper to craft (from 79-01)
- Bastion Stage 5+ can place boats on land (from 79-02)
- Hostile mobs in boats break out after 4 seconds (this plan)
  </action>
  <verify>`./gradlew build` completes successfully</verify>
  <done>Full build passes, all boat mechanics implemented</done>
</task>

</tasks>

<verification>
1. `./gradlew build` passes
2. In-game: Push zombie into boat, count to 4, zombie breaks out
3. In-game: Boat drops as item after breakout (not destroyed)
4. In-game: Can attack trapped mob while in boat
</verification>

<success_criteria>
- BOAT-04 satisfied: Hostile mobs can be trapped inside boats
- BOAT-05 satisfied: Hostile mobs break out after 4 seconds
- BOAT-06 satisfied: Boat drops as item when mob breaks out
- Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/79-boat-mastery/79-03-SUMMARY.md`
</output>
