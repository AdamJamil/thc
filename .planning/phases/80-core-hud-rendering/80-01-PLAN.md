---
phase: 80-core-hud-rendering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/client/kotlin/thc/client/EffectsHudRenderer.kt
  - src/client/kotlin/thc/THCClient.kt
autonomous: true

must_haves:
  truths:
    - "Player with active status effects sees them rendered in the bottom-left corner of the screen"
    - "Multiple effects stack vertically upward from bottom-left with no gaps between frames"
    - "Effects are sorted by priority: Wither > Poison > Resistance > Absorption > Strength > Slowness > Weakness > Speed > all others"
    - "Each effect displays inside a 44x44 frame using effect_frame.png"
    - "Vanilla mob effect icon appears at 2x scale (36x36) centered inside the frame"
  artifacts:
    - path: "src/client/kotlin/thc/client/EffectsHudRenderer.kt"
      provides: "Effects HUD rendering with priority sorting and frame+icon layout"
      contains: "object EffectsHudRenderer"
    - path: "src/client/kotlin/thc/THCClient.kt"
      provides: "HUD element registration for effects renderer"
      contains: "EffectsHudRenderer"
  key_links:
    - from: "src/client/kotlin/thc/THCClient.kt"
      to: "src/client/kotlin/thc/client/EffectsHudRenderer.kt"
      via: "HudElementRegistry.attachElementAfter registration"
      pattern: "HudElementRegistry.*EffectsHudRenderer"
    - from: "src/client/kotlin/thc/client/EffectsHudRenderer.kt"
      to: "Minecraft.getInstance().player.activeEffects"
      via: "Client player effect collection each frame"
      pattern: "getActiveEffects|activeEffects"
---

<objective>
Render active status effects as a vertical stack in the bottom-left corner of the HUD with priority sorting and framed icons.

Purpose: Provides at-a-glance visibility of active status effects during gameplay, enabling tactical decision-making.
Output: EffectsHudRenderer.kt registered as a Fabric HUD element, rendering framed and sorted effect icons.
</objective>

<execution_context>
@/home/tack/.claude/get-shit-done/workflows/execute-plan.md
@/home/tack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v3.2-ROADMAP.md

# Existing HUD rendering patterns
@src/client/kotlin/thc/client/BucklerHudRenderer.kt
@src/client/kotlin/thc/THCClient.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EffectsHudRenderer with priority sorting and frame+icon rendering</name>
  <files>src/client/kotlin/thc/client/EffectsHudRenderer.kt</files>
  <action>
Create `src/client/kotlin/thc/client/EffectsHudRenderer.kt` as a Kotlin object following the BucklerHudRenderer pattern.

**Priority system:**
Define a hardcoded priority map for sorting effects. Lower number = higher priority = rendered closer to bottom (first in the stack). Use `Holder<MobEffect>` keys from `MobEffects.*`:
- MobEffects.WITHER -> 0
- MobEffects.POISON -> 1
- MobEffects.RESISTANCE -> 2
- MobEffects.ABSORPTION -> 3
- MobEffects.STRENGTH -> 4
- MobEffects.SLOWNESS -> 5
- MobEffects.WEAKNESS -> 6
- MobEffects.SPEED -> 7
- All others -> 100 (fallback, further sorted by registry name for stability)

**Effect collection:**
Each render call: `Minecraft.getInstance().player?.getActiveEffects()` returns `Collection<MobEffectInstance>`. Sort using a Comparator that checks the priority map via `instance.effect` (which is `Holder<MobEffect>`). Compare by checking if `instance.effect.is(MobEffects.WITHER)` etc., or by getting the registry key via `instance.effect.unwrapKey()` and looking it up.

For the priority comparator, build a `Map<ResourceKey<MobEffect>, Int>` from the MobEffects holders. Use `MobEffects.WITHER.unwrapKey().orElse(null)` to extract the key. In the comparator, effects not in the map get priority 100, with secondary sort by `effect.unwrapKey()` string for deterministic ordering.

**Rendering layout:**
- Frame texture: `Identifier.fromNamespaceAndPath("thc", "textures/item/effect_frame.png")` — 44x44 source
- Position anchor: bottom-left of screen. Start X = 4px from left edge, start Y = screen height - 4px (bottom margin) - 44px (first frame).
- Stack upward: each subsequent effect rendered at Y - 44 (zero gap between frames per HUD-02).
- Render the frame first, then the icon on top.

**Icon rendering:**
- For each `MobEffectInstance`, derive the vanilla icon texture path from the effect's registry key.
- Get the key: `instance.effect.unwrapKey().orElse(null)?.location()` gives a `ResourceLocation` like `minecraft:wither`.
- Build texture identifier: `Identifier.fromNamespaceAndPath(key.namespace, "textures/mob_effect/${key.path}.png")` — this produces paths like `minecraft:textures/mob_effect/wither.png`.
- The vanilla icon is 18x18. Render at 2x scale = 36x36.
- Center inside the 44x44 frame: offset = (44 - 36) / 2 = 4px from each edge of the frame.
- Use `guiGraphics.blit(RenderPipelines.GUI_TEXTURED, iconTexture, x+4, y+4, 0f, 0f, 36, 36, 18, 18)` — the last two params (textureWidth=18, textureHeight=18) combined with render size 36x36 achieve the 2x scaling.

**Guard clauses (follow BucklerHudRenderer pattern):**
- Return early if `client.options.hideGui` or player is spectator.
- Return early if `player.getActiveEffects()` is empty.

**Identifier constant:**
`val EFFECTS_HUD_ID: Identifier = Identifier.fromNamespaceAndPath("thc", "effects_hud")`
  </action>
  <verify>Build with `./gradlew build` — compilation succeeds with no errors in EffectsHudRenderer.kt</verify>
  <done>EffectsHudRenderer.kt exists with render() function that collects active effects, sorts by priority, and draws frame + 2x-scaled vanilla icon for each effect stacked vertically from bottom-left</done>
</task>

<task type="auto">
  <name>Task 2: Register EffectsHudRenderer in THCClient</name>
  <files>src/client/kotlin/thc/THCClient.kt</files>
  <action>
In `src/client/kotlin/thc/THCClient.kt`, add import for `thc.client.EffectsHudRenderer` and register the HUD element in `onInitializeClient()`.

Register the effects HUD element using Fabric's HudElementRegistry. Since this is a standalone bottom-left overlay (not integrated into the vanilla status bar area), register it after the existing elements. Use `HudElementRegistry.attachElementAfter` with an appropriate vanilla element. Since the effects HUD is independent of health/armor bars and should render on top of most HUD elements, attach after `VanillaHudElements.CHAT`:

```kotlin
HudElementRegistry.attachElementAfter(VanillaHudElements.CHAT, EffectsHudRenderer.EFFECTS_HUD_ID) { guiGraphics, _ ->
    EffectsHudRenderer.render(guiGraphics)
}
```

This ensures the effects overlay renders after chat but is still visible. If `VanillaHudElements.CHAT` doesn't exist or doesn't compile, fall back to using `VanillaHudElements.CROSSHAIR` or any available vanilla element — the rendering position is absolute (bottom-left) so the attachment point only affects render order, not position.

Add the import at the top with the other client imports.
  </action>
  <verify>Build with `./gradlew build` — full project compiles cleanly. Check that THCClient.kt contains the HudElementRegistry call for EffectsHudRenderer.</verify>
  <done>THCClient.kt registers EffectsHudRenderer as a Fabric HUD element, and the full project builds without errors</done>
</task>

</tasks>

<verification>
1. `./gradlew build` succeeds with no compilation errors
2. EffectsHudRenderer.kt contains priority map with all 8 specified effects in correct order
3. EffectsHudRenderer.kt renders frame texture at 44x44 from bottom-left anchor
4. EffectsHudRenderer.kt renders vanilla icon at 36x36 (2x scale of 18x18) centered in frame with 4px border
5. EffectsHudRenderer.kt sorts effects using priority comparator before rendering
6. EffectsHudRenderer.kt stacks effects vertically upward with zero gaps
7. THCClient.kt registers EffectsHudRenderer via HudElementRegistry
</verification>

<success_criteria>
- Project builds cleanly with `./gradlew build`
- EffectsHudRenderer renders active effects in bottom-left, sorted by Wither>Poison>Resistance>Absorption>Strength>Slowness>Weakness>Speed>others
- Each effect appears inside a 44x44 frame with a 36x36 vanilla icon centered inside
- Effects stack vertically with no gaps between frames
</success_criteria>

<output>
After completion, create `.planning/phases/80-core-hud-rendering/80-01-SUMMARY.md`
</output>
