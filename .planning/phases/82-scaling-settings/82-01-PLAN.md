---
phase: 82-scaling-settings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/client/kotlin/thc/client/EffectsGuiConfig.kt
  - src/client/java/thc/mixin/client/VideoSettingsScreenMixin.java
  - src/client/resources/thc.client.mixins.json
  - src/client/kotlin/thc/client/EffectsHudRenderer.kt
  - src/main/resources/assets/thc/lang/en_us.json
autonomous: true

must_haves:
  truths:
    - "Video Settings menu contains an Effects GUI Scaling slider"
    - "Slider adjusts from 2% to 20% of screen width"
    - "Scale factor is readable by the Effects HUD renderer"
    - "Setting persists across game restarts (saved to config file)"
  artifacts:
    - path: "src/client/kotlin/thc/client/EffectsGuiConfig.kt"
      provides: "Client config holder with OptionInstance slider and file persistence"
      contains: "OptionInstance"
    - path: "src/client/java/thc/mixin/client/VideoSettingsScreenMixin.java"
      provides: "Mixin injecting slider into Video Settings screen"
      contains: "VideoSettingsScreen"
    - path: "src/client/resources/thc.client.mixins.json"
      provides: "Mixin registration for VideoSettingsScreenMixin"
      contains: "VideoSettingsScreenMixin"
  key_links:
    - from: "src/client/java/thc/mixin/client/VideoSettingsScreenMixin.java"
      to: "src/client/kotlin/thc/client/EffectsGuiConfig.kt"
      via: "Mixin reads OptionInstance from config to create widget"
      pattern: "EffectsGuiConfig"
    - from: "src/client/kotlin/thc/client/EffectsHudRenderer.kt"
      to: "src/client/kotlin/thc/client/EffectsGuiConfig.kt"
      via: "Renderer reads scale percentage to compute frame size"
      pattern: "EffectsGuiConfig\\.getScalePercent"
---

<objective>
Add an "Effects GUI Scaling" slider to the Video Settings menu that controls the size of the Effects HUD from Phase 80. The slider maps frame width from 2% to 20% of screen width. The setting persists to a config file.

Purpose: Lets players customize the Effects HUD size to fit their screen/preference (SCAL-01, SCAL-02).
Output: Config system, Video Settings mixin, and scale integration into renderer.
</objective>

<execution_context>
@/home/tack/.claude/get-shit-done/workflows/execute-plan.md
@/home/tack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key references:
@src/client/kotlin/thc/THCClient.kt — client init, HUD registration pattern
@src/client/kotlin/thc/client/BucklerHudRenderer.kt — existing HUD renderer pattern (GuiGraphics, blit, pose transforms)
@src/client/java/thc/mixin/client/EnchantmentScreenMixin.java — existing screen mixin pattern
@src/client/resources/thc.client.mixins.json — mixin registration
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EffectsGuiConfig with OptionInstance slider and file persistence</name>
  <files>
    src/client/kotlin/thc/client/EffectsGuiConfig.kt
    src/main/resources/assets/thc/lang/en_us.json
  </files>
  <action>
Create `src/client/kotlin/thc/client/EffectsGuiConfig.kt` as a Kotlin `object` with:

1. **OptionInstance slider**: Create an `OptionInstance<Integer>` named `effectsGuiScale` with:
   - Translation key: `"thc.options.effectsGuiScale"`
   - Value range: `OptionInstance.IntRange(2, 20)` (represents 2% to 20%)
   - Display: Use `Options.genericValueLabel(component, Component.literal("$integer%"))` pattern to show "Effects GUI Scaling: N%"
   - Default value: `8` (8% of screen width — reasonable default for 44px base at 1080p)
   - On-change callback: no-op (renderer reads live)

2. **Accessor function**: `fun getScalePercent(): Int` returns `effectsGuiScale.get()`. This is what the Effects HUD renderer (from Phase 80) will call to compute `frame_width = screen_width * (percent / 100.0)`.

3. **File persistence**: Simple load/save to `config/thc-effects-gui.txt`:
   - `fun load()`: Read single line `effectsGuiScale:N` from file, call `effectsGuiScale.set(N)`. If file missing or parse error, keep default.
   - `fun save()`: Write `effectsGuiScale:N` to file. Called from the OptionInstance's onValueUpdate consumer.
   - Config dir: Use `net.fabricmc.loader.api.FabricLoader.getInstance().configDir` to get the config directory path.

4. **Initialization**: Call `load()` during THCClient.onInitializeClient() — add to THCClient.kt.

Add the translation key to `src/main/resources/assets/thc/lang/en_us.json`:
- `"thc.options.effectsGuiScale": "Effects GUI Scaling"`

IMPORTANT: The OptionInstance constructor takes a String translation key as first param. Minecraft uses `Component.translatable(key)` for the caption. The `CaptionBasedToString` lambda receives `(caption: Component, value: T)` and returns the display Component. Use the pattern:
```kotlin
OptionInstance(
    "thc.options.effectsGuiScale",
    OptionInstance.noTooltip(),
    { component, integer -> Options.genericValueLabel(component, Component.literal("${integer}%")) },
    OptionInstance.IntRange(2, 20),
    8,
    { save() }
)
```

The IntRange(2, 20) will create a slider with discrete integer steps from 2 to 20. Each step represents a percentage.
  </action>
  <verify>
Project compiles with `./gradlew build`. EffectsGuiConfig object exists with effectsGuiScale OptionInstance, getScalePercent() accessor, load/save functions.
  </verify>
  <done>
EffectsGuiConfig holds an OptionInstance slider (2-20 range), persists to config/thc-effects-gui.txt, loads on client init. Translation key registered.
  </done>
</task>

<task type="auto">
  <name>Task 2: Mixin VideoSettingsScreen to inject scaling slider and wire to renderer</name>
  <files>
    src/client/java/thc/mixin/client/VideoSettingsScreenMixin.java
    src/client/resources/thc.client.mixins.json
    src/client/kotlin/thc/client/EffectsHudRenderer.kt
  </files>
  <action>
**Part A — VideoSettingsScreen Mixin:**

Create `src/client/java/thc/mixin/client/VideoSettingsScreenMixin.java`:

```java
@Mixin(VideoSettingsScreen.class)
public abstract class VideoSettingsScreenMixin extends OptionsSubScreen {
    // Dummy constructor to satisfy OptionsSubScreen
    protected VideoSettingsScreenMixin(Screen screen, Options options, Component component) {
        super(screen, options, component);
    }

    @Inject(method = "addOptions", at = @At("TAIL"))
    private void thc$addEffectsGuiScale(CallbackInfo ci) {
        if (this.list != null) {
            this.list.addSmall(EffectsGuiConfig.INSTANCE.getEffectsGuiScale());
        }
    }
}
```

Key details:
- Target class: `net.minecraft.client.gui.screens.options.VideoSettingsScreen`
- Inject at TAIL of `addOptions()` to append after all vanilla options
- Access `this.list` (inherited from OptionsSubScreen — it's a `@Nullable OptionsList` field)
- Use `addSmall()` which takes a single OptionInstance and renders it as a half-width option in the list
- Import EffectsGuiConfig from `thc.client.EffectsGuiConfig`
- NOTE: Since VideoSettingsScreenMixin extends OptionsSubScreen (Java), accessing `this.list` requires the mixin to extend OptionsSubScreen. The `list` field is `protected` in OptionsSubScreen. Alternatively, use `@Shadow` on the `list` field.

Actually, the cleaner approach using @Shadow (avoids needing to extend OptionsSubScreen):

```java
@Mixin(VideoSettingsScreen.class)
public class VideoSettingsScreenMixin {
    @Shadow
    @Nullable
    protected OptionsList list;

    @Inject(method = "addOptions", at = @At("TAIL"))
    private void thc$addEffectsGuiScale(CallbackInfo ci) {
        if (this.list != null) {
            this.list.addSmall(EffectsGuiConfig.INSTANCE.getEffectsGuiScale());
        }
    }
}
```

Wait — `list` is defined on OptionsSubScreen not VideoSettingsScreen. Shadow only works for fields on the target class or its supers accessible from the mixin. Since mixin targets VideoSettingsScreen which extends OptionsSubScreen, and `list` is `protected`, the extending approach is better:

```java
@Mixin(VideoSettingsScreen.class)
public abstract class VideoSettingsScreenMixin extends OptionsSubScreen {
    protected VideoSettingsScreenMixin(Screen screen, Options options, Component component) {
        super(screen, options, component);
    }

    @Inject(method = "addOptions", at = @At("TAIL"))
    private void thc$addEffectsGuiScale(CallbackInfo ci) {
        if (this.list != null) {
            this.list.addSmall(new OptionInstance[]{EffectsGuiConfig.INSTANCE.getEffectsGuiScale()});
        }
    }
}
```

The `addSmall(OptionInstance<?>... optionInstances)` is a varargs method. Pass the single option. It will render as a half-width widget in the options list, which is the standard pattern for Video Settings entries.

**Part B — Register mixin:**

Add `"VideoSettingsScreenMixin"` to the `client` array in `src/client/resources/thc.client.mixins.json`.

**Part C — Wire scale to EffectsHudRenderer:**

NOTE: EffectsHudRenderer.kt is created in Phase 80. If Phase 80 has not executed yet, this task creates a minimal stub or adds a comment/TODO. However, the executor should check:
- If `EffectsHudRenderer.kt` already exists (Phase 80 completed): Add scale computation. Where the renderer computes frame size, replace hardcoded 44px with:
  ```kotlin
  val scalePercent = EffectsGuiConfig.getScalePercent()
  val frameWidth = (guiGraphics.guiWidth() * scalePercent / 100.0).toInt()
  // Derive icon size, border, numeral position proportionally from frameWidth
  ```
- If `EffectsHudRenderer.kt` does NOT exist yet: Skip this sub-task. Document in SUMMARY that the renderer wiring is pending Phase 80 completion. The config and mixin are self-contained and testable independently.

The critical deliverables are the config + mixin. The renderer wiring is the integration point that Phase 80's renderer will consume via `EffectsGuiConfig.getScalePercent()`.
  </action>
  <verify>
1. `./gradlew build` succeeds
2. Launch game with `./gradlew runClient`, go to Options > Video Settings, scroll to bottom — "Effects GUI Scaling" slider appears
3. Slider moves between 2% and 20%
4. Close game, check `config/thc-effects-gui.txt` has saved value
5. Relaunch — slider shows persisted value
  </verify>
  <done>
VideoSettingsScreen shows "Effects GUI Scaling" slider at bottom of options list. Slider range 2%-20%. Value persists across restarts via config file. Mixin registered in client mixins JSON.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew build` compiles without errors
2. In-game Video Settings contains "Effects GUI Scaling" slider
3. Slider displays "Effects GUI Scaling: N%" for values 2-20
4. Changing slider saves to config/thc-effects-gui.txt
5. Restarting game restores saved value
6. EffectsGuiConfig.getScalePercent() returns current slider value (callable from renderer)
</verification>

<success_criteria>
- SCAL-01: Video Settings menu includes an "Effects GUI Scaling" option [slider visible in Video Settings]
- SCAL-02: Scale range maps frame width from 2% to 20% of screen width [slider range 2-20 with % display]
- Setting persists across game restarts [config file read/write works]
- Scale factor accessible to HUD renderer [EffectsGuiConfig.getScalePercent() returns int 2-20]
</success_criteria>

<output>
After completion, create `.planning/phases/82-scaling-settings/82-01-SUMMARY.md`
</output>
