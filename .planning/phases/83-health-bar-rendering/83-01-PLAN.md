---
phase: 83-health-bar-rendering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/client/kotlin/thc/client/MobHealthBarRenderer.kt
  - src/client/kotlin/thc/THCClient.kt
autonomous: true

must_haves:
  truths:
    - "Hostile mobs within 32 blocks display a floating health bar above their head"
    - "Health bar floats ~0.5 blocks above mob head and always faces the player (billboard)"
    - "Health bar shows empty background with filled HP portion that shrinks as mob takes damage"
    - "Mobs with absorption show a third layer over the HP bar representing absorption amount"
    - "Health bar is hidden when mob is at full HP and has no active effects"
  artifacts:
    - path: "src/client/kotlin/thc/client/MobHealthBarRenderer.kt"
      provides: "World-space billboard health bar renderer for hostile mobs"
      contains: "MobHealthBarRenderer"
    - path: "src/client/kotlin/thc/THCClient.kt"
      provides: "Registration of MobHealthBarRenderer in client init"
      contains: "MobHealthBarRenderer"
  key_links:
    - from: "src/client/kotlin/thc/THCClient.kt"
      to: "MobHealthBarRenderer"
      via: "WorldRenderEvents.AFTER_ENTITIES registration"
      pattern: "WorldRenderEvents.AFTER_ENTITIES"
    - from: "src/client/kotlin/thc/client/MobHealthBarRenderer.kt"
      to: "health_bar_empty.png, health_bar_full.png, health_bar_absorption.png"
      via: "Identifier texture references and blit calls"
      pattern: "health_bar"
---

<objective>
Render floating three-layer health bars above hostile mobs in world-space using billboard quads.

Purpose: Give players combat awareness by showing enemy HP and absorption as layered textures floating above mob heads, hidden when mobs are undamaged.
Output: MobHealthBarRenderer.kt registered via WorldRenderEvents.AFTER_ENTITIES in THCClient.kt
</objective>

<execution_context>
@/home/tack/.claude/get-shit-done/workflows/execute-plan.md
@/home/tack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing world-space rendering pattern (camera-relative positioning, PoseStack, billboard)
@src/client/kotlin/thc/client/DownedBodyRenderer.kt
# Existing textured quad rendering with vertex buffer (UV math, full bright lighting)
@src/client/java/thc/client/BeaconBeamHelper.java
# Camera accessor for position (already exists, reuse)
@src/client/java/thc/mixin/client/access/CameraAccessor.java
# Client init with WorldRenderEvents registration pattern
@src/client/kotlin/thc/THCClient.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MobHealthBarRenderer with billboard positioning and three-layer texture rendering</name>
  <files>src/client/kotlin/thc/client/MobHealthBarRenderer.kt</files>
  <action>
Create `MobHealthBarRenderer` as a Kotlin object in `src/client/kotlin/thc/client/`.

**Texture constants:**
- `EMPTY_TEXTURE`: `thc:textures/item/health_bar_empty.png` (328x64)
- `FULL_TEXTURE`: `thc:textures/item/health_bar_full.png` (328x64)
- `ABSORPTION_TEXTURE`: `thc:textures/item/health_bar_absorption.png` (82x16)
- Texture dimensions: empty/full are 328x64, absorption is 82x16

**Render size in world-space:**
- The bar should be roughly 1.5 blocks wide in world space. Use a world-space width of ~1.5f and derive height from the 328:64 aspect ratio (width * 64/328).

**Core `render(context: WorldRenderContext)` method:**
1. Get camera position via `(camera as CameraAccessor).position`
2. Get player from `Minecraft.getInstance().player`; bail if null or hideGui
3. Iterate all entities in the client level. For each entity:
   - Filter: must be `net.minecraft.world.entity.monster.Monster` (import from `net.minecraft.world.entity.monster.Monster`)
   - Filter: distance to player <= 32 blocks (use `distanceToSqr` with 1024.0 threshold to avoid sqrt)
   - Filter: must NOT be invisible (`entity.isInvisible`)
   - **Visibility gate (HBAR-06):** Skip if mob is at full HP (`entity.health >= entity.maxHealth`) AND has no active effects (`entity.activeEffects.isEmpty()`) AND has no absorption (`entity.absorptionAmount <= 0`)
4. For each qualifying mob, call `renderHealthBar(mob, context, cameraPos)`

**Billboard positioning in `renderHealthBar`:**
1. Push pose stack from `context.matrices()`
2. Calculate world position: mob's position interpolated with partialTick (`mob.getPosition(partialTick)`)
3. Translate relative to camera: `(mobPos.x - cam.x, mobPos.y - cam.y + mob.bbHeight + 0.5, mobPos.z - cam.z)` — this puts it 0.5 blocks above the mob's head
4. **Billboard rotation:** Get camera yRot and xRot from `Minecraft.getInstance().gameRenderer.mainCamera`. Apply `Axis.YP.rotationDegrees(-camera.yRot)` then `Axis.XP.rotationDegrees(camera.xRot)` so the quad always faces the player
5. Scale down: the quad vertices will be in world units (about 1.5 blocks wide)

**Three-layer rendering using vertex buffer (like BeaconBeamHelper):**

Use `MultiBufferSource.BufferSource` from `Minecraft.getInstance().renderBuffers().bufferSource()` with `RenderType.entityTranslucent(texture)` for each layer. Each layer is a textured quad (4 vertices).

The bar is centered horizontally. Let `halfW = BAR_WIDTH / 2` and `halfH = BAR_HEIGHT / 2`:

**Layer 1 — Empty bar (always full width):**
- Render a quad from (-halfW, -halfH, 0) to (halfW, halfH, 0)
- UV: full texture (0,0) to (1,1)
- Texture: EMPTY_TEXTURE

**Layer 2 — Full bar (clipped to HP ratio):**
- Compute `hpRatio = mob.health / mob.maxHealth` clamped to 0..1
- The filled portion uses an 8px left inset in texture space. In UV terms: `uStart = 8.0f / 328.0f`. The fillable region is 312px wide (328 - 8 - 8).
- Render width = `8.0f/328.0f * BAR_WIDTH + hpRatio * (312.0f/328.0f) * BAR_WIDTH`
- Left edge of quad: `-halfW`, right edge: `-halfW + renderWidth`
- UV: u from 0 to `(8.0f + hpRatio * 312.0f) / 328.0f`, v from 0 to 1
- Texture: FULL_TEXTURE

**Layer 3 — Absorption (only if absorptionAmount > 0):**
- Compute `absRatio = (mob.absorptionAmount / mob.maxHealth)` clamped to 0..1
- Absorption bar overlays the filled portion. Render at same left inset (8px).
- Width = `absRatio * (312.0f/328.0f) * BAR_WIDTH`
- Position: starts at same 8px inset from left edge
- UV: full absorption texture (0,0) to (1,1) — the 82x16 texture tiles/stretches to fit
- Texture: ABSORPTION_TEXTURE

For each layer, render 4 vertices with:
- `.setColor(1f, 1f, 1f, 1f)` (full white, no tinting)
- `.setUv(u, v)` per vertex
- `.setOverlay(OverlayTexture.NO_OVERLAY)`
- `.setLight(15728880)` (full bright, same as BeaconBeamHelper)
- `.setNormal(pose, 0f, 0f, 1f)` (facing toward camera after billboard rotation)

After rendering all layers, pop the pose and call `bufferSource.endBatch()`.

**Important:** Use `RenderType.entityTranslucent(texture)` (not `entityCutout`) so the dark border of the empty bar and the absorption gold render with proper alpha blending. Import from `net.minecraft.client.renderer.RenderType`.
  </action>
  <verify>Run `./gradlew build` — project compiles with no errors.</verify>
  <done>MobHealthBarRenderer.kt exists with render() method that iterates hostile mobs within 32 blocks, applies visibility gating (skip full HP + no effects + no absorption), positions billboard quads 0.5 blocks above mob head facing camera, and renders three texture layers (empty background, HP-clipped full bar, absorption overlay) using vertex buffers with full-bright lighting.</done>
</task>

<task type="auto">
  <name>Task 2: Register MobHealthBarRenderer in THCClient via WorldRenderEvents</name>
  <files>src/client/kotlin/thc/THCClient.kt</files>
  <action>
In `THCClient.onInitializeClient()`, add registration of MobHealthBarRenderer using the same pattern as DownedBodyRenderer:

1. Add import: `import thc.client.MobHealthBarRenderer`
2. After the existing `DownedBodyRenderer.register()` call, add:
```kotlin
WorldRenderEvents.AFTER_ENTITIES.register { context ->
    MobHealthBarRenderer.render(context)
}
```
3. Also add the WorldRenderEvents import if not already present: `import net.fabricmc.fabric.api.client.rendering.v1.world.WorldRenderEvents`

This registers the health bar renderer to run after all entities are rendered each frame, so health bars appear on top of mobs.
  </action>
  <verify>Run `./gradlew build` — project compiles with no errors. Verify THCClient.kt contains MobHealthBarRenderer registration.</verify>
  <done>THCClient registers MobHealthBarRenderer via WorldRenderEvents.AFTER_ENTITIES so health bars render above hostile mobs each frame.</done>
</task>

</tasks>

<verification>
1. `./gradlew build` succeeds with no compilation errors
2. `MobHealthBarRenderer.kt` exists and contains: Monster filter, 32-block range check, full-HP visibility gate, billboard rotation, three texture layers (empty/full/absorption)
3. `THCClient.kt` contains `MobHealthBarRenderer.render(context)` inside a `WorldRenderEvents.AFTER_ENTITIES` registration
4. No existing files broken (all other renderers still registered)
</verification>

<success_criteria>
- Project builds cleanly
- MobHealthBarRenderer implements all 6 HBAR requirements: range filtering (HBAR-01), billboard positioning (HBAR-02), empty background layer (HBAR-03), HP-clipped full bar (HBAR-04), absorption overlay (HBAR-05), full-HP hiding (HBAR-06)
- Renderer registered in THCClient for execution each frame
</success_criteria>

<output>
After completion, create `.planning/phases/83-health-bar-rendering/83-01-SUMMARY.md`
</output>
