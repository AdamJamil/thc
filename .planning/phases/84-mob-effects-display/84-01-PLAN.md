---
phase: 84-mob-effects-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/client/kotlin/thc/client/MobHealthBarRenderer.kt
  - src/client/kotlin/thc/client/EffectsHudRenderer.kt
autonomous: true

must_haves:
  truths:
    - "Player can see status effect icons arranged left-to-right directly above a mob's health bar"
    - "Effect icons use the same frame/icon/overlay/numeral style as the player's effects GUI"
    - "Effect duration overlays drain smoothly per tick with sub-tick interpolation"
  artifacts:
    - path: "src/client/kotlin/thc/client/MobHealthBarRenderer.kt"
      provides: "Mob effect icon rendering above health bar"
      contains: "renderEffects"
  key_links:
    - from: "MobHealthBarRenderer.kt"
      to: "effect_frame.png"
      via: "textured quad rendering"
      pattern: "effect_frame"
    - from: "MobHealthBarRenderer.kt"
      to: "mob_effect/.*.png"
      via: "vanilla icon texture path derivation"
      pattern: "mob_effect"
    - from: "MobHealthBarRenderer.kt"
      to: "EffectsHudRenderer priority/sorting"
      via: "shared priority map or comparator"
      pattern: "effectComparator|PRIORITY_MAP"
---

<objective>
Render active status effects on hostile mobs as icons directly above their health bar, reusing the visual style from the player's effects GUI (frame + icon + green duration overlay + roman numerals).

Purpose: Players need combat awareness — seeing what effects are active on a mob (poison, slowness, wither, etc.) tells them whether their tactics are working and what state the enemy is in.
Output: Modified MobHealthBarRenderer.kt with effect icon rendering, plus any shared constants extracted from EffectsHudRenderer.kt.
</objective>

<execution_context>
@/home/tack/.claude/get-shit-done/workflows/execute-plan.md
@/home/tack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/80-core-hud-rendering/80-01-SUMMARY.md
@.planning/phases/81-duration-overlay-and-numerals/81-01-SUMMARY.md

# Key source files
@src/client/kotlin/thc/client/EffectsHudRenderer.kt
@src/client/kotlin/thc/client/MobHealthBarRenderer.kt
@src/main/resources/assets/thc/textures/item/effect_frame.png
@src/main/resources/assets/thc/textures/item/numerals.png
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract shared effect rendering constants from EffectsHudRenderer</name>
  <files>src/client/kotlin/thc/client/EffectsHudRenderer.kt</files>
  <action>
Extract the following constants and utilities from EffectsHudRenderer to be accessible from MobHealthBarRenderer (either as public/internal vals or into a shared companion-like pattern):

1. **PRIORITY_MAP and effectComparator** — Move or expose as `internal` so MobHealthBarRenderer can sort mob effects the same way. The comparator and priority map should be accessible outside EffectsHudRenderer.

2. **Shared texture references** — The following must be accessible:
   - `FRAME_TEXTURE` (effect_frame.png identifier)
   - `NUMERALS_TEXTURE` (numerals.png identifier)
   - `OVERLAY_COLOR` (0x5A00FF00)

3. **Shared constants** — Expose these for world-space rendering calculations:
   - `BASE_FRAME_SIZE` (44)
   - `ICON_SOURCE_SIZE` (18)
   - `ICON_SIZE` (36), `ICON_OFFSET` (4)
   - `NUMERAL_SRC_WIDTH` (13), `NUMERAL_SRC_HEIGHT` (9), `NUMERAL_SHEET_HEIGHT` (90)
   - `NUMERAL_X` (5), `NUMERAL_Y` (5)

Make all of these `internal` visibility (Kotlin module-level) so they are accessible within the thc.client package but not exposed as public API. The existing EffectsHudRenderer render() method should continue to work identically — this is a pure refactoring task. Do NOT change any behavior.

Also expose the `originalDurations` map concept. The mob effects renderer will need its own per-mob duration tracking (keyed by entity ID + effect name), so the HUD renderer's map stays as-is. Just ensure the duration overlay ratio calculation logic is understandable for replication.
  </action>
  <verify>Build compiles (`./gradlew build`). EffectsHudRenderer still references all constants correctly. All constant values unchanged.</verify>
  <done>EffectsHudRenderer constants, textures, priority map, and comparator are accessible as internal vals for reuse by MobHealthBarRenderer.</done>
</task>

<task type="auto">
  <name>Task 2: Add effect icon rendering above mob health bars</name>
  <files>src/client/kotlin/thc/client/MobHealthBarRenderer.kt</files>
  <action>
Add mob status effect rendering to MobHealthBarRenderer, rendering effect icons left-to-right directly above each mob's health bar. This integrates into the existing per-mob render loop established by Phase 83.

**Effect collection and sorting:**
- For each mob being rendered, call `mob.activeEffects` to get active `MobEffectInstance` list
- Filter out infinite-duration effects (same as EffectsHudRenderer)
- Sort using the shared effectComparator from EffectsHudRenderer (priority sorting)
- If no effects after filtering, skip effect rendering for this mob

**Positioning above health bar:**
- Phase 83 renders the health bar as a billboard in world-space. The health bar texture is 328x62px rendered at some world-space scale.
- Effect icons render directly above the health bar (no gap), arranged left-to-right, centered horizontally.
- Each effect icon is rendered at a world-space size proportional to the health bar height. The effect frame in design space is 44x44. Scale it so its height roughly matches the health bar height (the bar is 62px tall in texture space; scale the 44px frame to match approximately: frame world-size = healthBar world-height * (44.0/62.0), or simpler: just use the same scale factor as the health bar and render the 44px frame at that scale).
- First icon starts at: healthBar center X - (totalEffectsWidth / 2), healthBar top Y (directly above, no gap)
- Each subsequent icon offsets rightward by frameWorldSize

**World-space textured quad rendering for each effect:**
For each effect icon, render 4 layers as textured quads (using VertexConsumer and the same RenderType pattern as the health bar):

1. **Frame** — Render `effect_frame.png` (44x44 source) as a quad of `frameWorldSize x frameWorldSize`
2. **Mob effect icon** — Derive texture path from effect registry key: `Identifier.fromNamespaceAndPath(loc.namespace, "textures/mob_effect/${loc.path}.png")`. Render the 18x18 source texture scaled to fill the icon area (inset by iconOffset from frame edges). The icon area in world-space is `iconWorldSize x iconWorldSize` where iconWorldSize = frameWorldSize * (36.0/44.0), offset by frameWorldSize * (4.0/44.0) from frame origin.
3. **Duration overlay** — Green semi-transparent quad (OVERLAY_COLOR) covering the icon area from bottom, with height = iconWorldSize * durationRatio. Duration ratio calculation: track original durations per mob in a `mutableMapOf<Int, MutableMap<String, Int>>()` keyed by entity ID then effect name. Logic matches EffectsHudRenderer: store on first-see or when duration increases, ratio = effectiveRemaining / original, effectiveRemaining = remaining - (1 - partialTick), clamped to [0, 1].
4. **Roman numeral** — For amplifier >= 1 and <= 9, render from `numerals.png` spritesheet. Position at frame origin + (5/44 * frameWorldSize, 5/44 * frameWorldSize). Source UV: row = amplifier * 9 within the 13x90 sheet.

**Quad rendering technique:**
Use the same `MultiBufferSource.BufferSource` from `Minecraft.getInstance().renderBuffers().bufferSource()` as BeaconBeamHelper does. For textured quads use `RenderType.entityTranslucent(texture)` or `RenderType.entityCutout(texture)` depending on whether alpha is needed. Each quad is 4 vertices with position, color, UV, overlay (0), light (fullbright 15728880), and normal (0,0,1 facing camera since billboard).

The billboard matrix is already set up by Phase 83's per-mob pose stack (translated to world position, rotated to face camera). Effect icons share this billboard orientation.

**Duration tracking cleanup:**
Each frame, after iterating all mobs, clean up duration tracking entries for entity IDs no longer being rendered (mob died, moved out of range, etc.). Use `retainAll` on the outer map keys.

**Important:** The effect rendering happens AFTER the health bar for each mob (same pose stack context, just translated upward). The health bar's world-space height determines where effects start rendering.
  </action>
  <verify>Build compiles (`./gradlew build`). Review rendered output: hostile mob with effects (e.g., apply poison with tipped arrow, or use /effect command) should show effect icons above its health bar.</verify>
  <done>Hostile mobs display their active status effects as icons above their health bar with frame/icon/overlay/numeral layers, duration drain with sub-tick interpolation, and priority-based left-to-right ordering.</done>
</task>

</tasks>

<verification>
1. Build compiles: `./gradlew build` succeeds with no errors
2. In-game test: `/effect give @e[type=zombie,limit=1] minecraft:poison 30 1` — zombie should show poison icon with "II" numeral above its health bar
3. In-game test: Apply multiple effects to a mob — icons arrange left-to-right with priority sorting (wither before poison before others)
4. Duration drain: Watch the green overlay shrink over time for timed effects, matching the smooth drain behavior of the player's effects GUI
5. Effect icon style matches player effects GUI: same frame texture, same icon rendering, same overlay color and behavior
</verification>

<success_criteria>
- MEFF-01: Active status effects render as icons left-to-right directly above the health bar (no gap)
- MEFF-02: Effect icons use same frame/icon/overlay style as player effects GUI (effect_frame.png, vanilla mob effect icons, green overlay, roman numerals)
- MEFF-03: Effect duration overlay drains per tick with sub-tick interpolation matching effects GUI behavior
</success_criteria>

<output>
After completion, create `.planning/phases/84-mob-effects-display/84-01-SUMMARY.md`
</output>
