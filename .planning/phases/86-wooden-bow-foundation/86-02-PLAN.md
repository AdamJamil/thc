---
phase: 86-wooden-bow-foundation
plan: 02
type: execute
wave: 2
depends_on: ["86-01"]
files_modified:
  - src/main/java/thc/mixin/AbstractArrowMixin.java
  - src/main/java/thc/mixin/BowItemMixin.java
  - src/main/resources/thc.mixins.json
autonomous: true

must_haves:
  truths:
    - "Wooden Bow arrows deal 50% of their normal final damage"
    - "Mobs hit by player projectiles no longer receive Glowing"
    - "Tipped arrows cannot be fired from the Wooden Bow"
    - "When tipped arrow blocked, a regular arrow is consumed instead and tipped arrow stays in inventory"
    - "If player has ONLY tipped arrows and no regular arrows, bow does not fire"
  artifacts:
    - path: "src/main/java/thc/mixin/AbstractArrowMixin.java"
      provides: "50% damage for wooden_bow, glowing removal"
      contains: "thc$bowTypeTag"
    - path: "src/main/java/thc/mixin/BowItemMixin.java"
      provides: "Tipped arrow restriction"
      contains: "TippedArrowItem"
  key_links:
    - from: "AbstractArrowMixin.java"
      to: "ProjectileEntityMixin.java"
      via: "bow type tag from shoot"
      pattern: "thc\\$getBowTypeTag"
    - from: "BowItemMixin.java"
      to: "BowType.kt"
      via: "bow type check for tipped restriction"
      pattern: "BowType"
---

<objective>
Apply 50% damage reduction for Wooden Bow arrows, remove Glowing effect from all player projectile hits, and block tipped arrows from being fired from the Wooden Bow.

Purpose: Complete the Wooden Bow's damage and restriction mechanics. Players will feel the bow as a weaker but accessible weapon, with tipped arrows reserved for future specialized bows.
Output: Working damage reduction, no more Glowing on projectile hits, tipped arrow gating.
</objective>

<execution_context>
@/home/tack/.claude/get-shit-done/workflows/execute-plan.md
@/home/tack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v3.4-ROADMAP.md
@.planning/phases/86-wooden-bow-foundation/86-CONTEXT.md
@.planning/phases/86-wooden-bow-foundation/86-01-SUMMARY.md
@src/main/java/thc/mixin/AbstractArrowMixin.java
@src/main/java/thc/mixin/ProjectileEntityMixin.java
@src/main/resources/thc.mixins.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply 50% damage for Wooden Bow arrows and remove Glowing</name>
  <files>
    src/main/java/thc/mixin/AbstractArrowMixin.java
  </files>
  <action>
  Modify `AbstractArrowMixin.java` to add bow-type-based damage and remove Glowing:

  1. **Remove Glowing effect** (DMG-05):
     - In `thc$applyArrowHitEffects`, remove the line that adds `MobEffects.GLOWING` to the target. The Speed III effect stays. Only Glowing is removed.
     - This satisfies "Mobs hit by player projectiles no longer receive the Glowing effect"

  2. **Apply 50% damage for wooden_bow arrows** (DMG-01):
     - In `thc$applyArrowHitEffects`, after confirming the owner is a ServerPlayer, retrieve the bow type tag from the Projectile superclass. Cast `self` to `ProjectileEntityMixin` won't work from a different mixin. Instead, use duck interface or direct field access.
     - **Approach**: Access the bow type tag by casting the `AbstractArrow` (which extends `Projectile`) to `Object` and using reflection-free access. Since `ProjectileEntityMixin` adds `thc$getBowTypeTag()` to `Projectile` class, and `AbstractArrow` extends `Projectile`, we can cast to get the method. Create a simple interface `BowTypeTagHolder` in `thc/bow/` package with a single method `String thc$getBowTypeTag()`. Have `ProjectileEntityMixin` implement this interface (add `implements BowTypeTagHolder` via mixin's `@Implements` or just rely on duck typing since Mixin adds the method to the class). Then in AbstractArrowMixin, cast `self` to `BowTypeTagHolder` and call the method.
     - **Simpler approach** (preferred): Since both mixins target the same class hierarchy and the method is `@Unique`, use direct duck-type casting: `((ProjectileEntityMixin)(Object)self).thc$getBowTypeTag()` -- but this won't compile because mixin classes aren't directly referenceable.
     - **Simplest approach**: Add a `@Unique private String thc$bowTypeTag` field directly to `AbstractArrowMixin` as well, and set it via an `@Inject` on the arrow's tick or creation. But this duplicates state.
     - **Best approach**: Create a simple interface `src/main/java/thc/bow/BowTypeTagAccess.java` with method `String thc$getBowTypeTag()`. In `ProjectileEntityMixin`, implement this interface (Mixin supports this via class declaration). In `AbstractArrowMixin`, cast `(AbstractArrow)(Object)this` to `BowTypeTagAccess` to read the tag. This is clean and standard Mixin practice.
     - After getting the bow type tag, if tag equals "wooden_bow", apply an additional 0.5x multiplier to `baseDamage`. This stacks with the existing 0.13 class-based reduction. So total for wooden bow = baseDamage * 0.13 * classMultiplier * 0.5.
     - Apply the 0.5x AFTER the class multiplier calculation (line `baseDamage = reducedDamage;`), so change to: `baseDamage = reducedDamage * bowDamageMultiplier;` where bowDamageMultiplier is 0.5 for wooden_bow and 1.0 otherwise.

  3. **Create the BowTypeTagAccess interface**:
     - `src/main/java/thc/bow/BowTypeTagAccess.java`
     - Simple interface: `public interface BowTypeTagAccess { String thc$getBowTypeTag(); }`
     - Update `ProjectileEntityMixin` class declaration to implement this interface
     - This file is shared infrastructure but won't be written by Plan 01, so create it here

  Implementation order: Create interface first, then update ProjectileEntityMixin to implement it, then modify AbstractArrowMixin.

  Note: The `thc$originalBaseDamage` store/restore pattern in AbstractArrowMixin already handles temporary damage changes correctly -- the 50% bow multiplier is applied before hit processing and restored after, just like the existing class reduction.
  </action>
  <verify>
  `./gradlew build` compiles. Grep AbstractArrowMixin.java for: no `MobEffects.GLOWING` reference, `BowTypeTagAccess` cast present, 0.5 multiplier for wooden_bow present. Grep ProjectileEntityMixin.java for `BowTypeTagAccess` in class declaration.
  </verify>
  <done>
  Wooden Bow arrows deal 50% final damage (stacking with existing class-based reduction). Glowing effect completely removed from arrow hits. BowTypeTagAccess interface bridges bow type data from Projectile mixin to AbstractArrow mixin cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Block tipped arrows from Wooden Bow</name>
  <files>
    src/main/java/thc/mixin/BowItemMixin.java
    src/main/resources/thc.mixins.json
  </files>
  <action>
  Create a new mixin `BowItemMixin.java` that intercepts the bow's arrow selection to block tipped arrows:

  1. **Create `src/main/java/thc/mixin/BowItemMixin.java`**:
     - `@Mixin(net.minecraft.world.item.BowItem.class)`
     - Target the `releaseUsing` method which handles bow firing
     - The vanilla bow firing flow: `releaseUsing` -> finds the arrow item to use via `player.getProjectile(bowStack)` -> creates arrow entity -> shoots it
     - **Injection strategy**: Use `@Redirect` on the call to `player.getProjectile(weaponStack)` inside `releaseUsing`. This is where vanilla determines which arrow to consume.
     - In the redirect:
       a. Call the original `getProjectile()` to get the vanilla-selected arrow stack
       b. Check if the bow is a Wooden Bow (use `BowType.fromBowItem(weaponStack)` -- if WOODEN, apply restriction)
       c. If the selected arrow is a tipped arrow (`stack.getItem() instanceof net.minecraft.world.item.TippedArrowItem` -- note: in 1.21.11 this might be `net.minecraft.world.item.alchemy.PotionContents` component on an arrow, check the actual class), block it
       d. When blocked: search player's inventory for a regular (non-tipped) arrow. Regular arrows are: vanilla `Items.ARROW` and THC tiered arrows (iron/diamond/netherite). Tipped arrows have the `PotionContents` component.
       e. If a regular arrow is found, return that stack instead (vanilla will consume from it)
       f. If NO regular arrow found, return `ItemStack.EMPTY` to prevent firing entirely
       g. Optionally show actionbar message: "Your bow can't fire tipped arrows" (per Claude's discretion from CONTEXT.md -- do this, it's good UX)

  2. **Tipped arrow detection in 1.21.11**:
     - Check if the arrow ItemStack has the `DataComponents.POTION_CONTENTS` component set AND is not empty/water. This is more reliable than checking item class.
     - `stack.has(DataComponents.POTION_CONTENTS)` should work for tipped arrows
     - Actually, vanilla `TippedArrowItem` is a subclass of `ArrowItem` -- check `stack.getItem() instanceof TippedArrowItem` or check for the potion contents component

  3. **Register in thc.mixins.json**: Add "BowItemMixin" to the mixins array.

  4. **Edge case** (per Claude's discretion from CONTEXT.md): If player has ONLY tipped arrows and no regular arrows, bow simply does not fire. Return `ItemStack.EMPTY` and optionally show actionbar message.

  NOTE: The tipped arrow stays in inventory because we never consume from the tipped arrow stack -- we either find and return a different (regular) stack, or return EMPTY. Vanilla only consumes from the stack we return.
  </action>
  <verify>
  `./gradlew build` compiles. Verify BowItemMixin.java exists with @Redirect on getProjectile call. Verify thc.mixins.json contains "BowItemMixin". Grep for TippedArrowItem or POTION_CONTENTS in BowItemMixin.
  </verify>
  <done>
  Wooden Bow cannot fire tipped arrows. Attempting to fire a tipped arrow consumes a regular arrow instead. If no regular arrow available, bow does not fire. Tipped arrows remain in player inventory. Actionbar message shown when tipped arrow blocked.
  </done>
</task>

</tasks>

<verification>
- `./gradlew build` succeeds
- AbstractArrowMixin no longer applies Glowing to targets
- AbstractArrowMixin applies 50% damage multiplier for wooden_bow tagged arrows
- BowItemMixin redirects arrow selection to block tipped arrows
- BowTypeTagAccess interface bridges ProjectileEntityMixin tag to AbstractArrowMixin
- thc.mixins.json includes BowItemMixin
</verification>

<success_criteria>
Wooden Bow arrows deal half damage. Glowing removed from all player projectile hits. Tipped arrows blocked from Wooden Bow with regular arrow consumed instead and player notification.
</success_criteria>

<output>
After completion, create `.planning/phases/86-wooden-bow-foundation/86-02-SUMMARY.md`
</output>
