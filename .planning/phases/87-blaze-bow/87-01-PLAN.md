---
phase: 87-blaze-bow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/kotlin/thc/item/BlazeBowItem.kt
  - src/main/kotlin/thc/item/THCItems.kt
  - src/main/kotlin/thc/bow/BowType.kt
  - src/main/java/thc/mixin/AbstractArrowMixin.java
  - src/main/resources/assets/thc/items/blaze_bow.json
  - src/main/resources/assets/thc/models/item/blaze_bow.json
  - src/main/resources/assets/thc/lang/en_us.json
  - src/main/resources/data/thc/recipe/blaze_bow.json
autonomous: true

must_haves:
  truths:
    - "Blaze Bow item exists in-game with custom idle texture and three pulling state textures"
    - "Blaze Bow is craftable with 3 blaze rods + 3 string"
    - "Arrows fired from the Blaze Bow set the target on fire for 3 seconds"
    - "Blaze Bow takes 1.5x longer to fully draw compared to the Wooden Bow"
    - "Non-Ranged players or players below Stage 2 cannot use the Blaze Bow"
    - "Denied players see actionbar message: The bow burns your fragile hands."
    - "Blaze Bow arrows deal 100% final damage (no bow-specific damage reduction)"
  artifacts:
    - path: "src/main/kotlin/thc/item/BlazeBowItem.kt"
      provides: "Custom bow item with class gate and 1.5x draw speed"
      contains: "BlazeBowItem"
    - path: "src/main/kotlin/thc/item/THCItems.kt"
      provides: "Blaze Bow item registration"
      contains: "BLAZE_BOW"
    - path: "src/main/kotlin/thc/bow/BowType.kt"
      provides: "Updated fromBowItem to recognize BlazeBowItem"
      contains: "BlazeBowItem"
    - path: "src/main/java/thc/mixin/AbstractArrowMixin.java"
      provides: "Fire-on-hit for blaze_bow tagged arrows"
      contains: "blaze_bow"
    - path: "src/main/resources/assets/thc/items/blaze_bow.json"
      provides: "Item definition with pulling state overrides"
    - path: "src/main/resources/data/thc/recipe/blaze_bow.json"
      provides: "3 blaze rods + 3 string shaped recipe"
      contains: "blaze_rod"
  key_links:
    - from: "BlazeBowItem.kt"
      to: "ClassManager/StageManager"
      via: "class gate check on use"
      pattern: "ClassManager\\.getClass|StageManager\\.getBoonLevel"
    - from: "AbstractArrowMixin.java"
      to: "BowTypeTagAccess"
      via: "bow type tag check for fire-on-hit"
      pattern: "blaze_bow"
    - from: "BowType.kt"
      to: "BlazeBowItem.kt"
      via: "fromBowItem identification"
      pattern: "BlazeBowItem"
---

<objective>
Create the Blaze Bow as a complete item: custom BowItem subclass with Ranged Stage 2+ class gate and 1.5x draw speed, item registration with textures and pulling states, recipe, and fire-on-hit mechanics for arrows tagged "blaze_bow".

Purpose: Ranged class gets a specialized fire-damage bow that rewards slow, deliberate shooting. The class gate and slow draw differentiate it from the Wooden Bow foundation.
Output: Working Blaze Bow item with crafting, class gate, slow draw, and fire-on-hit.
</objective>

<execution_context>
@/home/tack/.claude/get-shit-done/workflows/execute-plan.md
@/home/tack/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v3.4-ROADMAP.md
@.planning/phases/87-blaze-bow/87-CONTEXT.md
@.planning/phases/86-wooden-bow-foundation/86-01-SUMMARY.md
@.planning/phases/86-wooden-bow-foundation/86-02-SUMMARY.md
@src/main/kotlin/thc/item/THCItems.kt
@src/main/kotlin/thc/item/BucklerItem.kt
@src/main/kotlin/thc/bow/BowType.kt
@src/main/java/thc/mixin/AbstractArrowMixin.java
@src/main/java/thc/playerclass/ClassManager.java
@src/main/java/thc/stage/StageManager.java
@src/main/java/thc/playerclass/PlayerClass.java
@src/main/resources/thc.mixins.json
@src/main/resources/assets/thc/lang/en_us.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BlazeBowItem with class gate and slow draw, register item with textures and recipe</name>
  <files>
    src/main/kotlin/thc/item/BlazeBowItem.kt
    src/main/kotlin/thc/item/THCItems.kt
    src/main/kotlin/thc/bow/BowType.kt
    src/main/resources/assets/thc/items/blaze_bow.json
    src/main/resources/assets/thc/models/item/blaze_bow.json
    src/main/resources/assets/thc/lang/en_us.json
    src/main/resources/data/thc/recipe/blaze_bow.json
  </files>
  <action>
  1. **Create `src/main/kotlin/thc/item/BlazeBowItem.kt`**:
     - Extends `net.minecraft.world.item.BowItem(properties)`
     - Override `use(world, player, hand)`:
       a. If player is ServerPlayer, check class gate: `ClassManager.getClass(player)` must be `PlayerClass.RANGED` AND `StageManager.getBoonLevel(player) >= 2`
       b. If gate fails, show actionbar message: `"The bow burns your fragile hands."` with `ChatFormatting.RED`, return `InteractionResult.FAIL`
       c. If gate passes, call `super.use(world, player, hand)` and return its result
     - Override `getUseDuration(stack, entity)`: Return `(72000 * 1.5).toInt()` — this is `108000`. Vanilla BowItem.getUseDuration returns 72000. The 1.5x multiplier makes it take longer to fully draw. Note: The actual draw speed is determined by `useDuration - useTicksRemaining` compared to charge thresholds. By increasing useDuration, the tick counter takes longer to reach full charge, but vanilla BowItem uses `getUseDuration - ticksRemaining` for charge calculation, and the max charge is capped at 1.0 in `BowItem.getPowerForTime`. The time to reach full power = 20 ticks (1 second) in vanilla. To make it 1.5x, we need to slow the draw progress.
     - **IMPORTANT draw speed clarification**: Vanilla bow draw speed is actually controlled by `BowItem.getPowerForTime(int charge)` where `charge = getUseDuration - ticksLeft`. The formula is: `float f = (float) charge / 20.0F; f = (f * f + f * 2.0F) / 3.0F; return Math.min(f, 1.0F);`. Full power at ~20 ticks. To make it 1.5x slower, we need the power function to take 30 ticks to reach 1.0. Override `getPowerForTime` is not possible (it's static). Instead, override `releaseUsing` to intercept the charge time and scale it down by dividing by 1.5 before it's used. **Better approach**: Since `releaseUsing` calls `BowItem.getPowerForTime(i)` where `i = getUseDuration() - remainingTicks`, and we want it to take 1.5x longer, we can override `getUseDuration` to return a higher value, but that affects the charge calculation `i = useDuration - ticksRemaining`. Actually, that approach works perfectly: if useDuration is 108000 instead of 72000, then `i = 108000 - ticksRemaining` vs `i = 72000 - ticksRemaining`. Since the player starts using at tick T and `ticksRemaining = useDuration - (currentTick - startTick)`, we get `i = currentTick - startTick`. So useDuration doesn't actually affect draw speed! The charge progress `i` is always `ticks_since_start`.
     - **Correct approach for 1.5x draw speed**: Override `releaseUsing` in BlazeBowItem. In the override:
       a. Calculate the actual charge time: `int actualCharge = getUseDuration(stack, entity) - timeLeft`
       b. Scale it down: `int scaledCharge = (int)(actualCharge / 1.5f)` — this makes 30 real ticks equivalent to 20 vanilla ticks
       c. Calculate the adjusted timeLeft: `int adjustedTimeLeft = getUseDuration(stack, entity) - scaledCharge`
       d. Call `super.releaseUsing(stack, level, entity, adjustedTimeLeft)` with the adjusted time
       This makes the bow feel 1.5x slower because the power curve progresses 1/1.5 = 0.667x as fast.
     - Follow the BucklerItem pattern for imports and class gate structure (see `@src/main/kotlin/thc/item/BucklerItem.kt`).

  2. **Register item in `THCItems.kt`**:
     - Add `BLAZE_BOW` field using the register pattern:
       ```kotlin
       @JvmField
       val BLAZE_BOW: Item = register("blaze_bow") { key ->
           BlazeBowItem(
               Item.Properties()
                   .setId(key)
                   .stacksTo(1)
                   .durability(384)
           )
       }
       ```
     - Durability 384 matches vanilla bow (same durability category).
     - Add to combat creative tab: `ItemGroupEvents.modifyEntriesEvent(combatTabKey).register { entries -> entries.accept(BLAZE_BOW) }`. Add the combatTabKey constant like THCArrows uses:
       ```kotlin
       private val combatTabKey: ResourceKey<CreativeModeTab> = ResourceKey.create(
           Registries.CREATIVE_MODE_TAB,
           Identifier.withDefaultNamespace("combat")
       )
       ```
     - In `init()`, add the creative tab registration for BLAZE_BOW.

  3. **Update `BowType.kt`** (created by Phase 86):
     - Update `fromBowItem(stack: ItemStack)` to return `BLAZE` when `stack.item is BlazeBowItem`.
     - Add the import for BlazeBowItem.

  4. **Create item definition `assets/thc/items/blaze_bow.json`**:
     - This is the MC 1.21+ item model system. The blaze bow needs pulling state overrides.
     - For a bow with pulling states in 1.21+, the items JSON uses `minecraft:condition` with `minecraft:using_item` and `minecraft:use_duration` properties:
       ```json
       {
         "model": {
           "type": "minecraft:select",
           "property": "minecraft:using_item",
           "on_true": {
             "type": "minecraft:range_dispatch",
             "property": "minecraft:use_duration",
             "scale": 0.05,
             "entries": [
               {
                 "threshold": 0.0,
                 "model": {
                   "type": "minecraft:model",
                   "model": "thc:item/blaze_bow_pulling_0"
                 }
               },
               {
                 "threshold": 0.65,
                 "model": {
                   "type": "minecraft:model",
                   "model": "thc:item/blaze_bow_pulling_1"
                 }
               },
               {
                 "threshold": 0.9,
                 "model": {
                   "type": "minecraft:model",
                   "model": "thc:item/blaze_bow_pulling_2"
                 }
               }
             ],
             "fallback": {
               "type": "minecraft:model",
               "model": "thc:item/blaze_bow_pulling_0"
             }
           },
           "on_false": {
             "type": "minecraft:model",
             "model": "thc:item/blaze_bow"
           }
         }
       }
       ```
     - The thresholds (0.0, 0.65, 0.9) match vanilla bow pulling progression. The `scale: 0.05` converts tick count to the 0-1 range (20 ticks * 0.05 = 1.0). For the Blaze Bow with 1.5x draw time, adjust scale to `0.0333` (30 ticks * 0.0333 = ~1.0) so pulling textures transition at the correct visual pace. If scale is not adjustable per-item in the items JSON (it's a static model property), keep `0.05` and accept slightly early texture transitions. The actual damage power is correctly scaled via releaseUsing override regardless of visual.

  5. **Create model files** for blaze bow and pulling states:
     - `assets/thc/models/item/blaze_bow.json`:
       ```json
       {
         "parent": "minecraft:item/generated",
         "textures": {
           "layer0": "thc:item/blaze_bow"
         }
       }
       ```
     - `assets/thc/models/item/blaze_bow_pulling_0.json`:
       ```json
       {
         "parent": "minecraft:item/generated",
         "textures": {
           "layer0": "thc:item/blaze_bow_iron_pulling_0"
         }
       }
       ```
     - `assets/thc/models/item/blaze_bow_pulling_1.json` and `blaze_bow_pulling_2.json` following same pattern with `blaze_bow_iron_pulling_1` and `blaze_bow_iron_pulling_2` textures respectively.
     - The existing texture files are named `blaze_bow_iron_pulling_X.png` — the model JSON references these.

  6. **Add lang entry in `en_us.json`**: `"item.thc.blaze_bow": "Blaze Bow"`

  7. **Create recipe `data/thc/recipe/blaze_bow.json`**:
     - Shaped recipe, category "equipment"
     - Key: "B" = minecraft:blaze_rod, "S" = minecraft:string
     - Pattern: " BS", "B S", " BS" (standard bow shape with blaze rods)
     - Result: thc:blaze_bow
     - Note: recipe goes in `data/thc/recipe/` (mod namespace), not `data/minecraft/recipe/`
  </action>
  <verify>
  `./gradlew build` compiles without errors. Verify: BlazeBowItem.kt exists with class gate check and releaseUsing override, THCItems.kt has BLAZE_BOW registration, BowType.kt fromBowItem handles BlazeBowItem, items/blaze_bow.json exists with pulling states, recipe/blaze_bow.json uses blaze_rod + string.
  </verify>
  <done>
  Blaze Bow item registered with custom textures (idle + 3 pulling states), craftable with 3 blaze rods + 3 string. Draw speed is 1.5x slower than Wooden Bow. Non-Ranged or sub-Stage-2 players see "The bow burns your fragile hands." on actionbar and cannot use it. BowType.fromBowItem recognizes BlazeBowItem as BLAZE.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add fire-on-hit for Blaze Bow arrows</name>
  <files>
    src/main/java/thc/mixin/AbstractArrowMixin.java
  </files>
  <action>
  Modify `AbstractArrowMixin.java` to apply fire to targets hit by blaze_bow arrows:

  1. **In `thc$applyArrowHitEffects`**, after the existing player arrow processing (class-based damage reduction):
     - Retrieve the bow type tag using the `BowTypeTagAccess` interface (created in Phase 86 Plan 02): `String bowTag = ((BowTypeTagAccess)(Object)self).thc$getBowTypeTag();`
     - If `bowTag` equals `"blaze_bow"`:
       a. Set the target entity on fire for 3 seconds (60 ticks): `target.igniteForSeconds(3.0f)` — this is the standard Fabric/MC API for setting fire duration. The method name may be `igniteForSeconds(float)` or `setRemainingFireTicks(int)`. Use `target.setRemainingFireTicks(60)` if `igniteForSeconds` is not available.
       b. Fire deals 0.5 damage/second in vanilla (1 HP per 2 seconds, ticking every 20 ticks). Three seconds = 1.5 HP total fire damage. This matches "3 seconds (0.5 damage/second)" from the requirements.
     - **Fire refreshes on re-hit** (Claude's discretion): Yes, re-hitting refreshes the fire duration. `setRemainingFireTicks(60)` naturally does this since it overwrites the current fire timer.

  2. **Blaze Bow damage multiplier**: Per CONTEXT.md locked decision, Blaze Bow arrows deal 100% final damage. This means NO additional bow-specific multiplier. The existing code from Phase 86 Plan 02 applies `0.5` multiplier for `wooden_bow` tag. For `blaze_bow`, the multiplier should be `1.0` (or simply no modification). Verify the Phase 86 implementation — if there's a switch/if on bow type for damage, ensure `blaze_bow` maps to 1.0x. If Phase 86 only checks `wooden_bow` specifically and defaults to 1.0, no change needed.

  3. **Visual fire**: The arrow itself should appear flaming in flight (Claude's discretion). Set the arrow entity on fire before it's shot: In ProjectileEntityMixin's shoot method (Phase 86), add a check — if bow type is BLAZE, call `self.igniteForSeconds(100)` or `self.setRemainingFireTicks(2000)` to make the arrow visually flaming. **However**, this is in ProjectileEntityMixin which is Phase 86's file. Instead, handle it here: in AbstractArrowMixin, add a `@Inject` on `tick` at HEAD that checks if the bow type tag is "blaze_bow" and the arrow isn't already on fire, then set it on fire. This way the arrow burns visually in flight. Actually, a simpler approach: in the shoot inject already in ProjectileEntityMixin (Phase 86), the bow type is determined. If the executor of Phase 86 stored the bow type tag, we can add an `@Inject` on AbstractArrow's constructor or post-shoot to set fire. **Simplest**: Add a one-time check in AbstractArrowMixin. Add a `@Unique private boolean thc$blazeFireApplied = false;` field. In a `@Inject(method = "tick", at = @At("HEAD"))` method, if `!thc$blazeFireApplied` and bow tag is `"blaze_bow"`, call `self.setRemainingFireTicks(2000)` and set `thc$blazeFireApplied = true`. This makes the arrow appear flaming throughout its flight.

  4. **Ensure no duplicate effects**: The fire-on-hit logic should only run for player-shot arrows (already gated by the `owner instanceof ServerPlayer` check).
  </action>
  <verify>
  `./gradlew build` compiles. Grep AbstractArrowMixin.java for: `blaze_bow` string present, `setRemainingFireTicks` or `igniteForSeconds` call present, fire tick check in tick method present. No damage multiplier applied for blaze_bow (should be 1.0 / no modifier).
  </verify>
  <done>
  Blaze Bow arrows set targets on fire for 3 seconds (0.5 damage/second, 1.5 HP total). Arrows appear flaming in flight. Fire duration refreshes on re-hit. Blaze Bow arrows deal 100% final damage (no bow-specific reduction). Fire-on-hit only applies to player-shot arrows from the Blaze Bow.
  </done>
</task>

</tasks>

<verification>
- `./gradlew build` succeeds
- BlazeBowItem exists with Ranged Stage 2+ gate and "The bow burns your fragile hands." message
- BlazeBowItem.releaseUsing scales charge time by 1/1.5 for slower draw
- THCItems.BLAZE_BOW registered with durability 384 and combat creative tab
- BowType.fromBowItem returns BLAZE for BlazeBowItem
- items/blaze_bow.json has pulling state model overrides
- models/item/blaze_bow*.json reference correct textures
- data/thc/recipe/blaze_bow.json uses 3 blaze rods + 3 string
- en_us.json has "Blaze Bow" entry
- AbstractArrowMixin applies fire (3 seconds) to targets hit by blaze_bow arrows
- AbstractArrowMixin makes blaze_bow arrows appear flaming in flight
- No damage reduction applied to blaze_bow arrows (100% damage)
</verification>

<success_criteria>
Blaze Bow is a complete item: registered, craftable, textured with pulling states, class-gated to Ranged Stage 2+, draws 1.5x slower than Wooden Bow, fires arrows that set targets on fire for 3 seconds, and deals full (100%) damage. Non-Ranged or low-stage players are denied with actionbar message.
</success_criteria>

<output>
After completion, create `.planning/phases/87-blaze-bow/87-01-SUMMARY.md`
</output>
