---
milestone: v2.5
audited: 2026-01-28T18:45:00Z
status: passed
scores:
  requirements: 9/9
  phases: 4/4
  integration: 12/12
  flows: 5/5
gaps: {}
tech_debt: []
---

# v2.5 Enchantment Overhaul - Milestone Audit

**Audited:** 2026-01-28
**Status:** PASSED

## Executive Summary

Milestone v2.5 has 4 phases, all of which passed verification. A critical integration bug was found during audit (stage 3+ loot filtering also filtered mob drops) and was immediately fixed in commit `f524a1c`.

## Phase Verification Status

| Phase | Status | Score | Notes |
|-------|--------|-------|-------|
| 53: Enforcement Foundation | PASSED | 5/5 | Removed enchants, single-level display, fire damage |
| 54: Lectern Enchanting | PASSED | 6/6 | Stage 1-2 book placement, unlimited use |
| 55: Enchanting Table Overhaul | PASSED | 6/6 | Book-slot mechanic, stage requirements |
| 56: Acquisition Gating | PASSED | 9/9 | Loot filtering, mob drops (verification was code-only) |

All phases passed individual verification, but runtime integration was not tested.

## Critical Bug (FIXED)

### Location
`src/main/kotlin/thc/THC.kt:171-188`

### Description
The `LootTableEvents.MODIFY_DROPS` handler was ignoring the loot table identifier and filtering ALL drops containing stage 3+ enchantments, including mob entity loot tables.

### Resolution
Fixed in commit `f524a1c`. The handler now checks if the loot table key contains "entities/" and skips stage 3+ filtering for mob drops:

```kotlin
LootTableEvents.MODIFY_DROPS.register(LootTableEvents.ModifyDrops { key, _, drops ->
    // ... existing totem/item removal ...

    // Skip stage 3+ filtering for entity loot tables (mob drops are intended source)
    val keyString = key.toString()
    if (!keyString.contains("entities/")) {
        // ... stage 3+ filtering ...
    }

    // ... enchantment enforcement runs on ALL drops ...
})
```

All requirements now satisfied.

## Integration Verification

### Connected Exports (12/12)

| Export | Source | Consumer | Status |
|--------|--------|----------|--------|
| REMOVED_ENCHANTMENTS | P53 | stripAndNormalize, isStage3Plus | CONNECTED |
| STAGE_1_2_ENCHANTMENTS | P53 | P54, P55, P56 | CONNECTED |
| STAGE_4_5_ENCHANTMENTS | P55 | getStageForEnchantment | CONNECTED |
| isStage12Enchantment() | P53 | LecternEnchanting | CONNECTED |
| getStageForEnchantment() | P55 | EnchantmentMenuMixin | CONNECTED |
| getLevelRequirementForStage() | P55 | EnchantmentMenuMixin | CONNECTED |
| isStage3Plus() | P56 | THC.kt MODIFY_DROPS | CONNECTED |
| hasStage3PlusEnchantment() | P56 | THC.kt MODIFY_DROPS | CONNECTED |
| correctStack() | P53 | THC.kt, MobFinalizeSpawnMixin | CONNECTED |
| FIRE_SOURCE attachment | P53 | Fire mixins | CONNECTED |
| LecternEnchanting.register() | P54 | THC.kt | CONNECTED |
| SOUL_DUST item | P55 | Recipe | CONNECTED |

### Mixin Registrations (5/5)

All phase mixins registered in thc.mixins.json:
- EnchantmentMenuMixin (P55)
- FireAspectIgniteMixin (P53)
- FlameIgniteMixin (P53)
- ItemEnchantmentsMixin (P53)
- LivingEntityFireMixin (P53)

## E2E Flow Status

| Flow | Status | Notes |
|------|--------|-------|
| Lectern Enchanting | COMPLETE | Stage 1-2 books work, unlimited use |
| Enchanting Table | COMPLETE | Book-slot works, stage requirements enforced |
| Loot Filtering | COMPLETE | Stage 3+ filtered from chests (but also mobs - bug) |
| Mob Drop | BROKEN | Books filtered before reaching player |
| Fire Damage | COMPLETE | Flame/Fire Aspect custom damage working |

## Stage Classification Consistency

Stage classifications are internally consistent across all functions:
- Stage 1-2: mending, unbreaking, efficiency, fortune, silk_touch, lure, luck_of_the_sea
- Stage 3: Default (sharpness, protection, etc.)
- Stage 4-5: flame, fire_aspect, looting, sweeping_edge, feather_falling, blast_protection, projectile_protection

## Tech Debt

None identified.

## Recommendation

**Do not complete milestone.** The critical bug must be fixed first.

Create a gap-closure phase (Phase 56.1 or amend Phase 56) to fix the loot table filtering to exclude entity loot tables.

---

*Audited: 2026-01-28T18:30:00Z*
*Auditor: Claude (gsd-integration-checker)*
